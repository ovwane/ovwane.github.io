# 0165
# 0171
# 0183
# 0188
# 0193
# 0197
# 0209
# 0247
# 0261
# 0313
TCP/UDP 端口号（1~65535)
TCP三次握手
1、Client to Server Syn=1,Seq=0
2、Server to Client Syn=1,Ack=1,Seq=0
3、Client to Server Ack=1，Seq=Seq+1

三次握手之后tcp状态变成established。

TCP四次挥手
1、主机A fin=1,seq=seq
2、主机B seq=seq,ack=主机A的seq+1
3、主机B 数据传输完毕，fin=1，seq=seq
4、主机A seq=seq，ack=主机B的seq+1

TCP的11种状态

```
三次握手涉及的状态
CLOSED、SYN_SENT、SYN_RCVD、ESTABLISHED

四次挥手涉及的状态
FIN_WAIT1、CLOSE_WAIT、FIN_WAIT2、LAST_ACK、TIME_WAIT

CLOSING
```

tcp三次握手的状态
1、一开始，建立连接之前服务器和客户端的状态都是CLOSED。
2、服务器创建socket后开始监听，变成LISTEN状态。
3、客户端请求建立连接，向服务器发送syn报文，客户端的状态变为SYN_SENT。
4、服务器收到客户端的报文后向客户端发送ACK和SYN报文，此时服务器状态变为SYN——RCVD。
5、客户端收到服务器的ACK和SYN报文，就向服务器发送ACK报文，客户端状态变成ESTABLISHED。

tcp四次断开的状态
1、客户端先向服务器发送FIN报文，请求断开连接，其状态变成FIN_WAIT1。
2、服务器收到客户端FIN报文后，服务器向客户端发送ACK报文，服务器状态变为CLOSE_WAIT。
3、客户端收到服务器ACK报文后，进入FIN_WAIT2状态，此时连接已经断开一半了。如果服务器还有数据发送给客户端，就会继续发送。
4、服务器发送数据完成后，就发送FIN报文给客户端，服务器状态变为LAST_ACK状态。
5、客户端收到服务器的FIN报文，马上发送ACK报文给服务器，此时客户端进入TIME_WAIT状态。
6、客服端等待2MSL长的时间后进入CLOSED状态。服务器收到客户端的ACK报文就进入COLSED状态。

CLOSING状态
1、客户端向服务器发送FIN报文，没有收到服务器的ACK报文，直接收到了服务器的FIN报文。然后客户端状态变成CLOSING状态。
>这种情况发生在服务器发送ACK丢报的时候，因为网络传输有时会有意外。

socket socket的五元组
源ip
源端口
目标ip
目标端口
tcp/udp

# 0314
## ARP


# 0317
# 0325
# 0326
# 0327
作为linux运维，打开网站服务器访问慢，如何排错

# 0328
局域网机器无法上网如何解决？
硬件 IP DNS 
ping 域名 确认 dns 浏览器问题
ping ip网关 确认物理链路问题
查看IP
网卡 网线
交换机环路

>1、态度
>2、技术

# 0329
网站访问速度慢

网站带宽问题
服务器CPU过高
内容资源过大
用户的带宽问题
网站代码问题
南北互联
网站遭受攻击

1、自己把自己当作用户去测试

网络没问题

查看服务器服务 连接数，负载高。CPU高，IO高

带宽问题

网站调用别的第三方服务慢

用户的线路和服务器线路不同

集群架构问题

Web服务器问题
数据库问题
存储问题

# 0331
tcp/ip协议
http协议
机器无法上网
网站打开慢
dns解析

OSI 7层 TCP/IP 四层

如何查看已知端口被占用的服务名城

route 如何添加一个网络路由

>解答要专业、规范

# 0332
# 0340
# 0356
# 0394
# 0395
# 0442
## expect
非交互式功能实战
[轻松实现远程批量拷贝文件脚本（女学生作品）](http://oldboy.blog.51cto.com/256140/1205715)

## 安装expect
```
yum install expect
```

## 使用
创建用户
生成密钥
分发密钥
 
ssh-keygen -t dsa -P '' -f ~/.ssh/id_dsa >/dev/null 2>&1

vi fenfa_sshkey.exp
spawn ssh-copy-id -i
expect

## 实现把脚本当前目录下的文件拷贝到所有服务器的任意目录
下面是来自老男孩培训初级第14期第六节课的批量分发管理服务器课程的女学生的作品（详细注释）
在大多数男同学还在迷糊的时候，该女同学已经完整的读懂并注释了全部的脚本，老男孩非常感慨，大家都有此努力的学习态度何愁运维不牛呢？
脚本内容及注释如下：

```
[binzai@ssh-server scripts]$ cat fenfa_host.sh   #→实现把脚本当前目录下的文件拷贝到所有服务器的任意目录
#!/bin/sh
. /etc/init.d/functions
file="$1"   #→传参文件
remote_dir="$2"   #→远程服务器目录
if [ $# -ne 2 ];then      #→如果传的参数不等于2个，那么就打印如下报错信息。
#→ $#：获取当前shell命令行中的参数的总个数
#→ -ne：不等于
echo "usage:$0 argv1 argv2"
#→$0：首个参数（fenfa_host.sh）
echo "must have two argvs."
exit
fi
for ip in $(cat /home/binzai/scripts/all_iplist.txt)
#→$()：在脚本里引用全局变量
do
scp -P22 -r -p $file binzai@$ip:~ >/dev/null 2>&1 &&\
#→将hosts文件传到binzai家目录下，如果没有传递过去，将丢弃到/dev/null
ssh -p 22 -t binzai@$ip sudo rsync -avz -P $file $remote_dir >/dev/null 2>&1
#→通过ssh通道执行sudo命令将hosts文件拷贝到/etc目录下
if [ $? -eq 0 ];then   #→如果上次执行结果返回值等于0，则执行OK。如果不等于0，则执行NO
#→$?：上次执行结果的返回值
#→-eq：等于
action "$ip is successful." /bin/true
else
action "$ip is failure." /bin/false
fi
done
‍```

补充shell变量知识：

```
$0 获取当前执行的shell脚本的文件名，包括路径
$n 获取当前执行的shell脚本的第n个参数值，n=1..9，当n为0时表示脚本的文件名，如果n大于9用大括号括起来 {10}
$* 获取当前shell的所有参数，将所有的命令行参数视为单个字符串，相当于“$1$2$3”…….注意与$#的区别
$# 获取当前shell命令行中参数的总个数
$@ 这个程序的所有参数”$1” “$2” “$3” “……” ，这是将参数传递给其他程序的最佳方式，因为他会保留所有内嵌在每个参数里的任何空白。
$? 是上次执行结果的返回值
0是正确，非0是错误
$()是引用全局命令（在脚本里面引用命令）
```

执行效果：

老男孩老师补充：
1）以上为基础的脚本，没什么难度，主要是感慨下学生的努力态度。
2）本脚本需要借助SSH KEY或者补充expect实现。

## 这是一个无需做任何配置一键就实现批量分发密钥和文件的脚本：

```
#!/bin/bash
# this scripts comes from oldboy trainning's student.
# e_mail:70271111@qq.com
# qqinfo:49000448
# function: remote dis ssh key.
# version:1.1
################################################
# oldboy trainning info.
# QQ 80042789 70271111
# site:http://www.etiantian.org
# blog:http://oldboy.blog.51cto.com
# oldboy trainning QQ group: 208160987 45039636
################################################
. /etc/init.d/functions
file="$1"
remote_dir="$2"
if [[ $# -ne 2 ]];then
echo  "usage:$0 argv2"
echo "must have one argvs"
exit
fi
function KNOWN_HOST_REBUILD()
{
#确保本机存在known_hosts列表
[ ! -e ~/.ssh/known_hosts ] && mkdir -p ~/.ssh/ && touch ~/.ssh/known_hosts
local i=$1
sed -i "/^${i} /d" ~/.ssh/known_hosts
expect -c "
spawn /usr/bin/ssh oldboy@${i} echo ok;
expect \"*yes/no)?\";
send \"yes\r\";
expect eof " >/dev/null 2>&1
return 0
[[ $? -ne 0 ]] && echo "$i know host rebuild fail,maybe the server connect error"
}
function PASS_PASSWD()
{
ip=$1
expect -c "
set timeout -1
spawn ssh-copy-id -i id_dsa oldboy@$ip
expect \"*password:\"
send \"oldboy123\r\"
expect eof" >/dev/null 2>&1
}
function FENFA_id_dsa()
{
for ip in `awk '/^[^#]/{print $1}' all_client.txt`
do
KNOWN_HOST_REBUILD $ip
PASS_PASSWD $ip
if [[ $? -eq 0 ]];then
action "$ip send id_dsa is successful" /bin/true
else
action "$ip send id_dsa is failed copied" /bin/false
fi
done
}
function FENFA_config()
{
for ip in `awk '/^[^#]/{print $1}' all_client.txt`
do
port=$(grep $ip all_client.txt|awk '{print $2}')
scp -P${port} -r -p ${file} oldboy@${ip}:~ >/dev/null 2>&1 && \
ssh -p${port} -t oldboy@$ip sudo rsync ~/`basename ${file}` $remote_dir >/dev/null 2>&1
if [[ $? -eq 0 ]];then
action "$ip send $file is successful!!" /bin/true
else
action "$ip send $file is failed!!" /bin/false
fi
done
}
FENFA_id_dsa
FENFA_config
```

# 0445
## 如何一键自动化期中50台规模集群网站搭建
搭建yum仓库、ntp时间同步服务器
定制rpm包

### 1.运维班方案 sshkey expect
1.kickstart无人值守安装linux系统（自动创建用户、密码、优化）
2.分发机上创建密钥对、批量分发公钥（expect）
3.写安装部署及优化脚本、批量分发到各个服务器上，远程执行安装。

### 2.高级架构师班 cobbler saltstack
1.cobbler无人值守安装linux系统（自动创建用户、密码、优化、salt客户端）
2.服务端salt上，创建认证，写配置来批量安装管理各个节点服务器应用。

### 3.高级架构师班 kvm openstack
1.kvm虚拟化、根据不同的业务提前做好镜像（linux基础优化、salt客户端）
2.通过云计算工具openstack管理镜像，批量生成五个虚拟机。
3.服务端salt上，创建认证，写配置来批量安装管理各个节点服务器应用。

### 4.高级架构师班 docker

# 0446
## 自动化运维工具
0）业务需求分析
1）机房设备上下架
	1.弹性
	2.扩展性
	3.充分利用资源 80%以下 雪崩效应
	
2）系统初始化
3）应用环境初始化
4）应用的部署（调试、配置） saltstack ansible
5）业务代码发布 jenkins + ant + svn 灰度发布 集群
6）服务监控 应用监控 系统监控 硬件监控 zabbix
7）业务数据备份 

# 0447
## 自动化发展的阶段
1）标准化
	目录标准化 /data/wwwroot /usr/loca/nginx
	
2）文档化
	宕机 应对方案

3）工具化
	
web化 工具平台化 CMBD API 开发要日志给他接口API就行。
	
服务化

智能化 AIOps


# 0453
## web服务基础
用户访问网站基本流程

打开浏览器
输入域名DNS
网站web服务器
返回数据给用户

# 0454
企业真实场景面试题：

1、用户访问网站流程框架
2、DNS解析原理
3、tcp/ip 三次握手原理
4、http协议原理（www服务的请求过程）请求细节，报文细节！
5、大规模网站集群架构细节
6、http协议原理（www服务器的响应过程）响应报文细节！
7、tcp/ip四次挥手过程原理

# 0471
# 0478
pv ip 并发

# 0479

如何理解并发

静态网站
Apache httpd 2.2 2.4
Nginx 1.6.2 1.13.3 Tenginx 
Lighttpd

动态网站
PHP fastcgi Apache mod_php
tomcat 7.0 8.0
resin 3.0 3.1 4.0
IIS

>Python 比较火



# 0480
[要不要考认证](http://oldboy.blog.51cto.com/2561410/1731320)

>学历是铜牌
>能力是银牌
>人脉是金牌
>思维是王牌

# 0481

日期：20160505

企业真实场景面试题：
1、描述从浏览器打开http://blog.oldboyedu.com地址回车发送请求看到页面的过程？

笔试就画出来、

1、DNS ttl 递归 迭代
2、TCP 三次连接握手
HTTP 请求报文 get post http 1.1 http2.0
TCP 四次挥手 fin ack 服务的 fin ack time_wait

# 0483
用户访问网站流程框架
1、DNS解析原理
2、tcp/ip三次握手（tcp的11种状态）
3、http协议原理请求get post http协议
4、大规模服务器集群架构细节
5、hhtp协议原理响应过程
6、tcp/ip四次挥手

[亿级PV超大型网站集群架构图形化深度揭秘讲解](http://edu.csdn.net/course/detail/2278)

>象棋与运维的碰撞

# 0484
## 成功=信念（目标）+价值观（方法）+努力（行动）+坚持


# 0485
# 0491
# 0523
## LNMP环境应用实践
```
locatin ~* \.php${}
	fastcgi_pass ip:9000
```

nginx 通过fastcgi请求php解析php页面

# 0524
MySQL简介

# 0525
yum 
二进制

MySQL 5.6 AliSQL 5.6

# 0526
MySQL 安装方式

二进制安装包
源码

```
ls
mysql.tar.gz mysql.tar.gz.md5

md5sum -c mysql.tar.gz
```

```
#创建mysql用户名
useradd -s /sbin/nologin mysql -M
mysql——install_db --basedir --datadir --user
mysqld_safe

lsof -i :3306

PATH="/app/mysql/bin:$PATH"
echo "export PATH=/app/mysql/bin:$PATH" >>/etc/profile
```

# 0527
mysql数据库安装步骤总结

修改mysql 密码

```
mysqladmin -uroot password "oldboy"
mysqladmin -uroot -p password "oldboy"
```

>你用行动做了很多第一次，所以难忘。

# 0528
常见故障

>推我、鼓励我、说我


# 0529
FastCGI

CGI通用网关接口

FastCGI接口 socket：文件socket，IP socket

LNMP运行过程和解析原理

>架构师有销售能力
>让一个人痛苦的能力就是你营销的能力！

# 0530
```
netstat -lntup|egrep "nginx|mysql"
```
```
lib库 -devel的包
```
```
zlib gd freetype libpng libxml libcurl libconv libmcrypt mhash
```

# 0531
源码编译安装php
--enable-fpm
--with-fpm-user=www

ldconfig

make -j

# 0532
php.ini php-fpm.ini
sbin/php-fpm

# 0533
```
location ~ .*\,(php|php5)?$ {
	root html/blog;
	fastcgi_pass 127.0.0.1:9000;
	fastcgi_index index.php;
	include fastcgi.conf;
}
```

```
<php
	phpinfo();
?>
```
```
<php
	$link_id=mysql_connect('localhost','root','oldboy') or mysql_error();
	if($link_id){
		echo "mysql successful by oldboy!";
	else
		echo mysql_error();
?>
```

# 0535

mysql 语句

```
system whoami；

grant all on *.* to wordpress@'localhost' identified by '123456'；
select user from mysql.user;
show grant for wordpress@'localhost';
flush privileges;
```

bo-blog
wordpress
discuz

# 0536
总结
 
wordpress 网址静态化

# 0537
日期：20160517

主机名

```
负载均衡 lb01 
负载均衡 lb02
web服务 web01
web服务 web02
数据库主 dbm01
文件系统 nfs01
备份 backup01
监控 跳板机 m01
```
```
mysql -uroot -p wordpress <bak.sql 
mysql -uroot -p -e “show databases like 'wordpress';"

grant all on wordpress.* to wordpress@'172.16.1.%' identified by '123456';
#修改数据库信息 
vi wp-config.php

use wordpress;
show tables;
select * from old_post\G;
```

# 0538
将blog的资源文件迁移到nfs

# 0555
nginx 负载均衡

```
upstream server_pools {
	ip_hash;
	server 10.0.0.7:80 weight=1;
	server 10.0.0.8:80 weight=1;
}
```

# 0556
架构需求

架构设想

架构计划清单

架构逻辑图

硬件及IP规划

软件规划
	统一软件类型
	统一软件版本
	统一配置文件
	
必备lib和其他工具
	编译安装
	yum安装
	工具
	
目录规划

用户规划

自动化部署心脏---分发服务器

用数据说话---有图有真相
	shell脚本
	expect脚本
	python脚本
	
自动部署标准流程图

架构展望---怎么优化，更高效，更快速

>相信自己，不要给自己设限。
>------李扬 2015-03-19

# 0557

