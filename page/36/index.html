<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>幻舞梦境</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="幻舞梦境">
<meta property="og:url" content="http://ovwane.me/page/36/index.html">
<meta property="og:site_name" content="幻舞梦境">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="幻舞梦境">
  
    <link rel="alternative" href="/atom.xml" title="幻舞梦境" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
     
      <meta name="baidu-site-verification" content="3rC08I0Cp6" />
    
     
      <meta name="google-site-verification" content="rn8f25RzFQoiByt8ezg9E17KZIElbIlwJ4y-EKSlWbA" />
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">幻舞梦境</a></h1>
        </hgroup>

        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">首页</a></li>
                        
                            <li><a href="/WebGuide">导航</a></li>
                        
                            <li><a href="/ovwane_love">Love</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" target="_blank" href="https://github.com/ovwane" title="github">github</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Ansible/" style="font-size: 11.67px;">Ansible</a> <a href="/tags/Bind/" style="font-size: 10px;">Bind</a> <a href="/tags/Cacti/" style="font-size: 10px;">Cacti</a> <a href="/tags/CentOS/" style="font-size: 20px;">CentOS</a> <a href="/tags/Cobbler/" style="font-size: 10px;">Cobbler</a> <a href="/tags/DHCP/" style="font-size: 10px;">DHCP</a> <a href="/tags/Django/" style="font-size: 13.33px;">Django</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Elasticsearch/" style="font-size: 10px;">Elasticsearch</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Gitlab/" style="font-size: 11.67px;">Gitlab</a> <a href="/tags/HAProxy/" style="font-size: 10px;">HAProxy</a> <a href="/tags/Hexo/" style="font-size: 11.67px;">Hexo</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Jenkins/" style="font-size: 11.67px;">Jenkins</a> <a href="/tags/KVM/" style="font-size: 10px;">KVM</a> <a href="/tags/Kubernetes/" style="font-size: 10px;">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/MariaDB/" style="font-size: 10px;">MariaDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 10px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 16.67px;">Nginx</a> <a href="/tags/Oh-My-Zsh/" style="font-size: 10px;">Oh My Zsh</a> <a href="/tags/OpenLDAP/" style="font-size: 10px;">OpenLDAP</a> <a href="/tags/OpenStack/" style="font-size: 10px;">OpenStack</a> <a href="/tags/PHP/" style="font-size: 11.67px;">PHP</a> <a href="/tags/PXE/" style="font-size: 10px;">PXE</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/RHEL7/" style="font-size: 10px;">RHEL7</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Requests/" style="font-size: 10px;">Requests</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Samba/" style="font-size: 10px;">Samba</a> <a href="/tags/Scrapy/" style="font-size: 11.67px;">Scrapy</a> <a href="/tags/Scrapyd/" style="font-size: 10px;">Scrapyd</a> <a href="/tags/SpiderKeeper/" style="font-size: 10px;">SpiderKeeper</a> <a href="/tags/Squid/" style="font-size: 10px;">Squid</a> <a href="/tags/Subversion/" style="font-size: 10px;">Subversion</a> <a href="/tags/Supervisor/" style="font-size: 10px;">Supervisor</a> <a href="/tags/Tomcat/" style="font-size: 13.33px;">Tomcat</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/Xadmin/" style="font-size: 10px;">Xadmin</a> <a href="/tags/Zabbix/" style="font-size: 10px;">Zabbix</a> <a href="/tags/cacti/" style="font-size: 10px;">cacti</a> <a href="/tags/dovecot/" style="font-size: 10px;">dovecot</a> <a href="/tags/httpd/" style="font-size: 11.67px;">httpd</a> <a href="/tags/iSCSI/" style="font-size: 10px;">iSCSI</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/kickstart/" style="font-size: 10px;">kickstart</a> <a href="/tags/macOS/" style="font-size: 15px;">macOS</a> <a href="/tags/nagios/" style="font-size: 10px;">nagios</a> <a href="/tags/postfix/" style="font-size: 10px;">postfix</a> <a href="/tags/rsync/" style="font-size: 10px;">rsync</a> <a href="/tags/sshd/" style="font-size: 10px;">sshd</a> <a href="/tags/uWSGI/" style="font-size: 10px;">uWSGI</a> <a href="/tags/vsftpd/" style="font-size: 10px;">vsftpd</a> <a href="/tags/zabbix/" style="font-size: 10px;">zabbix</a> <a href="/tags/历史/" style="font-size: 18.33px;">历史</a> <a href="/tags/情感/" style="font-size: 10px;">情感</a> <a href="/tags/生活/" style="font-size: 10px;">生活</a> <a href="/tags/监控/" style="font-size: 13.33px;">监控</a> <a href="/tags/自己/" style="font-size: 10px;">自己</a> <a href="/tags/运维/" style="font-size: 10px;">运维</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://luuman.github.io/">name</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">纯海迷、爱运动、爱交友、爱旅行、喜欢接触新鲜事物、迎接新的挑战，更爱游离于错综复杂的编码与逻辑中</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">幻舞梦境</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">幻舞梦境</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">首页</a></li>
                
                    <li><a href="/WebGuide">导航</a></li>
                
                    <li><a href="/ovwane_love">Love</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/ovwane" title="github">github</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-LNAMP配置WordPress" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/17/LNAMP配置WordPress/" class="article-date">
      <time datetime="2015-05-17T15:21:20.000Z" itemprop="datePublished">2015-05-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/17/LNAMP配置WordPress/">LNAMP配置运行WordPress</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>LNAMP配置运行WordPress</p>
<h2 id="nginx-301重定向配置"><a href="#nginx-301重定向配置" class="headerlink" title="nginx 301重定向配置"></a><a href="http://www.ttlsa.com/nginx/nginx-301-redirect/" target="_blank" rel="noopener">nginx 301重定向配置</a></h2><p>301重定向不陌生, 有时候有需求把某目录整个重定向到一个二级域名,或者不带www的顶级域名请求全部重定向到带www的二级域名.如果是Apache，需要配置.htaccess，nginx不支持，需要在配置文件里面使用rewrite指令来实现。</p>
<p>顶级域名重定向到www</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"> server_name ttlsa.com;</span><br><span class="line"> rewrite ^/(.*)$ http://www.ttlsa.com/$1 permanent;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>如上配置，所有ttlsa.com的请求都会重定向到<a href="http://www.ttlsa.com,301重定向对SEO很有帮助.这个配置大家用的最多。" target="_blank" rel="noopener">www.ttlsa.com,301重定向对SEO很有帮助.这个配置大家用的最多。</a></p>
<p>www二级域名重定向到顶级域名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"> server_name www.ttlsa.com;</span><br><span class="line"> rewrite ^/(.*)$ http://domain.com/$1 permanent;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>江湖盛传顶级域名的权重会比www二级域名的权重高，有些seoer会要求运维一定要把www的请求转到顶级域名，和上面的做法相反。</p>
<p>目录重定向</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ( $request_filename ~ nginxjiaocheng/ ) &#123;</span><br><span class="line"> rewrite ^ http://www.ttlsa.com/nginx/? permanent;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>目录跳转新域名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ( $request_filename ~ nginx/ ) &#123;</span><br><span class="line"> rewrite ^ http://nginx.ttlsa.com/? permanent;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/httpd/">httpd</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-去广州" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/04/14/去广州/" class="article-date">
      <time datetime="2015-04-14T09:17:00.000Z" itemprop="datePublished">2015-04-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/14/去广州/">去广州</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <pre><code>上海发向广州的火车。没有买到有座位的票，一路站到广州。
</code></pre>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2014年终总结之败家" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/31/2014年终总结之败家/" class="article-date">
      <time datetime="2014-12-31T08:01:09.000Z" itemprop="datePublished">2014-12-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/31/2014年终总结之败家/">2014年终总结之败家</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2014年终总结之思考" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/31/2014年终总结之思考/" class="article-date">
      <time datetime="2014-12-31T08:00:24.000Z" itemprop="datePublished">2014-12-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/31/2014年终总结之思考/">2014年终总结之思考</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Nginx安装配置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/09/01/Nginx安装配置/" class="article-date">
      <time datetime="2014-09-01T18:10:02.000Z" itemprop="datePublished">2014-09-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/01/Nginx安装配置/">Nginx安装配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://www.ttlsa.com/nginx/nginx-install-on-linux/" target="_blank" rel="noopener">Nginx安装配置</a></p>
<h1 id="nginx介绍"><a href="#nginx介绍" class="headerlink" title="nginx介绍"></a>nginx介绍</h1><p>Nginx是一个自由、开源、高性能及轻量级的HTTP服务器及反转代理服务器，<br>其性能与IMAP/POP3代理服务器相当。Nginx以其高性能、稳定、功能丰富、配置简单及占用系统资源少而著称。<br>Nginx 超越 Apache 的高性能和稳定性，使得国内使用 Nginx 作为 Web 服务器的网站也越来越多.</p>
<h2 id="基础功能"><a href="#基础功能" class="headerlink" title="基础功能"></a>基础功能</h2><p>处理静态文件，索引文件以及自动索引；<br>反向代理加速(无缓存)，简单的负载均衡和容错；<br>FastCGI，简单的负载均衡和容错；<br>模块化的结构。过滤器包括gzipping, byte ranges, chunked responses, 以及 SSI-filter 。在SSI过滤器中，到同一个 proxy 或者 FastCGI 的多个子请求并发处理；<br>SSL 和 TLS SNI 支持；</p>
<h2 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h2><p>Nginx专为性能优化而开发，性能是其最重要的考量, 实现上非常注重效率 。它支持内核Poll模型，能经受高负载的考验, 有报告表明能支持高达 50,000 个并发连接数。<br>Nginx作为负载均衡服务器: Nginx 既可以在内部直接支持 Rails 和 PHP 程序对外进行服务, 也可以支持作为 HTTP代理服务器对外进行服务。<br>Nginx具有很高的稳定性。其它HTTP服务器，当遇到访问的峰值，或者有人恶意发起慢速连接时，也很可能会导致服务器物理内存耗尽频繁交换，失去响应，只能重启服务器。<br>例如当前apache一旦上到200个以上进程，web响应速度就明显非常缓慢了。而Nginx采取了分阶段资源分配技术，使得它的CPU与内存占用率非常低。<br>nginx官方表示保持10,000个没有活动的连接，它只占2.5M内存，就稳定性而言, nginx比lighthttpd更胜一筹。<br>Nginx支持热部署。它的启动特别容易, 并且几乎可以做到7*24不间断运行，即使运行数个月也不需要重新启动。你还能够在不间断服务的情况下，对软件版本进行进行升级。<br>Nginx采用C进行编写, 不论是系统资源开销还是CPU使用效率都比 Perlbal 要好很多。</p>
<h1 id="nginx安装"><a href="#nginx安装" class="headerlink" title="nginx安装"></a>nginx安装</h1><blockquote>
<p>当今nginx的劲头越来越猛，记得2011年版本才1.0.6,现在已经更新到了1.5.1,nginx的更新速度越来越快。</p>
</blockquote>
<h2 id="软件准备"><a href="#软件准备" class="headerlink" title="软件准备"></a>软件准备</h2><h3 id="安装pcre"><a href="#安装pcre" class="headerlink" title="安装pcre"></a>安装pcre</h3><p>为了支持rewrite功能，我们需要安装pcre。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pcre*</span><br></pre></td></tr></table></figure>
<h3 id="安装openssl"><a href="#安装openssl" class="headerlink" title="安装openssl"></a>安装openssl</h3><p>需要ssl的支持，如果不需要ssl支持，请跳过这一步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openssl*</span><br></pre></td></tr></table></figure>
<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.5.1.tar.gz</span><br><span class="line">tar xvf nginx-1.5.1.tar.gz</span><br><span class="line">cd nginx-1.5.1</span><br></pre></td></tr></table></figure>
<p>编译安装nginx</p>
<p>编译参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">--prefix= 指向安装目录</span><br><span class="line">--sbin-path 指向（执行）程序文件（nginx）</span><br><span class="line">--conf-path= 指向配置文件（nginx.conf）</span><br><span class="line">--error-log-path= 指向错误日志目录</span><br><span class="line">--pid-path= 指向pid文件（nginx.pid）</span><br><span class="line">--lock-path= 指向lock文件（nginx.lock）（安装文件锁定，防止安装文件被别人利用，或自己误操作。）</span><br><span class="line">--user= 指定程序运行时的非特权用户</span><br><span class="line">--group= 指定程序运行时的非特权用户组</span><br><span class="line">--builddir= 指向编译目录</span><br><span class="line">--with-rtsig_module 启用rtsig模块支持（实时信号）</span><br><span class="line">--with-select_module 启用select模块支持（一种轮询模式,不推荐在高载环境下使用）禁用：--without-select_module</span><br><span class="line">--with-poll_module 启用poll模块支持（功能与select相同，与select特性相同，为一种轮询模式,不推荐在高载环境下使用）</span><br><span class="line">--with-file-aio 启用file aio支持（一种APL文件传输格式）</span><br><span class="line">--with-ipv6 启用ipv6支持</span><br><span class="line">--with-http_ssl_module 启用ngx_http_ssl_module支持（使支持https请求，需已安装openssl）</span><br><span class="line">--with-http_realip_module 启用ngx_http_realip_module支持（这个模块允许从请求标头更改客户端的IP地址值，默认为关）</span><br><span class="line">--with-http_addition_module 启用ngx_http_addition_module支持（作为一个输出过滤器，支持不完全缓冲，分部分响应请求）</span><br><span class="line">--with-http_xslt_module 启用ngx_http_xslt_module支持（过滤转换XML请求）</span><br><span class="line">--with-http_image_filter_module 启用ngx_http_image_filter_module支持（传输JPEG/GIF/PNG 图片的一个过滤器）（默认为不启用。gd库要用到）</span><br><span class="line">--with-http_geoip_module 启用ngx_http_geoip_module支持（该模块创建基于与MaxMind GeoIP二进制文件相配的客户端IP地址的ngx_http_geoip_module变量）</span><br><span class="line">--with-http_sub_module 启用ngx_http_sub_module支持（允许用一些其他文本替换nginx响应中的一些文本）</span><br><span class="line">--with-http_dav_module 启用ngx_http_dav_module支持（增加PUT,DELETE,MKCOL：创建集合,COPY和MOVE方法）默认情况下为关闭，需编译开启</span><br><span class="line">--with-http_flv_module 启用ngx_http_flv_module支持（提供寻求内存使用基于时间的偏移量文件）</span><br><span class="line">--with-http_gzip_static_module 启用ngx_http_gzip_static_module支持（在线实时压缩输出数据流）</span><br><span class="line">--with-http_random_index_module 启用ngx_http_random_index_module支持（从目录中随机挑选一个目录索引）</span><br><span class="line">--with-http_secure_link_module 启用ngx_http_secure_link_module支持（计算和检查要求所需的安全链接网址）</span><br><span class="line">--with-http_degradation_module  启用ngx_http_degradation_module支持（允许在内存不足的情况下返回204或444码）</span><br><span class="line">--with-http_stub_status_module 启用ngx_http_stub_status_module支持（获取nginx自上次启动以来的工作状态）</span><br><span class="line">--without-http_charset_module 禁用ngx_http_charset_module支持（重新编码web页面，但只能是一个方向--服务器端到客户端，并且只有一个字节的编码可以被重新编码）</span><br><span class="line">--without-http_gzip_module 禁用ngx_http_gzip_module支持（该模块同-with-http_gzip_static_module功能一样）</span><br><span class="line">--without-http_ssi_module 禁用ngx_http_ssi_module支持（该模块提供了一个在输入端处理处理服务器包含文件（SSI）的过滤器，目前支持SSI命令的列表是不完整的）</span><br><span class="line">--without-http_userid_module 禁用ngx_http_userid_module支持（该模块用来处理用来确定客户端后续请求的cookies）</span><br><span class="line">--without-http_access_module 禁用ngx_http_access_module支持（该模块提供了一个简单的基于主机的访问控制。允许/拒绝基于ip地址）</span><br><span class="line">--without-http_auth_basic_module禁用ngx_http_auth_basic_module（该模块是可以使用用户名和密码基于http基本认证方法来保护你的站点或其部分内容）</span><br><span class="line">--without-http_autoindex_module 禁用disable ngx_http_autoindex_module支持（该模块用于自动生成目录列表，只在ngx_http_index_module模块未找到索引文件时发出请求。）</span><br><span class="line">--without-http_geo_module 禁用ngx_http_geo_module支持（创建一些变量，其值依赖于客户端的IP地址）</span><br><span class="line">--without-http_map_module 禁用ngx_http_map_module支持（使用任意的键/值对设置配置变量）</span><br><span class="line">--without-http_split_clients_module 禁用ngx_http_split_clients_module支持（该模块用来基于某些条件划分用户。条件如：ip地址、报头、cookies等等）</span><br><span class="line">--without-http_referer_module 禁用disable ngx_http_referer_module支持（该模块用来过滤请求，拒绝报头中Referer值不正确的请求）</span><br><span class="line">--without-http_rewrite_module 禁用ngx_http_rewrite_module支持（该模块允许使用正则表达式改变URI，并且根据变量来转向以及选择配置。如果在server级别设置该选项，那么他们将在 location之前生效。如果在location还有更进一步的重写规则，location部分的规则依然会被执行。如果这个URI重写是因为location部分的规则造成的，那么 location部分会再次被执行作为新的URI。 这个循环会执行10次，然后Nginx会返回一个500错误。）</span><br><span class="line">--without-http_proxy_module 禁用ngx_http_proxy_module支持（有关代理服务器）</span><br><span class="line">--without-http_fastcgi_module 禁用ngx_http_fastcgi_module支持（该模块允许Nginx 与FastCGI 进程交互，并通过传递参数来控制FastCGI 进程工作。 ）FastCGI一个常驻型的公共网关接口。</span><br><span class="line">--without-http_uwsgi_module 禁用ngx_http_uwsgi_module支持（该模块用来医用uwsgi协议，uWSGI服务器相关）</span><br><span class="line">--without-http_scgi_module 禁用ngx_http_scgi_module支持（该模块用来启用SCGI协议支持，SCGI协议是CGI协议的替代。它是一种应用程序与HTTP服务接口标准。它有些像FastCGI但他的设计 更容易实现。）</span><br><span class="line">--without-http_memcached_module 禁用ngx_http_memcached_module支持（该模块用来提供简单的缓存，以提高系统效率）</span><br><span class="line">-without-http_limit_zone_module 禁用ngx_http_limit_zone_module支持（该模块可以针对条件，进行会话的并发连接数控制）</span><br><span class="line">--without-http_limit_req_module 禁用ngx_http_limit_req_module支持（该模块允许你对于一个地址进行请求数量的限制用一个给定的session或一个特定的事件）</span><br><span class="line">--without-http_empty_gif_module 禁用ngx_http_empty_gif_module支持（该模块在内存中常驻了一个1*1的透明GIF图像，可以被非常快速的调用）</span><br><span class="line">--without-http_browser_module 禁用ngx_http_browser_module支持（该模块用来创建依赖于请求报头的值。如果浏览器为modern ，则$modern_browser等于modern_browser_value指令分配的值；如 果浏览器为old，则$ancient_browser等于 ancient_browser_value指令分配的值；如果浏览器为 MSIE中的任意版本，则 $msie等于1）</span><br><span class="line">--without-http_upstream_ip_hash_module 禁用ngx_http_upstream_ip_hash_module支持（该模块用于简单的负载均衡）</span><br><span class="line">--with-http_perl_module 启用ngx_http_perl_module支持（该模块使nginx可以直接使用perl或通过ssi调用perl）</span><br><span class="line">--with-perl_modules_path= 设定perl模块路径</span><br><span class="line">--with-perl= 设定perl库文件路径</span><br><span class="line">--http-log-path= 设定access log路径</span><br><span class="line">--http-client-body-temp-path= 设定http客户端请求临时文件路径</span><br><span class="line">--http-proxy-temp-path= 设定http代理临时文件路径</span><br><span class="line">--http-fastcgi-temp-path= 设定http fastcgi临时文件路径</span><br><span class="line">--http-uwsgi-temp-path= 设定http uwsgi临时文件路径</span><br><span class="line">--http-scgi-temp-path= 设定http scgi临时文件路径</span><br><span class="line">-without-http 禁用http server功能</span><br><span class="line">--without-http-cache 禁用http cache功能</span><br><span class="line">--with-mail 启用POP3/IMAP4/SMTP代理模块支持</span><br><span class="line">--with-mail_ssl_module 启用ngx_mail_ssl_module支持</span><br><span class="line">--without-mail_pop3_module 禁用pop3协议（POP3即邮局协议的第3个版本,它是规定个人计算机如何连接到互联网上的邮件服务器进行收发邮件的协议。是因特网电子邮件的第一个离线协议标 准,POP3协议允许用户从服务器上把邮件存储到本地主机上,同时根据客户端的操作删除或保存在邮件服务器上的邮件。POP3协议是TCP/IP协议族中的一员，主要用于 支持使用客户端远程管理在服务器上的电子邮件）</span><br><span class="line">--without-mail_imap_module 禁用imap协议（一种邮件获取协议。它的主要作用是邮件客户端可以通过这种协议从邮件服务器上获取邮件的信息，下载邮件等。IMAP协议运行在TCP/IP协议之上， 使用的端口是143。它与POP3协议的主要区别是用户可以不用把所有的邮件全部下载，可以通过客户端直接对服务器上的邮件进行操作。）</span><br><span class="line">--without-mail_smtp_module 禁用smtp协议（SMTP即简单邮件传输协议,它是一组用于由源地址到目的地址传送邮件的规则，由它来控制信件的中转方式。SMTP协议属于TCP/IP协议族，它帮助每台计算机在发送或中转信件时找到下一个目的地。）</span><br><span class="line">--with-google_perftools_module 启用ngx_google_perftools_module支持（调试用，剖析程序性能瓶颈）</span><br><span class="line">--with-cpp_test_module 启用ngx_cpp_test_module支持</span><br><span class="line">--add-module= 启用外部模块支持</span><br><span class="line">--with-cc= 指向C编译器路径</span><br><span class="line">--with-cpp= 指向C预处理路径</span><br><span class="line">--with-cc-opt= 设置C编译器参数（PCRE库，需要指定–with-cc-opt=”-I /usr/local/include”，如果使用select()函数则需要同时增加文件描述符数量，可以通过–with-cc- opt=”-D FD_SETSIZE=2048”指定。）</span><br><span class="line">--with-ld-opt= 设置连接文件参数。（PCRE库，需要指定–with-ld-opt=”-L /usr/local/lib”。）</span><br><span class="line">--with-cpu-opt= 指定编译的CPU，可用的值为: pentium, pentiumpro, pentium3, pentium4, athlon, opteron, amd64, sparc32, sparc64, ppc64</span><br><span class="line">--without-pcre 禁用pcre库</span><br><span class="line">--with-pcre 启用pcre库</span><br><span class="line">--with-pcre= 指向pcre库文件目录</span><br><span class="line">--with-pcre-opt= 在编译时为pcre库设置附加参数</span><br><span class="line">--with-md5= 指向md5库文件目录（消息摘要算法第五版，用以提供消息的完整性保护）</span><br><span class="line">--with-md5-opt= 在编译时为md5库设置附加参数</span><br><span class="line">--with-md5-asm 使用md5汇编源</span><br><span class="line">--with-sha1= 指向sha1库目录（数字签名算法，主要用于数字签名）</span><br><span class="line">--with-sha1-opt= 在编译时为sha1库设置附加参数</span><br><span class="line">--with-sha1-asm 使用sha1汇编源</span><br><span class="line">--with-zlib= 指向zlib库目录</span><br><span class="line">--with-zlib-opt= 在编译时为zlib设置附加参数</span><br><span class="line">--with-zlib-asm= 为指定的CPU使用zlib汇编源进行优化，CPU类型为pentium, pentiumpro</span><br><span class="line">--with-libatomic 为原子内存的更新操作的实现提供一个架构</span><br><span class="line">--with-libatomic= 指向libatomic_ops安装目录</span><br><span class="line">--with-openssl= 指向openssl安装目录</span><br><span class="line">--with-openssl-opt 在编译时为openssl设置附加参数</span><br><span class="line">--with-debug 启用debug日志</span><br></pre></td></tr></table></figure>
<p>安装make工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install make -y</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-pcre</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="启动nginx"><a href="#启动nginx" class="headerlink" title="启动nginx"></a>启动nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#启动</span><br><span class="line">/usr/local/nginx/sbin/nginx start</span><br><span class="line">#关闭</span><br><span class="line">/usr/local/nginx/sbin/nginx stop</span><br><span class="line">#重新加载配置文件</span><br><span class="line">/usr/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="nginx安全配置"><a href="#nginx安全配置" class="headerlink" title="nginx安全配置"></a>nginx安全配置</h2><h3 id="隐藏Nginx版本号"><a href="#隐藏Nginx版本号" class="headerlink" title="隐藏Nginx版本号"></a>隐藏Nginx版本号</h3><p>server_tokens off;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">keepalive_timeout 60;</span><br><span class="line">tcp_nodelay on;</span><br><span class="line">server_tokens off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果使用了php-fpm,需要修改fastcfi.conf或fcgi.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_param SERVER_SOFTWARE nginx/$nginx_version;</span><br><span class="line">改为：</span><br><span class="line">fastcgi_param SERVER_SOFTWARE nginx;</span><br></pre></td></tr></table></figure>
<p>### </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">在配置文件中小心使用&quot;if&quot;</span><br><span class="line">它是重写模块的一部分，不应该在任何地方使用。</span><br><span class="line">“if”声明是重写模块评估指令强制性的部分。换个说法，Nginx的配置一般来说是声明式的。在有些情况下，由于用户的需求，他们试图在一些非重写指令内使用“if”，这导致我们现在遇到的情况。大多数情况下都能正常工作，但…看上面提到的。</span><br><span class="line">看起来唯一正确的解决方案是在非重写的指令内完全禁用“if”。这将更改现有的许多配置，所以还没有完成。IfIsEvil：http://wiki.nginx.org/IfIsEvil</span><br><span class="line"></span><br><span class="line">将每个~ .php$请求转递给PHP</span><br><span class="line">我们上周发布了这个流行指令的潜在安全漏洞介绍。即使文件名为hello.php.jpeg它也会匹配~ .php$这个正则而执行文件。</span><br><span class="line">现在有两个解决上述问题的好方法。我觉得确保你不轻易执行任意代码的混合方法很有必要。</span><br><span class="line"></span><br><span class="line">1 如果没找到文件时使用try_files和only(在所有的动态执行情况下都应该注意) 将它转递给运行PHP的FCGI进程。</span><br><span class="line">2 确认php.ini文件中cgi.fix_pathinfo设置为0 (cgi.fix_pathinfo=0) 。这样确保PHP检查文件全名(当它在文件结尾没有发现.php它将忽略)</span><br><span class="line">3 修复正则表达式匹配不正确文件的问题。现在正则表达式认为任何文件都包含&quot;.php&quot;。在站点后加“if”确保只有正确的文件才能运行。将/location ~ .php$和location ~ ..*/.*.php$都设置为return 403;</span><br><span class="line"></span><br><span class="line">禁用autoindex模块</span><br><span class="line">这个可能在你使用的Nginx版本中已经更改了，如果没有的话只需在配置文件的location块中增加autoindex off;声明即可。</span><br><span class="line"></span><br><span class="line">禁用服务器上的ssi (服务器端引用)</span><br><span class="line">这个可以通过在location块中添加ssi off; 。</span><br><span class="line"></span><br><span class="line">在配置文件中设置自定义缓存以限制缓冲区溢出攻击的可能性</span><br><span class="line"></span><br><span class="line">client_body_buffer_size 1K;</span><br><span class="line">client_header_buffer_size 1k;</span><br><span class="line">client_max_body_size 1k;</span><br><span class="line">large_client_header_buffers 2 1k;</span><br><span class="line"></span><br><span class="line">将timeout设低来防止DOS攻击</span><br><span class="line">所有这些声明都可以放到主配置文件中。</span><br><span class="line"></span><br><span class="line">client_body_timeout 10;</span><br><span class="line">client_header_timeout 10;</span><br><span class="line">keepalive_timeout 5 5;</span><br><span class="line">send_timeout 10;</span><br><span class="line"></span><br><span class="line">限制用户连接数来预防DOS攻击</span><br><span class="line"></span><br><span class="line">limit_zone slimits $binary_remote_addr 5m;</span><br><span class="line">limit_conn slimits 5;</span><br><span class="line"></span><br><span class="line">试着避免使用HTTP认证</span><br><span class="line">HTTP认证默认使用crypt，它的哈希并不安全。如果你要用的话就用MD5（这也不是个好选择但负载方面比crypt好） 。</span><br><span class="line"></span><br><span class="line">保持与最新的Nginx安全更新</span><br></pre></td></tr></table></figure>
<h2 id="nginx日志配置"><a href="#nginx日志配置" class="headerlink" title="nginx日志配置"></a>nginx日志配置</h2><p>日志对于统计排错来说非常有利的。</p>
<p>nginx日志相关的配置如access_log、log_format、open_log_file_cache、log_not_found、log_subrequest、rewrite_log、error_log。</p>
<p>nginx有一个非常灵活的日志记录模式。每个级别的配置可以有各自独立的访问日志。日志格式通过log_format命令来定义。ngx_http_log_module是用来定义请求日志格式的。</p>
<h3 id="access-log指令"><a href="#access-log指令" class="headerlink" title="access_log指令"></a>access_log指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">语法: access_log path [format [buffer=size [flush=time]]];</span><br><span class="line">access_log path format gzip[=level] [buffer=size] [flush=time];</span><br><span class="line">access_log syslog:server=address[,parameter=value] [format];</span><br><span class="line">access_log off;</span><br><span class="line">默认值: access_log logs/access.log combined;</span><br><span class="line">配置段: http, server, location, if in location, limit_except</span><br><span class="line">gzip压缩等级。</span><br><span class="line">buffer设置内存缓存区大小。</span><br><span class="line">flush保存在缓存区中的最长时间。</span><br><span class="line">不记录日志：access_log off;</span><br><span class="line">使用默认combined格式记录日志：access_log logs/access.log 或 access_log logs/access.log combined;</span><br></pre></td></tr></table></figure>
<h3 id="log-format指令"><a href="#log-format指令" class="headerlink" title="log_format指令"></a>log_format指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">语法: log_format name string …;</span><br><span class="line">默认值: log_format combined “…”;</span><br><span class="line">配置段: http</span><br></pre></td></tr></table></figure>
<p>name表示格式名称，string表示等义的格式。log_format有一个默认的无需设置的combined日志格式，相当于apache的combined日志格式，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log_format  combined  &apos;$remote_addr - $remote_user  [$time_local]  &apos;</span><br><span class="line">                                   &apos; &quot;$request&quot;  $status  $body_bytes_sent  &apos;</span><br><span class="line">                                   &apos; &quot;$http_referer&quot;  &quot;$http_user_agent&quot; &apos;;</span><br><span class="line">log_format  combined  &apos;$remote_addr - $remote_user  [$time_local]  &apos;</span><br><span class="line">                                   &apos; &quot;$request&quot;  $status  $body_bytes_sent  &apos;</span><br><span class="line">                                   &apos; &quot;$http_referer&quot;  &quot;$http_user_agent&quot; &apos;;</span><br></pre></td></tr></table></figure>
<p>如果nginx位于负载均衡器，squid，nginx反向代理之后，web服务器无法直接获取到客户端真实的IP地址了。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$remote_addr获取反向代理的IP地址。反向代理服务器在转发请求的http头信息中，可以增加X-Forwarded-For信息，用来记录 客户端IP地址和客户端请求的服务器地址。</span><br><span class="line"></span><br><span class="line">log_format  porxy  &apos;$http_x_forwarded_for - $remote_user  [$time_local]  &apos;</span><br><span class="line">                             &apos; &quot;$request&quot;  $status $body_bytes_sent &apos;</span><br><span class="line">                             &apos; &quot;$http_referer&quot;  &quot;$http_user_agent&quot; &apos;;</span><br><span class="line">log_format  porxy  &apos;$http_x_forwarded_for - $remote_user  [$time_local]  &apos;</span><br><span class="line">                             &apos; &quot;$request&quot;  $status $body_bytes_sent &apos;</span><br><span class="line">                             &apos; &quot;$http_referer&quot;  &quot;$http_user_agent&quot; &apos;;</span><br></pre></td></tr></table></figure>
<p>日志格式允许包含的变量注释如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$remote_addr, $http_x_forwarded_for 记录客户端IP地址</span><br><span class="line">$remote_user 记录客户端用户名称</span><br><span class="line">$request 记录请求的URL和HTTP协议</span><br><span class="line">$status 记录请求状态</span><br><span class="line">$body_bytes_sent 发送给客户端的字节数，不包括响应头的大小； 该变量与Apache模块mod_log_config里的“%B”参数兼容。</span><br><span class="line">$bytes_sent 发送给客户端的总字节数。</span><br><span class="line">$connection 连接的序列号。</span><br><span class="line">$connection_requests 当前通过一个连接获得的请求数量。</span><br><span class="line">$msec 日志写入时间。单位为秒，精度是毫秒。</span><br><span class="line">$pipe 如果请求是通过HTTP流水线(pipelined)发送，pipe值为“p”，否则为“.”。</span><br><span class="line">$http_referer 记录从哪个页面链接访问过来的</span><br><span class="line">$http_user_agent 记录客户端浏览器相关信息</span><br><span class="line">$request_length 请求的长度（包括请求行，请求头和请求正文）。</span><br><span class="line">$request_time 请求处理时间，单位为秒，精度毫秒； 从读入客户端的第一个字节开始，直到把最后一个字符发送给客户端后进行日志写入为止。</span><br><span class="line">$time_iso8601 ISO8601标准格式下的本地时间。</span><br><span class="line">$time_local 通用日志格式下的本地时间。</span><br><span class="line"></span><br><span class="line">$remote_addr, $http_x_forwarded_for 记录客户端IP地址</span><br><span class="line">$remote_user 记录客户端用户名称</span><br><span class="line">$request 记录请求的URL和HTTP协议</span><br><span class="line">$status 记录请求状态</span><br><span class="line">$body_bytes_sent 发送给客户端的字节数，不包括响应头的大小； 该变量与Apache模块mod_log_config里的“%B”参数兼容。</span><br><span class="line">$bytes_sent 发送给客户端的总字节数。</span><br><span class="line">$connection 连接的序列号。</span><br><span class="line">$connection_requests 当前通过一个连接获得的请求数量。</span><br><span class="line">$msec 日志写入时间。单位为秒，精度是毫秒。</span><br><span class="line">$pipe 如果请求是通过HTTP流水线(pipelined)发送，pipe值为“p”，否则为“.”。</span><br><span class="line">$http_referer 记录从哪个页面链接访问过来的</span><br><span class="line">$http_user_agent 记录客户端浏览器相关信息</span><br><span class="line">$request_length 请求的长度（包括请求行，请求头和请求正文）。</span><br><span class="line">$request_time 请求处理时间，单位为秒，精度毫秒； 从读入客户端的第一个字节开始，直到把最后一个字符发送给客户端后进行日志写入为止。</span><br><span class="line">$time_iso8601 ISO8601标准格式下的本地时间。</span><br><span class="line">$time_local 通用日志格式下的本地时间。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>发送给客户端的响应头拥有“sent_http_”前缀。 比如$sent_http_content_range。</p>
</blockquote>
<p>实例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">	log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                                        &apos;&quot;$status&quot; $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                                        &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &apos;</span><br><span class="line">                                        &apos;&quot;$gzip_ratio&quot; $request_time $bytes_sent $request_length&apos;;</span><br><span class="line"></span><br><span class="line">	log_format srcache_log &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                                &apos;&quot;$status&quot; $body_bytes_sent $request_time $bytes_sent $request_length &apos;</span><br><span class="line">                                &apos;[$upstream_response_time] [$srcache_fetch_status] [$srcache_store_status] [$srcache_expire]&apos;;</span><br><span class="line"></span><br><span class="line">	open_log_file_cache max=1000 inactive=60s;</span><br><span class="line"></span><br><span class="line">	server &#123;</span><br><span class="line">		server_name ~^(www\.)?(.+)$;</span><br><span class="line">		access_log logs/$2-access.log main;</span><br><span class="line">		error_log logs/$2-error.log;</span><br><span class="line"></span><br><span class="line">		location /srcache &#123;</span><br><span class="line">			access_log logs/access-srcache.log srcache_log;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="open-log-file-cache指令"><a href="#open-log-file-cache指令" class="headerlink" title="open_log_file_cache指令"></a>open_log_file_cache指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法: open_log_file_cache max=N [inactive=time] [min_uses=N] [valid=time];</span><br><span class="line">open_log_file_cache off;</span><br><span class="line">默认值: open_log_file_cache off;</span><br><span class="line">配置段: http, server, location</span><br></pre></td></tr></table></figure>
<p>对于每一条日志记录，都将是先打开文件，再写入日志，然后关闭。可以使用open_log_file_cache来设置日志文件缓存(默认是off)，格式如下：<br>参数注释如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">max:设置缓存中的最大文件描述符数量，如果缓存被占满，采用LRU算法将描述符关闭。</span><br><span class="line">inactive:设置存活时间，默认是10s</span><br><span class="line">min_uses:设置在inactive时间段内，日志文件最少使用多少次后，该日志文件描述符记入缓存中，默认是1次</span><br><span class="line">valid:设置检查频率，默认60s</span><br><span class="line">off：禁用缓存</span><br></pre></td></tr></table></figure>
<p>实例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">open_log_file_cache max=1000 inactive=20s valid=1m min_uses=2;</span><br><span class="line">open_log_file_cache max=1000 inactive=20s valid=1m min_uses=2;</span><br></pre></td></tr></table></figure>
<h3 id="log-not-found指令"><a href="#log-not-found指令" class="headerlink" title="log_not_found指令"></a>log_not_found指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法: log_not_found on | off;</span><br><span class="line">默认值: log_not_found on;</span><br><span class="line">配置段: http, server, location</span><br><span class="line">是否在error_log中记录不存在的错误。默认是。</span><br></pre></td></tr></table></figure>
<h3 id="log-subrequest指令"><a href="#log-subrequest指令" class="headerlink" title="log_subrequest指令"></a>log_subrequest指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法: log_subrequest on | off;</span><br><span class="line">默认值: log_subrequest off;</span><br><span class="line">配置段: http, server, location</span><br><span class="line">是否在access_log中记录子请求的访问日志。默认不记录。</span><br></pre></td></tr></table></figure>
<h3 id="rewrite-log指令"><a href="#rewrite-log指令" class="headerlink" title="rewrite_log指令"></a>rewrite_log指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">由ngx_http_rewrite_module模块提供的。用来记录重写日志的。对于调试重写规则建议开启。 Nginx重写规则指南</span><br><span class="line">语法: rewrite_log on | off;</span><br><span class="line">默认值: rewrite_log off;</span><br><span class="line">配置段: http, server, location, if</span><br><span class="line">启用时将在error log中记录notice级别的重写日志。</span><br></pre></td></tr></table></figure>
<h3 id="error-log指令"><a href="#error-log指令" class="headerlink" title="error_log指令"></a>error_log指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法: error_log file | stderr | syslog:server=address[,parameter=value] [debug | info | notice | warn | error | crit | alert | emerg];</span><br><span class="line">默认值: error_log logs/error.log error;</span><br><span class="line">配置段: main, http, server, location</span><br><span class="line">配置错误日志。</span><br></pre></td></tr></table></figure>
<h3 id="nginx日志切割"><a href="#nginx日志切割" class="headerlink" title="nginx日志切割"></a>nginx日志切割</h3><p>nginx日志默认情况下统统写入到一个文件中，文件会变的越来越大，非常不方便查看分析。以日期来作为日志的切割是比较好的，通常我们是以每日来做统计的。下面来说说nginx日志切割。</p>
<h4 id="定义日志轮滚策略"><a href="#定义日志轮滚策略" class="headerlink" title="定义日志轮滚策略"></a>定义日志轮滚策略</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-log-rotate</span><br><span class="line"></span><br><span class="line">/data/logs/nginx/*.log &#123;</span><br><span class="line">    nocompress</span><br><span class="line">    daily</span><br><span class="line">    copytruncate</span><br><span class="line">    create</span><br><span class="line">    notifempty</span><br><span class="line">    rotate 7</span><br><span class="line">    olddir /data/logs/nginx/old_log</span><br><span class="line">    missingok</span><br><span class="line">    dateext</span><br><span class="line">    postrotate</span><br><span class="line">        /bin/kill -HUP `cat /var/run/nginx.pid 2&gt; /dev/null` 2&gt; /dev/null || true</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>/data/logs/nginx/*.log使用通配符时，/data/logs/nginx/目录下的所有匹配到的日志文件都将切割。如果要切割特定日志文件，就指定到该文件。</p>
<h4 id="设置计划任务"><a href="#设置计划任务" class="headerlink" title="设置计划任务"></a>设置计划任务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/crontab</span><br><span class="line">59 23 * * * root ( /usr/sbin/logrotate -f /PATH/TO/nginx-log-rotate)</span><br><span class="line">1</span><br><span class="line">59 23 * * * root ( /usr/sbin/logrotate -f /PATH/TO/nginx-log-rotate)</span><br><span class="line">这样每天23点59分钟执行日志切割。</span><br></pre></td></tr></table></figure>
<h2 id="配置虚拟主机"><a href="#配置虚拟主机" class="headerlink" title="配置虚拟主机"></a>配置虚拟主机</h2><h3 id="新建目录"><a href="#新建目录" class="headerlink" title="新建目录"></a>新建目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#站点目录</span><br><span class="line">mkdir /data/wwwroot -p</span><br><span class="line">cd /data/wwwroot/</span><br><span class="line">mkdir a.ttlsa.com</span><br><span class="line">mkdir b.ttlsa.com</span><br><span class="line">#日志文件目录</span><br><span class="line">mkdir /data/logs/nginx -p</span><br></pre></td></tr></table></figure>
<h4 id="配置nginx主配置文件"><a href="#配置nginx主配置文件" class="headerlink" title="配置nginx主配置文件"></a>配置nginx主配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">server&#123;</span><br><span class="line">server_name a.ttlsa.com;</span><br><span class="line">listen 80;</span><br><span class="line">root /data/wwwroot/a.ttlsa.com;</span><br><span class="line"> </span><br><span class="line">access_log /data/logs/nginx/a.ttlsa.com-access.log main;</span><br><span class="line">location /</span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">server&#123;</span><br><span class="line">server_name b.ttlsa.com;</span><br><span class="line">listen 80;</span><br><span class="line">root /data/wwwroot/b.ttlsa.com;</span><br><span class="line"> </span><br><span class="line">access_log /data/logs/nginx/b.ttlsa.com-access.log main;</span><br><span class="line">location /</span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置讲解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server&#123;&#125;：配置虚拟主机必须有这个段。</span><br><span class="line">server_name：虚拟主机的域名，可以写多个域名，类似于别名，比如说你可以配置成</span><br><span class="line">server_name b.ttlsa.com c.ttlsa.com d.ttlsa.com，这样的话，访问任何一个域名，内容都是一样的</span><br><span class="line">listen 80，监听ip和端口，这边仅仅只有端口，表示当前服务器所有ip的80端口，如果只想监听127.0.0.1的80，写法如下：</span><br><span class="line">listen 127.0.0.1:80</span><br><span class="line">root /data/site/b.ttlsa.com：站点根目录，你网站文件存放的地方。注：站点目录和域名尽量一样，养成一个好习惯</span><br><span class="line">access_log /data/logs/nginx/b.ttlsa.com-access.log main：访问日志</span><br><span class="line">location /&#123;&#125; 默认uri,location具体内容后续讲解,大家关注一下.</span><br></pre></td></tr></table></figure>
<p>检查nginx配置文件并启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -t</span><br><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
<h2 id="nginx正向代理"><a href="#nginx正向代理" class="headerlink" title="nginx正向代理"></a>nginx正向代理</h2><p>我们平时用的最多的最常见的是反向代理。反向代理想必都会配置的， 那么nginx的正向代理是如何配置的呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 8090;</span><br><span class="line">	location / &#123;</span><br><span class="line">			resolver 218.85.157.99 218.85.152.99;</span><br><span class="line">			resolver_timeout 30s;</span><br><span class="line">			proxy_pass http://$host$request_uri;</span><br><span class="line">	&#125;</span><br><span class="line">	access_log  /data/httplogs/proxy-$host-aceess.log;      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就这么简单哈。<br>测试：<br><a href="http://www.ttlsa.com:8090" target="_blank" rel="noopener">http://www.ttlsa.com:8090</a></p>
<p>resolver指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">语法: resolver address ... [valid=time];</span><br><span class="line">默认值: —</span><br><span class="line">配置段: http, server, location</span><br><span class="line">配置DNS服务器IP地址。可以指定多个，以轮询方式请求。</span><br><span class="line">nginx会缓存解析的结果。默认情况下，缓存时间是名字解析响应中的TTL字段的值，可以通过valid参数更改。</span><br></pre></td></tr></table></figure>
<p>resolver_timeout指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法: resolver_timeout time;</span><br><span class="line">默认值: resolver_timeout 30s;</span><br><span class="line">配置段: http, server, location</span><br><span class="line">解析超时时间。</span><br></pre></td></tr></table></figure>
<h2 id="nginx反向代理"><a href="#nginx反向代理" class="headerlink" title="nginx反向代理"></a>nginx反向代理</h2><p>由于公司内网有多台服务器的http服务要映射到公司外网静态IP，如果用路由的端口映射来做，就只能一台内网服务器的80端口映射到外网80端口，其他服务器的80端口只能映射到外网的非80端口。非80端口的映射在访问的时候要域名加上端口，比较麻烦。并且公司入口路由最多只能做20个端口映射。肯定以后不够用。<br>然后k兄就提议可以在内网搭建个nginx反向代理服务器，将nginx反向代理服务器的80映射到外网IP的80，这样指向到公司外网IP的域名的HTTP请求就会发送到nginx反向代理服务器，利用nginx反向代理将不同域名的请求转发给内网不同机器的端口，就起到了“根据域名自动转发到相应服务器的特定端口”的效果，而路由器的端口映射做到的只是“根据不同端口自动转发到相应服务器的特定端口”，真是喜大普奔啊。<br>涉及的知识：nginx编译安装，nginx反向代理基本配置，路由端口映射知识，还有网络域名等常识。<br>本次实验目标是做到：在浏览器中输入xxx123.tk能访问到内网机器192.168.10.38的3000端口，输入xxx456.tk能访问到内网机器192.168.10.40的80端口。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>vim nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">user www www;</span><br><span class="line">worker_processes 1;</span><br><span class="line">error_log logs/error.log;</span><br><span class="line">pid logs/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    worker_connections 65535;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line">    include /usr/local/nginx/conf/reverse-proxy.conf;</span><br><span class="line">    sendfile on;</span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line">    gzip on;</span><br><span class="line">    client_max_body_size 50m; #缓冲区代理缓冲用户端请求的最大字节数,可以理解为保存到本地再传给用户</span><br><span class="line">    client_body_buffer_size 256k;</span><br><span class="line">    client_header_timeout 3m;</span><br><span class="line">    client_body_timeout 3m;</span><br><span class="line">    send_timeout 3m;</span><br><span class="line">    proxy_connect_timeout 300s; #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line">    proxy_read_timeout 300s; #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line">    proxy_send_timeout 300s;</span><br><span class="line">    proxy_buffer_size 64k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line">    proxy_buffers 4 32k; #proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line">    proxy_busy_buffers_size 64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line">    proxy_temp_file_write_size 64k; #设定缓存文件夹大小，大于这个值，将从upstream服务器传递请求，而不缓冲到磁盘</span><br><span class="line">    proxy_ignore_client_abort on; #不允许代理端主动关闭连接</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root html;</span><br><span class="line">            index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编辑反向代理服务器配置文件：<br>vim /usr/local/nginx/conf/reverse-proxy.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name xxx123.tk;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass http://192.168.10.38:3000;</span><br><span class="line">    &#125;</span><br><span class="line">    access_log logs/xxx123.tk_access.log;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name xxx456.tk;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass http://192.168.10.40:80;</span><br><span class="line">    &#125;</span><br><span class="line">    access_log logs/xxx456.tk_access.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果想对后端机器做负载均衡，像下面这配置就可以把对nagios.xxx123.tk的请求分发给内网的131和132这两台机器做负载均衡了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">upstream monitor_server &#123;</span><br><span class="line">    server 192.168.0.131:80;</span><br><span class="line">    server 192.168.0.132:80;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name nagios.xxx123.tk;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; </span><br><span class="line">        proxy_pass http://monitor_server;</span><br><span class="line">    &#125;</span><br><span class="line">    access_log logs/nagios.xxx123.tk_access.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>额，关于负载均衡和缓存就不多说了，这里只是要起到一个简单的“域名转发”功能。<br>另外，由于http请求最后都是由反向代理服务器传递给后段的机器，所以后端的机器原来的访问日志记录的访问IP都是反向代理服务器的IP。<br>要想能记录真实IP，需要修改后端机器的日志格式，这里假设后端也是一台nginx：<br>在后端配置文件里面加入这一段即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log_format access &apos;$HTTP_X_REAL_IP - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">&apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">&apos;&quot;$http_user_agent&quot; $HTTP_X_Forwarded_For&apos;;</span><br><span class="line"> </span><br><span class="line">access_log logs/access.log access;</span><br></pre></td></tr></table></figure>
<p>再看看原来日志的格式长什么样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#log_format main &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line"># &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line"># &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"> </span><br><span class="line">#access_log logs/access.log main;</span><br></pre></td></tr></table></figure>
<p>之前没配置下面这段，访问时候偶尔会出现504 gateway timeout，由于偶尔出现，所以不太好排查。</p>
<p>从日志看来是连接超时了，网上一通乱查之后估计可能是后端服务器响应超时了，本着大胆假设，小心求证的原则，既然假设了错误原因就要做实验重现错误：那就调整代理超时参数，反过来把代理超时阀值设小（比如1ms）看会不会次次出现504。后来发现把proxy_read_timeout 这个参数设置成1ms的时候，每次访问都出现504。于是把这个参数调大，加入下面那段配置，解决问题了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">proxy_connect_timeout 300s;</span><br><span class="line">proxy_read_timeout 300s;</span><br><span class="line">proxy_send_timeout 300s;</span><br><span class="line">proxy_buffer_size 64k;</span><br><span class="line">proxy_buffers 4 32k;</span><br><span class="line">proxy_busy_buffers_size 64k;</span><br><span class="line">proxy_temp_file_write_size 64k;</span><br><span class="line">proxy_ignore_client_abort on;</span><br></pre></td></tr></table></figure>
<h2 id="nginx-tcp代理"><a href="#nginx-tcp代理" class="headerlink" title="nginx tcp代理"></a>nginx tcp代理</h2><p><a href="http://yaoweibin.github.io/nginx_tcp_proxy_module/README.html" target="_blank" rel="noopener">nginx_tcp_proxy_module模块</a><br>nginx tcp代理功能由nginx_tcp_proxy_module模块提供，同时监测后端主机状态。该模块包括的模块有： ngx_tcp_module, ngx_tcp_core_module, ngx_tcp_upstream_module, ngx_tcp_proxy_module, ngx_tcp_upstream_ip_hash_module。</p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.4.4.tar.gz</span><br><span class="line">tar zxvf nginx-1.4.4.tar.gz</span><br><span class="line">cd nginx-1.4.4</span><br><span class="line">./configure --add-module=/path/to/nginx_tcp_proxy_module</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location /status &#123;</span><br><span class="line">        check_status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">tcp &#123;</span><br><span class="line">    upstream cluster_www_ttlsa_com &#123;</span><br><span class="line">        # simple round-robin</span><br><span class="line">        server 127.0.0.1:1234;</span><br><span class="line">        check interval=3000 rise=2 fall=5 timeout=1000;</span><br><span class="line">        #check interval=3000 rise=2 fall=5 timeout=1000 type=ssl_hello;</span><br><span class="line">        #check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span><br><span class="line">        #check_http_send &quot;GET / HTTP/1.0\r\n\r\n&quot;;</span><br><span class="line">        #check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8888;</span><br><span class="line">        proxy_pass cluster_www_ttlsa_com;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这会出现一个问题，就是tcp连接会掉线。原因在于当服务端关闭连接的时候，客户端不可能立刻发觉连接已经被关闭，需要等到当Nginx在执行check规则时认为服务端链接关闭，此时nginx会关闭与客户端的连接。</p>
<h3 id="保持连接配置"><a href="#保持连接配置" class="headerlink" title="保持连接配置"></a>保持连接配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location /status &#123;</span><br><span class="line">        check_status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">tcp &#123;</span><br><span class="line"> timeout 1d;</span><br><span class="line">    proxy_read_timeout 10d;</span><br><span class="line">    proxy_send_timeout 10d;</span><br><span class="line">    proxy_connect_timeout 30;</span><br><span class="line">    upstream cluster_www_ttlsa_com &#123;</span><br><span class="line">        # simple round-robin</span><br><span class="line">        server 127.0.0.1:1234;</span><br><span class="line">        check interval=3000 rise=2 fall=5 timeout=1000;</span><br><span class="line">        #check interval=3000 rise=2 fall=5 timeout=1000 type=ssl_hello;</span><br><span class="line">        #check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span><br><span class="line">        #check_http_send &quot;GET / HTTP/1.0\r\n\r\n&quot;;</span><br><span class="line">        #check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8888;</span><br><span class="line">        proxy_pass cluster_www_ttlsa_com;</span><br><span class="line"> so_keepalive on;</span><br><span class="line">        tcp_nodelay on;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="高可用nginx群集和高速缓存"><a href="#高可用nginx群集和高速缓存" class="headerlink" title="高可用nginx群集和高速缓存"></a>高可用nginx群集和高速缓存</h2><p>nginx+keepalived+proxy_cache 配置高可用nginx群集和高速缓存</p>
<h3 id="安装nginx-主从服务器"><a href="#安装nginx-主从服务器" class="headerlink" title="安装nginx 主从服务器"></a>安装nginx 主从服务器</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.0.11.tar.gz</span><br><span class="line">wget http://labs.frickle.com/files/ngx_cache_purge-1.4.tar.gz</span><br></pre></td></tr></table></figure>
<h4 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum -y install zlib-devel pcre-devel openssl-devel  # 安装依赖</span><br><span class="line">tar –xvf ngx_cache_purge-1.4.tar.gz</span><br><span class="line">tar –xvf nginx-1.0.11.tar.gz</span><br><span class="line">cd nginx-1.0.11/</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/nginx --add-module=../ngx_cache_purge-1.4 --with-http_stub_status_module --with-http_ssl_module --with-http_flv_module --with-http_gzip_static_module</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h4 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/local/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">user nobody;</span><br><span class="line">worker_processes 8;</span><br><span class="line">events &#123;</span><br><span class="line">worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">include mime.types;</span><br><span class="line">default_type application/octet-stream;</span><br><span class="line">charset utf-8;</span><br><span class="line">server_names_hash_bucket_size 128;</span><br><span class="line">client_header_buffer_size 32k;</span><br><span class="line">large_client_header_buffers 4 32k;</span><br><span class="line">client_max_body_size 300m;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">tcp_nodelay on;</span><br><span class="line">client_body_buffer_size 512k;</span><br><span class="line">proxy_connect_timeout 5;</span><br><span class="line">proxy_read_timeout 60;</span><br><span class="line">proxy_send_timeout 5;</span><br><span class="line">proxy_buffer_size 16k;</span><br><span class="line">proxy_buffers 4 64k;</span><br><span class="line">proxy_busy_buffers_size 128k;</span><br><span class="line">proxy_temp_file_write_size 128k;</span><br><span class="line">sendfile on;</span><br><span class="line">gzip on;</span><br><span class="line">gzip_min_length 1k;</span><br><span class="line">gzip_buffers 4 16k;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_comp_level 2;</span><br><span class="line">gzip_types text/plain application/x-javascript text/css application/xml;</span><br><span class="line">gzip_vary on;</span><br><span class="line">proxy_temp_path /data/proxy_temp_dir;</span><br><span class="line">proxy_cache_path /data/proxy_cache_dir levels=1:2 keys_zone=cache_one:50m inactive=1m max_size=2g;</span><br><span class="line">upstream real_server_pool&#123;</span><br><span class="line">server 192.168.200.148:80 weight=1 max_fails=2 fail_timeout=30s;</span><br><span class="line">server 192.168.10.251:80 weight=1 max_fails=2 fail_timeout=30s;</span><br><span class="line">&#125;</span><br><span class="line">keepalive_timeout 65;</span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name localhost;</span><br><span class="line">location / &#123;</span><br><span class="line">root html;</span><br><span class="line">index index.html index.htm;</span><br><span class="line">proxy_next_upstream http_502 http_504 error timeout invalid_header;</span><br><span class="line">proxy_cache cache_one;</span><br><span class="line">proxy_cache_valid 200 304 12h;</span><br><span class="line">proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">proxy_set_header Host $host;</span><br><span class="line">proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">proxy_pass http://real_server_pool;</span><br><span class="line">expires 1d;</span><br><span class="line">&#125;</span><br><span class="line">error_page 500 502 503 504 /50x.html;</span><br><span class="line">location = /50x.html &#123;</span><br><span class="line">root html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ .*\.(php|jsp|cgi)?$</span><br><span class="line">&#123;</span><br><span class="line">proxy_set_header Host $host;</span><br><span class="line">proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">proxy_pass http://real_server_pool;</span><br><span class="line">&#125;</span><br><span class="line">log_format access &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot;&apos;</span><br><span class="line">&apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">&apos;&quot;$http_user_agent&quot; $http_x_forwarded_for&apos;;</span><br><span class="line">access_log /data/logs/access.log access;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>备用调度器的nginx配置文件和主调度器的配置文件一样。</p>
<h4 id="启动nginx-1"><a href="#启动nginx-1" class="headerlink" title="启动nginx"></a>启动nginx</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
<h3 id="安装keepalived（在nginx的mater和backup都安装）"><a href="#安装keepalived（在nginx的mater和backup都安装）" class="headerlink" title="安装keepalived（在nginx的mater和backup都安装）"></a>安装keepalived（在nginx的mater和backup都安装）</h3><h4 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.keepalived.org/software/keepalived-1.1.19.tar.gz</span><br></pre></td></tr></table></figure>
<h4 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf keepalived-1.1.19.tar.gz</span><br><span class="line">cd keepalived-1.1.19</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/keepalived</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">cp /usr/local/keepalived/sbin/keepalived /usr/sbin/</span><br><span class="line">cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/</span><br><span class="line">cp /usr/local/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/</span><br><span class="line">mkdir /etc/keepalived</span><br></pre></td></tr></table></figure>
<h4 id="配置-4"><a href="#配置-4" class="headerlink" title="配置"></a>配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/keepalived/keepalived.conf</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_INET1 &#123;</span><br><span class="line">state MASTER</span><br><span class="line">interface eth0</span><br><span class="line">virtual_router_id 53</span><br><span class="line">priority 100</span><br><span class="line">advert_int 1</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type pass</span><br><span class="line">auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">192.168.10.104/24</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.10.104 80 &#123;</span><br><span class="line">delay_loop 6</span><br><span class="line">lb_algo rr</span><br><span class="line">lb_kind NAT</span><br><span class="line">nat_mask 255.255.255.0</span><br><span class="line">persistence_timeout 50</span><br><span class="line">protocol TCP</span><br><span class="line">real_server 192.168.10.251 80 &#123;</span><br><span class="line">weight 3</span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 10</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 80</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.200.148 80 &#123;</span><br><span class="line">weight 3</span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 10</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 80</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置备用调度器的keepalived,只需要将state MASTER 改为state BACKUP,降低priority 100 的值:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">state MASTER ---&gt; state BACKUP</span><br><span class="line">priority 100 ---&gt;  priority 99 （此值必须低于主的）</span><br></pre></td></tr></table></figure>
<h4 id="主备启动"><a href="#主备启动" class="headerlink" title="主备启动"></a>主备启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/keepalived start</span><br></pre></td></tr></table></figure>
<h2 id="优化指南"><a href="#优化指南" class="headerlink" title="优化指南"></a>优化指南</h2><h3 id="基本的-优化过的-配置"><a href="#基本的-优化过的-配置" class="headerlink" title="基本的 (优化过的)配置"></a>基本的 (优化过的)配置</h3><p>我们将修改的唯一文件是nginx.conf，其中包含Nginx不同模块的所有设置。你应该能够在服务器的/etc/nginx目录中找到nginx.conf。首先，我们将谈论一些全局设置，然后按文件中的模块挨个来，谈一下哪些设置能够让你在大量客户端访问时拥有良好的性能，为什么它们会提高性能。本文的结尾有一个完整的配置文件。</p>
<h4 id="高层的配置"><a href="#高层的配置" class="headerlink" title="高层的配置"></a>高层的配置</h4><p>nginx.conf文件中，Nginx中有少数的几个高级配置在模块部分之上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user www-data;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line">worker_processes auto;</span><br><span class="line">worker_rlimit_nofile 100000;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user和pid应该按默认设置 - 我们不会更改这些内容，因为更改与否没有什么不同。</span><br><span class="line">worker_processes 定义了nginx对外提供web服务时的worder进程数。最优值取决于许多因素，包括（但不限于）CPU核的数量、存储数据的硬盘数量及负载模式。不能确定的时候，将其设置为可用的CPU内核数将是一个好的开始（设置为“auto”将尝试自动检测它）。</span><br><span class="line">worker_rlimit_nofile 更改worker进程的最大打开文件数限制。如果没设置的话，这个值为操作系统的限制。设置后你的操作系统和Nginx可以处理比“ulimit -a”更多的文件，所以把这个值设高，这样nginx就不会有“too many open files”问题了。</span><br></pre></td></tr></table></figure>
<h4 id="Events模块"><a href="#Events模块" class="headerlink" title="Events模块"></a>Events模块</h4><p>events模块中包含nginx中所有处理连接的设置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">worker_connections 2048;</span><br><span class="line">multi_accept on;</span><br><span class="line">use epoll;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">worker_connections设置可由一个worker进程同时打开的最大连接数。如果设置了上面提到的worker_rlimit_nofile，我们可以将这个值设得很高。</span><br><span class="line">记住，最大客户数也由系统的可用socket连接数限制（~ 64K），所以设置不切实际的高没什么好处。</span><br><span class="line">multi_accept 告诉nginx收到一个新连接通知后接受尽可能多的连接。</span><br><span class="line">use 设置用于复用客户端线程的轮询方法。如果你使用Linux 2.6+，你应该使用epoll。如果你使用*BSD，你应该使用kqueue。想知道更多有关事件轮询？看下维基百科吧（注意，想了解一切的话可能需要neckbeard和操作系统的课程基础）</span><br><span class="line">（值得注意的是如果你不知道Nginx该使用哪种轮询方法的话，它会选择一个最适合你操作系统的）</span><br></pre></td></tr></table></figure>
<h4 id="HTTP-模块"><a href="#HTTP-模块" class="headerlink" title="HTTP 模块"></a>HTTP 模块</h4><p>HTTP模块控制着nginx http处理的所有核心特性。因为这里只有很少的配置，所以我们只节选配置的一小部分。所有这些设置都应该在http模块中，甚至你不会特别的注意到这段设置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">server_tokens off;</span><br><span class="line">sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">tcp_nodelay on;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server_tokens 并不会让nginx执行的速度更快，但它可以关闭在错误页面中的nginx版本数字，这样对于安全性是有好处的。sendfile可以让sendfile()发挥作用。sendfile()可以在磁盘和TCP socket之间互相拷贝数据(或任意两个文件描述符)。Pre-sendfile是传送数据之前在用户空间申请数据缓冲区。之后用read()将数据从文件拷贝到这个缓冲区，write()将缓冲区数据写入网络。sendfile()是立即将数据从磁盘读到OS缓存。因为这种拷贝是在内核完成的，sendfile()要比组合read()和write()以及打开关闭丢弃缓冲更加有效(更多有关于sendfile)</span><br><span class="line">tcp_nopush 告诉nginx在一个数据包里发送所有头文件，而不一个接一个的发送</span><br><span class="line">tcp_nodelay 告诉nginx不要缓存数据，而是一段一段的发送--当需要及时发送数据时，就应该给应用设置这个属性，这样发送一小块数据信息时就不能立即得到返回值。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">access_log off;</span><br><span class="line">error_log /var/log/nginx/error.log crit;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">access_log设置nginx是否将存储访问日志。关闭这个选项可以让读取磁盘IO操作更快(aka,YOLO)</span><br><span class="line">error_log 告诉nginx只能记录严重的错误。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keepalive_timeout 10;</span><br><span class="line">client_header_timeout 10;</span><br><span class="line">client_body_timeout 10;</span><br><span class="line">reset_timedout_connection on;</span><br><span class="line">send_timeout 10;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keepalive_timeout 给客户端分配keep-alive链接超时时间。服务器将在这个超时时间过后关闭链接。我们将它设置低些可以让ngnix持续工作的时间更长。client_header_timeout 和client_body_timeout 设置请求头和请求体(各自)的超时时间。我们也可以把这个设置低些。</span><br><span class="line">reset_timeout_connection告诉nginx关闭不响应的客户端连接。这将会释放那个客户端所占有的内存空间。</span><br><span class="line">send_timeout 指定客户端的响应超时时间。这个设置不会用于整个转发器，而是在两次客户端读取操作之间。如果在这段时间内，客户端没有读取任何数据，nginx就会关闭连接。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">limit_conn_zone $binary_remote_addr zone=addr:5m;</span><br><span class="line">limit_conn addr 100;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">limit_conn_zone设置用于保存各种key（比如当前连接数）的共享内存的参数。5m就是5兆字节，这个值应该被设置的足够大以存储（32K*5）32byte状态或者（16K*5）64byte状态。</span><br><span class="line">limit_conn为给定的key设置最大连接数。这里key是addr，我们设置的值是100，也就是说我们允许每一个IP地址最多同时打开有100个连接。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">include /etc/nginx/mime.types;</span><br><span class="line">default_type text/html;</span><br><span class="line">charset UTF-8;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">include只是一个在当前文件中包含另一个文件内容的指令。这里我们使用它来加载稍后会用到的一系列的MIME类型。default_type设置文件使用的默认的MIME-type。</span><br><span class="line">charset设置我们的头文件中的默认的字符集</span><br><span class="line">以下两点对于性能的提升在伟大的WebMasters StackExchange中有解释。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gzip on;</span><br><span class="line">gzip_disable &quot;msie6&quot;;</span><br><span class="line"># gzip_static on;</span><br><span class="line">gzip_proxied any;</span><br><span class="line">gzip_min_length 1000;</span><br><span class="line">gzip_comp_level 4;</span><br><span class="line">gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gzip是告诉nginx采用gzip压缩的形式发送数据。这将会减少我们发送的数据量。</span><br><span class="line">gzip_disable为指定的客户端禁用gzip功能。我们设置成IE6或者更低版本以使我们的方案能够广泛兼容。</span><br><span class="line">gzip_static告诉nginx在压缩资源之前，先查找是否有预先gzip处理过的资源。这要求你预先压缩你的文件（在这个例子中被注释掉了），从而允许你使用最高压缩比，这样nginx就不用再压缩这些文件了（想要更详尽的gzip_static的信息，请点击这里）。</span><br><span class="line">gzip_proxied允许或者禁止压缩基于请求和响应的响应流。我们设置为any，意味着将会压缩所有的请求。</span><br><span class="line">gzip_min_length设置对数据启用压缩的最少字节数。如果一个请求小于1000字节，我们最好不要压缩它，因为压缩这些小的数据会降低处理此请求的所有进程的速度。</span><br><span class="line">gzip_comp_level设置数据的压缩等级。这个等级可以是1-9之间的任意数值，9是最慢但是压缩比最大的。我们设置为4，这是一个比较折中的设置。</span><br><span class="line">gzip_type设置需要压缩的数据格式。上面例子中已经有一些了，你也可以再添加更多的格式。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache max=100000 inactive=20s;</span><br><span class="line">open_file_cache_valid 30s;</span><br><span class="line">open_file_cache_min_uses 2;</span><br><span class="line">open_file_cache_errors on;</span><br><span class="line"></span><br><span class="line">include /etc/nginx/conf.d/*.conf;</span><br><span class="line">include /etc/nginx/sites-enabled/*;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache打开缓存的同时也指定了缓存最大数目，以及缓存的时间。我们可以设置一个相对高的最大时间，这样我们可以在它们不活动超过20秒后清除掉。</span><br><span class="line">open_file_cache_valid 在open_file_cache中指定检测正确信息的间隔时间。</span><br><span class="line">open_file_cache_min_uses 定义了open_file_cache中指令参数不活动时间期间里最小的文件数。</span><br><span class="line">open_file_cache_errors指定了当搜索一个文件时是否缓存错误信息，也包括再次给配置中添加文件。我们也包括了服务器模块，这些是在不同文件中定义的。如果你的服务器模块不在这些位置，你就得修改这一行来指定正确的位置。</span><br></pre></td></tr></table></figure>
<p>一个完整的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cat nginx.conf</span><br><span class="line"></span><br><span class="line">user www-data;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line">worker_processes auto;</span><br><span class="line">worker_rlimit_nofile 100000;</span><br><span class="line">events &#123;</span><br><span class="line"> worker_connections 2048;</span><br><span class="line"> multi_accept on;</span><br><span class="line"> use epoll;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">  server_tokens off;</span><br><span class="line"> sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line"> tcp_nodelay on;</span><br><span class="line"> access_log off;</span><br><span class="line"> error_log /var/log/nginx/error.log crit;</span><br><span class="line"> keepalive_timeout 10;</span><br><span class="line"> client_header_timeout 10;</span><br><span class="line"> client_body_timeout 10;</span><br><span class="line">reset_timedout_connection on;</span><br><span class="line"> send_timeout 10;</span><br><span class="line"> limit_conn_zone $binary_remote_addr zone=addr:5m;</span><br><span class="line"> limit_conn addr 100;</span><br><span class="line"> include /etc/nginx/mime.types;</span><br><span class="line"> default_type text/html;</span><br><span class="line">charset UTF-8;</span><br><span class="line">gzip on;</span><br><span class="line"> gzip_disable &quot;msie6&quot;;</span><br><span class="line">gzip_proxied any;</span><br><span class="line">gzip_min_length 1000;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line"> gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line"> open_file_cache max=100000 inactive=20s;</span><br><span class="line">open_file_cache_valid 30s;</span><br><span class="line">open_file_cache_min_uses 2;</span><br><span class="line">open_file_cache_errors on;</span><br><span class="line"> include /etc/nginx/conf.d/*.conf;</span><br><span class="line"> include /etc/nginx/sites-enabled/*;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#<br>#</p>
<h1 id="nginx开启https"><a href="#nginx开启https" class="headerlink" title="nginx开启https"></a>nginx开启https</h1><p>nginx的https协议需要ssl模块的支持，我们在编译nginx时使用–with-http_ssl_module参数加入SSL模块。还需要服务器私钥，服务器证书。</p>
<p>检查Nginx的SSL模块是否安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V |grep ssl</span><br></pre></td></tr></table></figure>
<p>准备证书<br><a href="https://www.startcomca.com" target="_blank" rel="noopener">StartSSL</a></p>
<p>开启Nginx SSL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen       443;</span><br><span class="line">ssl on;</span><br><span class="line">ssl_certificate /data/cert/server.crt;</span><br><span class="line">ssl_certificate_key /data/cert/server.key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br><span class="line">netstat -lntup|grep 443</span><br></pre></td></tr></table></figure>
<p>配置重定向80端口转443端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">rewrite ^(.*) https://$server_name$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-运维工程师的职责和前景" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/03/20/运维工程师的职责和前景/" class="article-date">
      <time datetime="2014-03-20T16:43:40.000Z" itemprop="datePublished">2014-03-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/03/20/运维工程师的职责和前景/">运维工程师的职责和前景</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>运维中关键技术点解剖：<br>1、大量高并发网站的设计方案 ；<br>2、高可靠、高可伸缩性网络架构设计；<br>3、网站安全问题，如何避免被黑；<br>4、南北互联问题，动态 CDN 解决方案；<br>5、海量数据存储架构。</p>
<p>一、什么是大型网站运维<br>首先明确一下，全文所讲的“运维”是指：大型网站运维，与其它运维的区别还是蛮大的；然后我们再对大型网站与小型网站进行范围定义，此定义主要从运维复杂性角度考虑，如网站规范、知名度、服务器量级、PV 量等考虑，其它因素不是重点；因此，我们先定义服务器规模大于1000台，PV 每天至少上亿（至少国内排名前10），如sina、baidu、QQ，51.com等等；其它小型网站可能没有真正意义上的运维工程师，这与网站规范不够和成本因素有关，更多的是集合网络、系统 、开发工作于一身的“复合性人才”，就如有些公司把一些合同采购都纳入了运维职责范围，还有如 IDC 网络规划也纳入运维职责。所以，非常重要一定需要明白：运维对其它关联工种必须非常了解熟悉：网络、系统、系统开发、存储、安全、DB 等；我在这里所讲的运维工程师就是指专职运维工程师。</p>
<p>我们再来说说一般产品的“出生”流程：<br>1、首先公司管理层给出指导思想，PM 定位市场需求（或 COPY 成熟应用）进行调研、分析、最终给出详细设计；<br>2、架构师根据产品设计的需求，如 PV 大小预估、服务器规模、应用架构等因素完成网络规划，架构设计等（基本上对网络变动不大，除非大项目）；<br>3、开发工程师将设计 CODE 实现出来、测试工程师对应用进行测试；<br>4、好，到运维工程师出马了，首先明确一点不是说前三步就与运维工作无关了，恰恰相反，前三步与运维关系很大：应用的前期架构设计、软/硬件资源评估申请采购、应用设计性能隐患及评估、IDC、服务性能/安全调优、服务器系统级优化（与特定应用有关）等都需运维全程参与，并主导整个应用上线项目；运维工程师负责产品服务器上架准备工作，服务器系统安装、网络、IP、通用工具集安装。运维工程师还需要对上线的应用系统架构是否合理、是否具备可扩展性、及安全隐患等因素负责，并负责最后将产品（程序）、网络、系统三者进行拼接并最优化的组合在一起，最终完成产品上线提供用户使用，并周而复始：需求 -&gt; 开发（升级）-&gt; 测试 -&gt; 上线（性能、安全问题等之前预估外的问题随之慢慢就全出来了）在这里提一点：网站开发模式与传统软件开发完全不一样，网站一天开发上线1~5个升级版本是家常便饭，用户体验为王嘛，如果某个线上问题像 M$ 需要1年解决，用户早跑光了；应用上线后，运维工作才刚开始，具体工作可能包括：升级版本上线工作、服务监控、应用状态统计、日常服务状态巡检、突发故障处理、服务日常变更调整、集群管理、服务性能评估优化、数据库管理优化、随着应用 PV 增减进行应用架构的伸缩、安全、运维开发工作：<br>a、尽量将日常机械性手工工作通过工具实现（如服务监控、应用状态统计、服务上线等等），提高效率。<br>b、解决现实中服务存在的问题，如高可靠性、可扩展性问题等。<br>c、大规模集群管理工具的开发，如1万台机器如何在1分钟内完成密码修改、或运行指定任务？2000台服务器如何快速安装操作系统？各分布式 IDC、存储集群中数 TP 级的数据如何快速的存储、共享、分析？等一系列挑战都需运维工程师的努力。</p>
<p>在此说明一下其它配合工种情况，在整个项目中，前端应用对于网络/系统工程师来说是黑匣子，同时开发工程师职责只是负责完成应用的功能性开发，并对应用本身性能、安全性等应用本身负责，它不负责或关心网络/系统架构方面事宜，当然软/硬件采购人员等事业部其它同事也不会关心这些问题，各司其职，但项目的核心是运维工程师~！所有其它部门的桥梁。</p>
<p>上面说了很多，我想大家应该对运维有一些概念了，在此打个比方吧，如果我们是一辆高速行驶在高速公路上的汽车，那运维工程师就是司机兼维修工，这个司机不简单，有时需要在高速行驶过程中换轮胎、并根据道路情况换档位、当汽车速度越来越快，汽车本身不能满足高速度时对汽车性能调优或零件升级、高速行进中解决汽车故障及性能问题、时刻关注前方安全问题，并先知先觉的采取规避手段。这就是运维工作~！</p>
<p>最后说一下运维工程师的职责：“确保线上稳定”，看似简单，但实属不容易，运维工程师必须在诸多不利因素中进行权衡：新产品模式对现有架构及技术的冲击、产品高频度的升级带来的线上 BUG 隐患、运维自动化管理承度不高导致的人为失误、IT 行业追求的高效率导致流程执行上的缺失、用户增涨带来的性能及架构上的压力、IT 行业宽松的技术管理文化、创新风险、互联网安全性问题等因素，都会是网站稳定的大敌，运维工程师必须把控好这最后一关，需具体高度的责任感、原则性及协调能力，如果能做到各因素的最佳平衡，那就是一名优秀的运维工程师了。</p>
<p>另外在此聊点题外话，我在这里看到有很多人要sina、QQ、baidu、51.com等聊自己的运维方面的经验，其实这对于它们有点免为其难：<br>a、各公司自已网络架构、规模、或多或少还算是公司的核心秘密，要保密。另外，对于大家所熟知的通用软件、架构，由于很多公司会根据自己实际业务需要，同时因为原版性能、安全性、已知 BUG、功能等原因，进行过二次开发（如Apache、PHP、MySQL），操作系统内核也会根据不同业务类型进行定制的，如某些应用属于运算型、某些是高IO型、或大存储大内存型。根据这些特点进行内核优化定制，如 sina 就在 Memcache 上进行过二次开发，搞出了一个 MemcacheDB，具体做得如何我们不谈，但开源了，是值得称赞的，国内公司对于开源基本上是索取，没有贡献；另外，服务器也不是大家所熟知的型号，根据业务特点，大部份都是找 DELL/HP/IBM 进行过定制；另外，在分布式储存方面都有自己解决方案，要不就是使用现成开源 Hadoop 等解决方案，或自己开发。但 90% 都是借鉴Google GFS的思想:分布式存储、计算、大表。<br>b、各公司业务方向不一样，会导致运维模式或方法都不一样，如 51.com 和 baidu 运维肯定区别很大，因为他们业务模式决定了其架构、服务器量级、IDC 分布、网络结构、通用技术都会不一样，主打新闻门户的 sina 与主打 SNS 的51.com 运维模式差异就非常大，甚至职责都不大一样；但有一点，通用技术及大致架构上都大同小异，大家不要太神化，更多的公司只是玩垒积木的游戏罢了，没什么技术含量。<br>c、如上面所讲，目前大型网站运维还处于幼年时期理念和经验都比较零散，没有成熟的知识体系，可能具体什么是运维，大家都要先思索一番，或压根没想过，真正讨论也只是运维工作的冰山一角，局限于具体技术细节，或某某著名网站大的框架，真正运维体系化东西没有，这也许是目前网上运维相关资料比较少的缘故吧。或者也是国内运维人员比较难招，比较牛的运维工程师比较少见的原因之一吧。</p>
<p>二、运维工作师需要什么样的技能及素质<br>做为一名运维工程师需要什么样的技能及素质呢，首先说说技能吧，如大家上面所看到，运维是一个集多IT工种技能与一身的岗位，对系统 -&gt; 网络 -&gt; 存储 -&gt; 协议 -&gt; 需求 -&gt; 开发 -&gt; 测试 -&gt; 安全等各环节都需要了解一些，但对于某些环节需熟悉甚至精通，如系统 (基本操作系统的熟悉使用，*nix、windows ..)、协议、系统开发(日常很重要的工作是自动运维化相关开发、大规模集群工具开发、管理）、通用应用（如LVS、HA、WEB Server 、DB、中间件、存储等）、网络、IDC 拓朴架构；</p>
<p>技能方面总结以下几点：<br>1、开发能力，这点非常重要，因为运维工具都需要自己开发，开发语言：Perl、Python、PHP（其中之一）、shell（awk、sed、expect….等），需要有过实际项目开发经验，否则工作会非常痛苦；<br>2、通用应用方面需要了解：操作系统（目前国内主要是Linux、BSD）、WEB Server 相关 (Nginx、Apahe、PHP、Lighttpd、Java…)、数据库(MySQL、Oralce)、其它杂七八拉的东东；系统优化，高可靠性；这些只是加分项，不需必备，可以边工作边慢慢学，这些东西都不难。当然在运维中，有些是有分工偏重点不一样；<br>3、系统、网络、安全、存储、CDN、DB 等需要相当了解，知道其相关原理。</p>
<p>个人素质方面：<br>1、沟通能力、团队协作：运维工作跨部门、跨工种工作很多，需善于沟通、并且团队协作能力要强；这应该是现代企业的基本素质要求了，不多说；<br>2、工作中需胆大心细：胆大才能创新、不走寻常路，特别对于运维这种新的工种，更需创新才能促进发展；心细，运维工程师是网站 admin，最高线上权限者，一不小心就会遗憾终生或打入十八层地狱；<br>3、主动性、执行力、精力旺盛、抗压能力强：由于 IT 行业的特性，变化快；往往计划赶不上变化，运维工作就更突出了，比如国内各大公司服务器往往是全国各地，哪里便宜性价比高，就那往搬，进行大规模服务迁移（牵扯的服务器成百上千台），这是一个非常头痛的问题；往往时间非常紧迫，如限1周内完成，这种情况下，运维工程师的主动性及执行力就有很高的要求了：计划、方案、服务无缝迁移、机器搬迁上架、环境准备、安全评估、性能评估、基建、各关联部门扯皮，7x24小紧急事故响应等；<br>4、其它就是一些基本素质了：头脑要灵光、逻辑思维能力强、为人谦虚稳重、亲和力、乐于助人、有大局观；<br>5、最后一点，做网站运维需要有探索创新精神，通过创新型思维解决现实中的问题，因为这是一个处于幼年的职业（国外也一样，但比国内起步早点），没有成熟体系或方法论可以借鉴，只能靠大家自已摸索努力。</p>
<p>三、怎样才算是一个合格的运维工程师<br>1、保证服务达到要求的线上标准，如 99.9%；保证线上稳定，这是运维工程师的基本责职所在；<br>2、不断的提升应用的可靠性与健壮性、性能优化、安全提升；这方面非常考验主动性和创新思维；<br>3、网站各层面监控、统计的覆盖度，软件、硬件、运行状态，能监控的都需要监控统计，避免监控死角、并能实时了解应用的运转情况；<br>4、通过创新思维解决运维效率问题；目前各公司大部分运维主要工作还是依赖人工操作干预，需要尽可能的解放双手；<br>5、运维知识的积累与沉淀、文档的完备性，运维是一个经验性非常强的岗位，好的经验与陷阱都需积累下来，避免重复性犯错；<br>6、计划性和执行力；工作有计划，计划后想法设法达到目标，不找借口；<br>7、自动化运维；能对日常机械化工作进行提炼、设计并开发成工具、系统，能让系统自动完成的尽量依靠系统；让大家更多的时间用于思考、创新思维、做自己喜欢的事情。</p>
<p>以上只是技术上的一些层面，当然个人意识也是很重要的。</p>
<p>四、运维职业的迷惘、现状与发展前景<br>运维岗位不像其它岗位，如研发工程师、测试工程师等，有非常明确的职责定位及职业规划，比较有职业认同感与成就感；而运维工作可能给人的感觉是哪方面都了解一些，但又都比上专职工程师更精通、感觉平时被关注度比较低（除非线上出现故障），慢慢的大家就会迷惘，对职业发展产生困惑，为什么会有这种现象呢？除了职业本身特点外，主要还是因为对运维了解不深入、做得不深入导致；其实这个问题其它岗位也会出现，但我发现运维更典型，更容易出现这个问题；</p>
<p>针对这个问题我谈一下网站运维的现状及发展前景（也在思考中，可能不太深入全面，也请大家斧正补充）</p>
<p>运维现状：<br>1、处于刚起步的初级阶段，各大公司有此专职，但重视或重要程度不高，可替代性强；小公司更多是由其它岗位来兼顾做这一块工作，没有专职，也不可能做得深入；<br>2、技术层次比较低；主要处于技术探索、积累阶段，没有形成体系化的理念、技术；<br>3、体力劳动偏大；这个问题主要与第二点有关系，很多事情还是依靠人力进行，没有完成好的提练，对于大规模集群没有成熟的自动化管理方法，在此说明一下，大规模集群与运维工作是息息相关的，如果只是百十来台机器，那就没有运维太大的生存空间了；<br>4、优秀运维人才的极度缺乏；目前各大公司基本上都靠自己培养，这个现状导致行业内运维人才的流动性非常低，非常多好的技术都局限在各大公司内部，如 Google 50万台机器科学的管理，或者国内互联公司 TOP 10 的一些运维经验，这些经验是非常有价值的东西并决定了一个公司的核心竞争力；这些问题进而导致业内先进运维技术的流通、贯通、借签，并最终将限制了运维发展；<br>5、很多优秀的运维经验都掌握在大公司手中；这不在于公司的技术实力，而在于大公司的技术规模、海量PV、硬件规模足够大，如 baidu 可怕的流量、51.com 海量数据~~~~这些因素决定了他们遇到的问题都是其它中/小公司还没有遇到的，或即将遇到。但大公司可能已有很好的解决方案或系统。</p>
<p>发展前景：<br>1、从行业角度来看，随着中国互联网的高速发展（目前中国网民已跃升为全球第一）、网站规模越来越来大、架构越来越复杂；对专职网站运维工程师、网站架构师的要求会越来越急迫，特别是对有经验的优秀运维人才需求量大，而且是越老越值钱；目前国内基本上都是选择毕业生培养（限于大公司），培养成本高，而且没有经验人才加入会导致公司技术更新缓慢、影响公司的技术发展；当然，毕业生也有好处：白纸一张，可塑性强，比较认同并容易融入企业文化；<br>2、从个人角度，运维工程师技术含量及要求会越来越高，同时也是对公司应用、架构最了解最熟悉的人、越来越得到重视；<br>3、网站运维将成为一个融合多学科（网络、系统、开发、安全、应用架构、存储等）的综合性技术岗位，给大家提供一个很好的个人能力与技术广度的发展空间；<br>4、运维工作的相关经验将会变得非常重要，而且也将成为个人的核心竞争力，具备很好的各层面问题的解决能力及方案提供、全局思考能力等；<br>5、特长发挥和兴趣的培养；由于运维岗位所接触的知识面非常广阔，更容易培养或发挥出个人某些方面的特长或爱好，如内核、网络、开发、数据库等方面，可以做得非常深入精通、成为这方面的专家；<br>6、如果真要以后不想做运维了，转到其它岗位也比较容易，不会有太大的局限性。当然了，你得真正用心去做；<br>7、技术发展方向：网站/系统架构师。</p>
<p>五、运维关键技术点解剖<br>大规模集群管理问题<br>首先我们先要明确集群的概念，集群不是泛指各功能服务器的总和，而是指为了达到某一目的或功能的服务器、硬盘 资源的整合（机器数大于两台），对于应用来说它就是一个整体，目前常规集群可分为：高可用性集群（HA）、负载均衡集群（如 LVS）、分布式存储、计算存储集群（DFS，如 Google GFS、Yahoo Hadoop），特定应用集群（某一特定功能服务器组合、如 DB、CACHE 层等），目前互联网行业主要基于这四种类型；对于前两种类似，如果业务简单、应用上 Post 操作比较少，可以简单地采用四层交换机解决（如 F5），达到服务高可用/负载均衡的作用，对于资源紧张的公司也有一些开源解决办法如 LVS + HA，非常灵活；对于后两种，那就考验公司技术实力及应用特点了，第三种 DFS 主要应用于海量数据应用上，如邮件、搜索等应用，特别是搜索要求就更高了，除了简单海量存储，还包括数据挖掘、用户行为分析；如 Google、Yahoo 就能保存分析近一年的用户记录数据，而 baidu 应该少于30天、Sogou 就更少了。这些对于搜索准备性及用户体验是至关重要的。</p>
<p>接下来，我们再谈谈如何科学的管理集群，有以下关键几点：<br>I、监控<br>主要包括故障监控和性能、流量、负载等状态监控，这些监控关系到集群的健康运行，及潜在问题的及时发现与干预；<br>a、服务故障、状态监控：主要是对服务器自身、上层应用、关联服务数据交互监控；例如针对前端 WEB Server，我们就可以有很多种类型的监控，包括应用端口状态监控，便于及时发现服务器或应用本身是否 Crash、通过 ICMP 包探测服务器健康状态，更上层可能还包括应用各频道业务的监控，常用方法是采用页面特征码进行判断，或对重点页面进行签名，以防网站被黑篡改（报警、并自动恢复被篡改数据）等等，这些只是一部份，还有 N 多监控方式，依应用特点而定，还有一些问题需解决，如集群过大，如何高性能的进行监控也是一个现实问题。<br>b、其它就是集群状态类的监控或统计，为我们合理管理调优集群提供数据参考、包括服务瓶颈、性能问题、异常流量、攻击等问题。</p>
<p>II、故障管理<br>a、硬件故障问题；对于成百上千或上万机器的 N 多集群，服务器死机、硬件故障概率是非常大的，几乎每时每刻都有服务器硬件问题，死机、硬盘损坏、电源、内存、交换机。针对这种情况，我们在设计网站架构时需要充分考虑到这些问题，并将其视为常态；更多地依靠应用的冗余机制来规避这种风险，给系统工程师足够宽裕的处理时间。（如Google 不是号称同时死800台机器，服务不会受到任何影响）；这就是考验运维工程师及网站架构师功能的地方了，好的设计能达到 Google 所描述自恢复能力，如 GFS，糟糕的设计那就是一台服务器的死机可能会造成大面积服务的连锁故障反应，直接对用户拒绝响应。<br>b、应用故障问题；可能是某一 BUG 被触发、或某一性能阀值被超越、攻击等情况不一而定，但重要的一点，是要有对这些问题的预防性措施，不能想当然，它不会出问题，如真出问题了，如何应对？这需要运维工程师平时做足功夫，包括应急响应速度、故障处理的科学性、备用方案的有效等。</p>
<p>III、自动化<br>自动化：简而言之，就是将我们日常手动进行的一些工作通过工具，系统自动来完成，解放我们的双手及枯燥的重复性劳动，例如：没有工具前，我们安装系统需要一台一台裸机安装，如2000台，可能需要10人/10天，搞烂 N 张光盘，人力成本更大。而现在通过自动化工具，只需几个简单命令就能搞定、还有如机器人类程序，自动完成以往每天人工干预的工作，使其自动完成、汇报结果，并具备一定的专家系统能力，能做一些简单的是/非判断、优化选择等。这些好处非常明显不再多说。应该说，自动化运维是运维工程师职业化的一个追求，利己利公，虽然这是一个异常艰巨的任务：不断变更的业务、不规范化的应用设计、开发模式、网络架构变更、IDC 变更、规范变动等因素，都可能会对现有自动化系统产生影响，所以需要模块化、接口化、变更参数化等。因此，自动化相关工作，是运维工程师的核心重点工作之一，也是价值的体现。</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/运维/">运维</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2013年终总结之思考" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/12/31/2013年终总结之思考/" class="article-date">
      <time datetime="2013-12-31T10:05:00.000Z" itemprop="datePublished">2013-12-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/12/31/2013年终总结之思考/">2013年终总结之思考</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2013年终总结之败家" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/12/31/2013年终总结之败家/" class="article-date">
      <time datetime="2013-12-31T10:02:37.000Z" itemprop="datePublished">2013-12-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/12/31/2013年终总结之败家/">2013年终总结之败家</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>Apple Mac mini 2012 mid</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Nginx配置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2013/04/20/Nginx配置/" class="article-date">
      <time datetime="2013-04-20T09:22:28.000Z" itemprop="datePublished">2013-04-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/04/20/Nginx配置/">Nginx配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <ol>
<li><p>Nginx location 配置语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. location [ = | ~ | ~* | ^~ ] uri &#123; ... &#125;</span><br><span class="line">2. location @name &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>location 配置可以有两种配置方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.前缀 + uri（字符串/正则表达式）</span><br><span class="line">2.@ + name</span><br></pre></td></tr></table></figure>
</li>
<li><p>前缀含义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=  ：精确匹配（必须全部相等）</span><br><span class="line">~  ：大小写敏感</span><br><span class="line">~* ：忽略大小写</span><br><span class="line">^~ ：只需匹配uri部分</span><br><span class="line">@  ：内部服务跳转</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>Location 基础知识</p>
<p>1.location 是在 server 块中配置。<br>2.可以根据不同的 URI 使用不同的配置（location 中配置），来处理不同的请求。<br>3.location 是有顺序的，会被第一个匹配的location 处理。</p>
</li>
</ol>
<h3 id="Location-配置demo"><a href="#Location-配置demo" class="headerlink" title="Location 配置demo"></a>Location 配置demo</h3><p>1.<code>=</code>，精确匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line">    #规则</span><br><span class="line">&#125;</span><br><span class="line"># 则匹配到 `http://www.example.com/` 这种请求。</span><br></pre></td></tr></table></figure>
<p>2.<code>~</code>，大小写敏感</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~ /Example/ &#123;</span><br><span class="line">        #规则</span><br><span class="line">&#125;</span><br><span class="line">#请求示例</span><br><span class="line">#http://www.example.com/Example/  [成功]</span><br><span class="line">#http://www.example.com/example/  [失败]</span><br></pre></td></tr></table></figure>
<p>3.<code>~*</code>，大小写忽略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~* /Example/ &#123;</span><br><span class="line">            #规则</span><br><span class="line">&#125;</span><br><span class="line"># 则会忽略 uri 部分的大小写</span><br><span class="line">#http://www.example.com/Example/  [成功]</span><br><span class="line">#http://www.example.com/example/  [成功]</span><br></pre></td></tr></table></figure>
<p>4.<code>^~</code>，只匹配以 uri 开头</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /img/ &#123;</span><br><span class="line">        #规则</span><br><span class="line">&#125;</span><br><span class="line">#以 /img/ 开头的请求，都会匹配上</span><br><span class="line">#http://www.example.com/img/a.jpg   [成功]</span><br><span class="line">#http://www.example.com/img/b.mp4 [成功]</span><br></pre></td></tr></table></figure>
<p>5.<code>@</code>，nginx内部跳转</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /img/ &#123;</span><br><span class="line">    error_page 404 @img_err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location @img_err &#123;</span><br><span class="line">    # 规则</span><br><span class="line">&#125;</span><br><span class="line">#以 /img/ 开头的请求，如果链接的状态为 404。则会匹配到 @img_err 这条规则上。</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Nginx 中的 location 并没有想象中的很难懂，不必害怕。多找资料看看，多尝试。你就会有收获。</p>
<h1 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h1><h3 id="location"><a href="#location" class="headerlink" title="location"></a>location</h3><p>语法规则： location [=|~|~*|^~] /uri/ { … }</p>
<ul>
<li>= 开头表示精确匹配</li>
<li>^~ 开头表示uri以某个常规字符串开头，理解为匹配 url路径即可。nginx不对url做编码，因此请求为/static/20%/aa，可以被规则^~ /static/ /aa匹配到（注意是空格）。</li>
<li>~ 开头表示区分大小写的正则匹配</li>
<li>~*  开头表示不区分大小写的正则匹配</li>
<li>!~和!~*分别为区分大小写不匹配及不区分大小写不匹配 的正则</li>
<li>/ 通用匹配，任何请求都会匹配到。</li>
</ul>
<p>多个location配置的情况下匹配顺序为（参考资料而来，还未实际验证，试试就知道了，不必拘泥，仅供参考）：</p>
<p>首先匹配 =，其次匹配^~, 其次是按文件中顺序的正则匹配，最后是交给 / 通用匹配。当有匹配成功时候，停止匹配，按当前匹配规则处理请求。</p>
<ul>
<li>写优先级 =(绝对匹配) &gt; /url (真正全路径) &gt; ^~(带开头的正则，和~ ^/url 一样) &gt; ~和~* (模糊正则) &gt; /url (非全路径) &gt; / (匹配所有的) 其实就是 2 5 6 是一种，都是直接匹配路径，但一个比一个模糊 3,4是一种，都是正则，3比4更清晰，其他语言的正则里面也是3优先 1，就是绝对等于，相当于 ~ ^/xxx/xxx$ 完全固定不能匹配任何其他的。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /wechat/ &#123;</span><br><span class="line">    proxy_pass http://10.8.8.8:8080/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ReWrite"><a href="#ReWrite" class="headerlink" title="ReWrite"></a>ReWrite</h3><p>last – 基本上都用这个Flag。</p>
<p>break – 中止Rewirte，不在继续匹配</p>
<p>redirect – 返回临时重定向的HTTP状态302</p>
<p>permanent – 返回永久重定向的HTTP状态301</p>
<p>注：last和break最大的不同在于</p>
<ul>
<li>-break是终止当前location的rewrite检测,而且不再进行location匹配 </li>
<li>-last是终止当前location的rewrite检测,但会继续重试location匹配并处理区块中的rewrite规则</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">1、下面是可以用来判断的表达式：</span><br><span class="line"></span><br><span class="line">-f和!-f用来判断是否存在文件</span><br><span class="line"></span><br><span class="line">-d和!-d用来判断是否存在目录</span><br><span class="line"></span><br><span class="line">-e和!-e用来判断是否存在文件或目录</span><br><span class="line"></span><br><span class="line">-x和!-x用来判断文件是否可执行</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2、下面是可以用作判断的全局变量</span><br><span class="line"></span><br><span class="line">$args #这个变量等于请求行中的参数。</span><br><span class="line"></span><br><span class="line">$content_length #请求头中的Content-length字段。</span><br><span class="line"></span><br><span class="line">$content_type #请求头中的Content-Type字段。</span><br><span class="line"></span><br><span class="line">$document_root #当前请求在root指令中指定的值。</span><br><span class="line"></span><br><span class="line">$host #请求主机头字段，否则为服务器名称。</span><br><span class="line"></span><br><span class="line">$http_user_agent #客户端agent信息</span><br><span class="line"></span><br><span class="line">$http_cookie #客户端cookie信息</span><br><span class="line"></span><br><span class="line">$limit_rate #这个变量可以限制连接速率。</span><br><span class="line"></span><br><span class="line">$request_body_file #客户端请求主体信息的临时文件名。</span><br><span class="line"></span><br><span class="line">$request_method #客户端请求的动作，通常为GET或POST。</span><br><span class="line"></span><br><span class="line">$remote_addr #客户端的IP地址。</span><br><span class="line"></span><br><span class="line">$remote_port #客户端的端口。</span><br><span class="line"></span><br><span class="line">$remote_user #已经经过Auth Basic Module验证的用户名。</span><br><span class="line"></span><br><span class="line">$request_filename #当前请求的文件路径，由root或alias指令与URI请求生成。</span><br><span class="line"></span><br><span class="line">query_string #与args相同。</span><br><span class="line"></span><br><span class="line">$scheme #HTTP方法（如http，https）。</span><br><span class="line"></span><br><span class="line">$server_protocol #请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</span><br><span class="line"></span><br><span class="line">$server_addr #服务器地址，在完成一次系统调用后可以确定这个值。</span><br><span class="line"></span><br><span class="line">$server_name #服务器名称。</span><br><span class="line"></span><br><span class="line">$server_port #请求到达服务器的端口号。</span><br><span class="line"></span><br><span class="line">$request_uri #包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。</span><br><span class="line"></span><br><span class="line">uri #不带请求参数的当前URI，uri不包含主机名，如”/foo/bar.html”。</span><br><span class="line"></span><br><span class="line">document_uri #与uri相同。</span><br><span class="line"></span><br><span class="line">例：http://localhost:88/test1/test2/test.php</span><br><span class="line"></span><br><span class="line">$host：localhost</span><br><span class="line"></span><br><span class="line">$server_port：88</span><br><span class="line"></span><br><span class="line">$request_uri：http://localhost:88/test1/test2/test.php</span><br><span class="line"></span><br><span class="line">$document_uri：/test1/test2/test.php</span><br><span class="line"></span><br><span class="line">$document_root：D:\nginx/html</span><br><span class="line"></span><br><span class="line">$request_filename：D:\nginx/html/test1/test2/test.php</span><br></pre></td></tr></table></figure>
<h3 id="http-auth"><a href="#http-auth" class="headerlink" title="http_auth"></a>http_auth</h3><p>配置nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	auth_basic &quot;secret&quot;;</span><br><span class="line">	auth_basic_user_file /data/nginx/passwd.db; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf "admin:$(openssl passwd -crypt 123456)\n" &gt;&gt;/data/nginx/passwd.db</span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.csdn.net/tjcyjd/article/details/50897959" target="_blank" rel="noopener">nginx的location配置详解</a></p>
<p><a href="https://blog.coding.net/blog/tips-in-configuring-Nginx-location" target="_blank" rel="noopener">Nginx location 配置踩坑过程分享</a></p>
<p><a href="https://segmentfault.com/a/1190000009651161" target="_blank" rel="noopener">Nginx 的  从零开始配置</a></p>
<p><a href="http://www.ttlsa.com/nginx/nginx-basic-http-authentication/" target="_blank" rel="noopener">nginx用户认证配置（ Basic HTTP authentication）</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2012年终总结之败家" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2012/12/31/2012年终总结之败家/" class="article-date">
      <time datetime="2012-12-31T08:08:31.000Z" itemprop="datePublished">2012-12-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2012/12/31/2012年终总结之败家/">2012年终总结之败家</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>Apple iPhone 4S</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/35/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/34/">34</a><a class="page-number" href="/page/35/">35</a><span class="page-number current">36</span><a class="page-number" href="/page/37/">37</a><a class="extend next" rel="next" href="/page/37/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2018 幻舞梦境
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >海贼到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-39498261-3', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?1bb44bf25fea8f000a1397f9b5438de7";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>