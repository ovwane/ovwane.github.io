<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>幻舞梦境</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="幻舞梦境">
<meta property="og:url" content="https://ovwane.icu/page/44/index.html">
<meta property="og:site_name" content="幻舞梦境">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="幻舞梦境">
  
    <link rel="alternative" href="/atom.xml" title="幻舞梦境" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
     
      <meta name="baidu-site-verification" content="3rC08I0Cp6">
    
     
      <meta name="google-site-verification" content="rn8f25RzFQoiByt8ezg9E17KZIElbIlwJ4y-EKSlWbA">
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet">
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">幻舞梦境</a></h1>
        </hgroup>

        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/archives">博客归档</a></li>
                        
                            <li><a href="/FrontEndGuideV2/FrontEndGuide">测试导航</a></li>
                        
                            <li><a href="/ovwane_love">关于Love</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" target="_blank" href="https://github.com/ovwane" title="github">github</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Ansible/" style="font-size: 11.43px;">Ansible</a> <a href="/tags/Bind/" style="font-size: 10px;">Bind</a> <a href="/tags/Cacti/" style="font-size: 10px;">Cacti</a> <a href="/tags/CentOS/" style="font-size: 20px;">CentOS</a> <a href="/tags/Cobbler/" style="font-size: 10px;">Cobbler</a> <a href="/tags/DHCP/" style="font-size: 10px;">DHCP</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Gitlab/" style="font-size: 11.43px;">Gitlab</a> <a href="/tags/HAProxy/" style="font-size: 10px;">HAProxy</a> <a href="/tags/Hexo/" style="font-size: 11.43px;">Hexo</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Jenkins/" style="font-size: 11.43px;">Jenkins</a> <a href="/tags/KVM/" style="font-size: 10px;">KVM</a> <a href="/tags/Kubernetes/" style="font-size: 10px;">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 14.29px;">Linux</a> <a href="/tags/MariaDB/" style="font-size: 10px;">MariaDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 10px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.14px;">Nginx</a> <a href="/tags/Oh-My-Zsh/" style="font-size: 10px;">Oh My Zsh</a> <a href="/tags/OpenLDAP/" style="font-size: 10px;">OpenLDAP</a> <a href="/tags/OpenStack/" style="font-size: 10px;">OpenStack</a> <a href="/tags/PHP/" style="font-size: 11.43px;">PHP</a> <a href="/tags/PXE/" style="font-size: 10px;">PXE</a> <a href="/tags/Python/" style="font-size: 12.86px;">Python</a> <a href="/tags/RHEL7/" style="font-size: 10px;">RHEL7</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Samba/" style="font-size: 10px;">Samba</a> <a href="/tags/Scrapy/" style="font-size: 10px;">Scrapy</a> <a href="/tags/Scrapyd/" style="font-size: 10px;">Scrapyd</a> <a href="/tags/SpiderKeeper/" style="font-size: 10px;">SpiderKeeper</a> <a href="/tags/Squid/" style="font-size: 10px;">Squid</a> <a href="/tags/Subversion/" style="font-size: 10px;">Subversion</a> <a href="/tags/Supervisor/" style="font-size: 10px;">Supervisor</a> <a href="/tags/Tomcat/" style="font-size: 12.86px;">Tomcat</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/Zabbix/" style="font-size: 10px;">Zabbix</a> <a href="/tags/cacti/" style="font-size: 10px;">cacti</a> <a href="/tags/dovecot/" style="font-size: 10px;">dovecot</a> <a href="/tags/httpd/" style="font-size: 11.43px;">httpd</a> <a href="/tags/iSCSI/" style="font-size: 10px;">iSCSI</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/kickstart/" style="font-size: 10px;">kickstart</a> <a href="/tags/macOS/" style="font-size: 15.71px;">macOS</a> <a href="/tags/nagios/" style="font-size: 10px;">nagios</a> <a href="/tags/postfix/" style="font-size: 10px;">postfix</a> <a href="/tags/rsync/" style="font-size: 10px;">rsync</a> <a href="/tags/sshd/" style="font-size: 10px;">sshd</a> <a href="/tags/uWSGI/" style="font-size: 10px;">uWSGI</a> <a href="/tags/vsftpd/" style="font-size: 10px;">vsftpd</a> <a href="/tags/zabbix/" style="font-size: 10px;">zabbix</a> <a href="/tags/历史/" style="font-size: 18.57px;">历史</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/情感/" style="font-size: 10px;">情感</a> <a href="/tags/生活/" style="font-size: 10px;">生活</a> <a href="/tags/监控/" style="font-size: 12.86px;">监控</a> <a href="/tags/网络/" style="font-size: 10px;">网络</a> <a href="/tags/自己/" style="font-size: 10px;">自己</a> <a href="/tags/运维/" style="font-size: 10px;">运维</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://luuman.github.io/">name</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">纯海迷、爱运动、爱交友、爱旅行、喜欢接触新鲜事物、迎接新的挑战，更爱游离于错综复杂的编码与逻辑中</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">幻舞梦境</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">幻舞梦境</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/archives">博客归档</a></li>
                
                    <li><a href="/FrontEndGuideV2/FrontEndGuide">测试导航</a></li>
                
                    <li><a href="/ovwane_love">关于Love</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/ovwane" title="github">github</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-Jenkins+Ansible+Gitlab自动化部署" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/15/Jenkins+Ansible+Gitlab自动化部署/" class="article-date">
      <time datetime="2016-03-15T07:21:20.000Z" itemprop="datePublished">2016-03-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/15/Jenkins+Ansible+Gitlab自动化部署/">Jenkins+Ansible+Gitlab自动化部署</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://www.showerlee.com/archives/1880" target="_blank" rel="noopener">Jenkins+Ansible+Gitlab自动化部署</a></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li><p>Ansible 首先给大家介绍的是Ansible, 恩, 重要的问题说三遍, 不是Saltstack, Ansible作为一个python写的自动化部署工具, 确实较之前我所接触的Chef, saltstack, puppet更有自己的一些优势, 首先就是agentless, 无需在Linux client安装任何服务即可无缝连接Linux default ssh端口进行部署(windows需要安装winrm 开启ssh服务), 这点其实我觉得非常重要, 可以想象很多公司本身是对network管理非常严格的, 在部署一个产品的同时你需要考虑很多时间成本, 使用其他部署工具本身非常棘手的问题就是去申请开端口, client量少的话, 我们可以去等, 多的话本身你去request, waiting, unblock port等等long long process…. 最后会耗费很长时间. 这个对很多产品本身就是很致命的. 不推荐Saltstack的原因也是因为其需要在每台agent逐一去安装client service并测试, 这本身就会耗费一些时间成本。<br>其他呢? 其实我觉得就是容易上手, 语法简单, 有现成模板让你去学习, 加之是我们非常喜爱的python语法, why not?</p>
</li>
<li><p>Jenkins不用我多说, 估计懂行的人都在用它, 开源, 轻量级, 兼容性和扩展性强, 直观的GUI管理这都是它的优势, 配合Ansible我觉得用起来会非常easy going.</p>
</li>
<li><p>Gitlab 最后提一下Gitlab, 为什么要用Gitlab? 他作为一个代码版本控制系统和部署有什么关系呢? 其实这里就涉及一个我们Ansible playbook管理问题, 试想我们需要维护一个公司庞大的server集群, 我们所有需要部署的机器或者产品会对应我们相对的部署脚本, 我们使用的Ansible playbook如果只是保存在Ansible Server的具体某个目录, 这本身就不便于我们进行编写维护更新(想想每次都跑到远程去编写playbook或者每次在本地编写好后再upload到远程我都会脑补数以万计的草泥马从我眼前呼啸而来).<br>这里Gitlab就给我们提供一个非常方便以及直观的Playbook management. 我们需要做的其实就是在Gitlab去建立一个对应产品或者server的playbook仓库, 然后我们在本地写好后直接commit到这个仓库, 最后在部署的时候, 去让Jenkins pull这个playbook到其workspace, 并作为一个Job去run这个playbook, 这样是不是很规范, 而且便于管理?<br>当然Ansible本身企业版Tower也会提供一个类似管理并维护playbook以及监控ansible本身running process的GUI管理系统, 用起来也很不错, 但作为收费版本, 我们在这里就不做过多阐述了.</p>
</li>
</ul>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>这里我推荐Jenkins和Ansible可以安装到同一个环境作为部署server,<br>Gitlab作为版本控制系统可单独部署在另一台server.</p>
<p>总结:<br>Jenkins首先从Gitlab去抓取我们写好的具体产品的playbook, 并使用virtualenv下的Ansible相关命令, 保证我们在一个clean的环境下使用stable version去批量部署我们的产品到远程client。</p>
<h1 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h1><p>System: CentOS 6.7 x64 (deploy.example.com)<br>Jenkins: Jenkins ver. 1.650<br>Ansible: Ansible 2.1.0<br>Gitlab: GitLab 7.14.3</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="Jenkins配置"><a href="#Jenkins配置" class="headerlink" title="Jenkins配置"></a>Jenkins配置</h2><p>我们创建deploy用户作为jenkins_user, workspace为deploy家目录下的jenkins目录.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># adduser deploy</span><br><span class="line"># vi /et</span><br><span class="line">c/sysconfig/jenkins</span><br><span class="line"> ...</span><br><span class="line">JENKINS_HOME=&quot;/home/deploy/jenkins&quot;</span><br><span class="line">JENKINS_USER=&quot;deploy&quot;</span><br></pre></td></tr></table></figure>
<p>浏览器访问Jenkins页面<br><a href="http://deploy.example.com:8080" target="_blank" rel="noopener">http://deploy.example.com:8080</a><br>安装完成。</p>
<p>这里我们使用一个国内PHP网站模板phpcms作为我们需要部署的产品进行本次范例演示, 在进行最终的Build前我们需要做一些准备工作, 稍后我们会回到这个界面。</p>
<h2 id="Ansible配置"><a href="#Ansible配置" class="headerlink" title="Ansible配置"></a>Ansible配置</h2><p>配置<a href="http://www.showerlee.com/archives/1862" target="_blank" rel="noopener">virtualenv</a><br><a href="http://www.showerlee.com/archives/1649" target="_blank" rel="noopener">Ansible-playbook范例</a></p>
<h2 id="Gitlab配置"><a href="#Gitlab配置" class="headerlink" title="Gitlab配置"></a>Gitlab配置</h2><p>我们最终会创建一个ansible playbook仓库<a href="mailto:git@git.example.cn" target="_blank" rel="noopener">git@git.example.cn</a>:showerlee/Ansible-showerlee.git, 并在本地编写好我们的规则, 最终commit到这个仓库, 以便Jenkins去调用我们的部署规则。</p>
<p><a href="https://git.showerlee.com/showerlee/leon-playbook-phpcms1.1" target="_blank" rel="noopener">部署phpcms的playbook仓库实例</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ansible/">Ansible</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Gitlab/">Gitlab</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jenkins/">Jenkins</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-GitLab安装部署" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/15/GitLab安装部署/" class="article-date">
      <time datetime="2016-03-15T00:28:29.000Z" itemprop="datePublished">2016-03-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/15/GitLab安装部署/">GitLab安装部署</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://www.showerlee.com/archives/1285" target="_blank" rel="noopener">GitLab安装部署</a></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Gitlab是一个用Ruby on Rails开发的开源项目管理程序.可以通过WEB界面进行访问公开的或者私人项目. 它和Github有类似的功能，能够浏览源代码，管理缺陷和注释.</p>
<p>本文选择NGINX与MYSQL来配合GitLab实现web管理,数据存储等功能,配置过程中难点基本在GitLab的脚本修改,SSH秘钥连接,Nginx SSL证书等这些方面,作者也是耗费非常大的力气,结合很多文档的clue以及很多老外的debug comment,终于最终完成,希望在此给大家一个抛砖引玉的机会,了解到SCM(软件配置管理)其实也不是想象中那么小儿科,很多逻辑也着实需要下功夫investigation.</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>环境部署<br>操作系统               centos6.3 x64<br>GitLab                   GitLab 6-3-stable<br>GitLab Shell           1.8.0<br>Ruby                     2.0.0p353<br>NGINX                  nginx-1.4.0<br>MYSQL                 mysql-5.6.10</p>
<p>Git server(centos6.3 x64): git.example.com<br>Git client(centos6.3 x64): client.example.com</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="server端配置"><a href="#server端配置" class="headerlink" title="server端配置:"></a>server端配置:</h2><h3 id="安装前的准备工作"><a href="#安装前的准备工作" class="headerlink" title="安装前的准备工作"></a>安装前的准备工作</h3><ol>
<li>关闭iptables和SELINUX</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># service iptables stop</span><br><span class="line"># setenforce 0</span><br><span class="line"># vi /etc/sysconfig/selinux</span><br><span class="line">---------------</span><br><span class="line">SELINUX=disabled</span><br><span class="line">---------------</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>同步时间</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ntpdate cn.pool.ntp.org</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><p><a href="http://www.showerlee.com/archives/73" target="_blank" rel="noopener">安装LNMP</a></p>
</li>
<li><p>安装GitLab的所需依赖包和工具</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># su -</span><br><span class="line"># rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-5-4.noarch.rpm</span><br><span class="line"># yum -y groupinstall &apos;Development Tools&apos;</span><br><span class="line"># yum -y install vim-enhanced readline readline-devel ncurses-devel gdbm-devel glibc-devel tcl-devel openssl-devel curl-devel expat-devel db4-devel byacc sqlite-devel gcc-c++ libyaml libyaml-devel libffi libffi-devel libxml2 libxml2-devel libxslt libxslt-devel libicu libicu-devel system-config-firewall-tui python-devel redis sudo wget crontabs logwatch logrotate perl-Time-HiRes git</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>配置redis<br>配置redis开机启动：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># chkconfig redis on</span><br><span class="line"># service redis start</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>更改gem源(若默认无法连接)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a.显示当前使用的sources</span><br><span class="line"># gem sources</span><br><span class="line">b.删除缺省source</span><br><span class="line"># gem sources -r http://rubygems.org/</span><br><span class="line">c.添加一个source</span><br><span class="line"># gem sources -a https://ruby.taobao.org</span><br><span class="line">d.更新source cache</span><br><span class="line"># gem sources -u</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>安装Ruby<br>a.<a href="http://www.showerlee.com/archives/1123" target="_blank" rel="noopener">源码安装Ruby</a><br>b.安装bundle组件：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># gem install bundler --no-ri --no-rdoc</span><br></pre></td></tr></table></figure>
<h3 id="安装GITLab-shell"><a href="#安装GITLab-shell" class="headerlink" title="安装GITLab shell"></a>安装GITLab shell</h3><ol>
<li>创建用户git</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># su -</span><br><span class="line"># adduser --system --shell /bin/bash --comment &apos;GitLab&apos; --create-home --home-dir /home/git/ git</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置GitLab shell<br>GitLab shell是专门为GitLab开发的提供ssh访问和版本管理的软件。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a.使用git账户登陆</span><br><span class="line"># su - git</span><br><span class="line">b.克隆gitlab shell</span><br><span class="line"># git clone https://github.com/gitlabhq/gitlab-shell.git</span><br><span class="line">c.切换成1.8.0版本，并编辑配置</span><br><span class="line"># cd gitlab-shell</span><br><span class="line"># git checkout v1.8.0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">d.拷贝配置文件</span><br><span class="line"># cp config.yml.example config.yml</span><br><span class="line"># vi config.yml</span><br><span class="line"># 将gitlab_url修改成gitlab的访问域名。例如本文档：https://git.example.com/</span><br><span class="line">gitlab_url: &quot;https://git.example.com&quot;</span><br><span class="line"># 将self_signed_cert修改成 true</span><br><span class="line">self_signed_cert: true</span><br><span class="line"># 添加网站SSL证书 </span><br><span class="line">ca_file: &quot;/usr/local/nginx/ssl/gitlab.crt&quot;</span><br></pre></td></tr></table></figure>
<p>注：如果gitlab是使用http访问，则需将https替换成http，配置文件中的self_signed_cert要修改成false，否则gitlab shell在通过api和gitlab进行通信的时候就会出现错误，导致项目push出错。因为后面配置web服务器的时候是使用ssl，所以这里要按照ssl的方式配置。<br>另外本文档的域名为测试域名，不要忘记在C/S两端均做好域名映射。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e.安装一些需要的目录和文件</span><br><span class="line"># ./bin/install</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>配置MySQL数据库</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a.登录数据库</span><br><span class="line"># mysql -u root -p</span><br><span class="line">b. 为gitlab创建使用用户</span><br><span class="line">&gt; create user gitlab@&apos;localhost&apos; identified by &apos;123456&apos;;</span><br><span class="line">c.创建gitlaba使用的数据库</span><br><span class="line">&gt; CREATE DATABASE IF NOT EXISTS `gitlabhq_production` DEFAULT CHARACTER SET `utf8` COLLATE `utf8_unicode_ci`;</span><br><span class="line">d.给予gitlab用户权限</span><br><span class="line">&gt; GRANT SELECT, LOCK TABLES, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON `gitlabhq_production`.* TO &apos;gitlab&apos;@&apos;localhost&apos;;</span><br></pre></td></tr></table></figure>
<h3 id="安装GitLab"><a href="#安装GitLab" class="headerlink" title="安装GitLab"></a>安装GitLab</h3><ol>
<li>将GitLab安装在git的家目录下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># su - git</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>克隆GitLab并切换分支到6-3-stable</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">a.克隆GitLab</span><br><span class="line"># git clone https://github.com/gitlabhq/gitlabhq.git gitlab</span><br><span class="line">b. 切换到6-3-stable分支</span><br><span class="line"># cd /home/git/gitlab</span><br><span class="line"># git checkout 6-3-stable</span><br><span class="line">c、配置项目</span><br><span class="line">a.复制配置文件</span><br><span class="line"># cp config/gitlab.yml.example config/gitlab.yml</span><br><span class="line">b.修改配置文件中的访问域名</span><br><span class="line"># sed -i &apos;s|localhost|git.example.com|g&apos; config/gitlab.yml</span><br><span class="line">d.设定log和tmp目录所有者和权限</span><br><span class="line"># chown -R git log/</span><br><span class="line"># chown -R git tmp/</span><br><span class="line"># chmod -R u+rwX log/</span><br><span class="line"># chmod -R u+rwX tmp/</span><br><span class="line">e.创建gitlab-satellites目录</span><br><span class="line"># mkdir /home/git/gitlab-satellites</span><br><span class="line">f.创建tmp/pids/和tmp/sockets/目录，确保gitlab有相应的权限</span><br><span class="line"># mkdir tmp/pids/</span><br><span class="line"># mkdir tmp/sockets/</span><br><span class="line"># chmod -R u+rwX tmp/pids/</span><br><span class="line"># chmod -R u+rwX tmp/sockets/</span><br><span class="line">g.创建public/uploads目录</span><br><span class="line"># mkdir public/uploads</span><br><span class="line"># chmod -R u+rwX public/uploads</span><br><span class="line">h.复制unicorn配置</span><br><span class="line"># cp config/unicorn.rb.example config/unicorn.rb</span><br><span class="line">i.保持unicorn配置文件默认配置</span><br><span class="line">g.配置git的用户和邮件</span><br><span class="line"># git config --global user.name &quot;GitLab&quot;</span><br><span class="line"># git config --global user.email &quot;gitlab@git.example.com”</span><br><span class="line"># git config --global core.autocrlf input</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">k.配置数据库访问文件</span><br><span class="line"># cp config/database.yml.mysql config/database.yml</span><br><span class="line">编辑config/database.yml，设置其中连接数据库的账号密码</span><br><span class="line"># vi config/database.yml</span><br><span class="line">———————————————————————————————————</span><br><span class="line">#</span><br><span class="line"># PRODUCTION</span><br><span class="line">#</span><br><span class="line">production:</span><br><span class="line">  adapter: mysql2</span><br><span class="line">  encoding: utf8</span><br><span class="line">  reconnect: false</span><br><span class="line">  database: gitlabhq_production</span><br><span class="line">  pool: 10</span><br><span class="line">  username: gitlab</span><br><span class="line">  password: “123456”</span><br><span class="line">  # host: localhost</span><br><span class="line">  # socket: /tmp/mysql.sock</span><br><span class="line">———————————————————————————————————</span><br><span class="line">修改其中username和password就可以了，其中密码就是上面数据库步骤中创建gitlab用户的密码。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">l.确保该文件只有git账号有权限读取。</span><br><span class="line"># chmod o-rwx config/database.yml</span><br></pre></td></tr></table></figure>
<h3 id="安装Gems"><a href="#安装Gems" class="headerlink" title="安装Gems"></a>安装Gems</h3><ol>
<li>安装charlock_holmes</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># su -</span><br><span class="line"># gem install charlock_holmes --version &apos;0.6.9.4&apos;</span><br><span class="line"># exit</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>安装mysql包</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># cd /home/git/gitlab/</span><br><span class="line"># vi Gemfile </span><br><span class="line">修改 https://rubygems.org 为 https://ruby.taobao.org</span><br><span class="line"># bundle install --deployment --without development test postgres puma aws</span><br><span class="line">若报Could not find modernizr-2.6.2 in any of the sources错误,没有则无视:</span><br><span class="line">修复方案:</span><br><span class="line"># vi Gemfile</span><br><span class="line">搜索该行   gem &quot;modernizr&quot;,        &quot;2.6.2&quot;</span><br><span class="line">更改为：   gem &quot;modernizr-rails&quot;,  &quot;2.7.1&quot;</span><br><span class="line"># vi Gemfile.lock</span><br><span class="line">搜索该行   modernizr (2.6.2)</span><br><span class="line">更改为：   modernizr-rails (2.7.1)</span><br><span class="line">搜索该行   modernizr (= 2.6.2)：</span><br><span class="line">更改为：   modernizr-rails (= 2.7.1)</span><br><span class="line">重新执行</span><br><span class="line"># bundle install --deployment --without development test postgres puma aws</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>初始化数据和激活高级功能</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cd /home/git/gitlab</span><br><span class="line"># bundle exec rake gitlab:setup RAILS_ENV=production</span><br><span class="line">这步完成后，会生一个默认的管理员账号/密码：</span><br><span class="line">admin@local.host/5iveL!fe</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>安装启动脚本</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># su -</span><br><span class="line"># wget -O /etc/init.d/gitlab https://raw.github.com/gitlabhq/gitlab-recipes/5-0-stable/init.d/gitlab</span><br><span class="line"># chmod +x /etc/init.d/gitlab</span><br></pre></td></tr></table></figure>
<p>5.开机时启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># chkconfig --add gitlab</span><br><span class="line"># chkconfig gitlab on</span><br></pre></td></tr></table></figure>
<p>6.检测应用程序状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># su - git</span><br><span class="line"># cd gitlab/</span><br><span class="line"># bundle exec rake gitlab:env:info RAILS_ENV=production</span><br><span class="line"># exit</span><br></pre></td></tr></table></figure>
<p>可以查看到系统、Ruby、GitLab和GitLab Shell的版本和其他信息。</p>
<ol start="7">
<li>启动GitLab实例</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># service gitlab start</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>查看应用更加详细的信息</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># su - git</span><br><span class="line"># cd gitlab/</span><br><span class="line"># bundle exec rake gitlab:check RAILS_ENV=production</span><br><span class="line">这里会提示一个Init script up-to-date的错误，如下：</span><br><span class="line">——————————————————————————————————————————————————</span><br><span class="line">Init script up-to-date? ... no</span><br><span class="line">Try fixing it:</span><br><span class="line">Redownload the init script</span><br><span class="line">For more information see:</span><br><span class="line">doc/install/installation.md in section &quot;Install Init Script&quot;</span><br><span class="line">Please fix the error above and rerun the checks.</span><br><span class="line">——————————————————————————————————————————————————</span><br><span class="line">查阅官方自带文档,说明此问题可忽略.</span><br></pre></td></tr></table></figure>
<h3 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h3><ol>
<li>配置Gitlab虚拟主机及SSL连接:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cd /usr/local/nginx/conf/vhosts/</span><br><span class="line"># vi gitlab-ssl.conf</span><br><span class="line">注: 这里先感谢提供此脚本的极客,该脚本在原基础上稍作改动.</span><br><span class="line">内容用红字标注的地方为需要自定义的地方.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">## GitLab</span><br><span class="line">## Contributors: randx, yin8086, sashkab, orkoden, axilleas</span><br><span class="line">## App Version: 5.4 - 6.0</span><br><span class="line">##</span><br><span class="line">## Modified from nginx http version</span><br><span class="line">## Modified from http://blog.phusion.nl/2012/04/21/tutorial-setting-up-gitlab-on-debian-6/</span><br><span class="line">##</span><br><span class="line">## Lines starting with two hashes (##) are comments containing information</span><br><span class="line">## for configuration. One hash (#) comments are actual configuration parameters</span><br><span class="line">## which you can comment/uncomment to your liking.</span><br><span class="line">##</span><br><span class="line">###################################</span><br><span class="line">##        SSL configuration      ##</span><br><span class="line">###################################</span><br><span class="line">##</span><br><span class="line">## Optimal configuration is taken from:</span><br><span class="line">## https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html</span><br><span class="line">## Make sure to read it and understand what each option does.</span><br><span class="line">##</span><br><span class="line">## [Optional] Generate a self-signed ssl certificate:</span><br><span class="line">##    mkdir /etc/nginx/ssl/</span><br><span class="line">##    cd /etc/nginx/ssl/</span><br><span class="line">##    sudo openssl req -newkey rsa:2048 -x509 -nodes -days 3560 -out gitlab.crt -keyout gitlab.key</span><br><span class="line">##    sudo chmod o-r gitlab.key</span><br><span class="line">##</span><br><span class="line">## Edit `gitlab-shell/config.yml`:</span><br><span class="line">##  1) Set &quot;gitlab_url&quot; param in `gitlab-shell/config.yml` to `https://git.example.com`</span><br><span class="line">##  2) Set &quot;ca_file&quot; to `/etc/nginx/ssl/gitlab.crt`</span><br><span class="line">##  3) Set &quot;self_signed_cert&quot; to `true`</span><br><span class="line">## Edit `gitlab/config/gitlab.yml`:</span><br><span class="line">##  1) Define port for http &quot;port: 443&quot;</span><br><span class="line">##  2) Enable https &quot;https: true&quot;</span><br><span class="line">##  3) Update ssl for gravatar &quot;ssl_url: https://secure.gravatar.com/avatar/%&#123;hash&#125;?s=%&#123;size&#125;&amp;d=mm&quot;</span><br><span class="line">##</span><br><span class="line">##################################</span><br><span class="line">##        CHUNKED TRANSFER      ##</span><br><span class="line">##################################</span><br><span class="line">##</span><br><span class="line">## It is a known issue that Git-over-HTTP requires chunked transfer encoding [0]</span><br><span class="line">## which is not supported by Nginx &lt; 1.3.9 [1]. As a result, pushing a large object</span><br><span class="line">## with Git (i.e. a single large file) can lead to a 411 error. In theory you can get</span><br><span class="line">## around this by tweaking this configuration file and either:</span><br><span class="line">## - installing an old version of Nginx with the chunkin module [2] compiled in, or</span><br><span class="line">## - using a newer version of Nginx.</span><br><span class="line">##</span><br><span class="line">## At the time of writing we do not know if either of these theoretical solutions works. As a workaround</span><br><span class="line">## users can use Git over SSH to push large files.</span><br><span class="line">##</span><br><span class="line">## [0] https://git.kernel.org/cgit/git/git.git/tree/Documentation/technical/http-protocol.txt#n99</span><br><span class="line">## [1] https://github.com/agentzh/chunkin-nginx-module#status</span><br><span class="line">## [2] https://github.com/agentzh/chunkin-nginx-module</span><br><span class="line">upstream gitlab &#123;</span><br><span class="line">  ## Uncomment if you have set up puma/unicorn to listen on a unix socket (recommended).</span><br><span class="line">  server unix:/home/git/gitlab/tmp/sockets/gitlab.socket;</span><br><span class="line">  ## Uncomment if puma/unicorn are configured to listen on a tcp port.</span><br><span class="line">  ## Check the port number in /home/git/gitlab/config/&#123;puma.rb/unicorn.rb&#125;</span><br><span class="line">  # server 127.0.0.1:8080;</span><br><span class="line">&#125;</span><br><span class="line">## This is a normal HTTP host which redirects all traffic to the HTTPS host.</span><br><span class="line">server &#123;</span><br><span class="line">  listen *:80;</span><br><span class="line">  ## Replace git.example.com with your FQDN.</span><br><span class="line">  server_name git.example.com;</span><br><span class="line">  server_tokens off;</span><br><span class="line">  ## This doesn&apos;t have to be a valid path since we are redirecting,</span><br><span class="line">  ## you don&apos;t have to change it.</span><br><span class="line">  root /nowhere;</span><br><span class="line">  rewrite ^ https://$server_name$request_uri permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl;</span><br><span class="line">  ## Replace git.example.com with your FQDN.</span><br><span class="line">  server_name git.example.com;</span><br><span class="line">  server_tokens off;</span><br><span class="line">  root /home/git/gitlab/public;</span><br><span class="line">  ## Increase this if you want to upload large attachments</span><br><span class="line">  ## Or if you want to accept large git objects over http</span><br><span class="line">  client_max_body_size 20m;</span><br><span class="line">  ## Strong SSL Security</span><br><span class="line">  ## https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html</span><br><span class="line">  ssl on;</span><br><span class="line">  ssl_certificate /usr/local/nginx/ssl/gitlab.crt;</span><br><span class="line">  ssl_certificate_key /usr/local/nginx/ssl/gitlab.key;</span><br><span class="line">  ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">  ssl_session_cache  builtin:1000  shared:SSL:10m;</span><br><span class="line"></span><br><span class="line">  #add_header Strict-Transport-Security max-age=63072000;</span><br><span class="line">  #add_header X-Frame-Options DENY;</span><br><span class="line">  #add_header X-Content-Type-Options nosniff;</span><br><span class="line">  ## Individual nginx logs for this GitLab vhost</span><br><span class="line">  access_log  /usr/local/nginx/logs/gitlab_access.log;</span><br><span class="line">  error_log   /usr/local/nginx/logs/gitlab_error.log;</span><br><span class="line">  location / &#123;</span><br><span class="line">    ## Serve static files from defined root folder.</span><br><span class="line">    ## @gitlab is a named location for the upstream fallback, see below.</span><br><span class="line">    try_files $uri $uri/index.html $uri.html @gitlab;</span><br><span class="line">  &#125;</span><br><span class="line">  ## If a file, which is not found in the root folder is requested,</span><br><span class="line">  ## then the proxy pass the request to the upsteam (gitlab unicorn).</span><br><span class="line">  location @gitlab &#123;</span><br><span class="line">    ## If you use https make sure you disable gzip compression</span><br><span class="line">    ## to be safe against BREACH attack.</span><br><span class="line">    gzip off;</span><br><span class="line">    ## https://github.com/gitlabhq/gitlabhq/issues/694</span><br><span class="line">    ## Some requests take more than 30 seconds.</span><br><span class="line">    proxy_read_timeout      300;</span><br><span class="line">    proxy_connect_timeout   300;</span><br><span class="line">    proxy_redirect          off;</span><br><span class="line">    proxy_set_header   Host              $http_host;</span><br><span class="line">    proxy_set_header   X-Real-IP         $remote_addr;</span><br><span class="line">    proxy_set_header   X-Forwarded-Ssl   on;</span><br><span class="line">    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header   X-Forwarded-Proto $scheme;</span><br><span class="line">    proxy_pass http://127.0.0.1:8080;</span><br><span class="line">  &#125;</span><br><span class="line">  ## Enable gzip compression as per rails guide:</span><br><span class="line">  ## http://guides.rubyonrails.org/asset_pipeline.html#gzip-compression</span><br><span class="line">  location ~ ^/(assets)/ &#123;</span><br><span class="line">    root /home/git/gitlab/public;</span><br><span class="line">    gzip_static on; # to serve pre-gzipped version</span><br><span class="line">    expires max;</span><br><span class="line">    add_header Cache-Control public;</span><br><span class="line">  &#125;</span><br><span class="line">  error_page 502 /502.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>将nginx加入git用户组(重要)</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># usermod -a -G git nginx</span><br><span class="line"># chmod g+rx /home/git/</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>生成ssl证书</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mkdir /usr/local/nginx/ssl</span><br><span class="line"># cd /usr/local/nginx/ssl</span><br><span class="line"># openssl req -new -x509 -nodes -days 3560 -out gitlab.crt -keyout gitlab.key</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>开启Git over SSL</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># vi /home/git/gitlab/config/gitlab.yml</span><br><span class="line">  ## GitLab settings</span><br><span class="line">  gitlab:</span><br><span class="line">    ## Web server settings</span><br><span class="line">    host: git.example.com</span><br><span class="line">    port: 443</span><br><span class="line">    https: true</span><br><span class="line"># vi /home/git/gitlab-shell/config.yml</span><br><span class="line">gitlab_url: &quot;https://git.example.com&quot;</span><br><span class="line">http_settings:</span><br><span class="line">#  user: someone</span><br><span class="line">#  password: somepass</span><br><span class="line">#  ca_file: /etc/ssl/cert.pem</span><br><span class="line">#  ca_path: /etc/ssl/</span><br><span class="line">  self_signed_cert: true</span><br><span class="line"></span><br><span class="line">ca_file: &quot;/usr/local/nginx/ssl/gitlab.crt&quot;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>启动nginx</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># service nginx start</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>打开web页面 git.example.com<br>nginx直接跳转URL为<a href="https://git.example.com" target="_blank" rel="noopener">https://git.example.com</a></li>
</ol>
<p>GitLab默认的账号密码如下:<br><a href="mailto:admin@local.host" target="_blank" rel="noopener">admin@local.host</a>/5iveL!fe</p>
<h2 id="Client端配置"><a href="#Client端配置" class="headerlink" title="Client端配置:"></a>Client端配置:</h2><h3 id="上传git仓库"><a href="#上传git仓库" class="headerlink" title="上传git仓库"></a>上传git仓库</h3><ol>
<li>客户端生成秘钥</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd ~</span><br><span class="line"># ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>
<p>一路回车后生成公钥和秘钥对<br>$ cat ~/.ssh/id_rsa.pub </p>
<p>将这里生成的公钥全部复制并粘贴到gitlab web SSH Keys后台保存即可。</p>
<ol start="2">
<li>测试SSH连接</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ssh -p22 git@git.example.com</span><br></pre></td></tr></table></figure>
<p>若报如下错误:<br>——————————————————————————————————————<br>PTY allocation request failed on channel 1<br>/usr/bin/env: ruby: No such file or directory<br>Connection to git.example.com closed.<br>——————————————————————————————————————<br>说明服务端ruby环境变量未在此目录/usr/bin/ruby<br>在服务器端加此软链即可:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ln -s /usr/local/ruby/bin/ruby /usr/bin/ruby</span><br></pre></td></tr></table></figure>
<p>注:若服务器端SSH自定义端口,则需要在客户端~/.ssh/config下添加端口配置<br>假定自定义SSH端口为2222</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># echo “Port 2222” &gt;&gt; ~/.ssh/config</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>命令行上传git仓库</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># su - </span><br><span class="line"># mkdir testprojiect</span><br><span class="line"># cd testprojiect/</span><br><span class="line"># git init</span><br><span class="line"># echo &quot;What a fucking Hello World&quot; &gt; readme.txt</span><br><span class="line"># git add .</span><br><span class="line"># git commit -m &apos;first commit&apos;</span><br><span class="line"># git remote add origin git@git.example.com:root/testproject.git</span><br><span class="line"># git push -u origin master</span><br></pre></td></tr></table></figure>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">注: 若主页CSS出现错误未加载, 可从新编译assets, 可从新获取CSS文件.</span><br><span class="line"># cd /home/git/gitlab</span><br><span class="line"># bundle exec rake assets:precompile RAILS_ENV=production</span><br><span class="line"></span><br><span class="line">注: 解决Gravatar的头像加载timeout问题</span><br><span class="line">搜索plain_url部分, 将原有部分改成:</span><br><span class="line">plain_url: &quot;http://gravatar.duoshuo.com/avatar/%&#123;hash&#125;?s=%&#123;size&#125;&amp;d=identicon&quot;</span><br><span class="line">#cd /home/git/gitlab</span><br><span class="line">清除缓存</span><br><span class="line"># RAILS_ENV=production bundle exec rake cache:clear</span><br><span class="line"># service gitlab restart</span><br><span class="line"></span><br><span class="line">注: 解决内存耗尽问题</span><br><span class="line">如果你的VPS 为1G内存+1核处理器</span><br><span class="line">建议将默认的unicorn worker_process设置为2, timeout设定为60s, 这样就不会因为长时间加载web页面而出现timeout等问题.</span><br><span class="line"># vi /home/git/gitlab/config/unicorn.rb</span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Gitlab/">Gitlab</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Ansible安装配置" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/15/Ansible安装配置/" class="article-date">
      <time datetime="2016-03-15T00:24:13.000Z" itemprop="datePublished">2016-03-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/15/Ansible安装配置/">Ansible安装配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://www.showerlee.com/archives/1649" target="_blank" rel="noopener">Ansible安装部署</a></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Ansible是一种集成IT系统的配置管理, 应用部署, 执行特定任务的开源平台. 它基于Python语言实现, 部署只需在主控端部署Ansible环境, 被控端无需安装代理工具, 只需打开SSH, 让主控端通过SSH秘钥认证对其进行所有的管理监控操作. 相对于SaltStack, 它除了利用SSH安全传输, 无需在客户端进行任何配置, 而且它有一个很庞大的用户群体以及丰富的API, 相对适合部署到数量比较大且对系统软件安装要求比较严格的集群中.<br>更多配置参考: <a href="https://github.com/ansible" target="_blank" rel="noopener">https://github.com/ansible</a><br>官方文档: <a href="http://docs.ansible.com/ansible" target="_blank" rel="noopener">http://docs.ansible.com/ansible</a></p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>安装环境:<br>System: Centos 6.7 x64<br>Master: master.example.com<br>Minion: client01.example.com<br>Minion: client02.example.com</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h2><ol>
<li>关闭iptables和SELINUX</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># service iptables stop</span><br><span class="line"># setenforce 0</span><br><span class="line"># vi /etc/sysconfig/selinux</span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>Master端安装EPEL第三方yum源</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># rpm -Uvh http://ftp.linux.ncsu.edu/pub/epel/6/i386/epel-release-6-8.noarch.rpm</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>安装Ansible<br>a. yum</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install ansible -y</span><br></pre></td></tr></table></figure>
<p>b.pip<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install ansible</span><br></pre></td></tr></table></figure></p>
<ol start="4">
<li>添加环境变量以便vi能正常显示中文注释.</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vi /etc/profile</span><br><span class="line">添加:</span><br><span class="line">export LC_ALL=en_US.UTF-8</span><br><span class="line">export LANG=en_US.UTF-8</span><br><span class="line">export LANGUAGE=en_US.UTF-8</span><br><span class="line"># source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="初始配置"><a href="#初始配置" class="headerlink" title="初始配置"></a>初始配置</h2><ol>
<li>修改主机及组配置</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># cd /etc/ansible</span><br><span class="line"># cp hosts hosts.bak</span><br><span class="line"># cat /dev/null &gt; hosts</span><br><span class="line"># vi /etc/ansible/hosts</span><br><span class="line">[webservers]</span><br><span class="line">client01.example.com</span><br><span class="line">client02.example.com</span><br><span class="line">[nginx01]</span><br><span class="line">client01.example.com</span><br><span class="line">[nginx02]</span><br><span class="line">client02.example.com</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置SSH秘钥认证</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum install ssh* -y</span><br><span class="line"># ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>
<p>同步公钥文件id_rsa.pub到目标主机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ssh-copy-id -i /root/.ssh/id_rsa.pub root@client01.example.com</span><br><span class="line"># ssh-copy-id -i /root/.ssh/id_rsa.pub root@client02.example.com</span><br></pre></td></tr></table></figure>
<p>校验SSH免密码配置是否成功.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ssh root@client02.example.com</span><br></pre></td></tr></table></figure>
<p>如直接进入则配置完成.</p>
<ol start="3">
<li>定义主机与组<br>所有定义的主机与组规则都在/etc/Ansible/hosts下.<br>常见的写法:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.21:2135 定义一个IP为192.168.1.21, SSH端口为2135的主机.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jumper ansible_ssh_port=22 ansible_ssh_host=192.168.1.50 定义一个别名为jumper, SSH端口为22, IP为192.168.1.50的主机. </span><br><span class="line">组成员主机名称范例:</span><br><span class="line">[webservers]</span><br><span class="line">www[001:006].example.com</span><br><span class="line">[dbservers]</span><br><span class="line">db-[a:f].example.com</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>定义主机变量<br>主机可以指定变量, 后面可以供Playbooks调用</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[atlanta]</span><br><span class="line">host1 http_port=80 maxRequestsPerChild=808</span><br><span class="line">host2 http_port=8080 maxRequestsPerChild=909</span><br><span class="line">5.定义组变量</span><br><span class="line">[atlanta]</span><br><span class="line">host1</span><br><span class="line">host2</span><br><span class="line"></span><br><span class="line">[atlanta:vars]</span><br><span class="line">ntp_server=ntp.atlanta.example.com</span><br><span class="line">proxy=proxy.atlanta.example.com</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>匹配目标<br>重启webservers组所有SSH服务.</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible webservers -m service -a &quot;name=sshd state=restarted&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Ansible常用模块及API"><a href="#Ansible常用模块及API" class="headerlink" title="Ansible常用模块及API"></a>Ansible常用模块及API</h2><ol>
<li>远程命令模块<br>command: 执行远程主机SHELL命令:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible webservers -m command -a &quot;free -m&quot;</span><br></pre></td></tr></table></figure>
<p>script: 远程执行MASTER本地SHELL脚本.(类似scp+shell)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line"># echo &quot;df -h&quot; &gt; ~/test.sh</span><br><span class="line"># ansible webservers -m script -a &quot;~/test.sh&quot;</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">2. copy模块</span><br><span class="line">实现主控端向目标主机拷贝文件, 类似scp功能.</span><br><span class="line">该实例实现~/test.sh文件至webservers组目标主机/tmp下, 并更新文件owner和group</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># ansible webservers -m copy -a &quot;src=~/test.sh dest=/tmp/ owner=root group=root mode=0755&quot;</span><br><span class="line"># ansible webservers -m copy -a &quot;src=~/test.sh dest=/tmp/ owner=root group=root mode=0755&quot;</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">3. stat模块</span><br><span class="line">获取远程文件状态信息, 包括atime, ctime, mtime, md5, uid, gid等信息.</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># ansible webservers -m stat -a &quot;path=/etc/sysctl.conf&quot;</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">4. get_url模块</span><br><span class="line">实现在远程主机下载指定URL到本地.</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># ansible webservers -m get_url -a &quot;url=http://www.showerlee.com dest=/tmp/index.html mode=0400 force=yes&quot;</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">5. yum模块</span><br><span class="line">Linux包管理平台操作,  常见都会有yum和apt, 此处会调用yum管理模式</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># ansible servers -m yum -a &quot;name=curl state=latest&quot;</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">6. cron模块</span><br><span class="line">远程主机crontab配置</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># ansible webservers -m cron -a &quot;name=&apos;check dir&apos; hour=&apos;5,2&apos; job=&apos;ls -alh &gt; /dev/null&apos;&quot;</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">7. service模块</span><br><span class="line">远程主机系统服务管理</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># ansible webservers -m service -a &quot;name=crond state=stopped&quot;</span><br><span class="line"># ansible webservers -m service -a &quot;name=crond state=restarted&quot;</span><br><span class="line"># ansible webservers -m service -a &quot;name=crond state=reloaded&quot;</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">8. user服务模块</span><br><span class="line">远程主机系统用户管理</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line">添加用户:</span><br><span class="line"># ansible webservers -m user -a &quot;name=johnd comment=&apos;John Doe&apos;&quot;</span><br><span class="line">删除用户:</span><br><span class="line"># ansible webservers -m user -a &quot;name=johnd state=absent remove=yes&quot;</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">## playbook介绍</span><br><span class="line">playbook是一个不同于使用Ansible命令行执行方式的模式, 其功能是将大量命令行配置集成到一起形成一个可定制的多主机配置管理部署工具.</span><br><span class="line">它通过YAML格式定义, 可以实现向多台主机的分发应用部署.</span><br><span class="line">以下给大家详细介绍一个针对nginx嵌套复用结构的</span><br><span class="line">playbook部署实例:</span><br><span class="line"></span><br><span class="line">1. 构建目录结构</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># cd /etc/ansible/</span><br><span class="line"># mkdir group_vars</span><br><span class="line"># mkdir roles</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">2. 定义host</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># vi /etc/ansible/hosts</span><br><span class="line">[webservers]</span><br><span class="line">client01.example.com</span><br><span class="line">client02.example.com</span><br><span class="line">[nginx01]</span><br><span class="line">client01.example.com</span><br><span class="line">[nginx02]</span><br><span class="line">client02.example.com</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">3. 定义变量</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># vi /etc/ansible/group_vars/nginx01</span><br><span class="line">worker_processes: 4</span><br><span class="line">num_cpus: 4</span><br><span class="line">max_open_file: 65506</span><br><span class="line">root: /data</span><br><span class="line">remote_user: root</span><br><span class="line"># vi /etc/ansible/group_vars/nginx02</span><br><span class="line">worker_processes: 2</span><br><span class="line">num_cpus: 2</span><br><span class="line">max_open_file: 35506</span><br><span class="line">root: /www</span><br><span class="line">remote_user: root</span><br><span class="line">​```</span><br><span class="line">Tips:这里在group_vars下定义的文件名必须对应hosts文件下的group标签, 通过这里定义的不同参数从而部署不同类型的主机配置.</span><br><span class="line"></span><br><span class="line">4. 创建roles入口文件</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># vi /etc/ansible/site.yml</span><br><span class="line">- hosts: webservers</span><br><span class="line">  roles:</span><br><span class="line">  - base_env</span><br><span class="line">- hosts: nginx01</span><br><span class="line">  roles:</span><br><span class="line">  - nginx01</span><br><span class="line">- hosts: nginx02</span><br><span class="line">  roles:</span><br><span class="line">  - nginx02</span><br><span class="line">​```</span><br><span class="line">Tips: 这里的roles:下的字符串需对应roles目录下的目录名.</span><br><span class="line"></span><br><span class="line">5. 定义全局role base_env</span><br><span class="line">创建目录结构</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># mkdir -p /etc/ansible/roles/base_env/tasks </span><br><span class="line"># vi /etc/ansible/roles/base_env/tasks/main.yml</span><br><span class="line"># 将EPEL的yum源配置文件传送到客户端</span><br><span class="line">- name: Create the contains common plays that will run on all nodes </span><br><span class="line">  copy: src=epel.repo dest=/etc/yum.repos.d/epel.repo</span><br><span class="line">- name: Create the GPG key for EPEL</span><br><span class="line">  copy: src=RPM-GPG-KEY-EPEL-6 dest=/etc/pki/rpm-gpg</span><br><span class="line">  </span><br><span class="line"># 关闭SELINUX</span><br><span class="line">- name: test to see if selling is running</span><br><span class="line">  command: getenforce</span><br><span class="line">  register: sestatus</span><br><span class="line">  changed_when: false</span><br><span class="line"></span><br><span class="line"># 删除iptables默认规则并保存</span><br><span class="line">- name: remove the default iptables rules</span><br><span class="line">  command: iptables -F</span><br><span class="line">- name: save iptables rules</span><br><span class="line">  command: service iptables save</span><br><span class="line">将对应需要拷贝到远程的文件复制到base_env/files目录下</span><br><span class="line"># mkdir -p  /etc/ansible/roles/base_env/files</span><br><span class="line"># cp /etc/yum.repos.d/epel.repo /etc/ansible/roles/base_env/files</span><br><span class="line"># cp /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 /etc/ansible/roles/base_env/files</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">6. 定义nginx01和ngnix02 role</span><br><span class="line">创建目录结构</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># mkdir -p /etc/ansible/roles/nginx&#123;01,02&#125;</span><br><span class="line"># mkdir -p /etc/ansible/roles/nginx01/tasks</span><br><span class="line"># mkdir -p /etc/ansible/roles/nginx02/tasks</span><br><span class="line"># vi /etc/ansible/roles/nginx01/tasks/main.yml</span><br><span class="line"> # 安装nginx最新版本</span><br><span class="line">- name: ensure nginx is at the latest version</span><br><span class="line">  yum: pkg=nginx state=latest</span><br><span class="line"></span><br><span class="line"># 将nginx配置文件传送到远程目录</span><br><span class="line">- name: write the nginx config file</span><br><span class="line">  template: src=nginx.conf dest=/etc/nginx/nginx.conf</span><br><span class="line">  notify: restart nginx # 重启nginx</span><br><span class="line"></span><br><span class="line"># 创建nginx根目录</span><br><span class="line">- name: Create Web Root</span><br><span class="line">  file: dest=&#123;&#123; root &#125;&#125; mode=775 state=directory owner=nginx group=nginx</span><br><span class="line">  notify: reload nginx</span><br><span class="line">- name: ensure nginx is running</span><br><span class="line">  service: name=nginx state=restarted</span><br><span class="line"># cp /home/ansible/roles/nginx01/tasks/main.yml /home/ansible/roles/nginx02/tasks/main.yml</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">7. 定义files</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># mkdir -p /etc/ansible/roles/nginx01/templates</span><br><span class="line"># mkdir -p /etc/ansible/roles/nginx02/templates</span><br><span class="line"># vi /etc/ansible/roles/nginx01/templates/nginx.conf</span><br><span class="line"># For more information on configuration, see: </span><br><span class="line"></span><br><span class="line">user              nginx;  </span><br><span class="line">worker_processes  &#123;&#123; worker_processes &#125;&#125;;  </span><br><span class="line">&#123;% if num_cpus == 2 %&#125;  </span><br><span class="line">worker_cpu_affinity 01 10;  </span><br><span class="line">&#123;% elif num_cpus == 4 %&#125;  </span><br><span class="line">worker_cpu_affinity 1000 0100 0010 0001;  </span><br><span class="line">&#123;% elif num_cpus &gt;= 8 %&#125;  </span><br><span class="line">worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;  </span><br><span class="line">&#123;% else %&#125;  </span><br><span class="line">worker_cpu_affinity 1000 0100 0010 0001;  </span><br><span class="line">&#123;% endif %&#125;  </span><br><span class="line">worker_rlimit_nofile &#123;&#123; max_open_file &#125;&#125;;  </span><br><span class="line">  </span><br><span class="line">error_log  /var/log/nginx/error.log;  </span><br><span class="line">#error_log  /var/log/nginx/error.log  notice;  </span><br><span class="line">#error_log  /var/log/nginx/error.log  info;  </span><br><span class="line">  </span><br><span class="line">pid        /var/run/nginx.pid;  </span><br><span class="line">  </span><br><span class="line">events &#123;  </span><br><span class="line">    worker_connections  &#123;&#123; max_open_file &#125;&#125;;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">http &#123;  </span><br><span class="line">    include       /etc/nginx/mime.types;  </span><br><span class="line">    default_type  application/octet-stream;  </span><br><span class="line">  </span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;  </span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;  </span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;  </span><br><span class="line">  </span><br><span class="line">    access_log  /var/log/nginx/access.log  main;  </span><br><span class="line">  </span><br><span class="line">    sendfile        on;  </span><br><span class="line">    #tcp_nopush     on;  </span><br><span class="line">  </span><br><span class="line">    #keepalive_timeout  0;  </span><br><span class="line">    keepalive_timeout  65;  </span><br><span class="line">  </span><br><span class="line">    #gzip  on;  </span><br><span class="line">      </span><br><span class="line">    # Load config files from the /etc/nginx/conf.d directory  </span><br><span class="line">    # The default server is in conf.d/default.conf  </span><br><span class="line">    #include /etc/nginx/conf.d/*.conf;  </span><br><span class="line">    server &#123;  </span><br><span class="line">        listen       80 default_server;  </span><br><span class="line">        server_name  _;  </span><br><span class="line">  </span><br><span class="line">        #charset koi8-r;  </span><br><span class="line">  </span><br><span class="line">        #access_log  logs/host.access.log  main;  </span><br><span class="line">  </span><br><span class="line">        location / &#123;  </span><br><span class="line">            root   &#123;&#123; root &#125;&#125;;  </span><br><span class="line">            index  index.html index.htm;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        error_page  404              /404.html;  </span><br><span class="line">        location = /404.html &#123;  </span><br><span class="line">            root   /usr/share/nginx/html;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        # redirect server error pages to the static page /50x.html  </span><br><span class="line">        #  </span><br><span class="line">        error_page   500 502 503 504  /50x.html;  </span><br><span class="line">        location = /50x.html &#123;  </span><br><span class="line">            root   /usr/share/nginx/html;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125; </span><br><span class="line">​```</span><br><span class="line">Tip: worker_processes, num_cpus, max_open_file, root等参数会调用group_vars目录下配置文件中相应的变量值</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># cp /etc/ansible/roles/nginx01/templates/nginx.conf  /etc/ansible/roles/nginx02/templates/nginx.conf</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">8. 执行playbook</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line"># ansible-playbook -i /etc/ansible/hosts /etc/ansible/site.yml -f 10</span><br><span class="line">​```</span><br><span class="line">Tips: -f 为启动10个并行进程执行playbook, -i 定义inventory host文件, site.yml 为入口文件 </span><br><span class="line"></span><br><span class="line">最终部署目录结构如下</span><br><span class="line">​```</span><br><span class="line"># tree /etc/ansible/</span><br><span class="line">/etc/ansible/</span><br><span class="line">├── ansible.cfg</span><br><span class="line">├── group_vars</span><br><span class="line">│   ├── nginx01</span><br><span class="line">│   └── nginx02</span><br><span class="line">├── hosts</span><br><span class="line">├── hosts.bak</span><br><span class="line">├── roles</span><br><span class="line">│   ├── base_env</span><br><span class="line">│   │   ├── files</span><br><span class="line">│   │   │   ├── epel.repo</span><br><span class="line">│   │   │   └── RPM-GPG-KEY-EPEL-6</span><br><span class="line">│   │   └── tasks</span><br><span class="line">│   │       └── main.yml</span><br><span class="line">│   ├── nginx01</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── templates</span><br><span class="line">│   │       └── nginx.conf</span><br><span class="line">│   └── nginx02</span><br><span class="line">│       ├── tasks</span><br><span class="line">│       │   └── main.yml</span><br><span class="line">│       └── templates</span><br><span class="line">│           └── nginx.conf</span><br><span class="line">└── site.yml</span><br><span class="line"></span><br><span class="line">11 directories, 13 files</span><br><span class="line">​```</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release</span><br><span class="line">yum install -y python-pip sshpass</span><br><span class="line"></span><br><span class="line">pip install --upgrade pip</span><br><span class="line">pip install ansible</span><br></pre></td></tr></table></figure>
<p>ansible –version</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 2.4.2.0</span><br></pre></td></tr></table></figure>
<p>注：pip方式安装不会在/etc/ansible目录下生成默认的相关配置文件</p>
<p>ansible控制的主机<br>vim /etc/ansible/hosts </p>
<p>ansible配置<br>vim /etc/ansible/ansible.cfg</p>
<h2 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h2><p>ansible playbook</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim ssh-addkey.yml </span><br><span class="line"></span><br><span class="line"># ssh-addkey.yml </span><br><span class="line">---</span><br><span class="line">- hosts: s1</span><br><span class="line">  gather_facts: no</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: install ssh key</span><br><span class="line">    authorized_key: user=root </span><br><span class="line">                    key=&quot;&#123;&#123; lookup(&apos;file&apos;, &apos;/root/.ssh/id_rsa.pub&apos;) &#125;&#125;&quot; </span><br><span class="line">                    state=present</span><br></pre></td></tr></table></figure>
<p>运行playbook</p>
<p>ansible-playbook -i hosts ssh-addkey.yml</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ansible/">Ansible</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Jenkins安装部署" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/15/Jenkins安装部署/" class="article-date">
      <time datetime="2016-03-14T23:43:04.000Z" itemprop="datePublished">2016-03-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/15/Jenkins安装部署/">Jenkins安装部署</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>Jenkins安装部署</p>
<p>下载 jenkins war包<br>下载tomcat<br>下载jdk</p>
<p>###配置jenkins安装环境<br>建立/usr/local/下的jdk软连接方便以后版本升级 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/local/jdk1.8.0_151 /usr/local/jdk</span><br><span class="line">ln -s /usr/local/apache-tomcat-8.5.23 /usr/local/tomcat</span><br></pre></td></tr></table></figure>
<p>mkdir /data/webapps -p</p>
<p>/usr/local/tomcat/conf</p>
<h3 id="启动tomcat"><a href="#启动tomcat" class="headerlink" title="启动tomcat"></a>启动tomcat</h3><p><code>./startup.sh</code><br>server.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Connector port=&quot;80&quot; </span><br><span class="line"></span><br><span class="line">&lt;Host name=&quot;jenkins.ovwane.com&quot;  appBase=&quot;/data/webapps&quot;</span><br><span class="line">149             unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jenkins/">Jenkins</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Tomcat安装配置" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/07/Tomcat安装配置/" class="article-date">
      <time datetime="2016-03-07T12:15:00.000Z" itemprop="datePublished">2016-03-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/07/Tomcat安装配置/">Tomcat安装配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://www.zyops.com/java-tomcat" target="_blank" rel="noopener">Tomcat安装配置</a></p>
<h2 id="安装Tomcat"><a href="#安装Tomcat" class="headerlink" title="安装Tomcat"></a>安装Tomcat</h2><ul>
<li><p><a href="JDK安装配置.md">JDK安装配置</a></p>
</li>
<li><p>下载 <a href="http://tomcat.apache.org/" target="_blank" rel="noopener">Apache tomcat</a></p>
</li>
<li><p>安装Tomcat</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解压缩tomcat</span></span><br><span class="line">tar xf apache-tomcat-8.5.23.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line"><span class="comment">#软链接</span></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/apache-tomcat-8.5.23 /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line"><span class="comment">#添加系统变量</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export TOMCAT_HOME=/usr/local/tomcat'</span>&gt;&gt;/etc/profile</span><br><span class="line"><span class="comment">#立即生效系统变量</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment">#更改tomcat的权限</span></span><br><span class="line">chown -R root:root /usr/<span class="built_in">local</span>/apache-tomcat-8.5.23</span><br></pre></td></tr></table></figure>
<h2 id="启动Tomcat"><a href="#启动Tomcat" class="headerlink" title="启动Tomcat"></a>启动Tomcat</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动程序</span></span><br><span class="line">tomcat/bin/startup.sh</span><br><span class="line"><span class="comment">#关闭程序</span></span><br><span class="line">tomcat/bin/shutdown.sh</span><br><span class="line"><span class="comment">#查看网络</span></span><br><span class="line">netstat -tunlp|grep java</span><br><span class="line"><span class="comment">#查看进程</span></span><br><span class="line">ps -ef|grep [j]ava</span><br></pre></td></tr></table></figure>
<p>访问网站<br>网址：<a href="http://IP:8080/" target="_blank" rel="noopener">http://IP:8080/</a></p>
<p>Tomcat日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入日志目录</span></span><br><span class="line"><span class="built_in">cd</span> tomcat/logs/</span><br><span class="line"><span class="comment">#tomcat实时运行日志</span></span><br><span class="line">tail -f catalina.out</span><br><span class="line"><span class="comment">#访问日志</span></span><br><span class="line">tail -f 域名_access_log.日期.txt</span><br></pre></td></tr></table></figure>
<p>Tomcat配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> tomcat/conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#主配置文件</span></span><br><span class="line">server.xml</span><br><span class="line"><span class="comment">#Tomcat管理用户配置文件</span></span><br><span class="line">tomcat-users.xml</span><br></pre></td></tr></table></figure>
<p>站点目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> tomcat/webapps/ROOT</span><br></pre></td></tr></table></figure>
<h2 id="Tomcat简介"><a href="#Tomcat简介" class="headerlink" title="Tomcat简介"></a>Tomcat简介</h2><p>Tomcat是Apache软件基金会（Apache Software Foundation）的Jakarta 项目中的一个核心项目，由Apache、Sun和其他一些公司及个人共同开发而成。</p>
<p>Tomcat服务器是一个免费的开放源代码的Web应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP程序的首选。</p>
<p>Tomcat和Nginx、Apache(httpd)、lighttpd等Web服务器一样，具有处理HTML页面的功能，另外它还是一个Servlet和JSP容器，独立的Servlet容器是Tomcat的默认模式。不过，Tomcat处理静态HTML的能力不如Nginx/Apache服务器。</p>
<blockquote>
<p>目前Tomcat最新版本为9.0。Java容器应用还有resin、weblogic等。</p>
</blockquote>
<h2 id="Tomcat目录介绍"><a href="#Tomcat目录介绍" class="headerlink" title="Tomcat目录介绍"></a>Tomcat目录介绍</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cd /application/tomcat/</span><br><span class="line"></span><br><span class="line">tree -L 1</span><br><span class="line">.</span><br><span class="line">├── bin         #→用以启动、关闭Tomcat或者其它功能的脚本（.bat文件和.sh文件）</span><br><span class="line">├── conf        #→用以配置Tomcat的XML及DTD文件</span><br><span class="line">├── lib         #→存放web应用能访问的JAR包</span><br><span class="line">├── LICENSE</span><br><span class="line">├── logs        #→Catalina和其它Web应用程序的日志文件</span><br><span class="line">├── NOTICE</span><br><span class="line">├── RELEASE-NOTES</span><br><span class="line">├── RUNNING.txt</span><br><span class="line">├── temp        #→临时文件</span><br><span class="line">├── webapps     #→Web应用程序根目录</span><br><span class="line">└── work        #→用以产生有JSP编译出的Servlet的.java和.class文件</span><br><span class="line">7 directories, 4 files</span><br><span class="line"></span><br><span class="line">cd webapps/</span><br><span class="line"></span><br><span class="line">ll</span><br><span class="line"></span><br><span class="line">total 20</span><br><span class="line">drwxr-xr-x 14 root root 4096 Oct  5 12:09 docs     #→tomcat帮助文档</span><br><span class="line">drwxr-xr-x  6 root root 4096 Oct  5 12:09 examples #→web应用实例</span><br><span class="line">drwxr-xr-x  5 root root 4096 Oct  5 12:09 host-manager #→管理</span><br><span class="line">drwxr-xr-x  5 root root 4096 Oct  5 12:09 manager  #→管理</span><br><span class="line">drwxr-xr-x  3 root root 4096 Oct  5 12:09 ROOT     #→默认网站根目录</span><br></pre></td></tr></table></figure>
<h2 id="Tomcat管理"><a href="#Tomcat管理" class="headerlink" title="Tomcat管理"></a>Tomcat管理</h2><p>测试功能，生产环境不要用。</p>
<p>Tomcat管理功能用于对Tomcat自身以及部署在Tomcat上的应用进行管理的web应用。在默认情况下是处于禁用状态的。如果需要开启这个功能，就需要配置管理用户，即配置前面说过的tomcat-users.xml。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]# vim /application/tomcat/conf/tomcat-users.xml</span><br><span class="line">…………</span><br><span class="line">&lt;role rolename=&quot;manager-gui&quot;/&gt;</span><br><span class="line">&lt;role rolename=&quot;admin-gui&quot;/&gt;</span><br><span class="line">&lt;user username=&quot;tomcat&quot; password=&quot;tomcat&quot; roles=&quot;manager-gui,admin-gui&quot;/&gt;</span><br><span class="line">&lt;/tomcat-users&gt;  #→在此行前加入上面三行</span><br><span class="line">[root@tomcat ~]# /application/tomcat/bin/shutdown.sh</span><br><span class="line">[root@tomcat ~]# /application/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>
<h2 id="Tomcat主配置文件server-xml详解"><a href="#Tomcat主配置文件server-xml详解" class="headerlink" title="Tomcat主配置文件server.xml详解"></a>Tomcat主配置文件server.xml详解</h2><ul>
<li>顶级组件：位于整个配置的顶层，如server。</li>
<li>容器类组件：可以包含其它组件的组件，如service、engine、host、context。</li>
<li>连接器组件：连接用户请求至tomcat，如connector。</li>
<li>被嵌套类组件：位于一个容器当中，不能包含其他组件，如Valve、logger。</li>
</ul>
<p>组件详解</p>
<hr>
<p>engine：核心容器组件，catalina引擎，负责通过connector接收用户请求，并处理请求，将请求转至对应的虚拟主机host。<br>host：类似于httpd中的虚拟主机，一般而言支持基于FQDN的虚拟主机。<br>context：定义一个应用程序，是一个最内层的容器类组件（不能再嵌套）。配置context的主要目的指定对应对的webapp的根目录，类似于httpd的alias，其还能为webapp指定额外的属性，如部署方式等。<br>connector：接收用户请求，类似于httpd的listen配置监听端口的。<br>service（服务）：将connector关联至engine，因此一个service内部可以有多个connector，但只能有一个引擎engine。service内部有两个connector，一个engine。因此，一般情况下一个server内部只有一个service，一个service内部只有一个engine，但一个service内部可以有多个connector。<br>server：表示一个运行于JVM中的tomcat实例。<br>Valve：阀门，拦截请求并在将其转至对应的webapp前进行某种处理操作，可以用于任何容器中，比如记录日志(access log valve)、基于IP做访问控制(remote address filter valve)。<br>logger：日志记录器，用于记录组件内部的状态信息，可以用于除context外的任何容器中。<br>realm：可以用于任意容器类的组件中，关联一个用户认证库，实现认证和授权。可以关联的认证库有两种：UserDatabaseRealm、MemoryRealm和JDBCRealm。<br>UserDatabaseRealm：使用JNDI自定义的用户认证库。<br>MemoryRealm：认证信息定义在tomcat-users.xml中。<br>JDBCRealm：认证信息定义在数据库中，并通过JDBC连接至数据库中查找认证用户。</p>
<hr>
<p>配置文件注释</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">&lt;Server&gt;元素代表整个容器,是Tomcat实例的顶层元素.由org.apache.catalina.Server接口来定义.它包含一个&lt;Service&gt;元素.并且它不能做为任何元素的子元素.</span></span><br><span class="line"><span class="comment">    port指定Tomcat监听shutdown命令端口.终止服务器运行时,必须在Tomcat服务器所在的机器上发出shutdown命令.该属性是必须的.</span></span><br><span class="line"><span class="comment">    shutdown指定终止Tomcat服务器运行时,发给Tomcat服务器的shutdown监听端口的字符串.该属性必须设置</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="attr">SSLEngine</span>=<span class="string">"on"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">type</span>=<span class="string">"org.apache.catalina.UserDatabase"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">description</span>=<span class="string">"User database that can be updated and saved"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">factory</span>=<span class="string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">pathname</span>=<span class="string">"conf/tomcat-users.xml"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--service服务组件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    connector：接收用户请求，类似于httpd的listen配置监听端口.</span></span><br><span class="line"><span class="comment">        port指定服务器端要创建的端口号，并在这个端口监听来自客户端的请求。</span></span><br><span class="line"><span class="comment">        address：指定连接器监听的地址，默认为所有地址（即0.0.0.0）</span></span><br><span class="line"><span class="comment">        protocol连接器使用的协议，支持HTTP和AJP。AJP（Apache Jserv Protocol）专用于tomcat与apache建立通信的， 在httpd反向代理用户请求至tomcat时使用（可见Nginx反向代理时不可用AJP协议）。</span></span><br><span class="line"><span class="comment">        minProcessors服务器启动时创建的处理请求的线程数</span></span><br><span class="line"><span class="comment">        maxProcessors最大可以创建的处理请求的线程数</span></span><br><span class="line"><span class="comment">        enableLookups如果为true，则可以通过调用request.getRemoteHost()进行DNS查询来得到远程客户端的实际主机名，若为false则不进行DNS查询，而是返回其ip地址</span></span><br><span class="line"><span class="comment">        redirectPort指定服务器正在处理http请求时收到了一个SSL传输请求后重定向的端口号</span></span><br><span class="line"><span class="comment">        acceptCount指定当所有可以使用的处理请求的线程数都被使用时，可以放到处理队列中的请求数，超过这个数的请求将不予处理</span></span><br><span class="line"><span class="comment">        connectionTimeout指定超时的时间数(以毫秒为单位)</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8009"</span> <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--engine,核心容器组件,catalina引擎,负责通过connector接收用户请求,并处理请求,将请求转至对应的虚拟主机host</span></span><br><span class="line"><span class="comment">        defaultHost指定缺省的处理请求的主机名，它至少与其中的一个host元素的name属性值是一样的</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--Realm表示存放用户名，密码及role的数据库--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">      host表示一个虚拟主机</span></span><br><span class="line"><span class="comment">        name指定主机名</span></span><br><span class="line"><span class="comment">        appBase应用程序基本目录，即存放应用程序的目录.一般为appBase="webapps" ，相对于CATALINA_HOME而言的，也可以写绝对路径。</span></span><br><span class="line"><span class="comment">        unpackWARs如果为true，则tomcat会自动将WAR文件解压，否则不解压，直接从WAR文件中运行应用程序</span></span><br><span class="line"><span class="comment">        autoDeploy：在tomcat启动时，是否自动部署。</span></span><br><span class="line"><span class="comment">        xmlValidation：是否启动xml的校验功能，一般xmlValidation="false"。</span></span><br><span class="line"><span class="comment">        xmlNamespaceAware：检测名称空间，一般xmlNamespaceAware="false"。</span></span><br><span class="line"><span class="comment">      --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        Context表示一个web应用程序，通常为WAR文件</span></span><br><span class="line"><span class="comment">            docBase应用程序的路径或者是WAR文件存放的路径,也可以使用相对路径，起始路径为此Context所属Host中appBase定义的路径。</span></span><br><span class="line"><span class="comment">            path表示此web应用程序的url的前缀，这样请求的url为http://localhost:8080/path/****</span></span><br><span class="line"><span class="comment">            reloadable这个属性非常重要，如果为true，则tomcat会自动检测应用程序的/WEB-INF/lib 和/WEB-INF/classes目录的变化，自动装载新的应用程序，可以在不重启tomcat的情况下改变应用程序</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span>=<span class="string">""</span> <span class="attr">debug</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"localhost_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="WEB站点部署"><a href="#WEB站点部署" class="headerlink" title="#WEB站点部署"></a>#WEB站点部署</h1><p>上线的代码有两种方式，第一种方式是直接将程序目录放在webapps目录下面，这种方式大家已经明白了，就不多说了。第二种方式是使用开发工具将程序打包成war包，然后上传到webapps目录下面。下面让我们见识一下这种方式。</p>
<ul>
<li>使用war包部署web站点</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat webapps]# pwd</span><br><span class="line">/application/tomcat/webapps</span><br><span class="line">[root@tomcat webapps]# rz  #→上传memtest.war，此文件也在上面的百度网盘里</span><br><span class="line">[root@tomcat webapps]# ls</span><br><span class="line">docs  examples  host-manager  manager  memtest  memtest.war  ROOT</span><br></pre></td></tr></table></figure>
<p>浏览器访问：<a href="http://10.0.0.3:8080/memtest/meminfo.jsp" target="_blank" rel="noopener">http://10.0.0.3:8080/memtest/meminfo.jsp</a></p>
<ul>
<li>自定义默认网站目录<br>上面访问的网址为<a href="http://10.0.0.3:8080/memtest/meminfo.jsp" target="_blank" rel="noopener">http://10.0.0.3:8080/memtest/meminfo.jsp</a><br>现在我想访问格式为<a href="http://10.0.0.3:8080/meminfo.jsp" target="_blank" rel="noopener">http://10.0.0.3:8080/meminfo.jsp</a><br>怎么破？</li>
</ul>
<p>方法一</p>
<p>将meminfo.jsp或其他程序放在tomcat/webapps/ROOT目录下即可。因为默认网站根目录为tomcat/webapps/ROOT</p>
<p>方法二</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]# vim /application/tomcat/conf/server.xml</span><br><span class="line">      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">         &lt;Context path=&quot;&quot; docBase=&quot;/application/tomcat/webapps/memtest&quot; debug=&quot;0&quot; reloadable=&quot;false&quot; crossContext=&quot;true&quot;/&gt;</span><br><span class="line">[root@tomcat ~]# /application/tomcat/bin/shutdown.sh</span><br><span class="line">[root@tomcat ~]# /application/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>
<h2 id="Tomcat多实例及集群架构"><a href="#Tomcat多实例及集群架构" class="headerlink" title="Tomcat多实例及集群架构"></a>Tomcat多实例及集群架构</h2><ul>
<li>Tomcat多实例</li>
</ul>
<ol>
<li><p>复制Tomcat目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]# cd /application/</span><br><span class="line">[root@tomcat application]# cp -a apache-tomcat-8.0.27 tomcat8_1</span><br><span class="line">[root@tomcat application]# cp -a apache-tomcat-8.0.27 tomcat8_2</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat application]# mkdir -p /data/www/www/ROOT</span><br><span class="line">[root@tomcat application]# cp /application/tomcat/webapps/memtest/meminfo.jsp /data/www/www/ROOT/</span><br><span class="line">[root@tomcat ~]# sed -i &apos;22s#8005#8011#;69s#8080#8081#;123s#appBase=&quot;.*&quot;# appBase=&quot;/data/www/www&quot;#&apos; /application/tomcat8_1/conf/server.xml</span><br><span class="line">[root@tomcat ~]# sed -i &apos;22s#8005#8012#;69s#8080#8082#;123s#appBase=&quot;.*&quot;# appBase=&quot;/data/www/www&quot;#&apos; /application/tomcat8_2/conf/server.xml</span><br><span class="line">[root@tomcat ~]# diff /application/tomcat/conf/server.xml  /application/tomcat8_1/conf/server.xml   </span><br><span class="line">22c22</span><br><span class="line">&lt; &lt;Server port=&quot;8005&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</span><br><span class="line">---</span><br><span class="line">&gt; &lt;Server port=&quot;8011&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</span><br><span class="line">69c69</span><br><span class="line">&lt;     &lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">---</span><br><span class="line">&gt;     &lt;Connector port=&quot;8081&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">123c123</span><br><span class="line">&lt;       &lt;Host name=&quot;localhost&quot;  appBase=&quot;/application/tomcat/webapps/memtest&quot;</span><br><span class="line">---</span><br><span class="line">&gt;       &lt;Host name=&quot;localhost&quot;   appBase=&quot;/data/www/www&quot;</span><br><span class="line">[root@tomcat ~]# diff /application/tomcat/conf/server.xml  /application/tomcat8_2/conf/server.xml</span><br><span class="line">22c22</span><br><span class="line">&lt; &lt;Server port=&quot;8005&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</span><br><span class="line">---</span><br><span class="line">&gt; &lt;Server port=&quot;8012&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</span><br><span class="line">69c69</span><br><span class="line">&lt;     &lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">---</span><br><span class="line">&gt;     &lt;Connector port=&quot;8082&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">123c123</span><br><span class="line">&lt;       &lt;Host name=&quot;localhost&quot;  appBase=&quot;/application/tomcat/webapps/memtest&quot;</span><br><span class="line">---</span><br><span class="line">&gt;       &lt;Host name=&quot;localhost&quot;    appBase=&quot;/data/www/www&quot;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>启动多实例</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..2&#125;;do /application/tomcat8_$i/bin/startup.sh;done</span><br><span class="line">netstat -tunlp|grep java</span><br></pre></td></tr></table></figure>
<p>浏览器可以分别访问<a href="http://10.0.0.3:8081/meminfo.jsp" target="_blank" rel="noopener">http://10.0.0.3:8081/meminfo.jsp</a> 和 <a href="http://10.0.0.3:8082/meminfo.jsp" target="_blank" rel="noopener">http://10.0.0.3:8082/meminfo.jsp</a></p>
<h2 id="Tomcat集群"><a href="#Tomcat集群" class="headerlink" title="Tomcat集群"></a>Tomcat集群</h2><h3 id="使用nginx-Tomcat反向代理集群"><a href="#使用nginx-Tomcat反向代理集群" class="headerlink" title="使用nginx+Tomcat反向代理集群"></a>使用nginx+Tomcat反向代理集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]# vim /application/nginx/conf/nginx.conf</span><br><span class="line">    upstream web_pools &#123;</span><br><span class="line">        server 127.0.0.1:8081;</span><br><span class="line">        server 127.0.0.1:8082;</span><br><span class="line">        &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.jsp index.html index.htm;</span><br><span class="line">            proxy_pass http://web_pools;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">[root@tomcat ~]# /application/nginx/sbin/nginx -t</span><br><span class="line">[root@tomcat ~]# /application/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
<p>浏览器可以访问<a href="http://10.0.0.3/meminfo.jsp" target="_blank" rel="noopener">http://10.0.0.3/meminfo.jsp</a></p>
<h1 id="Tomcat监控"><a href="#Tomcat监控" class="headerlink" title="Tomcat监控"></a>Tomcat监控</h1><h1 id="Tomcat安全优化和性能优化"><a href="#Tomcat安全优化和性能优化" class="headerlink" title="Tomcat安全优化和性能优化"></a>Tomcat安全优化和性能优化</h1><h2 id="安全优化"><a href="#安全优化" class="headerlink" title="安全优化"></a>安全优化</h2><p>降权启动<br>telnet管理端口保护<br>ajp连接端口保护<br>禁用管理端</p>
<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><h3 id="屏蔽dns查询enableLookups-”false”"><a href="#屏蔽dns查询enableLookups-”false”" class="headerlink" title="屏蔽dns查询enableLookups=”false”"></a>屏蔽dns查询enableLookups=”false”</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector  port=&quot;8081&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">           connectionTimeout=&quot;6000&quot; enableLookups=&quot;false&quot; acceptCount=&quot;800&quot;</span><br><span class="line">           redirectPort=&quot;8443&quot; /&gt;</span><br></pre></td></tr></table></figure>
<h2 id="jvm调优"><a href="#jvm调优" class="headerlink" title="jvm调优"></a>jvm调优</h2><p>Tomcat最吃内存，只要内存足够，这只猫就跑的很快。<br>如果系统资源有限，那就需要进行调优，提高资源使用率。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">优化catalina.sh配置文件。在catalina.sh配置文件中添加以下代码：</span><br><span class="line">JAVA_OPTS=&quot;-Djava.awt.headless=true -Dfile.encoding=UTF-8 -server -Xms1024m -Xmx1024m -XX:NewSize=512m -XX:MaxNewSize=512m -XX:PermSize=512m -XX:MaxPermSize=512m&quot;</span><br><span class="line">server:一定要作为第一个参数，在多个CPU时性能佳</span><br><span class="line">-Xms：初始堆内存Heap大小，使用的最小内存,cpu性能高时此值应设的大一些</span><br><span class="line">-Xmx：初始堆内存heap最大值，使用的最大内存</span><br><span class="line">上面两个值是分配JVM的最小和最大内存，取决于硬件物理内存的大小，建议均设为物理内存的一半。</span><br><span class="line">-XX:PermSize:设定内存的永久保存区域</span><br><span class="line">-XX:MaxPermSize:设定最大内存的永久保存区域</span><br><span class="line">-XX:MaxNewSize:</span><br><span class="line">-Xss 15120 这使得JBoss每增加一个线程（thread)就会立即消耗15M内存，而最佳值应该是128K,默认值好像是512k.</span><br><span class="line">+XX:AggressiveHeap 会使得 Xms没有意义。这个参数让jvm忽略Xmx参数,疯狂地吃完一个G物理内存,再吃尽一个G的swap。</span><br><span class="line">-Xss：每个线程的Stack大小</span><br><span class="line">-verbose:gc 现实垃圾收集信息</span><br><span class="line">-Xloggc:gc.log 指定垃圾收集日志文件</span><br><span class="line">-Xmn：young generation的heap大小，一般设置为Xmx的3、4分之一</span><br><span class="line">-XX:+UseParNewGC ：缩短minor收集的时间</span><br><span class="line">-XX:+UseConcMarkSweepGC ：缩短major收集的时间</span><br></pre></td></tr></table></figure>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>Parallels Desktop 运行的CentOS 7.4.1708</p>
<p>jdk1.8.151<br>tomcat 8.5.23</p>
<p>重启tomcat 就打不开了。不知道什么原因。然后用vmware fusion就可以立刻重启。怀疑时paralles的网络有问题。但技术不行暂时找不到问题</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tomcat/">Tomcat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/">Web</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-JDK-配置" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/07/JDK-配置/" class="article-date">
      <time datetime="2016-03-07T12:10:00.000Z" itemprop="datePublished">2016-03-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/07/JDK-配置/">JDK 配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>CentOS 6.7<br>CentOS 7.4.1708</p>
</blockquote>
<ul>
<li>下载 <a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">JDK</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解压缩jdk</span></span><br><span class="line">tar xf jdk-*-linux-x64.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line"><span class="comment">#软连接</span></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/jdk1.8* /usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="comment">#更改jdk的权限</span></span><br><span class="line">chown -R root:root /usr/<span class="built_in">local</span>/jdk1.8*/</span><br></pre></td></tr></table></figure>
<ul>
<li>添加系统变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加java home系统变量</span></span><br><span class="line">sed -i.ori <span class="string">'$a export JAVA_HOME=/usr/local/jdk\nexport PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH\nexport CLASSPATH=.$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar'</span> /etc/profile</span><br><span class="line"><span class="comment">#立即生效系统变量</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment">#查看java版本</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Amazon-Kindle" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/23/Amazon-Kindle/" class="article-date">
      <time datetime="2016-01-22T23:17:00.000Z" itemprop="datePublished">2016-01-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/23/Amazon-Kindle/">Amazon Kindle</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Kindle-8th-Generation-2016-release"><a href="#Kindle-8th-Generation-2016-release" class="headerlink" title="Kindle 8th Generation - 2016 release."></a><a href="https://www.amazon.com/Amazon-Kindle-eReader-6-Inch-Touchscreen/dp/B00ZV9PXP2#tech" target="_blank" rel="noopener">Kindle 8th Generation - 2016 release.</a></h1><p><strong>图书管理</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew cask install calibre</span><br></pre></td></tr></table></figure>
<p><strong>支持的书籍格式</strong></p>
<ul>
<li>mobi，阅读时会生成 sdr 格式的数据。<em><u><strong>推荐使用的格式。</strong></u></em></li>
<li>pdf，阅读时会生成 sdr 格式的数据。</li>
<li>txt，阅读时会生成 sdr 格式的数据。</li>
</ul>
<p><strong>不支持的书籍格式</strong></p>
<ul>
<li>epub 会生成 sdr，但是不能阅读。</li>
</ul>
<h2 id="书籍格式"><a href="#书籍格式" class="headerlink" title="书籍格式"></a>书籍格式</h2><h3 id="EPUB"><a href="#EPUB" class="headerlink" title="EPUB"></a>EPUB</h3><ul>
<li><a href="http://idpf.org/epub" target="_blank" rel="noopener">EPUB | International Digital Publishing Forum</a></li>
<li><a href="https://en.wikipedia.org/wiki/EPUB" target="_blank" rel="noopener">EPUB - Wikipedia</a></li>
<li>免费书籍网站：<a href="https://www.epubbooks.com/" target="_blank" rel="noopener">epubBooks</a></li>
</ul>
<blockquote>
<p>EPUB在脚本，公式，矢量图形的支持方面强过MOBI。</p>
<p>现阶段EPUB的优势体现在图文混排，图片嵌入字体等，未来可预测的优势是EPUB对于声音，影像等多媒体内容互动的支持上。      </p>
<p>EPUB是开放标准，所以在开发工具上EPUB也会有更大的选择。</p>
</blockquote>
<h3 id="MOBI"><a href="#MOBI" class="headerlink" title="MOBI"></a>MOBI</h3><ul>
<li><a href="https://wiki.mobileread.com/wiki/MOBI" target="_blank" rel="noopener">MobileRead Wiki - MOBI</a></li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="电子书有哪些常见格式？以及该怎样阅读它">电子书有哪些常见格式？以及该怎样阅读它</a></p>
<p><a href="https://bookfere.com/post/10.html" target="_blank" rel="noopener">Calibre 使用教程之转换电子书格式</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2015年终总结之败家" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/31/2015年终总结之败家/" class="article-date">
      <time datetime="2015-12-31T00:20:13.000Z" itemprop="datePublished">2015-12-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/31/2015年终总结之败家/">2015年终总结之败家</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2015年终总结之思考" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/31/2015年终总结之思考/" class="article-date">
      <time datetime="2015-12-31T00:20:00.000Z" itemprop="datePublished">2015-12-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/31/2015年终总结之思考/">2015年终总结之思考</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-COBBLER无人值守安装" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/26/COBBLER无人值守安装/" class="article-date">
      <time datetime="2015-12-26T03:22:15.000Z" itemprop="datePublished">2015-12-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/26/COBBLER无人值守安装/">COBBLER无人值守安装</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://www.zyops.com/autoinstall-cobbler" target="_blank" rel="noopener">COBBLER无人值守安装</a></p>
<h2 id="Cobbler介绍"><a href="#Cobbler介绍" class="headerlink" title="Cobbler介绍"></a>Cobbler介绍</h2><p>Cobbler是一个Linux服务器安装的服务，可以通过网络启动(PXE)的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理DHCP，DNS等。</p>
<p>Cobbler可以使用命令行方式管理，也提供了基于Web的界面管理工具(cobbler-web)，还提供了API接口，可以方便二次开发使用。</p>
<p>Cobbler是较早前的kickstart的升级版，优点是比较容易配置，还自带web界面比较易于管理。</p>
<p>Cobbler内置了一个轻量级配置管理系统，但它也支持和其它配置管理系统集成，如Puppet，暂时不支持SaltStack。</p>
<h3 id="Cobbler集成的服务"><a href="#Cobbler集成的服务" class="headerlink" title="Cobbler集成的服务"></a>Cobbler集成的服务</h3><ul>
<li>PXE服务支持</li>
<li>DHCP服务管理</li>
<li>DNS服务管理(可选bind,dnsmasq)</li>
<li>电源管理</li>
<li>Kickstart服务支持</li>
<li>YUM仓库管理</li>
<li>TFTP(PXE启动时需要)</li>
<li>Apache(提供kickstart的安装源，并提供定制化的kickstart配置)</li>
</ul>
<h2 id="Cobbler安装配置"><a href="#Cobbler安装配置" class="headerlink" title="Cobbler安装配置"></a>Cobbler安装配置</h2><h3 id="系统环境准备"><a href="#系统环境准备" class="headerlink" title="系统环境准备"></a>系统环境准备</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# cat /etc/redhat-release</span><br><span class="line">CentOS release 6.7 (Final)</span><br><span class="line">[root@linux-node1 ~]# uname -r</span><br><span class="line">2.6.32-573.el6.x86_64</span><br><span class="line">[root@linux-node1 ~]# getenforce</span><br><span class="line">Disabled</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/iptables status</span><br><span class="line">iptables: Firewall is not running.</span><br><span class="line">[root@linux-node1 ~]# ifconfig eth0|awk -F &quot;[ :]+&quot; &apos;NR==2 &#123;print $4&#125;&apos;</span><br><span class="line">10.0.0.7</span><br><span class="line">[root@linux-node1 ~]# hostname</span><br><span class="line">linux-node1.example.com</span><br><span class="line"># 配置阿里云的epel源</span><br><span class="line">[root@linux-node1 ~]# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.rep</span><br></pre></td></tr></table></figure>
<h3 id="安装Cobbler"><a href="#安装Cobbler" class="headerlink" title="安装Cobbler"></a>安装Cobbler</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# yum -y install cobbler cobbler-web dhcp tftp-server pykickstart httpd</span><br><span class="line">[root@linux-node1 ~]# rpm -ql cobbler  # 查看安装的文件，下面列出部分。</span><br><span class="line">/etc/cobbler                  # 配置文件目录</span><br><span class="line">/etc/cobbler/settings         # cobbler主配置文件，这个文件是YAML格式，Cobbler是python写的程序。</span><br><span class="line">/etc/cobbler/dhcp.template    # DHCP服务的配置模板</span><br><span class="line">/etc/cobbler/tftpd.template   # tftp服务的配置模板</span><br><span class="line">/etc/cobbler/rsync.template   # rsync服务的配置模板</span><br><span class="line">/etc/cobbler/iso              # iso模板配置文件目录</span><br><span class="line">/etc/cobbler/pxe              # pxe模板文件目录</span><br><span class="line">/etc/cobbler/power            # 电源的配置文件目录</span><br><span class="line">/etc/cobbler/users.conf       # Web服务授权配置文件</span><br><span class="line">/etc/cobbler/users.digest     # 用于web访问的用户名密码配置文件</span><br><span class="line">/etc/cobbler/dnsmasq.template # DNS服务的配置模板</span><br><span class="line">/etc/cobbler/modules.conf     # Cobbler模块配置文件</span><br><span class="line">/var/lib/cobbler              # Cobbler数据目录</span><br><span class="line">/var/lib/cobbler/config       # 配置文件</span><br><span class="line">/var/lib/cobbler/kickstarts   # 默认存放kickstart文件</span><br><span class="line">/var/lib/cobbler/loaders      # 存放的各种引导程序</span><br><span class="line">/var/www/cobbler              # 系统安装镜像目录</span><br><span class="line">/var/www/cobbler/ks_mirror    # 导入的系统镜像列表</span><br><span class="line">/var/www/cobbler/images       # 导入的系统镜像启动文件</span><br><span class="line">/var/www/cobbler/repo_mirror  # yum源存储目录</span><br><span class="line">/var/log/cobbler              # 日志目录</span><br><span class="line">/var/log/cobbler/install.log  # 客户端系统安装日志</span><br><span class="line">/var/log/cobbler/cobbler.log  # cobbler日志</span><br></pre></td></tr></table></figure>
<h3 id="配置Cobbler"><a href="#配置Cobbler" class="headerlink" title="配置Cobbler"></a>配置Cobbler</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# /etc/init.d/httpd restart</span><br><span class="line">停止 httpd：                                               [失败]</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/cobblerd start</span><br><span class="line">Starting cobbler daemon:                                   [确定]</span><br><span class="line">[root@linux-node1 ~]# cobbler check  # 检查Cobbler的配置，如果看不到下面的结果，再次执行/etc/init.d/cobblerd restart</span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line">1 : The &apos;server&apos; field in /etc/cobbler/settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.</span><br><span class="line">2 : For PXE to be functional, the &apos;next_server&apos; field in /etc/cobbler/settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.</span><br><span class="line">3 : some network boot-loaders are missing from /var/lib/cobbler/loaders, you may run &apos;cobbler get-loaders&apos; to download them, or, if you only want to handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The &apos;cobbler get-loaders&apos; command is the easiest way to resolve these requirements.</span><br><span class="line">4 : change &apos;disable&apos; to &apos;no&apos; in /etc/xinetd.d/rsync</span><br><span class="line">5 : debmirror package is not installed, it will be required to manage debian deployments and repositories</span><br><span class="line">6 : The default password used by the sample templates for newly installed machines (default_password_crypted in /etc/cobbler/settings) is still set to &apos;cobbler&apos; and should be changed, try: &quot;openssl passwd -1 -salt &apos;random-phrase-here&apos; &apos;your-password-here&apos;&quot; to generate new one</span><br><span class="line">7 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them</span><br><span class="line">Restart cobblerd and then run &apos;cobbler sync&apos; to apply changes.</span><br><span class="line"># 看着上面的结果，一个一个解决。</span><br><span class="line"># 第1、2、6个问题，顺便修改其他功能</span><br><span class="line">[root@linux-node1 ~]# cp /etc/cobbler/settings&#123;,.ori&#125;  # 备份</span><br><span class="line"># server，Cobbler服务器的IP。</span><br><span class="line">sed -i &apos;s/server: 127.0.0.1/server: 10.0.0.7/&apos; /etc/cobbler/settings</span><br><span class="line"># next_server，如果用Cobbler管理DHCP，修改本项，作用不解释，看kickstart。</span><br><span class="line">sed -i &apos;s/next_server: 127.0.0.1/next_server: 10.0.0.7/&apos; /etc/cobbler/settings</span><br><span class="line"># 用Cobbler管理DHCP</span><br><span class="line">sed -i &apos;s/manage_dhcp: 0/manage_dhcp: 1/&apos; /etc/cobbler/settings</span><br><span class="line"># 防止循环装系统，适用于服务器第一启动项是PXE启动。</span><br><span class="line">sed -i &apos;s/pxe_just_once: 0/pxe_just_once: 1/&apos; /etc/cobbler/settings</span><br><span class="line"># 设置新装系统的默认root密码123456。下面的命令来源于提示6。random-phrase-here为干扰码，可以自行设定。</span><br><span class="line">[root@linux-node1 ~]# openssl passwd -1 -salt &apos;oldboy&apos; &apos;123456&apos;</span><br><span class="line">$1$oldboy$Npg9Pt9k98Mlg0ZeqHAuN1</span><br><span class="line">[root@linux-node1 ~]# vim /etc/cobbler/settings </span><br><span class="line">default_password_crypted: &quot;$1$oldboy$Npg9Pt9k98Mlg0ZeqHAuN1&quot; </span><br><span class="line"># 第3个问题</span><br><span class="line">[root@linux-node1 ~]# cobbler get-loaders  # 会自动从官网下载</span><br><span class="line">[root@linux-node1 ~]# cd /var/lib/cobbler/loaders/  # 下载的内容</span><br><span class="line">[root@linux-node1 loaders]# ls</span><br><span class="line">COPYING.elilo     COPYING.yaboot  grub-x86_64.efi  menu.c32    README</span><br><span class="line">COPYING.syslinux  elilo-ia64.efi  grub-x86.efi     pxelinux.0  yaboot</span><br><span class="line"># 第4个问题</span><br><span class="line">[root@linux-node1 ~]# vim /etc/xinetd.d/rsync</span><br><span class="line">disable = no</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/xinetd restart</span><br><span class="line">停止 xinetd：                                              [确定]</span><br><span class="line">正在启动 xinetd：                                          [确定]</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/cobblerd restart</span><br><span class="line">Stopping cobbler daemon:                                   [确定]</span><br><span class="line">Starting cobbler daemon:                                   [确定]</span><br><span class="line">[root@linux-node1 ~]# cobbler check</span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line">1 : debmirror package is not installed, it will be required to manage debian deployments and repositories  # 和debian系统相关，不需要</span><br><span class="line">2 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them # fence设备相关，不需要</span><br><span class="line">Restart cobblerd and then run &apos;cobbler sync&apos; to apply changes.</span><br></pre></td></tr></table></figure>
<h3 id="配置DHCP"><a href="#配置DHCP" class="headerlink" title="配置DHCP"></a>配置DHCP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 修改cobbler的dhcp模版，不要直接修改dhcp本身的配置文件，因为cobbler会覆盖。</span><br><span class="line">[root@linux-node1 ~]# vim /etc/cobbler/dhcp.template </span><br><span class="line"># 仅列出修改过的字段</span><br><span class="line">……</span><br><span class="line">subnet 10.0.0.0 netmask 255.255.255.0 &#123;</span><br><span class="line">     option routers             10.0.0.2;</span><br><span class="line">     option domain-name-servers 10.0.0.2;</span><br><span class="line">     option subnet-mask         255.255.255.0;</span><br><span class="line">     range dynamic-bootp        10.0.0.100 10.0.0.200;</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<h3 id="同步cobbler配置"><a href="#同步cobbler配置" class="headerlink" title="同步cobbler配置"></a>同步cobbler配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 同步最新cobbler配置，它会根据配置自动修改dhcp等服务。</span><br><span class="line">[root@linux-node1 ~]# cobbler sync   # 同步所有配置，可以仔细看一下sync做了什么。</span><br><span class="line">task started: 2015-12-03_204822_sync</span><br><span class="line">task started (id=Sync, time=Thu Dec  3 20:48:22 2015)</span><br><span class="line">running pre-sync triggers</span><br><span class="line">cleaning trees</span><br><span class="line">removing: /var/lib/tftpboot/pxelinux.cfg/default</span><br><span class="line">removing: /var/lib/tftpboot/grub/images</span><br><span class="line">copying bootloaders</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/pxelinux.0 -&gt; /var/lib/tftpboot/pxelinux.0</span><br><span class="line">copying: /var/lib/cobbler/loaders/pxelinux.0 -&gt; /var/lib/tftpboot/pxelinux.0</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/menu.c32 -&gt; /var/lib/tftpboot/menu.c32</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/yaboot -&gt; /var/lib/tftpboot/yaboot</span><br><span class="line">trying hardlink /usr/share/syslinux/memdisk -&gt; /var/lib/tftpboot/memdisk</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/grub-x86.efi -&gt; /var/lib/tftpboot/grub/grub-x86.efi</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/grub-x86_64.efi -&gt; /var/lib/tftpboot/grub/grub-x86_64.efi</span><br><span class="line">copying distros to tftpboot</span><br><span class="line">copying images</span><br><span class="line">generating PXE configuration files</span><br><span class="line">generating PXE menu structure</span><br><span class="line">rendering DHCP files</span><br><span class="line">generating /etc/dhcp/dhcpd.conf</span><br><span class="line">rendering TFTPD files</span><br><span class="line">generating /etc/xinetd.d/tftp</span><br><span class="line">cleaning link caches</span><br><span class="line">running post-sync triggers</span><br><span class="line">running python triggers from /var/lib/cobbler/triggers/sync/post/*</span><br><span class="line">running python trigger cobbler.modules.sync_post_restart_services</span><br><span class="line">running: dhcpd -t -q</span><br><span class="line">received on stdout: </span><br><span class="line">received on stderr: </span><br><span class="line">running: service dhcpd restart</span><br><span class="line">received on stdout: 关闭 dhcpd：[确定]</span><br><span class="line">正在启动 dhcpd：[确定]</span><br><span class="line">received on stderr: </span><br><span class="line">running shell triggers from /var/lib/cobbler/triggers/sync/post/*</span><br><span class="line">running python triggers from /var/lib/cobbler/triggers/change/*</span><br><span class="line">running python trigger cobbler.modules.scm_track</span><br><span class="line">running shell triggers from /var/lib/cobbler/triggers/change/*</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"># 再看一下dhcp的配置文件。</span><br><span class="line">[root@linux-node1 ~]# less /etc/dhcp/dhcpd.conf</span><br><span class="line"># ******************************************************************</span><br><span class="line"># Cobbler managed dhcpd.conf file</span><br><span class="line"># generated from cobbler dhcp.conf template (Thu Dec  3 12:48:23 2015)</span><br><span class="line"># Do NOT make changes to /etc/dhcpd.conf. Instead, make your changes</span><br><span class="line"># in /etc/cobbler/dhcp.template, as /etc/dhcpd.conf will be</span><br><span class="line"># overwritten.</span><br><span class="line"># ******************************************************************</span><br><span class="line">ddns-update-style interim;</span><br><span class="line">…………</span><br></pre></td></tr></table></figure>
<h3 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># 启动相关服务并设置开机启动(可选) 与第二种方法二选一</span><br><span class="line">chkconfig httpd on</span><br><span class="line">chkconfig xinetd on</span><br><span class="line">chkconfig cobblerd on</span><br><span class="line">chkconfig dhcpd on</span><br><span class="line">/etc/init.d/httpd restart</span><br><span class="line">/etc/init.d/xinetd restart</span><br><span class="line">/etc/init.d/cobblerd restart</span><br><span class="line">/etc/init.d/dhcpd restart</span><br><span class="line"># 编写Cobbler相关服务启动脚本(可选)</span><br><span class="line">cat &gt;&gt;/etc/init.d/cobbler&lt;&lt;EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line"># chkconfig: 345 80 90</span><br><span class="line"># description:cobbler</span><br><span class="line">case \$1 in</span><br><span class="line">  start)</span><br><span class="line">    /etc/init.d/httpd start</span><br><span class="line">    /etc/init.d/xinetd start</span><br><span class="line">    /etc/init.d/dhcpd start</span><br><span class="line">    /etc/init.d/cobblerd start</span><br><span class="line">    ;;</span><br><span class="line">  stop)</span><br><span class="line">    /etc/init.d/httpd stop</span><br><span class="line">    /etc/init.d/xinetd stop</span><br><span class="line">    /etc/init.d/dhcpd stop</span><br><span class="line">    /etc/init.d/cobblerd stop</span><br><span class="line">    ;;</span><br><span class="line">  restart)</span><br><span class="line">    /etc/init.d/httpd restart</span><br><span class="line">    /etc/init.d/xinetd restart</span><br><span class="line">    /etc/init.d/dhcpd restart</span><br><span class="line">    /etc/init.d/cobblerd restart</span><br><span class="line">    ;;</span><br><span class="line">  status)</span><br><span class="line">    /etc/init.d/httpd status</span><br><span class="line">    /etc/init.d/xinetd status</span><br><span class="line">    /etc/init.d/dhcpd status</span><br><span class="line">    /etc/init.d/cobblerd status</span><br><span class="line">    ;;</span><br><span class="line">  sync)</span><br><span class="line">    cobbler sync</span><br><span class="line">    ;;</span><br><span class="line">  *)</span><br><span class="line">    echo &quot;Input error,please in put &apos;start|stop|restart|status|sync&apos;!&quot;</span><br><span class="line">    exit 2</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line">EOF</span><br><span class="line"># chmod +x /etc/init.d/cobbler</span><br><span class="line"># chkconfig cobbler on</span><br></pre></td></tr></table></figure>
<h2 id="Cobbler的命令行管理"><a href="#Cobbler的命令行管理" class="headerlink" title="Cobbler的命令行管理"></a>Cobbler的命令行管理</h2><h3 id="查看命令帮助"><a href="#查看命令帮助" class="headerlink" title="查看命令帮助"></a>查看命令帮助</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# cobbler</span><br><span class="line">usage</span><br><span class="line">=====</span><br><span class="line">cobbler &lt;distro|profile|system|repo|image|mgmtclass|package|file&gt; ... </span><br><span class="line">        [add|edit|copy|getks*|list|remove|rename|report] [options|--help]</span><br><span class="line">cobbler &lt;aclsetup|buildiso|import|list|replicate|report|reposync|sync|validateks|version|signature|get-loaders|hardlink&gt; [options|--help]</span><br><span class="line">[root@linux-node1 ~]# cobbler import --help  # 导入镜像</span><br><span class="line">Usage: cobbler [options]</span><br><span class="line">Options:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  --arch=ARCH           OS architecture being imported</span><br><span class="line">  --breed=BREED         the breed being imported</span><br><span class="line">  --os-version=OS_VERSION</span><br><span class="line">                        the version being imported</span><br><span class="line">  --path=PATH           local path or rsync location</span><br><span class="line">  --name=NAME           name, ex &apos;RHEL-5&apos;</span><br><span class="line">  --available-as=AVAILABLE_AS</span><br><span class="line">                        tree is here, don&apos;t mirror</span><br><span class="line">  --kickstart=KICKSTART_FILE</span><br><span class="line">                        assign this kickstart file</span><br><span class="line">  --rsync-flags=RSYNC_FLAGS</span><br><span class="line">                        pass additional flags to rsync</span><br><span class="line">cobbler check    核对当前设置是否有问题</span><br><span class="line">cobbler list     列出所有的cobbler元素</span><br><span class="line">cobbler report   列出元素的详细信息</span><br><span class="line">cobbler sync     同步配置到数据目录,更改配置最好都要执行下</span><br><span class="line">cobbler reposync 同步yum仓库</span><br><span class="line">cobbler distro   查看导入的发行版系统信息</span><br><span class="line">cobbler system   查看添加的系统信息</span><br><span class="line">cobbler profile  查看配置信息</span><br></pre></td></tr></table></figure>
<h3 id="导入镜像"><a href="#导入镜像" class="headerlink" title="导入镜像"></a>导入镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# mount /dev/cdrom /mnt/  # 挂载CentOS7的系统镜像。</span><br><span class="line"># 导入系统镜像</span><br><span class="line">[root@linux-node1 ~]# cobbler import --path=/mnt/ --name=CentOS-7.1-x86_64 --arch=x86_64</span><br><span class="line"># --path 镜像路径</span><br><span class="line"># --name 为安装源定义一个名字</span><br><span class="line"># --arch 指定安装源是32位、64位、ia64, 目前支持的选项有: x86│x86_64│ia64</span><br><span class="line"># 安装源的唯一标示就是根据name参数来定义，本例导入成功后，安装源的唯一标示就是：CentOS-7.1-x86_64，如果重复，系统会提示导入失败。</span><br><span class="line">[root@linux-node1 ~]# cobbler distro list  # 查看镜像列表</span><br><span class="line">   CentOS-7.1-x86_64</span><br><span class="line"># 镜像存放目录，cobbler会将镜像中的所有安装文件拷贝到本地一份，放在/var/www/cobbler/ks_mirror下的CentOS-7.1-x86_64目录下。因此/var/www/cobbler目录必须具有足够容纳安装文件的空间。</span><br><span class="line">[root@linux-node1 ~]# cd /var/www/cobbler/ks_mirror/</span><br><span class="line">[root@linux-node1 ks_mirror]# ls</span><br><span class="line">CentOS-7.1-x86_64  config</span><br><span class="line">[root@linux-node1 ks_mirror]# ls CentOS-7.1-x86_64/</span><br><span class="line">CentOS_BuildTag  GPL       LiveOS    RPM-GPG-KEY-CentOS-7</span><br><span class="line">EFI              images    Packages  RPM-GPG-KEY-CentOS-Testing-7</span><br><span class="line">EULA             isolinux  repodata  TRANS.TBL</span><br></pre></td></tr></table></figure>
<h3 id="指定ks-cfg文件及调整内核参数"><a href="#指定ks-cfg文件及调整内核参数" class="headerlink" title="指定ks.cfg文件及调整内核参数"></a>指定ks.cfg文件及调整内核参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"># Cobbler的ks.cfg文件存放位置</span><br><span class="line">[root@linux-node1 ks_mirror]# cd /var/lib/cobbler/kickstarts/</span><br><span class="line">[root@linux-node1 kickstarts]# ls  # 自带很多</span><br><span class="line">default.ks    install_profiles  sample_autoyast.xml  sample_esxi4.ks  sample_old.seed</span><br><span class="line">esxi4-ks.cfg  legacy.ks         sample_end.ks（默认使用的ks文件）        sample_esxi5.ks  sample.seed</span><br><span class="line">esxi5-ks.cfg  pxerescue.ks      sample_esx4.ks       sample.ks</span><br><span class="line">[root@linux-node1 kickstarts]# rz  # 上传准备好的ks文件</span><br><span class="line">rz waiting to receive.</span><br><span class="line">Starting zmodem transfer.  Press Ctrl+C to cancel.</span><br><span class="line">Transferring Cobbler-CentOS-7.1-x86_64.cfg...</span><br><span class="line">  100%       1 KB       1 KB/sec    00:00:01       0 Errors</span><br><span class="line">[root@linux-node1 kickstarts]# mv Cobbler-CentOS-7.1-x86_64.cfg CentOS-7.1-x86_64.cfg</span><br><span class="line"># 在第一次导入系统镜像后，Cobbler会给镜像指定一个默认的kickstart自动安装文件在/var/lib/cobbler/kickstarts下的sample_end.ks。</span><br><span class="line">[root@linux-node1 ~]# cobbler list</span><br><span class="line">distros:</span><br><span class="line">   CentOS-7.1-x86_64</span><br><span class="line">profiles:</span><br><span class="line">   CentOS-7.1-x86_64</span><br><span class="line">systems:</span><br><span class="line">repos:</span><br><span class="line">images:</span><br><span class="line">mgmtclasses:</span><br><span class="line">packages:</span><br><span class="line">files:</span><br><span class="line"># 查看安装镜像文件信息</span><br><span class="line">[root@linux-node1 ~]# cobbler distro report --name=CentOS-7.1-x86_64</span><br><span class="line">Name                           : CentOS-7.1-x86_64</span><br><span class="line">Architecture                   : x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Breed                          : redhat</span><br><span class="line">Comment                        : </span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Initrd                         : /var/www/cobbler/ks_mirror/CentOS-7.1-x86_64/images/pxeboot/initrd.img</span><br><span class="line">Kernel                         : /var/www/cobbler/ks_mirror/CentOS-7.1-x86_64/images/pxeboot/vmlinuz</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart Metadata             : &#123;&apos;tree&apos;: &apos;http://@@http_server@@/cblr/links/CentOS-7.1-x86_64&apos;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">OS Version                     : rhel7</span><br><span class="line">Owners                         : [&apos;admin&apos;]</span><br><span class="line">Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line"># 查看所有的profile设置</span><br><span class="line">[root@linux-node1 ~]# cobbler profile report</span><br><span class="line"># 查看指定的profile设置</span><br><span class="line">[root@linux-node1 ~]# cobbler profile report --name=CentOS-7.1-x86_64</span><br><span class="line">Name                           : CentOS-7.1-x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        : </span><br><span class="line">DHCP Tag                       : default</span><br><span class="line">Distribution                   : CentOS-7.1-x86_64</span><br><span class="line">Enable gPXE?                   : 0</span><br><span class="line">Enable PXE Menu?               : 1</span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart                      : /var/lib/cobbler/kickstarts/sample_end.ks  --&gt;默认ks文件</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">Management Parameters          : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Owners                         : [&apos;admin&apos;]</span><br><span class="line">Parent Profile                 : </span><br><span class="line">Internal proxy                 : </span><br><span class="line">Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Repos                          : []</span><br><span class="line">Server Override                : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line">Virt Auto Boot                 : 1</span><br><span class="line">Virt Bridge                    : xenbr0</span><br><span class="line">Virt CPUs                      : 1</span><br><span class="line">Virt Disk Driver Type          : raw</span><br><span class="line">Virt File Size(GB)             : 5</span><br><span class="line">Virt Path                      : </span><br><span class="line">Virt RAM (MB)                  : 512</span><br><span class="line">Virt Type                      : kvm</span><br><span class="line"># 编辑profile，修改关联的ks文件</span><br><span class="line">[root@linux-node1 ~]# cobbler profile edit --name=CentOS-7.1-x86_64 --kickstart=/var/lib/cobbler/kickstarts/CentOS-7.1-x86_64.cfg</span><br><span class="line"># 修改安装系统的内核参数，在CentOS7系统有一个地方变了，就是网卡名变成eno16777736这种形式，但是为了运维标准化，我们需要将它变成我们常用的eth0，因此使用下面的参数。但要注意是CentOS7才需要下面的步骤，CentOS6不需要。</span><br><span class="line">[root@linux-node1 ~]# cobbler profile edit --name=CentOS-7.1-x86_64 --kopts=&apos;net.ifnames=0 biosdevname=0&apos;</span><br><span class="line">[root@linux-node1 ~]# cobbler profile report CentOS-7.1-x86_64</span><br><span class="line">Name                           : CentOS-7.1-x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        : </span><br><span class="line">DHCP Tag                       : default</span><br><span class="line">Distribution                   : CentOS-7.1-x86_64</span><br><span class="line">Enable gPXE?                   : 0</span><br><span class="line">Enable PXE Menu?               : 1</span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Kernel Options                 : &#123;&apos;biosdevname&apos;: &apos;0&apos;, &apos;net.ifnames&apos;: &apos;0&apos;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart                      : /var/lib/cobbler/kickstarts/CentOS-7.1-x86_64.cfg</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">Management Parameters          : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Owners                         : [&apos;admin&apos;]</span><br><span class="line">Parent Profile                 : </span><br><span class="line">Internal proxy                 : </span><br><span class="line">Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Repos                          : []</span><br><span class="line">Server Override                : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line">Virt Auto Boot                 : 1</span><br><span class="line">Virt Bridge                    : xenbr0</span><br><span class="line">Virt CPUs                      : 1</span><br><span class="line">Virt Disk Driver Type          : raw</span><br><span class="line">Virt File Size(GB)             : 5</span><br><span class="line">Virt Path                      : </span><br><span class="line">Virt RAM (MB)                  : 512</span><br><span class="line">Virt Type                      : kvm</span><br><span class="line"># 每次修改完都要同步一次</span><br><span class="line">[root@linux-node1 ~]# cobbler sync</span><br></pre></td></tr></table></figure>
<h3 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h3><p>可以很愉快的告诉你到这里就可以安装系统了！<br>有没有发现不美观的地方？<br>网址不是我的！改！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#修改Cobbler提示</span><br><span class="line">[root@linux-node1 ~]# vim /etc/cobbler/pxe/pxedefault.template</span><br><span class="line">MENU TITLE Cobbler | http://www.zyops.com</span><br><span class="line">[root@linux-node1 ~]# cobbler sync # 修改配置都要同步</span><br></pre></td></tr></table></figure>
<h2 id="ks-cfg文件简析"><a href="#ks-cfg文件简析" class="headerlink" title="ks.cfg文件简析"></a>ks.cfg文件简析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">文件大部分参数含义见kickstart文章，此处只讲一些不同的地方。同时可以参考模板文件。</span><br><span class="line">[root@linux-node1 kickstarts]# cat CentOS-7.1-x86_64.cfg</span><br><span class="line"># Cobbler for Kickstart Configurator for CentOS 7.1 by yao zhang</span><br><span class="line">install</span><br><span class="line">url --url=$tree  # 这些$开头的变量都是调用配置文件里的值。</span><br><span class="line">text</span><br><span class="line">lang en_US.UTF-8</span><br><span class="line">keyboard us</span><br><span class="line">zerombr</span><br><span class="line">bootloader --location=mbr --driveorder=sda --append=&quot;crashkernel=auto rhgb quiet&quot;</span><br><span class="line"># Network information</span><br><span class="line">$SNIPPET(&apos;network_config&apos;)</span><br><span class="line">timezone --utc Asia/Shanghai</span><br><span class="line">authconfig --enableshadow --passalgo=sha512</span><br><span class="line">rootpw  --iscrypted $default_password_crypted</span><br><span class="line">clearpart --all --initlabel</span><br><span class="line">part /boot --fstype xfs --size 1024  # CentOS7系统磁盘默认格式xfs</span><br><span class="line">part swap --size 1024</span><br><span class="line">part / --fstype xfs --size 1 --grow</span><br><span class="line">firstboot --disable</span><br><span class="line">selinux --disabled</span><br><span class="line">firewall --disabled</span><br><span class="line">logging --level=info</span><br><span class="line">reboot</span><br><span class="line">%pre</span><br><span class="line">$SNIPPET(&apos;log_ks_pre&apos;)</span><br><span class="line">$SNIPPET(&apos;kickstart_start&apos;)</span><br><span class="line">$SNIPPET(&apos;pre_install_network_config&apos;)</span><br><span class="line"># Enable installation monitoring</span><br><span class="line">$SNIPPET(&apos;pre_anamon&apos;)</span><br><span class="line">%end</span><br><span class="line">%packages</span><br><span class="line">@base</span><br><span class="line">@compat-libraries</span><br><span class="line">@debugging</span><br><span class="line">@development</span><br><span class="line">tree</span><br><span class="line">nmap</span><br><span class="line">sysstat</span><br><span class="line">lrzsz</span><br><span class="line">dos2unix</span><br><span class="line">telnet</span><br><span class="line">iptraf</span><br><span class="line">ncurses-devel</span><br><span class="line">openssl-devel</span><br><span class="line">zlib-devel</span><br><span class="line">OpenIPMI-tools</span><br><span class="line">screen</span><br><span class="line">%end</span><br><span class="line">%post</span><br><span class="line">systemctl disable postfix.service</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>
<h2 id="定制化安装"><a href="#定制化安装" class="headerlink" title="定制化安装"></a>定制化安装</h2><p>可能从学习kickstart开始就有人想怎样能够指定某台服务器使用指定ks文件，kickstart实现这功能可能比较复杂，但是Cobbler就很简单了。</p>
<p>区分一台服务器的最简单的方法就是物理MAC地址。<br>物理服务器的MAC地址在服务器上的标签上写了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cobbler system add --name=oldboy --mac=00：0C：29：7F：2F：A1 --profile=CentOS-7.1-x86_64 --ip-address=10.0.0.111 --subnet=255.255.255.0 --gateway=10.0.0.2 --interface=eth0 --static=1 --hostname=oldboy.example.com --name-servers=&quot;114.114.114.114 8.8.8.8&quot;</span><br><span class="line"># --name 自定义，但不能重复</span><br><span class="line"># 查看定义的列表</span><br><span class="line">[root@linux-node1 ~]# cobbler system list</span><br><span class="line">   oldboy</span><br><span class="line">[root@linux-node1 ~]# cobbler sync</span><br></pre></td></tr></table></figure>
<p>再次开机安装就不再询问选择了，直接安装。</p>
<h2 id="Cobbler的Web管理界面的安装与配置"><a href="#Cobbler的Web管理界面的安装与配置" class="headerlink" title="Cobbler的Web管理界面的安装与配置"></a>Cobbler的Web管理界面的安装与配置</h2><p>已经安装cobbler-web软件。</p>
<p>访问网址：<a href="http://10.0.0.7/cobbler_web和https://10.0.0.7/cobbler_web" target="_blank" rel="noopener">http://10.0.0.7/cobbler_web和https://10.0.0.7/cobbler_web</a></p>
<p>默认用户名：cobbler<br>默认密码 ：cobbler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/etc/cobbler/users.conf       # Web服务授权配置文件</span><br><span class="line">/etc/cobbler/users.digest     # 用于web访问的用户名密码配置文件</span><br><span class="line">[root@linux-node1 ~]# cat /etc/cobbler/users.digest</span><br><span class="line">cobbler:Cobbler:a2d6bae81669d707b72c0bd9806e01f3</span><br><span class="line"># 设置Cobbler web用户登陆密码</span><br><span class="line"># 在Cobbler组添加cobbler用户，提示输入2遍密码确认</span><br><span class="line">[root@linux-node1 ~]# htdigest /etc/cobbler/users.digest &quot;Cobbler&quot; cobbler</span><br><span class="line">Changing password for user cobbler in realm Cobbler</span><br><span class="line">New password: 123456</span><br><span class="line">Re-type new password:123456</span><br><span class="line">[root@linux-node1 ~]# cobbler sync</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/httpd restart</span><br><span class="line">停止 httpd：                                               [确定]</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/cobblerd restart</span><br><span class="line">Stopping cobbler daemon:                                   [确定]</span><br><span class="line">Starting cobbler daemon:                                   [确定]</span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cobbler/">Cobbler</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/43/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/42/">42</a><a class="page-number" href="/page/43/">43</a><span class="page-number current">44</span><a class="page-number" href="/page/45/">45</a><a class="page-number" href="/page/46/">46</a><a class="page-number" href="/page/47/">47</a><a class="extend next" rel="next" href="/page/45/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 幻舞梦境
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit">海贼到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-39498261-3', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?1bb44bf25fea8f000a1397f9b5438de7";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>