<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>幻舞梦境</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="幻舞梦境">
<meta property="og:url" content="http://ovwane.me/page/20/index.html">
<meta property="og:site_name" content="幻舞梦境">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="幻舞梦境">
  
    <link rel="alternative" href="/atom.xml" title="幻舞梦境" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
     
      <meta name="baidu-site-verification" content="3rC08I0Cp6">
    
     
      <meta name="google-site-verification" content="rn8f25RzFQoiByt8ezg9E17KZIElbIlwJ4y-EKSlWbA">
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet">
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">幻舞梦境</a></h1>
        </hgroup>

        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/archives">博客归档</a></li>
                        
                            <li><a href="/FrontEndGuideV2/FrontEndGuide">测试导航</a></li>
                        
                            <li><a href="/ovwane_love">关于Love</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" target="_blank" href="https://github.com/ovwane" title="github">github</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Ansible/" style="font-size: 11.67px;">Ansible</a> <a href="/tags/Bind/" style="font-size: 10px;">Bind</a> <a href="/tags/Cacti/" style="font-size: 10px;">Cacti</a> <a href="/tags/CentOS/" style="font-size: 20px;">CentOS</a> <a href="/tags/Cobbler/" style="font-size: 10px;">Cobbler</a> <a href="/tags/DHCP/" style="font-size: 10px;">DHCP</a> <a href="/tags/Django/" style="font-size: 13.33px;">Django</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Elasticsearch/" style="font-size: 10px;">Elasticsearch</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Gitlab/" style="font-size: 11.67px;">Gitlab</a> <a href="/tags/HAProxy/" style="font-size: 10px;">HAProxy</a> <a href="/tags/Hexo/" style="font-size: 11.67px;">Hexo</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Jenkins/" style="font-size: 11.67px;">Jenkins</a> <a href="/tags/KVM/" style="font-size: 10px;">KVM</a> <a href="/tags/Kubernetes/" style="font-size: 10px;">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/MariaDB/" style="font-size: 10px;">MariaDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 10px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 16.67px;">Nginx</a> <a href="/tags/Oh-My-Zsh/" style="font-size: 10px;">Oh My Zsh</a> <a href="/tags/OpenLDAP/" style="font-size: 10px;">OpenLDAP</a> <a href="/tags/OpenStack/" style="font-size: 10px;">OpenStack</a> <a href="/tags/PHP/" style="font-size: 11.67px;">PHP</a> <a href="/tags/PXE/" style="font-size: 10px;">PXE</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/RHEL7/" style="font-size: 10px;">RHEL7</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Requests/" style="font-size: 10px;">Requests</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Samba/" style="font-size: 10px;">Samba</a> <a href="/tags/Scrapy/" style="font-size: 11.67px;">Scrapy</a> <a href="/tags/Scrapyd/" style="font-size: 10px;">Scrapyd</a> <a href="/tags/SpiderKeeper/" style="font-size: 10px;">SpiderKeeper</a> <a href="/tags/Squid/" style="font-size: 10px;">Squid</a> <a href="/tags/Subversion/" style="font-size: 10px;">Subversion</a> <a href="/tags/Supervisor/" style="font-size: 10px;">Supervisor</a> <a href="/tags/Tomcat/" style="font-size: 13.33px;">Tomcat</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/Xadmin/" style="font-size: 10px;">Xadmin</a> <a href="/tags/Zabbix/" style="font-size: 10px;">Zabbix</a> <a href="/tags/cacti/" style="font-size: 10px;">cacti</a> <a href="/tags/dovecot/" style="font-size: 10px;">dovecot</a> <a href="/tags/httpd/" style="font-size: 11.67px;">httpd</a> <a href="/tags/iSCSI/" style="font-size: 10px;">iSCSI</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/kickstart/" style="font-size: 10px;">kickstart</a> <a href="/tags/macOS/" style="font-size: 15px;">macOS</a> <a href="/tags/nagios/" style="font-size: 10px;">nagios</a> <a href="/tags/postfix/" style="font-size: 10px;">postfix</a> <a href="/tags/rsync/" style="font-size: 10px;">rsync</a> <a href="/tags/sshd/" style="font-size: 10px;">sshd</a> <a href="/tags/uWSGI/" style="font-size: 10px;">uWSGI</a> <a href="/tags/vsftpd/" style="font-size: 10px;">vsftpd</a> <a href="/tags/zabbix/" style="font-size: 10px;">zabbix</a> <a href="/tags/历史/" style="font-size: 18.33px;">历史</a> <a href="/tags/情感/" style="font-size: 10px;">情感</a> <a href="/tags/生活/" style="font-size: 10px;">生活</a> <a href="/tags/监控/" style="font-size: 13.33px;">监控</a> <a href="/tags/自己/" style="font-size: 10px;">自己</a> <a href="/tags/运维/" style="font-size: 10px;">运维</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://luuman.github.io/">name</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">纯海迷、爱运动、爱交友、爱旅行、喜欢接触新鲜事物、迎接新的挑战，更爱游离于错综复杂的编码与逻辑中</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">幻舞梦境</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">幻舞梦境</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/archives">博客归档</a></li>
                
                    <li><a href="/FrontEndGuideV2/FrontEndGuide">测试导航</a></li>
                
                    <li><a href="/ovwane_love">关于Love</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/ovwane" title="github">github</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-CentOS7 新装服务器初始化配置" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/17/CentOS7 新装服务器初始化配置/" class="article-date">
      <time datetime="2017-11-17T10:52:45.000Z" itemprop="datePublished">2017-11-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/17/CentOS7 新装服务器初始化配置/">CentOS7 新装服务器初始化配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="CentOS7-新装服务器初始化配置"><a href="#CentOS7-新装服务器初始化配置" class="headerlink" title="CentOS7 新装服务器初始化配置"></a>CentOS7 新装服务器初始化配置</h1><blockquote>
<p>CentOS 7.4.1708</p>
</blockquote>
<p><a href="http://wzlinux.blog.51cto.com/8021085/1945374" target="_blank" rel="noopener">CentOS 7 新装服务器部署流程</a></p>
<p>所有的服务器基本都是最小化安装，版本为CentOS 7.x  64位系列。</p>
<h2 id="配置IP和网关"><a href="#配置IP和网关" class="headerlink" title="配置IP和网关"></a>配置IP和网关</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line"></span><br><span class="line">IPADDR=10.0.0.7</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.1</span><br><span class="line">DNS1=114.114.114.114</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#重启网络服务</span><br><span class="line">systemctl restart network.service</span><br></pre></td></tr></table></figure>
<h2 id="设置时区"><a href="#设置时区" class="headerlink" title="设置时区"></a>设置时区</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">timedatectl list-timezones           #列出所有时区</span><br><span class="line">timedatectl set-local-rtc 1          #将硬件时钟调整为与本地时钟一致,0为设置为UTC时间</span><br><span class="line">timedatectl set-timezone Asia/Shanghai #设置系统时区为上海</span><br></pre></td></tr></table></figure>
<h2 id="设置主机名"><a href="#设置主机名" class="headerlink" title="设置主机名"></a>设置主机名</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#设置一个主机的变量因为主机名从node1-node9</span><br><span class="line">a=1</span><br><span class="line">#$a为变量</span><br><span class="line">hostnamectl set-hostname node$a.ovwane.com</span><br></pre></td></tr></table></figure>
<h2 id="关闭SELinux"><a href="#关闭SELinux" class="headerlink" title="关闭SELinux"></a>关闭SELinux</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/SELINUX=enforcing/SELINUX=disabled/g&apos; /etc/selinux/config</span><br></pre></td></tr></table></figure>
<h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld&amp;&amp;systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<h2 id="关闭IPv6"><a href="#关闭IPv6" class="headerlink" title="关闭IPv6"></a>关闭IPv6</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/^GRUB_CMDLINE_LINUX=\&quot;/GRUB_CMDLINE_LINUX=\&quot;ipv6.disable=1 /g&apos; /etc/default/grub&amp;&amp;</span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br></pre></td></tr></table></figure>
<h2 id="更改YUM源"><a href="#更改YUM源" class="headerlink" title="更改YUM源"></a>更改YUM源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm /etc/yum.repos.d/* -rf;curl -ssL http://mirrors.163.com/.help/CentOS7-Base-163.repo&gt;/etc/yum.repos.d/CentOS-Base.repo;echo $?</span><br></pre></td></tr></table></figure>
<h2 id="时间同步"><a href="#时间同步" class="headerlink" title="时间同步"></a>时间同步</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y chrony;systemctl enable chronyd.service&amp;&amp;systemctl start chronyd.service</span><br></pre></td></tr></table></figure>
<h2 id="常用软件"><a href="#常用软件" class="headerlink" title="常用软件"></a>常用软件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y lrzsz wget vim git tree bash-completion sysstat lsof net-tools unzip</span><br></pre></td></tr></table></figure>
<h2 id="VIM安装配置"><a href="#VIM安装配置" class="headerlink" title="VIM安装配置"></a>VIM安装配置</h2><h2 id="修改文件句柄数"><a href="#修改文件句柄数" class="headerlink" title="修改文件句柄数"></a>修改文件句柄数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#临时修改，立刻生效</span><br><span class="line">ulimit -n 655360         </span><br><span class="line"> </span><br><span class="line">#永久修改</span><br><span class="line">echo &quot;* soft nofile 655360&quot; &gt;&gt; /etc/security/limits.conf&amp;&amp;echo &quot;* hard nofile 655360&quot; &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure>
<h2 id="SSH设置"><a href="#SSH设置" class="headerlink" title="SSH设置"></a>SSH设置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/#UseDNS no/UseDNS no/g&apos; /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>
<h2 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -r now</span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Linux之路" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/14/Linux之路/" class="article-date">
      <time datetime="2017-11-14T14:53:32.000Z" itemprop="datePublished">2017-11-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/14/Linux之路/">Linux之路</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>2012.06.19 上海第一份工作 有一台Red Hat的Linux服务器<br>2013.10月份 小毛哥的大学中参观学习，郑州河南财经政法大学老校区的课堂上学习Linux。<br>2016.12.12 北京的公司有CentOS 6.3的服务器</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-五笔输入法" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/13/五笔输入法/" class="article-date">
      <time datetime="2017-11-13T15:29:00.000Z" itemprop="datePublished">2017-11-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/13/五笔输入法/">五笔输入法</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>五笔输入法</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h2><blockquote>
<p>macOS 10.13.1</p>
</blockquote>
<h3 id="鼠鬚管"><a href="#鼠鬚管" class="headerlink" title="鼠鬚管"></a>鼠鬚管</h3><p><a href="http://rime.im/" target="_blank" rel="noopener">中州韻輸入法引擎</a><br><a href="https://github.com/rime/squirrel" target="_blank" rel="noopener">鼠鬚管</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew cask install squirrel</span><br></pre></td></tr></table></figure>
<p>鼠鬚管图形化配置工具<br><del><a href="https://github.com/neolee/SCU" target="_blank" rel="noopener">neolee/SCU</a> 是由 <a href="https://github.com/neolee" target="_blank" rel="noopener">Neo Lee</a> 開發的圖形化配置工具。</del></p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><h2 id="新世紀五筆"><a href="#新世紀五筆" class="headerlink" title="新世紀五筆"></a>新世紀五筆</h2><p><a href="https://github.com/lswqzhang/RIME-wubi" target="_blank" rel="noopener">RIME（鼠须管、小狼毫、中州韵）输入法五笔方案，98版，新世纪版</a></p>
<ol>
<li>直接使用<br>macOS 将 RIME 文件夹中的文件复制到 RIME输入法 用户设定文件夹”/Library/Input Methods/Squirrel.app/Contents”。</li>
</ol>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-学习计划书" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/13/学习计划书/" class="article-date">
      <time datetime="2017-11-13T15:09:00.000Z" itemprop="datePublished">2017-11-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/13/学习计划书/">学习计划书</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>一转眼从想学习PHP开始已经整整五年，可是却一直没有学成。回想这五年来，从一个初入社会的毛头小子，现在眼看就是要奔三的人了，可是收入才只能温饱啊。个中滋味，不胜言表啊！回顾之前的工作，做的大部分都是体力劳动相对多点的，价值不高，也不被人所尊重，至少我看来是这样的。在工作的过程中，我发现很多比我年纪小的毕业生月薪可以是我的两倍，这个有点刺激到我了。我心想还是有一个技术会比较好，这样学习技术的想法在我心里萌发了。<br>可是学什么呢？看看当前的社会形势，得学一个符合发展趋势的技术。要学习，要深造的这个念头就这样在我的脑海中萦绕着。就在这个阶段，迷茫的时候。身边的小伙伴就给了我建议，为什么不学一下计算机的相关知识呢，互联网是大势所趋，而且对人才的需求量也比较大。就这样我开始在网上了解。看到很多人和我有类似的经理，经过半年多的努力学习，可以找到一个月薪过万的工作，我很羡慕，也很想变成和他们一样。结合自己的实际情况，我感觉Linux运维工作比较适合我。于是自己鼓足勇气，决心学习，破釜沉舟。口号喊得再响不行，我要做一个行动派，说做就做。这样我报名了老男孩运维网络班，来给自己充电，提高自己。<br>从现在开始（2017.11.13），我计划用5-6个月的时间结束课程（预计在2018年3月-4月）。自己现在有目标了，也有奔头了，为了月薪可以过万，拼了。这个信念点燃了我的斗志，我也要给一个证明自己的机会，不达目的，誓不罢休。XXX，为了你的万元梦想向前冲吧，不要畏惧，不要气馁，你行的，加油！加油！加油！</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-CentOS6 新装服务器初始化配置" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/12/CentOS6 新装服务器初始化配置/" class="article-date">
      <time datetime="2017-11-12T11:31:45.000Z" itemprop="datePublished">2017-11-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/12/CentOS6 新装服务器初始化配置/">CentOS 6 新装服务器部署流程</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://oldboy.blog.51cto.com/2561410/1336488" target="_blank" rel="noopener">CentOS（5.8/6.4）linux生产环境若干优化实战</a><a href="http://wzlinux.blog.51cto.com/8021085/1704772" target="_blank" rel="noopener">CentOS 6 新装服务器部署流程</a><a href="http://maocong.blog.51cto.com/4706737/1682372" target="_blank" rel="noopener">实践生产服务器环境最小化安装后 Centos 6.5 优化</a></p>
<p>特别说明：本文来自老男孩linux培训VIP学生学习笔记。特和所有博友分享。更多优化，请关注老男孩培训后续课程内容以及分享。<br>为了满足广大博友工作需求，老男孩linux培训课程从2013年起已经同时适合Centos5.X和Centos6.X!<br>CentOS系统安装之后并不能立即投入生产环境使用，往往需要先经过我们运维人员的优化才行。在此讲解几点关于Linux系统安装后的基础优化操作。注意：本次优化都是基于CentOS（5.8/6.4）。<br>下面我就为大家简单讲解几点关于Linux系统安装后的基础优化操作。</p>
<p>修改ip地址、网关、主机名、DNS等<br>关闭selinux，清空iptables<br>添加普通用户并进行sudo授权管理<br>更新yum源及必要软件安装<br>定时自动更新服务器时间<br>精简开机自启动服务<br>定时自动清理/var/spool/clientmqueue/目录垃圾文件，放置inode节点被占满<br>变更默认的ssh服务端口，禁止root用户远程连接<br>锁定关键文件系统<br>调整文件描述符大小<br>调整字符集，使其支持中文<br>去除系统及内核版本登录前的屏幕显示<br>内核参数优化</p>
<h2 id="修改ip地址、网关、主机名、DNS等"><a href="#修改ip地址、网关、主机名、DNS等" class="headerlink" title="修改ip地址、网关、主机名、DNS等"></a>修改ip地址、网关、主机名、DNS等</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line"></span><br><span class="line">DEVICE=eth0         #网卡名字</span><br><span class="line">BOOTPROTO=static    #静态IP地址获取状态 如：DHCP表示自动获取IP地址</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=10.0.0.6</span><br><span class="line">NETMASK=255.255.255.0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">修改网关</span><br><span class="line">vi /etc/sysconfig/network</span><br><span class="line">GATEWAY=10.0.0.1    #修改默认网关,如果上面eth0里面不配置网关的话，默认就使用这里的网关了。</span><br><span class="line"></span><br><span class="line">修改DNS</span><br><span class="line">vi /etc/resolv.conf</span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line"></span><br><span class="line">service network restart   #重启网卡，生效</span><br><span class="line">#重启网卡，也可以用下面的命令</span><br><span class="line">/etc/init.d/network restart</span><br></pre></td></tr></table></figure>
<h2 id="设置时区"><a href="#设置时区" class="headerlink" title="设置时区"></a>设置时区</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f /etc/localtime</span><br><span class="line">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure>
<h2 id="添加普通用户并进行sudo授权管理"><a href="#添加普通用户并进行sudo授权管理" class="headerlink" title="添加普通用户并进行sudo授权管理"></a>添加普通用户并进行sudo授权管理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">useradd sunsky</span><br><span class="line">echo &quot;123456&quot;|passwd --stdin sunsky&amp;&amp;history –c</span><br><span class="line"></span><br><span class="line">visudo</span><br><span class="line">在root    ALL=(ALL)    ALL此行下，添加如下内容</span><br><span class="line">sunsky    ALL=(ALL)    ALL</span><br></pre></td></tr></table></figure>
<h2 id="更改YUM源"><a href="#更改YUM源" class="headerlink" title="更改YUM源"></a>更改YUM源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm /etc/yum.repos.d/* -rf;curl -ssL http://mirrors.163.com/.help/CentOS6-Base-163.repo&gt;/etc/yum.repos.d/CentOS-Base.repo;echo $?</span><br></pre></td></tr></table></figure>
<h2 id="安装常用工具"><a href="#安装常用工具" class="headerlink" title="安装常用工具"></a>安装常用工具</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ntpdate lrzsz wget vim git tree bash-completion sysstat lsof</span><br></pre></td></tr></table></figure>
<p>lrzsz是一个上传下载的软件<br>sysstat是用来检测系统性能及效率的工具</p>
<h2 id="定时自动更新服务器时间"><a href="#定时自动更新服务器时间" class="headerlink" title="定时自动更新服务器时间"></a>定时自动更新服务器时间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;*/10 * * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&apos; &gt;&gt;/var/spool/cron/root</span><br></pre></td></tr></table></figure>
<h2 id="精简开机自启动服务"><a href="#精简开机自启动服务" class="headerlink" title="精简开机自启动服务"></a>精简开机自启动服务</h2><p>刚装完操作系统可以只保留crond，network，rsyslog，sshd这四个服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#关闭所有服务</span><br><span class="line">for sun in `chkconfig --list|grep 3:on|awk &apos;&#123;print $1&#125;&apos;`;do chkconfig --level 3 $sun off;done</span><br><span class="line">#开启需要的服务</span><br><span class="line">for sun in crond rsyslog sshd network;do chkconfig --level 3 $sun on;done</span><br><span class="line">#查看开机启动服务</span><br><span class="line">chkconfig --list|grep 3:on</span><br></pre></td></tr></table></figure>
<h2 id="变更默认的ssh服务端口，禁止root用户远程连接"><a href="#变更默认的ssh服务端口，禁止root用户远程连接" class="headerlink" title="变更默认的ssh服务端口，禁止root用户远程连接"></a>变更默认的ssh服务端口，禁止root用户远程连接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak</span><br><span class="line"></span><br><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line">Port 52113#ssh连接默认的端口</span><br><span class="line">PermitRootLogin no   #root用户黑客都知道，禁止它远程登录</span><br><span class="line">PermitEmptyPasswords no #禁止空密码登录</span><br><span class="line">UseDNS no            #不使用DNS</span><br><span class="line"></span><br><span class="line">/etc/init.d/sshd reload    #从新加载配置</span><br><span class="line">netstat -lnt     #查看端口信息</span><br><span class="line">lsof -i tcp:52113</span><br></pre></td></tr></table></figure>
<h2 id="锁定关键文件系统"><a href="#锁定关键文件系统" class="headerlink" title="锁定关键文件系统"></a>锁定关键文件系统</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@c64 ~]# chattr +i /etc/passwd</span><br><span class="line">[root@c64 ~]# chattr +i /etc/inittab</span><br><span class="line">[root@c64 ~]# chattr +i /etc/group</span><br><span class="line">[root@c64 ~]# chattr +i /etc/shadow</span><br><span class="line">[root@c64 ~]# chattr +i /etc/gshadow</span><br><span class="line">使用chattr命令后，为了安全我们需要将其改名</span><br><span class="line">/bin/mv /usr/bin/chattr /usr/bin/任意名称</span><br></pre></td></tr></table></figure>
<h2 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h2><p>文件描述符在形式上是一个非负整数。实际上，它是一个索引值，指向内核为每一个进程所维护的该进程打开文件的记录表。当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。在程序设计中，一些涉及底层的程序编写往往会围绕着文件描述符展开。但是文件描述符这一概念往往只适用于Unix、Linux这样的操作系统。<br>习惯上，标准输入（standard input）的文件描述符是 0，标准输出（standard output）是 1，标准错误（standard error）是 2。尽管这种习惯并非Unix内核的特性，但是因为一些 shell 和很多应用程序都使用这种习惯，因此，如果内核不遵循这种习惯的话，很多应用程序将不能使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#临时修改，立刻生效</span><br><span class="line">ulimit -n 655360         </span><br><span class="line"> </span><br><span class="line">#永久修改</span><br><span class="line">echo &quot;* soft nofile 655360&quot; &gt;&gt; /etc/security/limits.conf&amp;&amp;echo &quot;* hard nofile 655360&quot; &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure>
<h2 id="调整字符集，使其支持中文"><a href="#调整字符集，使其支持中文" class="headerlink" title="调整字符集，使其支持中文"></a>调整字符集，使其支持中文</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sed-i &apos;s#LANG=&quot;en_US.UTF-8&quot;#LANG=&quot;zh_CN.GB18030&quot;#&apos;/etc/sysconfig/i18n</span><br><span class="line">source/etc/sysconfig/i18n</span><br><span class="line">扩展：什么是字符集？</span><br><span class="line">简单的说就是一套文字符号及其编码。常用的字符集有：</span><br><span class="line">GBK 定长双字节不是国际标准，支持系统不少</span><br><span class="line">UTF-8 非定长 1-4字节广泛支持，MYSQL也使用UTF-8</span><br></pre></td></tr></table></figure>
<h2 id="去除系统及内核版本登录前的屏幕显示"><a href="#去除系统及内核版本登录前的屏幕显示" class="headerlink" title="去除系统及内核版本登录前的屏幕显示"></a>去除系统及内核版本登录前的屏幕显示</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;/etc/redhat-release</span><br><span class="line">&gt;/etc/issue</span><br></pre></td></tr></table></figure>
<h2 id="内核参数优化"><a href="#内核参数优化" class="headerlink" title="内核参数优化"></a>内核参数优化</h2><p>说明：本优化适合apache，nginx，squid多种等web应用，特殊的业务也可能需要略作调整。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">#by sun in 20131001</span><br><span class="line">net.ipv4.tcp_fin_timeout = 2</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_keepalive_time =600</span><br><span class="line">net.ipv4.ip_local_port_range = 4000    65000</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.route.gc_timeout = 100</span><br><span class="line">net.ipv4.tcp_syn_retries = 1</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line">net.core.somaxconn = 16384</span><br><span class="line">net.core.netdev_max_backlog = 16384</span><br><span class="line">net.ipv4.tcp_max_orphans = 16384</span><br><span class="line"></span><br><span class="line">#一下参数是对iptables防火墙的优化，防火墙不开会有提示，可以忽略不理。</span><br><span class="line">net.ipv4.ip_conntrack_max = 25000000</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_max = 25000000</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_tcp_timeout_established = 180</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_tcp_timeout_time_wait = 120</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_tcp_timeout_close_wait = 60</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_tcp_timeout_fin_wait = 120</span><br><span class="line"></span><br><span class="line">sysctl –p    #使配置文件生效</span><br></pre></td></tr></table></figure>
<p>到此，我们Linux系统安装后的基础优化已经操作的差不多了，总结下来一共有13个优化点需要我们来熟知。后面我会出一个一键优化的shell脚本出来和大家一起交流学习。</p>
<p>所有的服务器基本都是最小化安装，版本为CentOS 6.x  64位系列。</p>
<h3 id="设置时区-1"><a href="#设置时区-1" class="headerlink" title="设置时区"></a>设置时区</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f /etc/localtime</span><br><span class="line">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure>
<h3 id="系统时间更新和设定定时任务"><a href="#系统时间更新和设定定时任务" class="headerlink" title="系统时间更新和设定定时任务"></a>系统时间更新和设定定时任务</h3><p>第一种：更新时间并且写入BOIS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntpdate time.windows.com &amp;&amp; hwclock -w &amp;&amp; hwclock --systohc</span><br></pre></td></tr></table></figure>
<p>第二种：更新时间并且写入定时任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;*/30 * * * * ntpdate time.windows.com &amp;&amp; hwclock -w &amp;&amp; hwclock --systohc &gt;/dev/null 2&gt;&amp;1&apos; &gt;&gt;/var/spool/cron/root</span><br></pre></td></tr></table></figure>
<p>第三种：每间隔5分钟和10分钟同步一次时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;*/5 * * * * /usr/sbin/ntpdate time.windows.com &gt;/dev/null 2 &gt;&amp;1&apos; &gt;&gt;/var/spool/cron/root</span><br><span class="line">echo &apos;*/10 * * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&apos; &gt;&gt;/var/spool/cron/root</span><br></pre></td></tr></table></figure>
<p>提示：CentOS 6.x的时间同步命令路径不一样 6是/usr/sbin/ntpdate 5是/sbin/ntpdate</p>
<p>#关闭selinux<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/SELINUX=enforcing/SELINUX=disabled/g&apos; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">getenforce</span><br></pre></td></tr></table></figure></p>
<h3 id="关闭火墙"><a href="#关闭火墙" class="headerlink" title="关闭火墙"></a>关闭火墙</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service iptables stop</span><br><span class="line">iptables -L</span><br><span class="line">service iptables save</span><br></pre></td></tr></table></figure>
<h3 id="修改文件句柄数"><a href="#修改文件句柄数" class="headerlink" title="修改文件句柄数"></a>修改文件句柄数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#查看文件描述符大小</span><br><span class="line">ulimit -n</span><br><span class="line"></span><br><span class="line">第一种：#这里参考的是阿里云主机默认设置。</span><br><span class="line">vi /etc/security/limits.conf</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br><span class="line">* soft nproc 65535</span><br><span class="line">* hard nproc 65535</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br><span class="line"></span><br><span class="line">第二种：echo &apos;* - nofile 65535&apos; &gt;&gt; /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line">第三种：把ulimit -SHn 65535命令加入到/etc/rc.local，然后每次重启生效 追加命令到rc.local配置文件里面</span><br><span class="line"></span><br><span class="line">cat &gt;&gt;/etc/rc.local&lt;&lt;EOF</span><br><span class="line">#open files</span><br><span class="line">ulimit -HSn 65535</span><br><span class="line">#stack size</span><br><span class="line">ulimit -s 65535</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">第四种：如果不修改limits配置文件，直接立即生效，但重启后又恢复之前的默认。 ulimit -SHn 65535</span><br></pre></td></tr></table></figure>
<h2 id="修改SSH端口号和屏蔽root账号远程登陆"><a href="#修改SSH端口号和屏蔽root账号远程登陆" class="headerlink" title="修改SSH端口号和屏蔽root账号远程登陆"></a>修改SSH端口号和屏蔽root账号远程登陆</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#备份SSH配置</span><br><span class="line">cp /etc/ssh/sshd_config sshd_config_bak</span><br><span class="line">#修改SSH安全配置</span><br><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line">#SSH链接默认端口</span><br><span class="line">port 52113</span><br><span class="line">#禁止root账号登陆</span><br><span class="line">PermitRootLogin no</span><br><span class="line">#禁止空密码</span><br><span class="line">PermitEmptyPasswords no</span><br><span class="line">#不使用DNS</span><br><span class="line">UseDNS no</span><br></pre></td></tr></table></figure>
<p>重新载入SSH配置 /etc/init.d/sshd reload 查看端口里面是否有刚才修改过的端口号52113</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">netstat -lnt</span><br><span class="line"> </span><br><span class="line">或者反查端口是那个进程</span><br><span class="line">lsof -i tcp:52113</span><br></pre></td></tr></table></figure>
<h3 id="配置LDAP客户端-可选"><a href="#配置LDAP客户端-可选" class="headerlink" title="配置LDAP客户端(可选)"></a>配置LDAP客户端(可选)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum install openldap-clients nss-pam-ldapd -y</span><br><span class="line"></span><br><span class="line">authconfig --enablemkhomedir \</span><br><span class="line">--disableldaptls \</span><br><span class="line">--enablemd5 \</span><br><span class="line">--enableldap \</span><br><span class="line">--enableldapauth \</span><br><span class="line">--ldapserver=ldap://211.x.x.27:8389 \</span><br><span class="line">--ldapbasedn=&quot;dc=wzlinux,dc=com&quot; \</span><br><span class="line">--enableshadow \</span><br><span class="line">--update</span><br></pre></td></tr></table></figure>
<h3 id="删除不必要的系统用户和群组"><a href="#删除不必要的系统用户和群组" class="headerlink" title="删除不必要的系统用户和群组"></a>删除不必要的系统用户和群组</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#删除不必要的用户</span><br><span class="line">userdel adm</span><br><span class="line">userdel lp</span><br><span class="line">userdel sync</span><br><span class="line">userdel shutdown</span><br><span class="line">userdel halt</span><br><span class="line">userdel news</span><br><span class="line">userdel uucp</span><br><span class="line">userdel operator</span><br><span class="line">userdel games</span><br><span class="line">userdel gopher</span><br><span class="line">userdel ftp</span><br><span class="line">#删除不必要的群组</span><br><span class="line">groupdel adm</span><br><span class="line">groupdel lp</span><br><span class="line">groupdel news</span><br><span class="line">groupdel uucp</span><br><span class="line">groupdel games</span><br><span class="line">groupdel dip</span><br><span class="line">groupdel pppusers</span><br></pre></td></tr></table></figure>
<h3 id="关闭重启ctl-alt-delete组合键"><a href="#关闭重启ctl-alt-delete组合键" class="headerlink" title="关闭重启ctl-alt-delete组合键"></a>关闭重启ctl-alt-delete组合键</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/init/control-alt-delete.conf</span><br><span class="line">#注释掉</span><br><span class="line">#exec /sbin/shutdown -r now &quot;Control-Alt-Deletepressed&quot;</span><br></pre></td></tr></table></figure>
<h3 id="设置一些全局变量"><a href="#设置一些全局变量" class="headerlink" title="设置一些全局变量"></a>设置一些全局变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#设置自动退出终端，防止非法关闭ssh客户端造成登录进程过多，可以设置大一些，单位为秒</span><br><span class="line">echo &quot;TMOUT=3600&quot;&gt;&gt; /etc/profile</span><br><span class="line">#历史命令记录数量设置为10条</span><br><span class="line">sed -i &quot;s/HISTSIZE=1000/HISTSIZE=10/&quot; /etc/profile</span><br><span class="line">#立即生效</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="关闭不需要的tty（保留2个就可以）"><a href="#关闭不需要的tty（保留2个就可以）" class="headerlink" title="关闭不需要的tty（保留2个就可以）"></a>关闭不需要的tty（保留2个就可以）</h2><p>vim /etc/inittab<br>init -q （不重启生效）</p>
<h2 id="修改shell命令的history的记录个数"><a href="#修改shell命令的history的记录个数" class="headerlink" title="修改shell命令的history的记录个数"></a>修改shell命令的history的记录个数</h2><p>vim /etc/profile<br>source /etc/profile</p>
<h2 id="关闭centos的写磁盘I-O功能"><a href="#关闭centos的写磁盘I-O功能" class="headerlink" title="关闭centos的写磁盘I/O功能"></a>关闭centos的写磁盘I/O功能</h2><p>vim /etc/fstab<br>追加类似该格式的(实际情况在修改分区)<br>/dev/sda5 /data/pics ext3 noatime,nodiratime 0 0</p>
<h2 id="优化内核参数"><a href="#优化内核参数" class="headerlink" title="优化内核参数"></a>优化内核参数</h2><h2 id="包的安装（注意尽量源码安装）"><a href="#包的安装（注意尽量源码安装）" class="headerlink" title="包的安装（注意尽量源码安装）"></a>包的安装（注意尽量源码安装）</h2><h2 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -r now</span><br></pre></td></tr></table></figure>
<p>1</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-HAProxy安装配置" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/12/HAProxy安装配置/" class="article-date">
      <time datetime="2017-11-12T05:39:00.000Z" itemprop="datePublished">2017-11-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/12/HAProxy安装配置/">HAProxy安装配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://zhang789.blog.51cto.com/11045979/1873432" target="_blank" rel="noopener">高可用高性能负载均衡软件HAproxy详解指南</a><br><a href="http://actionwenji.blog.51cto.com/4170472/1363335" target="_blank" rel="noopener">HAProxy简介和搭建</a></p>
<h2 id="haproxy简介"><a href="#haproxy简介" class="headerlink" title="haproxy简介"></a>haproxy简介</h2><p>HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代 理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。<br>   HAProxy实现了一种事件驱动, 单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制 、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户端(User-Space) 实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么他们必须进行优化以 使每个CPU时间片(Cycle)做更多的工作。<br>   HAProxy相比LVS的使用要简单很多，功能方面也很丰富。当 前，HAProxy支持两种主要的代理模式:”tcp”也即4层（大多用于邮件服务器、内部协议通信服务器等），和7层（HTTP）。在4层模式 下，HAProxy仅在客户端和服务器之间转发双向流量。7层模式下，HAProxy会分析协议，并且能通过允许、拒绝、交换、增加、修改或者删除请求 (request)或者回应(response)里指定内容来控制协议，这种操作要基于特定规则。</p>
<h2 id="HAproxy简介"><a href="#HAproxy简介" class="headerlink" title="HAproxy简介"></a>HAproxy简介</h2><p>1、HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。<br>2、HAProxy实现了一种事件驱动, 单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制 、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户空间(User-Space) 实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么他们必须进行优化以 使每个CPU时间片(Cycle)做更多的工作。(为了解决上下文切换，可以像nginx一样绑定cpu上面)</p>
<p>##为什么要使用HAproxy<br>1.免费开源，稳定性也是非常好，这个可通过一些项目可以看出来，单Haproxy也跑得不错，稳定性可以与硬件级的F5相媲美； </p>
<ol start="2">
<li>根据官方文档，HAProxy可以跑满10Gbps-New benchmark of HAProxy at 10 Gbps usingMyricom’s 10GbE NICs （Myri-10G PCI-Express），这个数值作为软件级负载均衡器是相当惊人的。 </li>
<li>HAProxy 支持连接拒绝 : 因为维护一个连接的打开的开销是很低的，有时我们很需要限制攻击蠕虫（attack bots），也就是说限制它们的连接打开从而限制它们的危害。 这个已经为一个陷于小型DDoS攻击的网站开发了而且已经拯救了很多站点，这个优点也是其它负载均衡器没有的。<br>4.HAProxy 支持全透明代理（已具备硬件防火墙的典型特点）: 可以用客户端IP地址或者任何其他地址来连接后端服务器. 这个特性仅在Linux 2.4/2.6内核打了cttproxy补丁后才可以使用，这个特性也使得为某特殊服务器处理部分流量同时又不修改服务器的地址成为可能。 </li>
<li>HAProxy现多于线上的Mysql集群环境，我们常用于它作为MySQL（读）负载均衡。 </li>
<li>自带强大的监控服务器状态的页面，实际环境中我们结合Nagios进行邮件或短信报警。 </li>
<li>HAProxy支持虚拟主机。 </li>
<li>HAProxy特别适用于那些负载特大的web站点， 这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。</li>
</ol>
<h2 id="haproxy-性能特点"><a href="#haproxy-性能特点" class="headerlink" title="haproxy 性能特点"></a>haproxy 性能特点</h2><p>HAProxy借助于OS上几种常见的技术来实现性能的最大化。</p>
<p>1、单进程、事件驱动模型显著降低了上下文切换的开销及内存占用。<br>2、O(1)事件检查器(event checker)允许其在高并发连接中对任何连接的任何事件实现即时探测。<br>3、在任何可用的情况下，单缓冲(single buffering)机制能以不复制任何数据的方式完成读写操作，这会节约大量的CPU时钟周期及内存带宽；<br>4、借助于Linux 2.6 (&gt;= 2.6.27.19)上的splice()系统调用，HAProxy可以实现零复制转发(Zero-copy forwarding)，在Linux 3.5及以上的OS中还可以实现零复制启动(zero-starting)；<br>5、MRU内存分配器在固定大小的内存池中可实现即时内存分配，这能够显著减少创建一个会话的时长；<br>6、树型存储：侧重于使用作者多年前开发的弹性二叉树，实现了以O(log(N))的低开销来保持计时器命令、保持运行队列命令及管理轮询及最少连接队列；<br>7、优化的HTTP首部分析：优化的首部分析功能避免了在HTTP首部分析过程中重读任何内存区域；<br>8、精心地降低了昂贵的系统调用，大部分工作都在用户空间完成，如时间读取、缓冲聚合及文件描述符的启用和禁用等；<br>所有的这些细微之处的优化实现了在中等规模负载之上依然有着相当低的CPU负载，甚至于在非常高的负载场景中，5%的用户空间占用率和95%的系统空间占用率也是非常普遍的现象，这意味着HAProxy进程消耗比系统空间消耗低20倍以上。因此，对OS进行性能调优是非常重要的。即使用户空间的占用率提高一倍，其CPU占用率也仅为10%，这也解释了为何7层处理对性能影响有限这一现象。由此，在高端系统上HAProxy的7层性能可轻易超过硬件负载均衡设备。<br>在生产环境中，在7层处理上使用HAProxy作为昂贵的高端硬件负载均衡设备故障故障时的紧急解决方案也时长可见。硬件负载均衡设备在“报文”级别处理请求，这在支持跨报文请求(request across multiple packets)有着较高的难度，并且它们不缓冲任何数据，因此有着较长的响应时间。对应地，软件负载均衡设备使用TCP缓冲，可建立极长的请求，且有着较大的响应时间。</p>
<h2 id="负载均衡器的性能评估因素"><a href="#负载均衡器的性能评估因素" class="headerlink" title="负载均衡器的性能评估因素"></a>负载均衡器的性能评估因素</h2><p>三个重要因素：<br>1、会话率 ：单位时间内的处理的请求数<br>2、会话并发能力：并发处理能力<br>3、数据率：处理数据能力<br>经过官方测试统计，haproxy 单位时间处理的最大请求数为20000个，可以同时维护40000-50000个并发连接，最大数据处理能力为10Gbps。综合上述，haproxy是性能优越的负载均衡、反向代理服务器。</p>
<h1 id="安装HAproxy"><a href="#安装HAproxy" class="headerlink" title="安装HAproxy"></a>安装HAproxy</h1><p>1、安装haproxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum -y groupinstall &quot;Development Tools&quot;</span><br><span class="line">[root@localhost ~]# yum -y install haproxy</span><br></pre></td></tr></table></figure>
<p>2、配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# rpm -ql haproxy</span><br><span class="line">/etc/haproxy   #配置文件目录 </span><br><span class="line">/etc/haproxy/haproxy.cfg   #配置文件 </span><br><span class="line">/usr/lib/systemd/system/haproxy.service    #启动脚本</span><br><span class="line">/usr/sbin/haproxy    #haproxy 命令 </span><br><span class="line">/usr/share/man/man1/haproxy.1.gz #man 文档</span><br></pre></td></tr></table></figure>
<p>3、默认配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy haproxy]# cat haproxy.cfg</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line"># Example configuration for a possible web application.  See the </span><br><span class="line"># full configuration options online. </span><br><span class="line"># </span><br><span class="line">#   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt  #官方配置文档，很详细，英文没问题的博友，可以看看</span><br><span class="line"># </span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># Global settings #全局配置文件</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">global </span><br><span class="line">    # to have these messages end up in /var/log/haproxy.log you will </span><br><span class="line">    # need to:  #配置日志</span><br><span class="line">    # </span><br><span class="line">    # 1) configure syslog to accept network log events.  This is done </span><br><span class="line">    #    by adding the &apos;-r&apos; option to the SYSLOGD_OPTIONS in </span><br><span class="line">    #    /etc/sysconfig/syslog #修改syslog配置文件</span><br><span class="line">    # </span><br><span class="line">    # 2) configure local2 events to go to the /var/log/haproxy.log </span><br><span class="line">    #   file. A line like the following can be added to </span><br><span class="line">    #   /etc/sysconfig/syslog  #定义日志设备</span><br><span class="line">    # </span><br><span class="line">    #    local2.*                       /var/log/haproxy.log </span><br><span class="line">    # </span><br><span class="line">    log         127.0.0.1 local2 #</span><br><span class="line">#全局的日志配置 其中日志级别是[err warning info debug]</span><br><span class="line">#local0 是日志设备，必须为如下24种标准syslog设备的一种:</span><br><span class="line">#kern user mail daemon auth syslog lpr news</span><br><span class="line">#uucp cron auth2 ftp ntp audit alert cron2</span><br><span class="line">#local0 local1 local2 local3 local4 local5 local6 local7</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid #将所有进程的pid写入文件启动进程的用户必须有权限访问此文件。</span><br><span class="line">    maxconn     4000 #最大连接数，默认4000</span><br><span class="line">    user        haproxy #用户</span><br><span class="line">    group       haproxy #组</span><br><span class="line">    daemon ##创建1个进程进入deamon模式运行。此参数要求将运行模式设置为&quot;daemon&quot;</span><br><span class="line">    # turn on stats unix socket  #unix socket 文件</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># common defaults that all the &apos;listen&apos; and &apos;backend&apos; sections will </span><br><span class="line"># use if not designated in their block  #默认的全局设置，这些参数可以被利用配置到frontend，backend，listen组件</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">defaults</span><br><span class="line">    mode                    http  #默认的模式mode &#123; tcp|http|health &#125;，tcp是4层，http是7层，health只会返回OK</span><br><span class="line">    log                     global #采用全局定义的日志</span><br><span class="line">    option                  httplog #日志类别http日志格式</span><br><span class="line">    option                  dontlognull #不记录健康检查的日志信息</span><br><span class="line">    option http-server-close #每次请求完毕后主动关闭http通道</span><br><span class="line">    option forwardfor       except 127.0.0.0/8 #不记录本机转发的日志</span><br><span class="line">    option                  redispatch #serverId对应的服务器挂掉后,强制定向到其他健康的服务器</span><br><span class="line">    retries                 3 #3次连接失败就认为服务不可用，也可以通过后面设置</span><br><span class="line">    timeout http-request    10s  #请求超时</span><br><span class="line">    timeout queue           1m #队列超时</span><br><span class="line">    timeout connect         10s #连接超时</span><br><span class="line">    timeout client          1m #客户端连接超时</span><br><span class="line">    timeout server          1m #服务器连接超时</span><br><span class="line">    timeout http-keep-alive 10s #长连接超时</span><br><span class="line">    timeout check           10s  #检查超时</span><br><span class="line">    maxconn                 3000 #最大连接数</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># main frontend which proxys to the backends #frontend 与backends  代理配置</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">frontend  main *:5000</span><br><span class="line">#acl策略配置</span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /stylesheets </span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line">    use_backend static          if url_static  #满足策略要求，则响应策略定义的backend页面</span><br><span class="line">    default_backend             app #不满足则响应backend的默认页面</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># static backend for serving up images, stylesheets and such #定义使用静态后端图像，样式表等</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">backend static </span><br><span class="line">    balance     roundrobin #负载均衡模式轮询</span><br><span class="line">    server      static 127.0.0.1:4331 check #服务器定义</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># round robin balancing between the various backends </span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">backend app </span><br><span class="line">    balance     roundrobin #负载均衡模式轮询</span><br><span class="line">    server  app1 127.0.0.1:5001 check #服务器定义，check进行健康检查</span><br><span class="line">    server  app2 127.0.0.1:5002 check </span><br><span class="line">    server  app3 127.0.0.1:5003 check </span><br><span class="line">    server  app4 127.0.0.1:5004 check</span><br></pre></td></tr></table></figure>
<h1 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h1><h2 id="实现web负载"><a href="#实现web负载" class="headerlink" title="实现web负载"></a>实现web负载</h2><p>client-&gt;Internet-HAProxy-&gt;{Web 1,Web 2}</p>
<p>1、安装http和测试页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web1 ~]# yum -y install httpd</span><br><span class="line">[root@web1 ~]# cd /var/www/html/</span><br><span class="line">[root@web1 html]# echo &quot;&lt;h1&gt;Server WWW node1&lt;/h1&gt;&quot; &gt; index.html</span><br></pre></td></tr></table></figure>
<p>2、node2安装http和测试页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web2 ~]# yum -y install httpd</span><br><span class="line">[root@web2 ~]# cd /var/www/html/</span><br><span class="line">[root@web2 html]# echo &quot;&lt;h1&gt;Server WWW node2&lt;/h1&gt;&quot; &gt; index.html</span><br></pre></td></tr></table></figure>
<p>3、haproxy安装配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HAproxy ~]# yum -y groupinstall &quot;Development Tools&quot;</span><br><span class="line">[root@HAproxy ~]# yum -y install haproxy</span><br></pre></td></tr></table></figure>
<p>4、配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@HAproxy ~]# cat /etc/haproxy/haproxy.cfg </span><br><span class="line">......主要配置函数</span><br><span class="line">listen stats   #监控页面</span><br><span class="line">    mode http</span><br><span class="line">    bind 0.0.0.0:1080</span><br><span class="line">    stats enable</span><br><span class="line">    stats hide-version</span><br><span class="line">    stats uri     /haproxyadmin?stats</span><br><span class="line">    stats realm   Haproxy\ Statistics</span><br><span class="line">    stats auth    admin:admin</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">frontend main  #定义服务器组</span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend server</span><br><span class="line">backend server  #定义服务器</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    option httpchk HEAD /index.html HTTP/1.0</span><br><span class="line">    server node1 192.168.211.140:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br><span class="line">    server node2 192.168.211.128:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br></pre></td></tr></table></figure>
<p>5、查看监控页面<br><a href="http://haproxy:1080/haproxyadmin?stats" target="_blank" rel="noopener">http://haproxy:1080/haproxyadmin?stats</a></p>
<p>6、测试</p>
<h1 id="HAproxy配置文件详解"><a href="#HAproxy配置文件详解" class="headerlink" title="HAproxy配置文件详解"></a>HAproxy配置文件详解</h1><p>1、配置文件的格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HAProxy的配置处理3类来主要参数来源：</span><br><span class="line">——最优先处理的命令行参数，</span><br><span class="line">——“global”配置段，用于设定全局配置参数；</span><br><span class="line">——proxy相关配置段，如“defaults”、“listen”、“frontend”和“backend”；</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">“defaults”段用于为所有其它配置段提供默认参数，这配置默认配置参数可由下一个“defaults”所重新设定。 </span><br><span class="line">“frontend”段用于定义一系列监听的套接字，这些套接字可接受客户端请求并与之建立连接。 </span><br><span class="line">“backend”段用于定义一系列“后端”服务器，代理将会将对应客户端的请求转发至这些服务器。 </span><br><span class="line">“listen”段通过关联“前端”和“后端”定义了一个完整的代理，通常只对TCP流量有用。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>1、注，“global”配置中的参数为进程级别的参数，且通常与其运行的OS相关。<br>2、注，所有代理的名称只能使用大写字母、小写字母、数字、-(中线)、_(下划线)、.(点号)和:(冒号)。此外，ACL名称会区分字母大小写。</p>
</blockquote>
<p>2、时间格式<br>一些包含了值的参数表示时间，如超时时长。这些值一般以毫秒为单位，但也可以使用其它的时间单位后缀。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">us: 微秒(microseconds)，即1/1000000秒；</span><br><span class="line">ms: 毫秒(milliseconds)，即1/1000秒；</span><br><span class="line">s: 秒(seconds)；</span><br><span class="line">m: 分钟(minutes)；</span><br><span class="line">h：小时(hours)；</span><br><span class="line">d: 天(days)；</span><br></pre></td></tr></table></figure>
<p>3、例子</p>
<p>下面的例子配置了一个监听在所有接口的80端口上HTTP proxy服务，它转发所有的请求轮训至后端192.168.211.139和192.168.211.128的”server”上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    daemon</span><br><span class="line">    maxconn 25600</span><br><span class="line">defaults</span><br><span class="line">    mode http</span><br><span class="line">    timeout connect 5000ms</span><br><span class="line">    timeout client 50000ms</span><br><span class="line">    timeout server 50000ms</span><br><span class="line">frontend http-in</span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend servers</span><br><span class="line">backend servers</span><br><span class="line">        balance roundrobin</span><br><span class="line">        server server1 192.168.211.139:80 check</span><br><span class="line">        server server2 192.168.211.128:80 check</span><br></pre></td></tr></table></figure>
<p>4.全局配置</p>
<blockquote>
<p>注，“global”配置中的参数为进程级别的参数，且通常与其运行的OS相关。</p>
</blockquote>
<p>(1).进程管理及安全相关的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">chroot &lt;jail dir&gt;：修改haproxy的工作目录至指定的目录并在放弃权限之前执行chroot()操作，可以提升haproxy的安全级别，不过需要注意的是要确保指定的目录为空目录且任何用户均不能有写权限； </span><br><span class="line">daemon：让haproxy以守护进程的方式工作于后台，其等同于“-D”选项的功能，当然，也可以在命令行中以“-db”选项将其禁用； </span><br><span class="line">gid &lt;number&gt;：以指定的GID运行haproxy，建议使用专用于运行haproxy的GID，以免因权限问题带来风险； </span><br><span class="line">group &lt;group name&gt;：同gid，不过指定的组名； </span><br><span class="line">log &lt;address&gt; &lt;facility&gt; [max level [min level]]：定义全局的syslog服务器，最多可以定义两个； </span><br><span class="line">log-send-hostname [&lt;string&gt;]：在syslog信息的首部添加当前主机名，可以为“string”指定的名称，也可以缺省使用当前主机名； </span><br><span class="line">nbproc &lt;number&gt;：指定启动的haproxy进程个数，只能用于守护进程模式的haproxy；默认只启动一个进程，鉴于调试困难等多方面的原因，一般只在单进程仅能打开少数文件描述符的场景中才使用多进程模式； </span><br><span class="line">pidfile：将所有进程的pid写入文件启动进程的用户必须有权限访问此文件 </span><br><span class="line">uid：以指定的UID身份运行haproxy进程； </span><br><span class="line">ulimit-n：设定每进程所能够打开的最大文件描述符数目，默认情况下其会自动进行计算，因此不推荐修改此选项； </span><br><span class="line">user：同uid，但使用的是用户名； </span><br><span class="line">stats： </span><br><span class="line">node：定义当前节点的名称，用于HA场景中多haproxy进程共享同一个IP地址时； </span><br><span class="line">description：当前实例的描述信息；</span><br></pre></td></tr></table></figure>
<p>(2).性能调整相关的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">maxconn &lt;number&gt;：设定每个haproxy进程所接受的最大并发连接数，其等同于命令行选项“n”；“ulimit n”自动计算的结果正是参照此参数设定的； </span><br><span class="line">maxpipes &lt;number&gt;：haproxy使用pipe完成基于内核的tcp报文重组，此选项则用于设定每进程所允许使用的最大pipe个数；每个pipe会打开两个文件描述符，因此，“ulimit n”自动计算时会根据需要调大此值；默认为maxconn/4，其通常会显得过大； </span><br><span class="line">noepoll：在Linux系统上禁用epoll机制； </span><br><span class="line">nokqueue：在BSE系统上禁用kqueue机制； </span><br><span class="line">nopoll：禁用poll机制； </span><br><span class="line">nosepoll：在Linux禁用启发式epoll机制； </span><br><span class="line">nosplice：禁止在Linux套接字上使用内核tcp重组，这会导致更多的recv/send系统调用；不过，在Linux 2.6.2528系列的内核上，tcp重组功能有bug存在； </span><br><span class="line">spreadchecks &lt;0..50, in percent&gt;：在haproxy后端有着众多服务器的场景中，在精确的时间间隔后统一对众服务器进行健康状况检查可能会带来意外问题；此选项用于将其检查的时间间隔长度上增加或减小一定的随机时长； </span><br><span class="line">tune.bufsize &lt;number&gt;：设定buffer的大小，同样的内存条件小，较小的值可以让haproxy有能力接受更多的并发连接，较大的值可以让某些应用程序使用较大的cookie信息；默认为16384，其可以在编译时修改，不过强烈建议使用默认值； </span><br><span class="line">tune.chksize &lt;number&gt;：设定检查缓冲区的大小，单位为字节；更大的值有助于在较大的页面中完成基于字符串或模式的文本查找，但也会占用更多的系统资源；不建议修改; </span><br><span class="line">tune.maxaccept &lt;number&gt;：设定haproxy进程内核调度运行时一次性可以接受的连接的个数，较大的值可以带来较大的吞吐率，默认在单进程模式下为100，多进程模式下为8，设定为1可以禁止此限制；一般不建议修改； </span><br><span class="line">tune.maxpollevents &lt;number&gt;：设定一次系统调用可以处理的事件最大数，默认值取决于OS；其值小于200时可节约带宽，但会略微增大网络延迟，而大于200时会降低延迟，但会稍稍增加网络带宽的占用量； </span><br><span class="line">tune.maxrewrite &lt;number&gt;：设定为首部重写或追加而预留的缓冲空间，建议使用1024左右的大小；在需要使用更大的空间时，haproxy会自动增加其值； </span><br><span class="line">tune.rcvbuf.server &lt;number&gt;：设定内核套接字中服务端或客户端接收缓冲的大小，单位为字节；强烈推荐使用默认值；</span><br></pre></td></tr></table></figure>
<h2 id="haproxy-配置文件中的关键字参考"><a href="#haproxy-配置文件中的关键字参考" class="headerlink" title="haproxy 配置文件中的关键字参考"></a>haproxy 配置文件中的关键字参考</h2><p>1.balance</p>
<p>格式：</p>
<p>balance <algorithm> [ <arguments> ]<br>balance url_param <param> [check_post [&lt;max_wait&gt;]]<br>定义负载均衡算法，可用于“defaults”、“listen”和“backend”。用于在负载均衡场景中挑选一个server，其仅应用于持久信息不可用的条件下或需要将一个连接重新派发至另一个服务器时。支持的算法有：</arguments></algorithm></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">roundrobin：基于权重进行轮叫，在服务器的处理时间保持均匀分布时，这是最平衡、最公平的算法。此算法是动态的，这表示其权重可以在运行时进行调整，不过，在设计上，最多能接受4128个后端服务器；（这完全够我们用了） </span><br><span class="line">static-rr：基于权重进行轮叫，与roundrobin类似，但是为静态方法，在运行时调整其服务器权重不会生效；不过，其在后端服务器连接数上没有限制；（新的服务器上线后，会立即发送上来大量的连接） </span><br><span class="line">leastconn：新的连接请求被派发至具有最少连接数目的后端服务器；在有着较长时间会话的场景中推荐使用此算法，如LDAP、SQL等，其并不太适用于较短会话的应用层协议，如HTTP；此算法是动态的，可以在运行时调整其权重； </span><br><span class="line">source：将请求的源地址进行hash运算，并由后端服务器的权重总数相除后派发至某匹配的服务器；这可以使得同一个客户端IP的请求始终被派发至某特定的服务器；不过，当服务器权重总数发生变化时，如某服务器宕机或添加了新的服务器，许多客户端的请求可能会被派发至与此前请求不同的服务器；常用于负载均衡无cookie功能的基于TCP的协议；其默认为静态，不过也可以使用hash-type修改此特性； </span><br><span class="line">uri：对URI的左半部分(“问题”标记之前的部分)或整个URI进行hash运算，并由服务器的总权重相除后派发至某匹配的服务器；这可以使得对同一个URI的请求总是被派发至某特定的服务器，除非服务器的权重总数发生了变化；此算法常用于代理缓存或反病毒代理以提高缓存的命中率；需要注意的是，此算法仅应用于HTTP后端服务器场景；其默认为静态算法，不过也可以使用hash-type修改此特性； </span><br><span class="line">url_param：通过为URL指定的参数在每个HTTP GET请求中将会被检索；如果找到了指定的参数且其通过等于号“=”被赋予了一个值，那么此值将被执行hash运算并被服务器的总权重相除后派发至某匹配的服务器；此算法可以通过追踪请求中的用户标识进而确保同一个用户ID的请求将被送往同一个特定的服务器，除非服务器的总权重发生了变化；如果某请求中没有出现指定的参数或其没有有效值，则使用轮叫算法对相应请求进行调度；此算法默认为静态的，不过其也可以使用hash-type修改此特性； </span><br><span class="line">hdr(&lt;name&gt;)：对于每个HTTP请求，通过指定的HTTP首部将会被检索；如果相应的首部没有出现或其没有有效值，则使用轮叫算法对相应请求进行调度；其有一个可选选项“use_domain_only”，可在指定检索类似Host类的首部时仅计算域名部分(比如通过www.test.com来说，仅计算test字符串的hash值)以降低hash算法的运算量；此算法默认为静态的，不过其也可以使用hash-type修改此特性； </span><br><span class="line">rdp-cookie </span><br><span class="line">rdp-cookie(name)</span><br></pre></td></tr></table></figure>
<p>会话保持机制</p>
<p>1、调度众多的MySQL从服务器，用什么调度方法？<br>    leastconn<br>2、调度web图片服务器组，用什么调度方法？<br>    roundrobin<br>3、调度web应用程序服务器组，用什么调度方法？<br>    source<br>    session保持的方式：<br>        session绑定<br>            源IP绑定：<br>                nginx: ip_hash<br>                haproxy: source<br>                ipvs: sh<br>            cookie绑定：<br>                cookie<br>                    session复制<br>                    session服务器<br>4、调度web缓存服务器组，用什么调度方法？<br>    uri<br>    hash-type<br>    map-based<br>    consistent<br>///解释：<br>uri: 用于后端服务器是cache server的场景，保证缓存命中率的；<br>url-params: 常用于后端服务器需要对用户进行认证的场景中；<br>hdr(host)<br>            host: <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a><br>            host: web.magedu.com<br>use_domain_only：在计算hash值时，仅使用域名，如上面的magedu.com；<br>常用于hdr(host)实现将对同一个虚拟主机的访问始终定向至同一个upstream server；</p>
<p>2.bind</p>
<p>格式：</p>
<p>bind [<address>]:&lt;port_range&gt; [, …]<br>bind [<address>]:&lt;port_range&gt; [, …] interface <interface><br>此指令仅能用于frontend和listen区段，用于定义一个或几个监听的套接字。 </interface></address></address></p>
<p><address>：可选选项，其可以为主机名、IPv4地址、IPv6地址或；省略此选项、将其指定为或0.0.0.0时，将监听当前系统的所有IPv4地址； </address></p>
<p>&lt;port_range&gt;：可以是一个特定的TCP端口，也可是一个端口范围(如5005-5010)，代理服务器将通过指定的端口来接收客户端请求；需要注意的是，每组监听的套接字在同一个实例上只能使用一次，而且小于1024的端口需要有特定权限的用户才能使用，这可能需要通过uid参数来定义； </p>
<p><interface>：指定物理接口的名称，仅能在Linux系统上使用；其不能使用接口别名，而仅能使用物理接口名称，而且只有管理有权限指定绑定的物理接口；</interface></p>
<p>3.mode</p>
<p>格式：</p>
<p>mode { tcp|http|health }<br>设定实例的运行模式或协议。当实现内容交换时，前端和后端必须工作于同一种模式(一般说来都是HTTP模式)，否则将无法启动实例。<br>tcp：实例运行于纯TCP模式，在客户端和服务器端之间将建立一个全双工的连接，且不会对7层报文做任何类型的检查；此为默认模式，通常用于SSL、SSH、SMTP等应用；<br>http：实例运行于HTTP模式，客户端请求在转发至后端服务器之前将被深度分析，所有不与RFC格式兼容的请求都会被拒绝；<br>health：实例工作于health模式，其对入站请求仅响应“OK”信息并关闭连接，且不会记录任何日志信息；此模式将用于响应外部组件的健康状态检查请求；目前来讲，此模式已经废弃，因为tcp或http模式中的monitor关键字可完成类似功能；</p>
<ol start="4">
<li>hash-type</li>
</ol>
<p>格式：</p>
<p>hash-type <method><br>定义用于将hash码映射至后端服务器的方法；其不能用于frontend区段；可用方法有map-based和consistent，在大多数场景下推荐使用默认的map-based方法。<br>map-based：hash表是一个包含了所有在线服务器的静态数组。其hash值将会非常平滑，会将权重考虑在列，但其为静态方法，对在线服务器的权重进行调整将不会生效，这意味着其不支持慢速启动。此外，挑选服务器是根据其在数组中的位置进行的，因此，当一台服务器宕机或添加了一台新的服务器时，大多数连接将会被重新派发至一个与此前不同的服务器上，对于缓存服务器的工作场景来说，此方法不甚适用。<br>consistent：hash表是一个由各服务器填充而成的树状结构；基于hash键在hash树中查找相应的服务器时，最近的服务器将被选中。此方法是动态的，支持在运行时修改服务器权重，因此兼容慢速启动的特性。添加一个新的服务器时，仅会对一小部分请求产生影响，因此，尤其适用于后端服务器为cache的场景。不过，此算法不甚平滑，派发至各服务器的请求未必能达到理想的均衡效果，因此，可能需要不时的调整服务器的权重以获得更好的均衡性。</method></p>
<p>5.log</p>
<p>格式：</p>
<p>log global<br>log <address> <facility> [<level> [<minlevel>]]<br>为每个实例启用事件和流量日志，因此可用于所有区段。每个实例最多可以指定两个log参数，不过，如果使用了“log global”且”global”段已经定了两个log参数时，多余了log参数将被忽略。<br>global：当前实例的日志系统参数同”global”段中的定义时，将使用此格式；每个实例仅能定义一次“log global”语句，且其没有任何额外参数； </minlevel></level></facility></address></p>
<p><address>：定义日志发往的位置，其格式之一可以为，其中的port为UDP协议端口，默认为514；格式之二为Unix套接字文件路径，但需要留心chroot应用及用户的读写权限； </address></p>
<p><facility>：可以为syslog系统的标准facility之一； </facility></p>
<p><level>：定义日志级别，即输出信息过滤器，默认为所有信息；指定级别时，所有等于或高于此级别的日志信息将会被发送；</level></p>
<p>6.maxconn</p>
<p>格式：</p>
<p>maxconn <conns><br>设定一个前端的最大并发连接数，因此，其不能用于backend区段。对于大型站点来说，可以尽可能提高此值以便让haproxy管理连接队列，从而避免无法应答用户请求。当然，此最大值不能超出“global”段中的定义。此外，需要留心的是，haproxy会为每个连接维持两个缓冲，每个缓冲的大小为8KB，再加上其它的数据，每个连接将大约占用17KB的RAM空间。这意味着经过适当优化后，有着1GB的可用RAM空间时将能维护40000-50000并发连接。</conns></p>
<p>如果为指定了一个过大值，极端场景下，其最终占据的空间可能会超出当前主机的可用内存，这可能会带来意想不到的结果；因此，将其设定了一个可接受值方为明智决定。其默认为2000。</p>
<p>7.default_backend</p>
<p>格式：</p>
<p>default_backend <backend><br>在没有匹配的”use_backend”规则时为实例指定使用的默认后端，因此，其不可应用于backend区段。在”frontend”和”backend”之间进行内容交换时，通常使用”use-backend”定义其匹配规则；而没有被规则匹配到的请求将由此参数指定的后端接收。 </backend></p>
<p><backend>：指定使用的后端的名称；<br>使用案例：</backend></p>
<p>use_backend     dynamic  if  url_dyn<br>use_backend     static   if  url_css url_img extension_img<br>default_backend dynamic<br>8.server</p>
<p>格式：</p>
<p>server <name> <address>[:port] [param*]<br>为后端声明一个server，因此，不能用于defaults和frontend区段。 </address></name></p>
<p><name>：为此服务器指定的内部名称，其将出现在日志及警告信息中；如果设定了”http-send-server-name”，它还将被添加至发往此服务器的请求首部中； </name></p>
<p><address>：此服务器的的IPv4地址，也支持使用可解析的主机名，只不过在启动时需要解析主机名至相应的IPv4地址；<br>[:port]：指定将连接请求所发往的此服务器时的目标端口，其为可选项；未设定时，将使用客户端请求时的同一相端口；<br>[param*]：为此服务器设定的一系参数；其可用的参数非常多，具体请参考官方文档中的说明，下面仅说明几个常用的参数；</address></p>
<p>服务器或默认服务器参数：</p>
<p>backup：设定为备用服务器，仅在负载均衡场景中的其它server均不可用于启用此server；</p>
<p>check：启动对此server执行健康状态检查，其可以借助于额外的其它参数完成更精细的设定，如：</p>
<blockquote>
<p>inter <delay>：设定健康状态检查的时间间隔，单位为毫秒，默认为2000；也可以使用fastinter和downinter来根据服务器端状态优化此时间延迟；<br>rise <count>：设定健康状态检查中，某离线的server从离线状态转换至正常状态需要成功检查的次数；<br>fall <count>：确认server从正常状态转换为不可用状态需要检查的次数；</count></count></delay></p>
</blockquote>
<p>cookie <value>：为指定server设定cookie值，此处指定的值将在请求入站时被检查，第一次为此值挑选的server将在后续的请求中被选中，其目的在于实现持久连接的功能；<br>maxconn <maxconn>：指定此服务器接受的最大并发连接数；如果发往此服务器的连接数目高于此处指定的值，其将被放置于请求队列，以等待其它连接被释放；<br>maxqueue <maxqueue>：设定请求队列的最大长度；<br>observe <mode>：通过观察服务器的通信状况来判定其健康状态，默认为禁用，其支持的类型有“layer4”和“layer7”，“layer7”仅能用于http代理场景；<br>redir <prefix>：启用重定向功能，将发往此服务器的GET和HEAD请求均以302状态码响应；需要注意的是，在prefix后面不能使用/，且不能使用相对地址，以免造成循环；例如：server srv1 172.16.100.6:80 redir <a href="http://imageserver.test.com" target="_blank" rel="noopener">http://imageserver.test.com</a> check </prefix></mode></maxqueue></maxconn></value></p>
<p>weight <weight>：权重，默认为1，最大值为256，0表示不参与负载均衡；</weight></p>
<p>检查方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">option httpchk    </span><br><span class="line">option httpchk &lt;uri&gt;    </span><br><span class="line">option httpchk &lt;method&gt; &lt;uri&gt;    </span><br><span class="line">option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt;：不能用于frontend段，例如：</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backend https_relay</span><br><span class="line">    mode tcp</span><br><span class="line">    option httpchk OPTIONS * HTTP/1.1\r\nHost:\ www.test.com</span><br><span class="line">    server apache1 192.168.1.1:443 check port 80</span><br></pre></td></tr></table></figure>
<p>使用案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server first  172.16.100.7:1080 cookie first  check inter 1000</span><br><span class="line">server second 172.16.100.8:1080 cookie second check inter 1000</span><br></pre></td></tr></table></figure>
<p>9.capture request header</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">capture request header &lt;name&gt; len &lt;length&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>捕获并记录指定的请求首部最近一次出现时的第一个值，仅能用于“frontend”和“listen”区段。捕获的首部值使用花括号{}括起来后添加进日志中。如果需要捕获多个首部值，它们将以指定的次序出现在日志文件中，并以竖线“|”作为分隔符。不存在的首部记录为空字符串，最常需要捕获的首部包括在虚拟主机环境中使用的“Host”、上传请求首部中的“Content-length”、快速区别真实用户和网络机器人的“User-agent”，以及代理环境中记录真实请求来源的“X-Forward-For”。</p>
</blockquote>
<p><name>：要捕获的首部的名称，此名称不区分字符大小写，但建议与它们出现在首部中的格式相同，比如大写首字母。需要注意的是，记录在日志中的是首部对应的值，而非首部名称。 </name></p>
<p><length>：指定记录首部值时所记录的精确长度，超出的部分将会被忽略。<br>可以捕获的请求首部的个数没有限制，但每个捕获最多只能记录64个字符。为了保证同一个frontend中日志格式的统一性，首部捕获仅能在frontend中定义。</length></p>
<p>10.capture response header</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">capture response header &lt;name&gt; len &lt;length&gt;</span><br></pre></td></tr></table></figure>
<p>捕获并记录响应首部，其格式和要点同请求首部。</p>
<p>11.stats enable</p>
<p>格式：<br>启用基于程序编译时默认设置的统计报告，不能用于“frontend”区段。只要没有另外的其它设定，它们就会使用如下的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stats uri   : /haproxy?stats</span><br><span class="line">stats realm : &quot;HAProxy Statistics&quot;</span><br><span class="line">stats auth  : no authentication</span><br><span class="line">stats scope : no restriction</span><br></pre></td></tr></table></figure>
<p>尽管“stats enable”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而带来非期后果。下面是一个配置案例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">backend public_www</span><br><span class="line">  server websrv1 172.16.100.11:80</span><br><span class="line">  stats enable</span><br><span class="line">  stats hide-version</span><br><span class="line">  stats scope   .</span><br><span class="line">  stats uri     /haproxyadmin?stats</span><br><span class="line">  stats realm   Haproxy\ Statistics</span><br><span class="line">  stats auth    statsadmin:password</span><br><span class="line">  stats auth    statsmaster:password</span><br></pre></td></tr></table></figure>
<p>12.stats hide-version</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats hide-version</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启用统计报告并隐藏HAProxy版本报告，不能用于“frontend”区段。默认情况下，统计页面会显示一些有用信息，包括HAProxy的版本号，然而，向所有人公开HAProxy的精确版本号是非常有风险的，因为它能帮助恶意用户快速定位版本的缺陷和漏洞。尽管“stats hide-version”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而带来非期后果。具体请参照“stats enable”一节的说明。</p>
</blockquote>
<p>13.stats realm</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats realm &lt;realm&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启用统计报告并高精认证领域，不能用于“frontend”区段。haproxy在读取realm时会将其视作一个单词，因此，中间的任何空白字符都必须使用反斜线进行转义。此参数仅在与“stats auth”配置使用时有意义。</p>
</blockquote>
<p><realm>：实现HTTP基本认证时显示在浏览器中的领域名称，用于提示用户输入一个用户名和密码。<br>尽管“stats realm”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而带来非期后果。具体请参照“stats enable”一节的说明。</realm></p>
<p>14.stats scope</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats scope &#123; &lt;name&gt; | &quot;.&quot; &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启用统计报告并限定报告的区段，不能用于“frontend”区段。当指定此语句时，统计报告将仅显示其列举出区段的报告信息，所有其它区段的信息将被隐藏。如果需要显示多个区段的统计报告，此语句可以定义多次。需要注意的是，区段名称检测仅仅是以字符串比较的方式进行，它不会真检测指定的区段是否真正存在。</p>
</blockquote>
<p><name>：可以是一个“listen”、“frontend”或“backend”区段的名称，而“.”则表示stats scope语句所定义的当前区段。<br>尽管“stats scope”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而带来非期后果。下面是一个配置案例。</name></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backend private_monitoring</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri     /haproxyadmin?stats</span><br><span class="line">    stats refresh 10s</span><br></pre></td></tr></table></figure>
<p>15.stats auth</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats auth &lt;user&gt;:&lt;passwd&gt;</span><br></pre></td></tr></table></figure>
<p>启用带认证的统计报告功能并授权一个用户帐号，其不能用于“frontend”区段。 </p>
<p><user>：授权进行访问的用户名； </user></p>
<p><passwd>：此用户的访问密码，明文格式；</passwd></p>
<blockquote>
<p>此语句将基于默认设定启用统计报告功能，并仅允许其定义的用户访问，其也可以定义多次以授权多个用户帐号。可以结合“stats realm”参数在提示用户认证时给出一个领域说明信息。在使用非法用户访问统计功能时，其将会响应一个“401 Forbidden”页面。其认证方式为HTTP Basic认证，密码传输会以明文方式进行，因此，配置文件中也使用明文方式存储以说明其非保密信息故此不能相同于其它关键性帐号的密码。<br>尽管“stats auth”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而带来非期后果。</p>
</blockquote>
<p>16.stats admin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats admin &#123; if | unless &#125; &lt;cond&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在指定的条件满足时启用统计报告页面的管理级别功能，它允许通过web接口启用或禁用服务器，不过，基于安全的角度考虑，统计报告页面应该尽可能为只读的。此外，如果启用了HAProxy的多进程模式，启用此管理级别将有可能导致异常行为。<br>目前来说，POST请求方法被限制于仅能使用缓冲区减去保留部分之外的空间，因此，服务器列表不能过长，否则，此请求将无法正常工作。因此，建议一次仅调整少数几个服务器。下面是两个案例，第一个限制了仅能在本机打开报告页面时启用管理级别功能，第二个定义了仅允许通过认证的用户使用管理级别功能。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">backend stats_localhost</span><br><span class="line">    stats enable</span><br><span class="line">    stats admin if LOCALHOST</span><br><span class="line">backend stats_auth</span><br><span class="line">    stats enable</span><br><span class="line">    stats auth  haproxyadmin:password</span><br><span class="line">    stats admin if TRUE</span><br></pre></td></tr></table></figure>
<p>17.option httplog</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option httplog [ clf ]</span><br></pre></td></tr></table></figure>
<p>启用记录HTTP请求、会话状态和计时器的功能。<br>clf：使用CLF格式来代替HAProxy默认的HTTP格式，通常在使用仅支持CLF格式的特定日志分析器时才需要使用此格式。</p>
<blockquote>
<p>默认情况下，日志输入格式非常简陋，因为其仅包括源地址、目标地址和实例名称，而“option httplog”参数将会使得日志格式变得丰富许多，其通常包括但不限于HTTP请求、连接计时器、会话状态、连接数、捕获的首部及cookie、“frontend”、“backend”及服务器名称，当然也包括源地址和端口号等。</p>
</blockquote>
<p>18.option logasap</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">option logasap   </span><br><span class="line">no option logasap</span><br></pre></td></tr></table></figure>
<p>启用或禁用提前将HTTP请求记入日志，不能用于“backend”区段。</p>
<blockquote>
<p>默认情况下，HTTP请求是在请求结束时进行记录以便能将其整体传输时长和字节数记入日志，由此，传较大的对象时，其记入日志的时长可能会略有延迟。“option logasap”参数能够在服务器发送complete首部时即时记录日志，只不过，此时将不记录整体传输时长和字节数。此情形下，捕获“Content-Length”响应首部来记录传输的字节数是一个较好选择。下面是一个例子。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listen http_proxy 0.0.0.0:80</span><br><span class="line">    mode http</span><br><span class="line">    option httplog</span><br><span class="line">    option logasap</span><br><span class="line">    log 172.16.100.9 local2</span><br></pre></td></tr></table></figure>
<p>19.option forwardfor</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option forwardfor [ except &lt;network&gt; ] [ header &lt;name&gt; ] [ if-none ]</span><br></pre></td></tr></table></figure>
<p>允许在发往服务器的请求首部中插入“X-Forwarded-For”首部。 </p>
<p><network>：可选参数，当指定时，源地址为匹配至此网络中的请求都禁用此功能。 </network></p>
<p><name>：可选参数，可使用一个自定义的首部，如“X-Client”来替代“X-Forwarded-For”。有些独特的web服务器的确需要用于一个独特的首部。<br>if-none：仅在此首部不存在时才将其添加至请求报文问道中。</name></p>
<blockquote>
<p>HAProxy工作于反向代理模式，其发往服务器的请求中的客户端IP均为HAProxy主机的地址而非真正客户端的地址，这会使得服务器端的日志信息记录不了真正的请求来源，“X-Forwarded-For”首部则可用于解决此问题。HAProxy可以向每个发往服务器的请求上添加此首部，并以客户端IP为其value。</p>
</blockquote>
<p>需要注意的是，HAProxy工作于隧道模式，其仅检查每一个连接的第一个请求，因此，仅第一个请求报文被附加此首部。如果想为每一个请求都附加此首部，请确保同时使用了“option httpclose”、“option forceclose”和“option http-server-close”几个option。</p>
<p>下面是一个例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">frontend www</span><br><span class="line">    mode http</span><br><span class="line">    option forwardfor except 127.0.0.1</span><br></pre></td></tr></table></figure>
<p>20.errorfile</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errorfile &lt;code&gt; &lt;file&gt;</span><br></pre></td></tr></table></figure>
<p>在用户请求不存在的页面时，返回一个页面文件给客户端而非由haproxy生成的错误代码；可用于所有段中。<br><code>：指定对HTTP的哪些状态码返回指定的页面；这里可用的状态码有200、400、403、408、500、502、503和504； </code></p>
<p><file>：指定用于响应的页面文件；<br>例如：</file></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">errorfile 400 /etc/haproxy/errorpages/400badreq.http</span><br><span class="line">errorfile 403 /etc/haproxy/errorpages/403forbid.http</span><br><span class="line">errorfile 503 /etc/haproxy/errorpages/503sorry.http</span><br><span class="line">21.errorloc 和 errorloc302</span><br></pre></td></tr></table></figure>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">errorloc &lt;code&gt; &lt;url&gt;   </span><br><span class="line">errorloc302 &lt;code&gt; &lt;url&gt;</span><br></pre></td></tr></table></figure>
<p>请求错误时，返回一个HTTP重定向至某URL的信息；可用于所有配置段中。<br><code>：指定对HTTP的哪些状态码返回指定的页面；这里可用的状态码有200、400、403、408、500、502、503和504； </code></p>
<p><url>：Location首部中指定的页面位置的具体路径，可以是在当前服务器上的页面的相对路径，也可以使用绝对路径；需要注意的是，如果URI自身错误时产生某特定状态码信息的话，有可能会导致循环定向；</url></p>
<p>需要留意的是，这两个关键字都会返回302状态吗，这将使得客户端使用同样的HTTP方法获取指定的URL，对于非GET法的场景(如POST)来说会产生问题，因为返回客户的URL是不允许使用GET以外的其它方法的。如果的确有这种问题，可以使用errorloc303来返回303状态码给客户端。</p>
<p>22.errorloc303</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errorloc303 &lt;code&gt; &lt;url&gt;</span><br></pre></td></tr></table></figure>
<p>请求错误时，返回一个HTTP重定向至某URL的信息给客户端；可用于所有配置段中。<br><code>：指定对HTTP的哪些状态码返回指定的页面；这里可用的状态码有400、403、408、500、502、503和504； </code></p>
<p><url>：Location首部中指定的页面位置的具体路径，可以是在当前服务器上的页面的相对路径，也可以使用绝对路径；需要注意的是，如果URI自身错误时产生某特定状态码信息的话，有可能会导致循环定向；</url></p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">backend webserver</span><br><span class="line">  server 172.16.100.6 172.16.100.6:80 check maxconn 3000 cookie srv01</span><br><span class="line">  server 172.16.100.7 172.16.100.7:80 check maxconn 3000 cookie srv02</span><br><span class="line">  errorloc 403 /etc/haproxy/errorpages/sorry.htm</span><br><span class="line">  errorloc 503 /etc/haproxy/errorpages/sorry.htm</span><br></pre></td></tr></table></figure>
<p>option http-request 访问控制<br>option http-server-close：允许服务器端关闭连接；<br>option dontlognull：访问内容为空的不记录日志；<br>option redispatch：在session失败后，是否允许重新分配；<br>retries：用于haproxy到后端server连接失败时重试次数；<br>option httplog：启用记录HTTP请求、会话状态和计时器的功能；<br>option forwardfor：允许在发往服务器的请求首部中插入“X-Forwarded-For”首部；</p>
<h2 id="HAproxy的ACL详解"><a href="#HAproxy的ACL详解" class="headerlink" title="# HAproxy的ACL详解"></a># HAproxy的ACL详解</h2><p>haproxy的ACL用于实现基于请求报文的首部、响应报文的内容或其它的环境状态信息来做出转发决策，这大大增强了其配置弹性。其配置法则通常分为两步，首先去定义ACL，即定义一个测试条件，而后在条件得到满足时执行某特定的动作，如阻止请求或转发至某特定的后端。定义ACL的语法格式如下。<br>acl <aclname> <criterion> [flags] [operator] <value> …</value></criterion></aclname></p>
<p><aclname>：ACL名称，区分字符大小写，且其只能包含大小写字母、数字、-(连接线)、_(下划线)、.(点号)和:(冒号)；haproxy中，acl可以重名，这可以把多个测试条件定义为一个共同的acl； </aclname></p>
<p><criterion>：测试标准，即对什么信息发起测试；测试方式可以由[flags]指定的标志进行调整；而有些测试标准也可以需要为其在之前指定一个操作符[operator]；<br>[flags]：目前haproxy的acl支持的标志位有3个：</criterion></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-i：不区分&lt;value&gt;中模式字符的大小写；</span><br><span class="line">-f：从指定的文件中加载模式；</span><br><span class="line">--：标志符的强制结束标记，在模式中的字符串像标记符时使用；</span><br></pre></td></tr></table></figure>
<p><value>：acl测试条件支持的值有以下四类：<br>1、整数或整数范围：如1024:65535表示从1024至65535；仅支持使用正整数(如果出现类似小数的标识，其为通常为版本测试)，且支持使用的操作符有5个，分别为eq、ge、gt、le和lt；<br>2、字符串：支持使用“-i”以忽略字符大小写，支持使用“\”进行转义；如果在模式首部出现了-i，可以在其之前使用“–”标志位；<br>3、正则表达式：其机制类同字符串匹配；<br>4、IP地址及网络地址</value></p>
<blockquote>
<p>同一个acl中可以指定多个测试条件，这些测试条件需要由逻辑操作符指定其关系。条件间的组合测试关系有三种：“与”(默认即为与操作)、“或”(使用“||”操作符)以及“非”(使用“!”操作符)。</p>
</blockquote>
<p>常用的测试标准(criteria)</p>
<p>be_sess_rate <integer></integer></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">be_sess_rate(backend) &lt;integer&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>用于测试指定的backend上会话创建的速率(即每秒创建的会话数)是否满足指定的条件；常用于在指定backend上的会话速率过高时将用户请求转发至另外的backend，或用于阻止攻击行为。例如：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backend dynamic</span><br><span class="line">    mode http</span><br><span class="line">    acl being_scanned be_sess_rate gt 50</span><br><span class="line">    redirect location /error_pages/denied.html if being_scanned</span><br></pre></td></tr></table></figure>
<p>fe_sess_rate <integer></integer></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fe_sess_rate(frontend) &lt;integer&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>用于测试指定的frontend(或当前frontend)上的会话创建速率是否满足指定的条件；常用于为frontend指定一个合理的会话创建速率的上限以防止服务被滥用。例如下面的例子限定入站邮件速率不能大于50封/秒，所有在此指定范围之外的请求都将被延时50毫秒。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frontend mail</span><br><span class="line">    bind :25</span><br><span class="line">    mode tcp</span><br><span class="line">    maxconn 500</span><br><span class="line">    acl too_fast fe_sess_rate ge 50</span><br><span class="line">    tcp-request inspect-delay 50ms</span><br><span class="line">    tcp-request content accept if ! too_fast</span><br><span class="line">    tcp-request content accept if WAIT_END</span><br></pre></td></tr></table></figure>
<p>hdr <string></string></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdr(header) &lt;string&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>用于测试请求报文中的所有首部或指定首部是否满足指定的条件；指定首部时，其名称不区分大小写，且在括号“()”中不能有任何多余的空白字符。测试服务器端的响应报文时可以使用shdr()。例如下面的例子用于测试首部Connection的值是否为close。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdr(Connection) -i close</span><br></pre></td></tr></table></figure>
<p>method <string></string></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method &lt;string&gt;</span><br></pre></td></tr></table></figure>
<p>测试HTTP请求报文中使用的方法。<br>path_beg <string></string></p>
<blockquote>
<p>用于测试请求的URL是否以指定的模式开头。下面的例子用于测试URL是否以/static、/images、/javascript或/stylesheets头。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acl url_static       path_beg       -i /static /images /javascript /stylesheets</span><br></pre></td></tr></table></figure>
<p>path_end <string></string></p>
<blockquote>
<p>用于测试请求的URL是否以指定的模式结尾。例如，下面的例子用户测试URL是否以jpg、gif、png、css或js结尾。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acl url_static       path_end       -i .jpg .gif .png .css .js</span><br></pre></td></tr></table></figure>
<p>hdr_beg <string></string></p>
<blockquote>
<p>用于测试请求报文的指定首部的开头部分是否符合指定的模式。例如，下面的例子用记测试请求是否为提供静态内容的主机img、video、download或ftp。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acl host_static hdr_beg(host) -i img. video. download. ftp.</span><br></pre></td></tr></table></figure>
<p>hdr_end <string></string></p>
<blockquote>
<p>用于测试请求报文的指定首部的结尾部分是否符合指定的模式。例如，下面的例子用记测试请求是否为</p>
</blockquote>
<h2 id="ACL案例"><a href="#ACL案例" class="headerlink" title="ACL案例"></a>ACL案例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">########ACL策略定义#########################</span><br><span class="line">1、#如果请求的域名满足正则表达式返回true -i是忽略大小写</span><br><span class="line">acl denali_policy hdr_reg(host) -i ^(www.inbank.com|image.inbank.com)$</span><br><span class="line"></span><br><span class="line">2、#如果请求域名满足www.inbank.com 返回 true -i是忽略大小写</span><br><span class="line">acl tm_policy hdr_dom(host) -i www.inbank.com</span><br><span class="line"></span><br><span class="line">3、#在请求url中包含sip_apiname=，则此控制策略返回true,否则为false</span><br><span class="line">acl invalid_req url_sub -i sip_apiname=#定义一个名为invalid_req的策略</span><br><span class="line"></span><br><span class="line">4、#在请求url中存在timetask作为部分地址路径，则此控制策略返回true,否则返回false</span><br><span class="line">acl timetask_req url_dir -i timetask</span><br><span class="line"></span><br><span class="line">5、#当请求的header中Content-length等于0时返回 true</span><br><span class="line">acl missing_cl hdr_cnt(Content-length) eq 0</span><br><span class="line"></span><br><span class="line">#########acl策略匹配相应###################</span><br><span class="line">1、#当请求中header中Content-length等于0 阻止请求返回403</span><br><span class="line">block if missing_cl</span><br><span class="line"></span><br><span class="line">2、#block表示阻止请求，返回403错误，当前表示如果不满足策略invalid_req，或者满足策略timetask_req，则阻止请求。</span><br><span class="line">block if !invalid_req || timetask_req</span><br><span class="line"></span><br><span class="line">3、#当满足denali_policy的策略时使用denali_server的backend</span><br><span class="line">use_backend denali_server if denali_policy</span><br><span class="line"></span><br><span class="line">4、#当满足tm_policy的策略时使用tm_server的backend</span><br><span class="line">use_backend tm_server if tm_policy</span><br><span class="line"></span><br><span class="line">5、#reqisetbe关键字定义，根据定义的关键字选择backend</span><br><span class="line">reqisetbe ^Host:\ img dynamic</span><br><span class="line">reqisetbe ^[^\ ]*\ /(img|css)/ dynamic</span><br><span class="line">reqisetbe ^[^\ ]*\ /admin/stats stats</span><br><span class="line"></span><br><span class="line">6、#以上都不满足的时候使用默认mms_server的backend</span><br><span class="line">default_backend mms</span><br></pre></td></tr></table></figure>
<h3 id="一份haproxy配置文件的详解"><a href="#一份haproxy配置文件的详解" class="headerlink" title="一份haproxy配置文件的详解"></a>一份haproxy配置文件的详解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">###########全局配置#########</span><br><span class="line">global</span><br><span class="line">　　log 127.0.0.1 local0 #[日志输出配置，所有日志都记录在本机，通过local0输出]</span><br><span class="line">　　log 127.0.0.1 local1 notice #定义haproxy 日志级别[error warringinfo debug]</span><br><span class="line">　　daemon #以后台形式运行harpoxy</span><br><span class="line">　　nbproc 1 #设置进程数量</span><br><span class="line">　　maxconn 4096 #默认最大连接数,需考虑ulimit-n限制</span><br><span class="line">　　#user haproxy #运行haproxy的用户</span><br><span class="line">　　#group haproxy #运行haproxy的用户所在的组</span><br><span class="line">　　#pidfile /var/run/haproxy.pid #haproxy 进程PID文件</span><br><span class="line">　　#ulimit-n 819200 #ulimit 的数量限制</span><br><span class="line">　　#chroot /usr/share/haproxy #chroot运行路径</span><br><span class="line">　　#debug #haproxy 调试级别，建议只在开启单进程的时候调试</span><br><span class="line">　　#quiet</span><br><span class="line"></span><br><span class="line">########默认配置############</span><br><span class="line">defaults</span><br><span class="line">　　log global</span><br><span class="line">　　mode http #默认的模式mode &#123; tcp|http|health &#125;，tcp是4层，http是7层，health只会返回OK</span><br><span class="line">　　option httplog #日志类别,采用httplog</span><br><span class="line">　　option dontlognull #不记录健康检查日志信息</span><br><span class="line">　　retries 2 #两次连接失败就认为是服务器不可用，也可以通过后面设置</span><br><span class="line">　　#option forwardfor #如果后端服务器需要获得客户端真实ip需要配置的参数，可以从Http Header中获得客户端ip</span><br><span class="line">　　option httpclose #每次请求完毕后主动关闭http通道,haproxy不支持keep-alive,只能模拟这种模式的实现</span><br><span class="line">　　#option redispatch #当serverId对应的服务器挂掉后，强制定向到其他健康的服务器，以后将不支持</span><br><span class="line">　　option abortonclose #当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接</span><br><span class="line">　　maxconn 4096 #默认的最大连接数</span><br><span class="line">　　timeout connect 5000ms #连接超时</span><br><span class="line">　　timeout client 30000ms #客户端超时</span><br><span class="line">　　timeout server 30000ms #服务器超时</span><br><span class="line">　　#timeout check 2000 #心跳检测超时</span><br><span class="line">　　#timeout http-keep-alive10s #默认持久连接超时时间</span><br><span class="line">　　#timeout http-request 10s #默认http请求超时时间</span><br><span class="line">　　#timeout queue 1m #默认队列超时时间</span><br><span class="line">　　balance roundrobin #设置默认负载均衡方式，轮询方式</span><br><span class="line">　　#balance source #设置默认负载均衡方式，类似于nginx的ip_hash</span><br><span class="line">　　#balnace leastconn #设置默认负载均衡方式，最小连接数</span><br><span class="line"></span><br><span class="line">########统计页面配置########</span><br><span class="line">listen stats</span><br><span class="line">　　bind 0.0.0.0:1080 #设置Frontend和Backend的组合体，监控组的名称，按需要自定义名称</span><br><span class="line">　　mode http #http的7层模式</span><br><span class="line">　　option httplog #采用http日志格式</span><br><span class="line">　　#log 127.0.0.1 local0 err #错误日志记录</span><br><span class="line">　　maxconn 10 #默认的最大连接数</span><br><span class="line">　　stats refresh 30s #统计页面自动刷新时间</span><br><span class="line">　　stats uri /stats #统计页面url</span><br><span class="line">　　stats realm XingCloud\ Haproxy #统计页面密码框上提示文本</span><br><span class="line">　　stats auth admin:admin #设置监控页面的用户和密码:admin,可以设置多个用户名</span><br><span class="line">　　stats auth Frank:Frank #设置监控页面的用户和密码：Frank</span><br><span class="line">　　stats hide-version #隐藏统计页面上HAProxy的版本信息</span><br><span class="line">　　stats admin if TRUE #设置手工启动/禁用，后端服务器(haproxy-1.4.9以后版本)</span><br><span class="line"></span><br><span class="line">########设置haproxy 错误页面#####</span><br><span class="line">#errorfile 403 /home/haproxy/haproxy/errorfiles/403.http</span><br><span class="line">#errorfile 500 /home/haproxy/haproxy/errorfiles/500.http</span><br><span class="line">#errorfile 502 /home/haproxy/haproxy/errorfiles/502.http</span><br><span class="line">#errorfile 503 /home/haproxy/haproxy/errorfiles/503.http</span><br><span class="line">#errorfile 504 /home/haproxy/haproxy/errorfiles/504.http</span><br><span class="line"></span><br><span class="line">########frontend前端配置##############</span><br><span class="line">frontend main</span><br><span class="line">　　bind *:80 #这里建议使用bind *:80的方式，要不然做集群高可用的时候有问题，vip切换到其他机器就不能访问了。</span><br><span class="line">　　acl web hdr(host) -i www.abc.com  #acl后面是规则名称，-i为忽略大小写，后面跟的是要访问的域名，如果访问www.abc.com这个域名，就触发web规则，。</span><br><span class="line">　　acl img hdr(host) -i img.abc.com  #如果访问img.abc.com这个域名，就触发img规则。</span><br><span class="line">　　use_backend webserver if web   #如果上面定义的web规则被触发，即访问www.abc.com，就将请求分发到webserver这个作用域。</span><br><span class="line">　　use_backend imgserver if img   #如果上面定义的img规则被触发，即访问img.abc.com，就将请求分发到imgserver这个作用域。</span><br><span class="line">　　default_backend dynamic #不满足则响应backend的默认页面</span><br><span class="line"></span><br><span class="line">########backend后端配置##############</span><br><span class="line">backend webserver #webserver作用域</span><br><span class="line">　　mode http</span><br><span class="line">　　balance roundrobin #balance roundrobin 负载轮询，balance source 保存session值，支持static-rr，leastconn，first，uri等参数</span><br><span class="line">　　option httpchk /index.html HTTP/1.0 #健康检查, 检测文件，如果分发到后台index.html访问不到就不再分发给它</span><br><span class="line">　　server web1 10.16.0.9:8085 cookie 1 weight 5 check inter 2000 rise 2 fall 3</span><br><span class="line">　　server web2 10.16.0.10:8085 cookie 2 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line">　　#cookie 1表示serverid为1，check inter 1500 是检测心跳频率 </span><br><span class="line">　　#rise 2是2次正确认为服务器可用，fall 3是3次失败认为服务器不可用，weight代表权重</span><br><span class="line"></span><br><span class="line">backend imgserver</span><br><span class="line">　　mode http</span><br><span class="line">　　option httpchk /index.php</span><br><span class="line">　　balance roundrobin </span><br><span class="line">　　server img01 192.168.137.101:80 check inter 2000 fall 3</span><br><span class="line">　　server img02 192.168.137.102:80 check inter 2000 fall 3</span><br><span class="line"></span><br><span class="line">backend dynamic </span><br><span class="line">　　balance roundrobin </span><br><span class="line">　　server test1 192.168.1.23:80 check maxconn 2000 </span><br><span class="line">　　server test2 192.168.1.24:80 check maxconn 2000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">listen tcptest </span><br><span class="line">　　bind 0.0.0.0:5222 </span><br><span class="line">　　mode tcp </span><br><span class="line">　　option tcplog #采用tcp日志格式 </span><br><span class="line">　　balance source </span><br><span class="line">　　#log 127.0.0.1 local0 debug </span><br><span class="line">　　server s1 192.168.100.204:7222 weight 1 </span><br><span class="line">　　server s2 192.168.100.208:7222 weight 1</span><br></pre></td></tr></table></figure>
<h1 id="HAproxy实例"><a href="#HAproxy实例" class="headerlink" title="HAproxy实例"></a>HAproxy实例</h1><h2 id="案例1：定义独立日志文件"><a href="#案例1：定义独立日志文件" class="headerlink" title="案例1：定义独立日志文件"></a>案例1：定义独立日志文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 haproxy]# vim /etc/rsyslog.conf #为其添加日志功能</span><br><span class="line"># Provides UDP syslog reception</span><br><span class="line">$ModLoad imudp</span><br><span class="line">$UDPServerRun 514 ------&gt;启动udp，启动端口后将作为服务器工作</span><br><span class="line"># Provides TCP syslog reception</span><br><span class="line">$ModLoad imtcp</span><br><span class="line">$InputTCPServerRun 514 ------&gt;启动tcp监听端口</span><br><span class="line">local2.* /var/log/haproxy.log</span><br><span class="line"></span><br><span class="line">[root@node1 haproxy]# service rsyslog restar</span><br><span class="line">[root@LB haproxy]# vim haproxy.cfg</span><br><span class="line">log 127.0.0.1 local2 ---------&gt;在global端中添加此行</span><br></pre></td></tr></table></figure>
<h2 id="案例2：haproxy统计页面的输出机制"><a href="#案例2：haproxy统计页面的输出机制" class="headerlink" title="案例2：haproxy统计页面的输出机制"></a>案例2：haproxy统计页面的输出机制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">listen statistics</span><br><span class="line">bind *:8009 # 自定义监听端口</span><br><span class="line">stats enable # 启用基于程序编译时默认设置的统计报告</span><br><span class="line">stats auth admin:admin # 统计页面用户名和密码设置</span><br><span class="line">stats uri /admin?stats # 自定义统计页面的URL，默认为/haproxy?stats</span><br><span class="line">stats hide-version # 隐藏统计页面上HAProxy的版本信息</span><br><span class="line">stats refresh 30s # 统计页面自动刷新时间</span><br><span class="line">stats admin if TRUE #如果认证通过就做管理功能，可以管理后端的服务器</span><br><span class="line">stats realm Hapadmin # 统计页面密码框上提示文本，默认为Haproxy\ Statistics</span><br></pre></td></tr></table></figure>
<h2 id="案例3：动静分离示例："><a href="#案例3：动静分离示例：" class="headerlink" title="案例3：动静分离示例："></a>案例3：动静分离示例：</h2><p>1、在两台机器上面同样在网站根目录下准备一个index.html和index.php </p>
<p>2、实现功能访问.html后缀的只能访问128，访问.php结尾访问140</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">frontend webservs</span><br><span class="line">    bind *:80</span><br><span class="line">    acl url_static path_beg -i /static /images /javascript /stylesheets</span><br><span class="line">    acl url_static path_end -i .jpg .gif .png .css .js .html</span><br><span class="line">    acl url_php path_end -i .php</span><br><span class="line">    acl host_static hdr_beg(host) -i img. imgs. video. videos. ftp. image. download.</span><br><span class="line">    use_backend static if url_static or host_static</span><br><span class="line">    use_backend dynamic if url_php</span><br><span class="line">    default_backend dynamic</span><br><span class="line">backend dynamic</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server node2 192.168.211.140:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br><span class="line">backend static</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server node1 192.168.211.128:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br></pre></td></tr></table></figure>
<h2 id="案例4：实现web负载"><a href="#案例4：实现web负载" class="headerlink" title="案例4：实现web负载"></a>案例4：实现web负载</h2><p>1、node1安装http和测试页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web1 ~]# yum -y install httpd</span><br><span class="line">[root@web1 ~]# cd /var/www/html/</span><br><span class="line">[root@web1 html]# echo &quot;&lt;h1&gt;Server WWW node1&lt;/h1&gt;&quot; &gt; index.html</span><br></pre></td></tr></table></figure>
<p>2、node2安装http和测试页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web2 ~]# yum -y install httpd</span><br><span class="line">[root@web2 ~]# cd /var/www/html/</span><br><span class="line">[root@web2 html]# echo &quot;&lt;h1&gt;Server WWW node2&lt;/h1&gt;&quot; &gt; index.html</span><br></pre></td></tr></table></figure>
<p>3、haproxy安装配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HAproxy ~]# yum -y groupinstall &quot;Development Tools&quot;</span><br><span class="line">[root@HAproxy ~]# yum -y install haproxy</span><br></pre></td></tr></table></figure>
<p>4、配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@HAproxy ~]# cat /etc/haproxy/haproxy.cfg </span><br><span class="line">......主要配置函数</span><br><span class="line">listen stats   #监控页面</span><br><span class="line">    mode http</span><br><span class="line">    bind 0.0.0.0:1080</span><br><span class="line">    stats enable</span><br><span class="line">    stats hide-version</span><br><span class="line">    stats uri     /haproxyadmin?stats</span><br><span class="line">    stats realm   Haproxy\ Statistics</span><br><span class="line">    stats auth    admin:admin</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">frontend main  #定义服务器组</span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend server</span><br><span class="line">backend server  #定义服务器</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    option httpchk HEAD /index.html HTTP/1.0</span><br><span class="line">    server node1 192.168.211.140:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br><span class="line">    server node2 192.168.211.128:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br></pre></td></tr></table></figure>
<p>5、查看监控页面</p>
<p>6、测试</p>
<h2 id="案例5：负载均衡MySQL服务"><a href="#案例5：负载均衡MySQL服务" class="headerlink" title="案例5：负载均衡MySQL服务"></a>案例5：负载均衡MySQL服务</h2><pre><code>frontend mysql
    bind *:3306
    mode tcp
    log global
    default_backend mysqlservers
backend mysqlservers
    balance leastconn
    server dbsrv1 192.168.211.140:3306 check port 3306 intval 2 rise 1 fall 2 maxconn 300
    server dbsrv2 192.168.211.128:3306 check port 3306 intval 2 rise 1 fall 2 maxconn 300
</code></pre>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HAProxy/">HAProxy</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-生病的这段日子" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/11/生病的这段日子/" class="article-date">
      <time datetime="2017-11-11T08:27:43.000Z" itemprop="datePublished">2017-11-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/11/生病的这段日子/">生病的这段日子</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>生病的这段日子</p>
<p>2017.10.21~</p>
<p>2017.10.21 星期六早上大概3点多。肚子突然就疼起来了。起初以为吃坏了肚子。肠炎而已。就忍着疼一直到天亮还是疼。大概10点多吧。去了住的地方路口的小诊所。给医生说自己肚子疼，可能是肠炎。然后医生就给输液，然后贴肚子的。起初好转很多也不疼了。等输液输完。贴肚子的使用完后。过了一会儿依然疼。给医生说。医生又给的阿莫西林和止疼药。同时医生说你去大医院检查一下吧、在诊所吃了阿莫西林和止疼药。休息了一会儿。还是疼。就回住处了。晚上喝了一点纯牛奶。疼痛一直没有消失。等到22号依然疼。早上9点多。还是疼。就骑着电动车忍着疼去了村中的另一家诊所。医生是一位阿姨。然后给她描述了症状，然后她给检查了。并说腹部敲击回声和整个腹部都痛。应该不是肠炎一类的病。就让去大医院看。这次没有再犹豫。就打滴滴去了北京清华长庚医院。排了急诊。等了好久，缴费，排队，检查，缴费，输液，然后有个医生过来说你的病很严重。需要住院，然后输着液。去缴费。在输液室等着医护带着去了住院部。22号下午住院，星期一有两个小伙伴去医院看我。很感谢他们。一直到27号做手术。期间输液没有停止，左胳膊输液出了反应肿了，换右胳膊。右胳膊肿了，换左胳膊，最后又换右胳膊。直到29号出院。</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-uWSGI搭配Nginx配置Django部署环境" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/11/uWSGI搭配Nginx配置Django部署环境/" class="article-date">
      <time datetime="2017-11-11T06:09:00.000Z" itemprop="datePublished">2017-11-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/11/uWSGI搭配Nginx配置Django部署环境/">uWSGI搭配Nginx配置Django部署环境</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://www.nowamagic.net/academy/detail/1330308" target="_blank" rel="noopener">uWSGI搭配Nginx配置</a>Django部署环境</p>
<h1 id="WSGI简介"><a href="#WSGI简介" class="headerlink" title="WSGI简介"></a>WSGI简介</h1><p>WSGI是什么？</p>
<p>WSGI，全称 Web Server Gateway Interface，或者 Python Web Server Gateway Interface ，是为 Python 语言定义的 Web 服务器和 Web 应用程序或框架之间的一种简单而通用的接口。自从 WSGI 被开发出来以后，许多其它语言中也出现了类似接口。</p>
<p>WSGI 的官方定义是，the Python Web Server Gateway Interface。从名字就可以看出来，这东西是一个Gateway，也就是网关。网关的作用就是在协议之间进行转换。</p>
<p>WSGI 是作为 Web 服务器与 Web 应用程序或应用框架之间的一种低级别的接口，以提升可移植 Web 应用开发的共同点。WSGI 是基于现存的 CGI 标准而设计的。</p>
<p>很多框架都自带了 WSGI server ，比如 Flask，webpy，Django、CherryPy等等。当然性能都不好，自带的 web server 更多的是测试用途，发布时则使用生产环境的 WSGI server或者是联合 nginx 做 uwsgi 。</p>
<p>WSGI的作用</p>
<p>WSGI有两方：“服务器”或“网关”一方，以及“应用程序”或“应用框架”一方。服务方调用应用方，提供环境信息，以及一个回调函数（提供给应用程序用来将消息头传递给服务器方），并接收Web内容作为返回值。</p>
<p>所谓的 WSGI中间件同时实现了API的两方，因此可以在WSGI服务和WSGI应用之间起调解作用：从WSGI服务器的角度来说，中间件扮演应用程序，而从应用程序的角度来说，中间件扮演服务器。“中间件”组件可以执行以下功能：</p>
<p>重写环境变量后，根据目标URL，将请求消息路由到不同的应用对象。<br>允许在一个进程中同时运行多个应用程序或应用框架。<br>负载均衡和远程处理，通过在网络上转发请求和响应消息。<br>进行内容后处理，例如应用XSLT样式表。<br>WSGI 的设计确实参考了 Java 的 servlet</p>
<p>WSGI是一种Web服务器网关接口。它是一个Web服务器（如nginx）与应用服务器（如uWSGI服务器）通信的一种规范。</p>
<p>接下来，我们要介绍的是 uWSGI。</p>
<p>uWSGI</p>
<p>uWSGI是一个Web服务器，它实现了WSGI协议、uwsgi、http等协议。Nginx中HttpUwsgiModule的作用是与uWSGI服务器进行交换。</p>
<p>要注意 WSGI / uwsgi / uWSGI 这三个概念的区分。</p>
<p>WSGI是一种通信协议。<br>uwsgi同WSGI一样是一种通信协议。<br>而uWSGI是实现了uwsgi和WSGI两种协议的Web服务器。<br>uwsgi协议是一个uWSGI服务器自有的协议，它用于定义传输信息的类型（type of information），每一个uwsgi packet前4byte为传输信息类型描述，它与WSGI相比是两样东西。</p>
<h1 id="Nginx-配置"><a href="#Nginx-配置" class="headerlink" title="Nginx 配置"></a>Nginx 配置</h1><p>在 nginx.conf 上加入/修改，我的 server 配置如下（一切从简……）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  115.28.0.89;</span><br><span class="line">    #server_name localhost;</span><br><span class="line"></span><br><span class="line">    access_log /home/nowamagic/logs/access.log;</span><br><span class="line">    error_log /home/nowamagic/logs/error.log;</span><br><span class="line"></span><br><span class="line">    #root         /root/nowamagic_venv/nowamagic_pj;</span><br><span class="line">    location / &#123;</span><br><span class="line">        uwsgi_pass 127.0.0.1:8077;</span><br><span class="line">        #include uwsgi_params;</span><br><span class="line">        include /etc/nginx/uwsgi_params;</span><br><span class="line">        #uwsgi_pass 127.0.0.1:8077;</span><br><span class="line">        #uwsgi_param UWSGI_SCRIPT index;</span><br><span class="line">        #uwsgi_param UWSGI_PYHOME $document_root;</span><br><span class="line">        #uwsgi_param UWSGI_CHDIR  $document_root;</span><br><span class="line">   &#125;</span><br><span class="line">   access_log off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意保证配置里写的目录 /home/nowamagic/logs/ 和 /home/nowamagic/logs/ 存在，接下来就没啥问题了，Nginx 配置很简单。</p>
<h1 id="uWSGI-配置"><a href="#uWSGI-配置" class="headerlink" title="uWSGI 配置"></a>uWSGI 配置</h1><h2 id="安装uWSGI"><a href="#安装uWSGI" class="headerlink" title="安装uWSGI"></a>安装uWSGI</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install uwsgi</span><br></pre></td></tr></table></figure>
<p>在实际部署环境中，我们常用的是配置文件的方式，而非命令行的方式。</p>
<p>我的 Django 程序目录：/root/nowamagic_venv/nowamagic_pj/</p>
<p>这里让 Nginx 采用 8077 端口与 uWSGI 通讯，请确保此端口没有被其它程序采用。</p>
<p>uWSGI 支持多种配置文件格式，比如 xml，ini，json 等等都可以。</p>
<p>xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vi /root/nowamagic_venv/nowamagic_pj/nowamgic_pj.xml</span><br><span class="line"></span><br><span class="line">&lt;uwsgi&gt;</span><br><span class="line"> &lt;socket&gt;127.0.0.1:8077&lt;/socket&gt;</span><br><span class="line"> &lt;listen&gt;80&lt;/listen&gt;</span><br><span class="line"> &lt;master&gt;true&lt;/master&gt;</span><br><span class="line"> &lt;pythonpath&gt;/root/nowamagic_venv/nowamagic_pj&lt;/pythonpath&gt;</span><br><span class="line"> &lt;processes&gt;1&lt;/processes&gt;</span><br><span class="line"> &lt;logdate&gt;true&lt;/logdate&gt;</span><br><span class="line"> &lt;daemonize&gt;/var/log/uwsgi.log&lt;/daemonize&gt;</span><br><span class="line"> &lt;plugins&gt;python&lt;/plugins&gt;</span><br><span class="line">&lt;/uwsgi&gt;</span><br></pre></td></tr></table></figure>
<p>然后执行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/uwsgi -x /root/nowamagic_venv/nowamagic_pj/nowamagic_pj.xml</span><br></pre></td></tr></table></figure>
<p>ini 配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">vhost = false</span><br><span class="line">plugins = python</span><br><span class="line">socket = 127.0.0.1:8077</span><br><span class="line">master = true</span><br><span class="line">enable-threads = true</span><br><span class="line">workers = 1</span><br><span class="line">wsgi-file = /root/nowamagic_venv/nowamagic_pj/nowamagic_pj/wsgi.py</span><br><span class="line">virtualenv = /root/nowamagic_venv</span><br><span class="line">chdir = /root/nowamagic_venv/nowamagic_pj</span><br></pre></td></tr></table></figure>
<p>执行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uwsgi --ini /root/nowamagic_venv/nowamagic_pj.ini&amp;</span><br></pre></td></tr></table></figure>
<p>uwsgi 这样就启动起来了。如果无意外的话，就能在网上访问你的 Python 项目了。</p>
<p>一些我在配置时用到的命令，省得你去搜索：</p>
<p>关闭 uWSGI：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">killall  -9 uwsgi</span><br><span class="line">killall -s HUP /var/www/uwsgi </span><br><span class="line">killall -s HUP /usr/local/bin/uwsgi</span><br></pre></td></tr></table></figure>
<p>列出端口占用情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -lpnt</span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a><a class="article-category-link" href="/categories/技术/Linux/Python/">Python</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Django/">Django</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/uWSGI/">uWSGI</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-brew 错误提示汇总" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/10/brew 错误提示汇总/" class="article-date">
      <time datetime="2017-11-10T07:18:51.000Z" itemprop="datePublished">2017-11-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="openssl"><a href="#openssl" class="headerlink" title="openssl"></a>openssl</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">A CA file has been bootstrapped using certificates from the SystemRoots</span><br><span class="line">keychain. To add additional certificates (e.g. the certificates added in</span><br><span class="line">the System keychain), place .pem files in</span><br><span class="line">  /usr/local/etc/openssl/certs</span><br><span class="line"></span><br><span class="line">and run</span><br><span class="line">  /usr/local/opt/openssl/bin/c_rehash</span><br><span class="line"></span><br><span class="line">This formula is keg-only, which means it was not symlinked into /usr/local,</span><br><span class="line">because Apple has deprecated use of OpenSSL in favor of its own TLS and crypto libraries.</span><br><span class="line"></span><br><span class="line">If you need to have this software first in your PATH run:</span><br><span class="line">  echo &apos;export PATH=&quot;/usr/local/opt/openssl/bin:$PATH&quot;&apos; &gt;&gt; ~/.zshrc</span><br><span class="line"></span><br><span class="line">For compilers to find this software you may need to set:</span><br><span class="line">    LDFLAGS:  -L/usr/local/opt/openssl/lib</span><br><span class="line">    CPPFLAGS: -I/usr/local/opt/openssl/include</span><br><span class="line">For pkg-config to find this software you may need to set:</span><br><span class="line">    PKG_CONFIG_PATH: /usr/local/opt/openssl/lib/pkgconfig</span><br></pre></td></tr></table></figure>
<h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Python modules have been installed and Homebrew&apos;s site-packages is not</span><br><span class="line">in your Python sys.path, so you will not be able to import the modules</span><br><span class="line">this formula installed. If you plan to develop with these modules,</span><br><span class="line">please run:</span><br><span class="line">  mkdir -p /Users/jinlong/Library/Python/2.7/lib/python/site-packages</span><br><span class="line">  echo &apos;import site; site.addsitedir(&quot;/usr/local/lib/python2.7/site-packages&quot;)&apos; &gt;&gt; /Users/jinlong/Library/Python/2.7/lib/python/site-packages/homebrew.pth</span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Cisco 路由器配置命令" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/05/Cisco 路由器配置命令/" class="article-date">
      <time datetime="2017-11-05T12:31:30.000Z" itemprop="datePublished">2017-11-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Cisco-路由器配置命令"><a href="#Cisco-路由器配置命令" class="headerlink" title="Cisco 路由器配置命令"></a>Cisco 路由器配置命令</h1><h3 id="改变命令状态"><a href="#改变命令状态" class="headerlink" title="改变命令状态"></a>改变命令状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">任务  命令 </span><br><span class="line">进入特权命令状态 enable </span><br><span class="line">退出特权命令状态 disable </span><br><span class="line">进入设置对话状态 setup  </span><br><span class="line">进入全局设置状态 config terminal </span><br><span class="line">退出全局设置状态 end  </span><br><span class="line">进入端口设置状态 interface type slot/number </span><br><span class="line">进入子端口设置状态 interface type number.subinterface [point-to-point | multipoint] </span><br><span class="line">进入线路设置状态 line type slot/number </span><br><span class="line">进入路由设置状态 router protocol </span><br><span class="line">退出局部设置状态  exit</span><br></pre></td></tr></table></figure>
<p>路由器的状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">命令状态</span><br><span class="line">route1&gt;</span><br><span class="line">特权命令状态(进入特权enable，退出特权disable)</span><br><span class="line">route1&gt;enable</span><br><span class="line">route1#</span><br><span class="line">特权状态下的命令</span><br><span class="line">进入设置对话状态 setup</span><br><span class="line">route1#setup</span><br><span class="line">         --- System Configuration Dialog ---</span><br><span class="line">Continue with configuration dialog? [yes/no]:</span><br><span class="line"></span><br><span class="line">进入全局设置状态 config terminal(conf t)</span><br><span class="line">route1#conf t</span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">route1(config)#</span><br><span class="line"></span><br><span class="line">退出全局设置状态 end</span><br><span class="line">route1(config)#end</span><br><span class="line">route1#</span><br><span class="line">进入端口配置</span><br><span class="line">route2#show ip interface</span><br><span class="line">FastEthernet0/0 is administratively down, line protocol is down</span><br><span class="line">  Internet protocol processing disabled</span><br><span class="line"></span><br><span class="line">route2(config)#interface FastEthernet0/0</span><br><span class="line">route2(config-if)#</span><br></pre></td></tr></table></figure>
<p>Cisco路由器初始化配置<br>设置路由器内部时钟</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">全局配置模式下 clock timezone GMT +8</span><br><span class="line">exit</span><br><span class="line">特权模式下</span><br><span class="line">clock set 11:54:00 october 22 2017</span><br></pre></td></tr></table></figure>
<p>1.路由器名<br>2.特权状态密码<br>3.Console密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">line console 0</span><br><span class="line">password 密码</span><br><span class="line">login</span><br></pre></td></tr></table></figure></p>
<p>4.AUX密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">line aux 0</span><br><span class="line">password 密码</span><br><span class="line">login</span><br></pre></td></tr></table></figure>
<p>5.VTY密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">使用远程登录，需要先配置特权密码</span><br><span class="line">line vty 0 4</span><br><span class="line">pass 密码</span><br><span class="line">login</span><br><span class="line"></span><br><span class="line">限制IP远程登录</span><br><span class="line">access-list 1 permit 12.1.1.1</span><br><span class="line">line vty 0 4</span><br><span class="line">access-class 1 in</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p>5.配置接口IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">interface </span><br><span class="line">ip address 10.0.0.1 255.255.255.0</span><br><span class="line">description &quot;描述信息&quot;</span><br><span class="line">ip address 10.1.1.1 255.255.255.0 secondary</span><br><span class="line">no shutdown</span><br></pre></td></tr></table></figure>
<p>模式转换<br>用户模式–&gt;特权模式 enable<br>特权模式–&gt;全局配置模式 config t<br>全剧配置模式–&gt;接口模式 interface<br>全局配置模式–&gt;线控模式 line</p>
<p>默认进入的是命令状态，<br>config 之后 状态上有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Cisco3725124-25.T14-1#configure terminal</span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Cisco3725124-25.T14-(config)#</span><br></pre></td></tr></table></figure>
<p>% Unrecognized command<br>％无法识别的命令</p>
<p>设置路由器主机名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">默认模式转换到全局配置模式 confit t</span><br><span class="line"></span><br><span class="line">Cisco3725124-25.T14-1#configure terminal</span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">Cisco3725124-25.T14-(config)#hostname riga</span><br></pre></td></tr></table></figure>
<p>设置特权密码<br>全局配置模式下执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route2(config)#enable secret 密码</span><br></pre></td></tr></table></figure>
<p>设置访问用户及密码</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/19/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><a class="page-number" href="/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/page/45/">45</a><a class="extend next" rel="next" href="/page/21/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 幻舞梦境
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit">海贼到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-39498261-3', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?1bb44bf25fea8f000a1397f9b5438de7";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>