<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>幻舞梦境</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="幻舞梦境">
<meta property="og:url" content="http://ovwane.me/page/21/index.html">
<meta property="og:site_name" content="幻舞梦境">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="幻舞梦境">
  
    <link rel="alternative" href="/atom.xml" title="幻舞梦境" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
     
      <meta name="baidu-site-verification" content="3rC08I0Cp6">
    
     
      <meta name="google-site-verification" content="rn8f25RzFQoiByt8ezg9E17KZIElbIlwJ4y-EKSlWbA">
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet">
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">幻舞梦境</a></h1>
        </hgroup>

        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/archives">博客归档</a></li>
                        
                            <li><a href="/FrontEndGuideV2/FrontEndGuide">测试导航</a></li>
                        
                            <li><a href="/ovwane_love">关于Love</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" target="_blank" href="https://github.com/ovwane" title="github">github</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Ansible/" style="font-size: 11.43px;">Ansible</a> <a href="/tags/Bind/" style="font-size: 10px;">Bind</a> <a href="/tags/Cacti/" style="font-size: 10px;">Cacti</a> <a href="/tags/CentOS/" style="font-size: 20px;">CentOS</a> <a href="/tags/Cobbler/" style="font-size: 10px;">Cobbler</a> <a href="/tags/DHCP/" style="font-size: 10px;">DHCP</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Gitlab/" style="font-size: 11.43px;">Gitlab</a> <a href="/tags/HAProxy/" style="font-size: 10px;">HAProxy</a> <a href="/tags/Hexo/" style="font-size: 11.43px;">Hexo</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Jenkins/" style="font-size: 11.43px;">Jenkins</a> <a href="/tags/KVM/" style="font-size: 10px;">KVM</a> <a href="/tags/Kubernetes/" style="font-size: 10px;">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 14.29px;">Linux</a> <a href="/tags/MariaDB/" style="font-size: 10px;">MariaDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 10px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.14px;">Nginx</a> <a href="/tags/Oh-My-Zsh/" style="font-size: 10px;">Oh My Zsh</a> <a href="/tags/OpenLDAP/" style="font-size: 10px;">OpenLDAP</a> <a href="/tags/OpenStack/" style="font-size: 10px;">OpenStack</a> <a href="/tags/PHP/" style="font-size: 11.43px;">PHP</a> <a href="/tags/PXE/" style="font-size: 10px;">PXE</a> <a href="/tags/Python/" style="font-size: 12.86px;">Python</a> <a href="/tags/RHEL7/" style="font-size: 10px;">RHEL7</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Samba/" style="font-size: 10px;">Samba</a> <a href="/tags/Scrapy/" style="font-size: 10px;">Scrapy</a> <a href="/tags/Scrapyd/" style="font-size: 10px;">Scrapyd</a> <a href="/tags/SpiderKeeper/" style="font-size: 10px;">SpiderKeeper</a> <a href="/tags/Squid/" style="font-size: 10px;">Squid</a> <a href="/tags/Subversion/" style="font-size: 10px;">Subversion</a> <a href="/tags/Supervisor/" style="font-size: 10px;">Supervisor</a> <a href="/tags/Tomcat/" style="font-size: 12.86px;">Tomcat</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/Zabbix/" style="font-size: 10px;">Zabbix</a> <a href="/tags/cacti/" style="font-size: 10px;">cacti</a> <a href="/tags/dovecot/" style="font-size: 10px;">dovecot</a> <a href="/tags/httpd/" style="font-size: 11.43px;">httpd</a> <a href="/tags/iSCSI/" style="font-size: 10px;">iSCSI</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/kickstart/" style="font-size: 10px;">kickstart</a> <a href="/tags/macOS/" style="font-size: 15.71px;">macOS</a> <a href="/tags/nagios/" style="font-size: 10px;">nagios</a> <a href="/tags/postfix/" style="font-size: 10px;">postfix</a> <a href="/tags/rsync/" style="font-size: 10px;">rsync</a> <a href="/tags/sshd/" style="font-size: 10px;">sshd</a> <a href="/tags/uWSGI/" style="font-size: 10px;">uWSGI</a> <a href="/tags/vsftpd/" style="font-size: 10px;">vsftpd</a> <a href="/tags/zabbix/" style="font-size: 10px;">zabbix</a> <a href="/tags/历史/" style="font-size: 18.57px;">历史</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/情感/" style="font-size: 10px;">情感</a> <a href="/tags/生活/" style="font-size: 10px;">生活</a> <a href="/tags/监控/" style="font-size: 12.86px;">监控</a> <a href="/tags/网络/" style="font-size: 10px;">网络</a> <a href="/tags/自己/" style="font-size: 10px;">自己</a> <a href="/tags/运维/" style="font-size: 10px;">运维</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://luuman.github.io/">name</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">纯海迷、爱运动、爱交友、爱旅行、喜欢接触新鲜事物、迎接新的挑战，更爱游离于错综复杂的编码与逻辑中</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">幻舞梦境</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">幻舞梦境</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/archives">博客归档</a></li>
                
                    <li><a href="/FrontEndGuideV2/FrontEndGuide">测试导航</a></li>
                
                    <li><a href="/ovwane_love">关于Love</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/ovwane" title="github">github</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-手把手带你构建一个分布式爬虫系统实战-学习笔记" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/12/08/手把手带你构建一个分布式爬虫系统实战-学习笔记/" class="article-date">
      <time datetime="2017-12-08T08:27:00.000Z" itemprop="datePublished">2017-12-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/08/手把手带你构建一个分布式爬虫系统实战-学习笔记/">手把手带你构建一个分布式爬虫系统实战 学习笔记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="手把手带你构建一个分布式爬虫系统实战-小象学院-学习笔记"><a href="#手把手带你构建一个分布式爬虫系统实战-小象学院-学习笔记" class="headerlink" title="手把手带你构建一个分布式爬虫系统实战-小象学院-学习笔记"></a>手把手带你构建一个分布式爬虫系统实战-小象学院-学习笔记</h1><blockquote>
<p>手把手带你构建一个分布式爬虫系统实战-第二期-小象学院-杨真</p>
</blockquote>
<p><a href="http://www.chinahadoop.cn/course/944" target="_blank" rel="noopener">《分布式爬虫实战》第二期</a></p>
<p><strong>课程目录</strong></p>
<p>01 静态网页爬虫：爬虫的基础技术.flv 2:40:54<br>02 登录及动态网页的抓取.flv 2:19:24<br>03 微博的抓取.flv 2:42:00<br>04 多线程与多进程的爬虫.flv 2:02:20<br>05 微博数据的存储：分布式数据库及应用.flv 2:15:07<br>06 多机并行的微博抓取：分布式系统设计.flv 2:12:20<br>07 应对反爬虫的策略.flv 2:25:33<br>08 分布式系统的高可用与高并发处理.flv 2:13:47<br>09 日志系统、以及基于Page Rank的顺序调整.flv 2:13:54<br>10 日志、守护线程以及验证码处理.flv 2:07:54<br>11 分布式数据库架构分析、优化及要点.flv 2:23:10<br>12 自动摘要及正文抽取.flv 1:57:54<br>13 网页分类与针对文本的机器学习应用.flv 2:17:14<br>14 信息检索、搜索引擎原理及应用.flv 2:31:18<br>15 Scrapy录播视频.flv 2:21:02<br>16 Scrapy进阶录播视频.flv 2:10:09<br>17 网页排重.flv 2:19:19</p>
<p>讲课开始时间：2017-06-08 19:51</p>
<h1 id="01-静态网页爬虫：爬虫的基础技术"><a href="#01-静态网页爬虫：爬虫的基础技术" class="headerlink" title="01 静态网页爬虫：爬虫的基础技术"></a>01 静态网页爬虫：爬虫的基础技术</h1><blockquote>
<p>讲课开始时间：2017-06-08 19:51</p>
<p>03:36 开始讲课</p>
</blockquote>
<h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul>
<li>Python 环境搭建及基础类</li>
<li>HTML 相关技术：HTML、CSS 及 JavaScript</li>
<li>HTTP 协议及 Python 的 DOM 树选择器</li>
<li>宽度与深度抓取介绍及比较</li>
<li>不重复抓取策略及 BloomFilter</li>
<li>网站结构分析</li>
<li>马蜂窝网页抓取案例</li>
</ul>
<p>对这门课程的预期，机器学习、搜索引擎。学习态度很重要。.pi</p>
<h2 id="基础环境-Python"><a href="#基础环境-Python" class="headerlink" title="基础环境 - Python"></a>基础环境 - Python</h2><p>13:11</p>
<ul>
<li><p>Python 2.7</p>
</li>
<li><p>pip，并设置 pip 源</p>
<p><strong>配置 pip conf，自动设置源</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 新建目录</span></span><br><span class="line">mkdir ~/.pip/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加 pip.conf 文件</span></span><br><span class="line">vim ~/.pip/pip.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url=https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>
<p><strong>每次安装指定 source</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple lxml</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>建议开发环境 Mac 或者 Linux。</p>
<p>Anaconda 4.2.0 </p>
<p>Python 2.7.12</p>
</blockquote>
<p>17:12</p>
<ul>
<li><p>下载 Anaconda，很多比较难以安装的源都已经包含了</p>
</li>
<li><p>仍然配置 pip 源，各个系统默认 pip.ini 位置不同，需要根据实际情况设置</p>
<p>官网：<a href="https://anaconda.org" target="_blank" rel="noopener">https://anaconda.org</a></p>
<p>下载主页： <a href="https://www.continuum.io/downloads" target="_blank" rel="noopener">https://www.continuum.io/downloads</a></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyenv install anaconda2-4.2.0</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>Python 底层是 C 的，lxml 是基于 C 语言编写，需要 C 语言编译环境。</p>
</blockquote>
<h2 id="HTTP-协议"><a href="#HTTP-协议" class="headerlink" title="HTTP 协议"></a>HTTP 协议</h2><p>18:26</p>
<blockquote>
<p>request 分为 header 和 body</p>
<p>response 404，401</p>
<p> 还有加密相关的</p>
</blockquote>
<h2 id="TCP-IP-四层-与-OSI-七层"><a href="#TCP-IP-四层-与-OSI-七层" class="headerlink" title="TCP/IP 四层 与 OSI 七层"></a>TCP/IP 四层 与 OSI 七层</h2><p>19:21</p>
<p>传输层：TCP、UDP 协议</p>
<p>应用层：HTTP、FTP</p>
<blockquote>
<p>监听 https 请求</p>
<p>https = http + ssl</p>
</blockquote>
<h2 id="HTTP-协议-1"><a href="#HTTP-协议-1" class="headerlink" title="HTTP 协议"></a>HTTP 协议</h2><p>23:16</p>
<ul>
<li>应用层的协议</li>
<li>无连接：每次连接只处理一个请求</li>
<li>无状态：每次连接、传输都是独立的</li>
</ul>
<blockquote>
<p>无状态的特性就必须使用 cookie 来标明身份。</p>
</blockquote>
<h3 id="HTTP-HEADER"><a href="#HTTP-HEADER" class="headerlink" title="HTTP HEADER"></a>HTTP HEADER</h3><p>25:21</p>
<h3 id="REQUEST-部分的-HTTP-HEADER"><a href="#REQUEST-部分的-HTTP-HEADER" class="headerlink" title="REQUEST 部分的 HTTP HEADER"></a>REQUEST 部分的 HTTP HEADER</h3><ul>
<li><strong>Accept: text/plain</strong></li>
<li><strong>Accept-Charset: utf-8</strong></li>
<li><strong>Accept-Encoding: gzip, deflate</strong></li>
<li>Accept-Language: en-US</li>
<li><strong>Connection: keep-alive</strong> (之前建立 socket 连接不要关闭)</li>
<li>Content-Length: 348</li>
<li>Content-Type: application/x-www-form-urlencoded</li>
<li>Date: Tue, 15 Nov 1994 08:12:31 GMT</li>
<li>Host: en.wikipedia.org:80</li>
<li><strong>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:12.0) Gecko/0100101 Firefox/1.0</strong></li>
<li><strong>Cookie: $Version=1; Skin=new;</strong></li>
</ul>
<blockquote>
<p>30:10 什么是 cookie</p>
<p>client 通过 http 向 server 发送请求，server 返回 set-cookie 字段。</p>
<p>cookie 大小最大 4kb。</p>
</blockquote>
<h3 id="keep-alive"><a href="#keep-alive" class="headerlink" title="keep-alive"></a>keep-alive</h3><p>34:17</p>
<p>Keep-Alive 功能使客户端到服务器端的连接持续有效，当出现对服务器的后续请求时，Keep-Alive 功能避免了建立或者重新建立连接。</p>
<h3 id="RESPONSE-的-HTTP-HEADER"><a href="#RESPONSE-的-HTTP-HEADER" class="headerlink" title="RESPONSE 的 HTTP HEADER"></a>RESPONSE 的 HTTP HEADER</h3><p>34:27</p>
<ul>
<li>Accept-Patch: text/example;charset=utf-8</li>
<li>Cache-Control: max-age=3600</li>
<li>Content-Encoding: gzip</li>
<li>Last-Modified: Tue, 15 Nov 1994 12:45:26 GMT</li>
<li>Content-Language: da</li>
<li>Content-Length: 348</li>
<li>Etag: “737060c”</li>
<li>Expires: Thu, 01 Dec 1994 16:00:00 GMT</li>
<li><strong>Location: <a href="http://www.w3.org/pub/WWW/People.html" target="_blank" rel="noopener">http://www.w3.org/pub/WWW/People.html</a></strong> （重定向，需要跳转）</li>
<li><strong>Set-Cookie: UserID=JohnDoe; Max-Age=3600; Version=1</strong> （设置 Cookie）</li>
<li><strong>Status: 200 OK</strong> （返回值状态码）</li>
</ul>
<blockquote>
<p>Location 跳转的意思。</p>
<p>很多地方有用，需要认证的时候，进行登录的时候，有很多301跳转。</p>
</blockquote>
<h3 id="HTTP-响应状态码"><a href="#HTTP-响应状态码" class="headerlink" title="HTTP 响应状态码"></a>HTTP 响应状态码</h3><p>30:40</p>
<ul>
<li>2XX 成功</li>
<li>3XX 跳转</li>
<li>4XX 客户端错误</li>
<li>5XX 服务器错误</li>
</ul>
<blockquote>
<p>401 错误 可能是爬虫被 block。</p>
<p>500 错误 大多数是服务器出问题了。</p>
</blockquote>
<h3 id="HTTP-响应状态码-300"><a href="#HTTP-响应状态码-300" class="headerlink" title="HTTP 响应状态码 300"></a>HTTP 响应状态码 300</h3><p>43:42</p>
<ul>
<li>300 Multiple Choices 存在多个可用的资源，可处理或丢弃</li>
<li>301 Moved Permanently 重定向</li>
<li>302 Found 重定向</li>
<li>304 Not Modified 请求的资源未更新，丢弃</li>
</ul>
<blockquote>
<p>一些 Python 库，例如 urllib2 已经对重定向做了处理，会自动跳转；动态网页处理的时候，也是自动跳转，所以不需要单独处理。</p>
<p>自动解析响应头的 Location 里的 url 地址并去请求。</p>
<p>urllib 给用户设置了很多钩子，例如 cookie 的钩子。</p>
</blockquote>
<h3 id="HTTP-响应状态码-400、500"><a href="#HTTP-响应状态码-400、500" class="headerlink" title="HTTP 响应状态码 400、500"></a>HTTP 响应状态码 400、500</h3><p>47:24</p>
<ul>
<li>400 Bad Request 客户端请求有语法错误，不能被服务器所理解</li>
<li>401 Unauthorized 请求未经授权，这个状态代码必须和 WWW-Authenticate 报头域一起使用</li>
<li>403 Forbidden 服务器收到请求，但是拒绝提供服务</li>
<li>404 Not Found 请求资源不存在，eg：输入了错误的 URL</li>
<li>500 Internal Server Error 服务器发生不可预期的错误</li>
<li>503 Server Unabailable 服务器当前不能处理客户端的请求，一段时间后可能恢复正常</li>
</ul>
<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>48:33</p>
<ul>
<li>400 Bad Request 检查请求的参数或者路径</li>
<li>401 Unauthorized 如果需要授权的网页，尝试重新登录</li>
<li>403 Forbidden<ul>
<li>如果是需要登录的网站，尝试重新登录</li>
<li>IP 被封，暂停爬取，并增加爬虫的等待时间，如果拨号网络，尝试重新联网更改 IP</li>
</ul>
</li>
<li>404 Not Found 直接丢弃</li>
<li>5XX 服务器错误，直接丢弃，并计数，如果连续不成功，WARNING 并停止爬取</li>
</ul>
<h3 id="HTTP-请求方法"><a href="#HTTP-请求方法" class="headerlink" title="HTTP 请求方法"></a>HTTP 请求方法</h3><p>50:13</p>
<ul>
<li>GET （GET 方法没有 body）（数据内容放在 url 里面）（请求数据的方法）</li>
<li>POST （POST 方法有 body 数据区域）</li>
</ul>
<h2 id="HTML-及-CSS"><a href="#HTML-及-CSS" class="headerlink" title="HTML 及 CSS"></a>HTML 及 CSS</h2><p>55:32</p>
<p>浏览器中不能看到 style=”display:none”，这个就是爬虫陷阱。</p>
<p><strong>Chrome Dev Tools： Console 中执行</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用类名获取元素</span></span><br><span class="line"><span class="built_in">document</span>.getElementsByClassName(<span class="string">'r'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 id 获取元素</span></span><br><span class="line"><span class="built_in">document</span>.getElementsById(<span class="string">''</span>)</span><br></pre></td></tr></table></figure>
<h2 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h2><p>1:10:17</p>
<p>HTML 是超文本标记语言，简单来说是可以认为是一种规范或者协议，浏览器根据 HTML 的语言规范来解析 HTML。</p>
<p>与爬虫相关的规范有以下：</p>
<p><strong>这一类 tag a 标记了外链用来做抓取，而 tr、p 用来进行内容抽取</strong></p>
<ul>
<li>Tag：<code>&lt;a&gt; &lt;tr&gt; &lt;p&gt;</code> </li>
</ul>
<p><strong>id、class 用在 css 上的，能帮助我们定位元素，作用和 tr p 类似：</strong></p>
<ul>
<li>Class</li>
<li>Id</li>
</ul>
<p>参考网站：<a href="http://www.w3school.com.cn/" target="_blank" rel="noopener">w3school 在线教程</a></p>
<h2 id="DOM-树"><a href="#DOM-树" class="headerlink" title="DOM 树"></a>DOM 树</h2><p>1:13:26</p>
<p>DOM 树最重要的作用是用来做网页数据分析及提取，我们可以充分利用 TAG、CLASS、ID 来找出某一类或某一个元素并提取内容。</p>
<h2 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h2><p>1:17:29</p>
<p>JavaScript 就是运行在前端的编程语言，最典型的用在动态网页的数据、内容加载及呈现上，JavaScript 做网络请求的时候最常用的技术是 AJAX（Asynchronous JavaScript and XML），专门用来异步请求数据，这些数据是我们抓取的时候需要用到的。</p>
<p>1:21:44 休息</p>
<p>1:22:17 问题解答</p>
<ul>
<li><p>编码问题</p>
</li>
<li><p>jQuery 的 Python 库 <code>pyquery</code></p>
</li>
<li><p>session 和 cookie 什么关系？</p>
<p>session 是服务器端的，cookie 是客户端的。</p>
</li>
<li><p>http 的 keep-alive 是操作 tcp 连接吗？</p>
<p>对，是 socket tcp 连接。 </p>
</li>
<li><p>selenium 会讲</p>
</li>
<li><p>经过混淆的页面怎么爬取？</p>
</li>
<li><p>汽车之家论坛加密的 HTML 代码</p>
</li>
</ul>
<h2 id="宽度及深度抓取"><a href="#宽度及深度抓取" class="headerlink" title="宽度及深度抓取"></a>宽度及深度抓取</h2><p>1:30:30</p>
<p>横向爬取优先：BSF</p>
<p>深度爬取优先：DSF</p>
<h2 id="爬虫的抓取对象类型"><a href="#爬虫的抓取对象类型" class="headerlink" title="爬虫的抓取对象类型"></a>爬虫的抓取对象类型</h2><p>1:31:38</p>
<ul>
<li><p>静态页面：</p>
<p><a href="https://en.wikipedia.org/wiki/Isaac_Newton" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Isaac_Newton</a></p>
</li>
<li><p>动态页面：</p>
<p><a href="https://item.jd.com/3133853.html" target="_blank" rel="noopener">https://item.jd.com/3133853.html</a></p>
</li>
<li><p>Web Service:</p>
<p><a href="https://m.weibo.cn/api/container/getIndex?uid=1618051664&amp;luicode=20000174&amp;featurecode=20000180&amp;type=uid&amp;value=1618051664&amp;containerid=1005051618051664" target="_blank" rel="noopener">https://m.weibo.cn/api/container/getIndex?uid=1618051664&amp;luicode=20000174&amp;featurecode=20000180&amp;type=uid&amp;value=1618051664&amp;containerid=1005051618051664</a></p>
</li>
</ul>
<h2 id="Web-API-数据获取"><a href="#Web-API-数据获取" class="headerlink" title="Web API 数据获取"></a>Web API 数据获取</h2><p>1:37:01</p>
<h2 id="Mafengwo-的结构"><a href="#Mafengwo-的结构" class="headerlink" title="Mafengwo 的结构"></a>Mafengwo 的结构</h2><p>1:37:42</p>
<h2 id="深度优先策略"><a href="#深度优先策略" class="headerlink" title="深度优先策略"></a>深度优先策略</h2><p>1:38:02</p>
<h2 id="宽度优先策略"><a href="#宽度优先策略" class="headerlink" title="宽度优先策略"></a>宽度优先策略</h2><p>1:38:22</p>
<h2 id="选择哪种策略？"><a href="#选择哪种策略？" class="headerlink" title="选择哪种策略？"></a>选择哪种策略？</h2><p>1:38:34</p>
<ul>
<li>重要的网页距离种子站点比较近</li>
<li>万维网的深度并没有很深，一个网页有很多路径可以到达（最大深度有17层左右）（数据结构：树、图）</li>
<li>宽度优先有利于多爬虫并行合作抓取 （队列）</li>
<li>深度限制与宽度优先相结合 （要设置最大深度 max-depth）</li>
</ul>
<blockquote>
<p>爬取策略：以宽度优先的方式加上爬取深度的限制。</p>
</blockquote>
<h2 id="不重复抓取策略"><a href="#不重复抓取策略" class="headerlink" title="不重复抓取策略"></a>不重复抓取策略</h2><p>1:46:41</p>
<p>网站每个子板块一般都有指向首页的链接，首页有子板块的链接，形成循环。</p>
<h2 id="如何记录抓取历史"><a href="#如何记录抓取历史" class="headerlink" title="如何记录抓取历史"></a>如何记录抓取历史</h2><p>1:48:38</p>
<ol>
<li>将访问过的 URL 保存到数据库。<strong>（效率太低）</strong></li>
<li>用 HashSet 将访问过的 URL 保存起来。那只需接近 O(1) 的代价就可以查到一个 URL 是否被访问过了。<strong>（消耗内存）</strong></li>
<li>URL 经过 MD5 或 SHA-1 等单向哈希后再保存到 HashSet 或数据库。（标准 MD5 长度16个字节）</li>
<li>Bit-Map 方法。建立一个 BitSet，将每个 URL 经过一个哈希函数映射到某一位。（Bit-Map 不是最佳方式）</li>
</ol>
<p><strong>老师向学员求助，有谁知道怎么退出 vnc</strong></p>
<p>2:00:44</p>
<p>老师要崩溃了哈</p>
<h2 id="MD5-函数"><a href="#MD5-函数" class="headerlink" title="MD5 函数"></a>MD5 函数</h2><p>2:03:42</p>
<p>MD5 签名是一个哈希函数，可以将任意长度的数据量转换为一个固定长度的数字（通常是4个整形，128位）。计算机不可能有2的128次方那么大内存，因此实际的哈希表都会是 URL.MD5 再 %n （即取模）。现实世界的 URL 组合必然超越哈希表的槽位数，因此碰撞是一定存在的。一般的 HASH 函数，例如 Java 的 HashTable 是一个 HASH 表再跟上一个链表，链表里存的是碰撞结果。</p>
<blockquote>
<p>两个网页的哈希值一样，就容易漏数据。</p>
</blockquote>
<h2 id="提高效率"><a href="#提高效率" class="headerlink" title="提高效率"></a>提高效率</h2><p>2:09:11</p>
<ul>
<li>评估网站的网页数量</li>
<li>选择合适的 HASH 算法和空间阀值，降低碰撞机率</li>
<li>选择合适的存储结构和算法</li>
</ul>
<blockquote>
<p>使用搜索引擎评估网站的网页数量</p>
<p>使用 Google：<code>site:www.mafengwo.cn/gonglve/</code></p>
<p>使用 百度：<code>site:www.mafengwo.cn</code>一般有显示网站的大致网页数量。</p>
</blockquote>
<h2 id="BITMAP-方式记录"><a href="#BITMAP-方式记录" class="headerlink" title="BITMAP 方式记录"></a>BITMAP 方式记录</h2><p>2:14:13</p>
<p><strong>将 URL 的 MD5 值再次哈希，用一个或多个 BIT 位来记录一个 URL：</strong></p>
<ol>
<li>确定空间大小 e.g. facebook 1.5Gb</li>
<li>按倍增加槽位 e.g. 16GB</li>
<li>HASH 算法映射（murmurhash3，cityhash）Python：<code>mmh3 bitarray</code></li>
</ol>
<p><strong>安装 murmurhash3 bitarray</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> pip install murmurhash3  <span class="comment"># murmurhash3 只支持 Python &gt;= 3.2.0</span></span></span><br><span class="line">pip install mmh3==2.4  # mmh3 支持 Python 2.7, Python 3.3 and higher.</span><br><span class="line">pip install bitarray==0.8.1</span><br></pre></td></tr></table></figure>
<p><strong>示例</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bitarray <span class="keyword">import</span> bitarray</span><br><span class="line"><span class="keyword">import</span> mmh3</span><br><span class="line"></span><br><span class="line">offset = <span class="number">2147483647</span> // <span class="number">2</span>^<span class="number">31</span> - <span class="number">1</span></span><br><span class="line">bit_array = bitarray(<span class="number">4</span>*<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>)  <span class="comment"># 空间大小 4个G</span></span><br><span class="line">bit_array.setall(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">b1 = mmh3.hash(url, <span class="number">42</span>) + offset  <span class="comment"># 42 是哈希的因子，一个数不能以负数开始所有加上 offset。</span></span><br><span class="line">bit_array[b1] = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="BITMAP-方式记录-压缩"><a href="#BITMAP-方式记录-压缩" class="headerlink" title="BITMAP 方式记录 压缩"></a>BITMAP 方式记录 压缩</h2><p>2:19:21</p>
<ul>
<li>优势：对存储进行了进一步压缩，在 MD5 的基础上，可以从128位最多压缩到1位，一般情况，如果用 4bit 或者 8bit 表示一个 url，也能压缩32或者16倍。</li>
<li>缺陷：碰撞概率增加。</li>
</ul>
<h2 id="Bloom-Filter"><a href="#Bloom-Filter" class="headerlink" title="Bloom Filter"></a>Bloom Filter</h2><p>2:20:37</p>
<p>Bloom Filter 使用了多个哈希函数，而不是一个，创建一个 m 位 BitSet，先将所有位初始化位0，然后选择 k 个不同的哈希函数。第 i 个哈希函数对字符串 str 哈希的结果记为 h（i，str），且 h（i，str）的范围是0到 m-1。只能插入，不能删除！！</p>
<blockquote>
<p>BITMAP 为了降低碰撞概率，需要设置大量空的 bit 位，来保证它们不被碰撞。</p>
<p>Bloom Filter 算法通过多个哈希函数同时命中，才算碰撞。</p>
</blockquote>
<h2 id="pybloomfilter"><a href="#pybloomfilter" class="headerlink" title="pybloomfilter"></a>pybloomfilter</h2><p>2:27:03</p>
<p><strong>安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pybloomfilter==1.0</span><br></pre></td></tr></table></figure>
<p><strong>使用源码安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/axiak/pybloomfiltermmap.git</span><br><span class="line">cd pybloomfiltermmap</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>
<p><strong>构造函数</strong></p>
<p><strong>Sample</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fruit = pybloomfilter.BloomFilter(<span class="number">100000</span>, <span class="number">0.1</span>, <span class="string">'/tmp/words.bloom'</span>)  <span class="comment"># 0.1是错误率， words.bloom 是种子文件。</span></span><br><span class="line">fruit.update((<span class="string">'apple'</span>, <span class="string">'pear'</span>, <span class="string">'orange'</span>, <span class="string">'apple'</span>))</span><br><span class="line"></span><br><span class="line">len(fruit)</span><br><span class="line"></span><br><span class="line"><span class="string">'mike'</span> <span class="keyword">in</span> fruit</span><br><span class="line"></span><br><span class="line"><span class="string">'apple'</span> <span class="keyword">in</span> fruit</span><br></pre></td></tr></table></figure>
<p><strong>官方文档</strong></p>
<p><a href="https://media.readthedocs.org/pdf/pybloomfiltermmap3/latest/pybloomfiltermmap3.pdf" target="_blank" rel="noopener">https://media.readthedocs.org/pdf/pybloomfiltermmap3/latest/pybloomfiltermmap3.pdf</a></p>
<p><a href="http://axiak.github.io/pybloomfiltermmap/" target="_blank" rel="noopener">Welcome to Python BloomFilter’s documentation! — Python BloomFilter v0.3.2 documentation</a></p>
<h2 id="如何有效记录抓取历史"><a href="#如何有效记录抓取历史" class="headerlink" title="如何有效记录抓取历史"></a>如何有效记录抓取历史</h2><p>2:29:00</p>
<ul>
<li>多数情况下不需要压缩，尤其网页数量少的情况</li>
<li>网页数量大的情况下，使用 Bloom Filter 压缩</li>
<li>重点是计算碰撞概率，并根据碰撞概率来确定存储空间的阀值</li>
<li>分布式系统，将散列映射到多台主机的内存</li>
</ul>
<h2 id="未讲内容：网站结构分析"><a href="#未讲内容：网站结构分析" class="headerlink" title="未讲内容：网站结构分析"></a>未讲内容：网站结构分析</h2><p>2:23:07</p>
<ul>
<li>mafengwo.cn 网站分析</li>
<li>Robots.txt</li>
<li>Sitemap.xml </li>
</ul>
<h2 id="问题解答"><a href="#问题解答" class="headerlink" title="问题解答"></a>问题解答</h2><p>2:34:00</p>
<p><a href="http://cn.mikecrm.com/aUZMT8z" target="_blank" rel="noopener">课程调查表</a></p>
<blockquote>
<p>滑动验证码无法破解，要做<strong>图像识别</strong>，但是这远远超过了爬虫的技术了。</p>
</blockquote>
<p>新建PyCharm项目 chinahadoop_crawl_spider<br>新建PyCharm项目 chinahadoop_crawl_spider_py2.7</p>
<p>cd chinahadoop_crawl_spider</p>
<p>macOS下安装pipenv</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install pipenv</span><br></pre></td></tr></table></figure>
<p>添加pipenv自动补全</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(pipenv --completion)</span>"</span></span><br></pre></td></tr></table></figure>
<p>初始化pipenv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipenv --python=/Users/jinlong/.pyenv/versions/2.7.14/bin/python</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipenv --python=/Users/jinlong/.pyenv/versions/3.6.3/bin/python</span><br></pre></td></tr></table></figure>
<p>修改pypi源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#linux</span></span><br><span class="line">sed -i <span class="string">"s#python.org#douban.com#g"</span> Pipfile</span><br><span class="line"></span><br><span class="line"><span class="comment">#macOS 和linux不同，需要加“”</span></span><br><span class="line">sed -i <span class="string">""</span> <span class="string">"s#python.org#douban.com#g"</span> Pipfile</span><br></pre></td></tr></table></figure>
<h1 id="02-登录及动态网页的抓取"><a href="#02-登录及动态网页的抓取" class="headerlink" title="02 登录及动态网页的抓取"></a>02 登录及动态网页的抓取</h1><blockquote>
<p>讲课开始时间：2017-06-13 19:58</p>
<p>03:02 开始讲课</p>
</blockquote>
<h2 id="大纲-1"><a href="#大纲-1" class="headerlink" title="大纲"></a>大纲</h2><ul>
<li>网站结构分析及案例：马蜂窝</li>
<li>XPath</li>
<li>正则表达式</li>
<li>动态网页</li>
<li>Headless 的浏览器：PhantomJS</li>
<li>浏览器的驱动：Selenium</li>
</ul>
<h2 id="网站结构分析-Robots-txt"><a href="#网站结构分析-Robots-txt" class="headerlink" title="网站结构分析 Robots.txt"></a>网站结构分析 Robots.txt</h2><p>04:56</p>
<ul>
<li>网站对爬虫的限制</li>
<li>利用 sitemap 来分析网站结构和估算目标网页的规模</li>
</ul>
<p>Robots：<a href="http://www.mafengwo.cn/robots.txt" target="_blank" rel="noopener">www.mafengwo.cn/robots.txt</a></p>
<p>Sitemap：<a href="http://www.mafengwo.cn/sitemapIndex.xml" target="_blank" rel="noopener">www.mafengwo.cn/sitemapIndex.xml</a></p>
<h2 id="Sitemap"><a href="#Sitemap" class="headerlink" title="Sitemap"></a>Sitemap</h2><p>10:34</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sitemap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">loc</span>&gt;</span>http://www.mafengwo.cn/article-0.xml<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>2017-02-04<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sitemap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sitemap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">loc</span>&gt;</span>http://www.mafengwo.cn/article-1.xml<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>2017-02-04<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sitemap</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="分析网站结构"><a href="#分析网站结构" class="headerlink" title="分析网站结构"></a>分析网站结构</h2><p>10:59</p>
<p>抓特定区域的游记，网站有反爬措施策略。</p>
<blockquote>
<p>403 401 501 典型的爬虫被禁止的返回状态码。</p>
</blockquote>
<p><a href="http://www.mafengwo.cn/mdd/" target="_blank" rel="noopener">目的地旅游攻略 - 马蜂窝</a></p>
<h2 id="有效率抓取特定内容"><a href="#有效率抓取特定内容" class="headerlink" title="有效率抓取特定内容"></a>有效率抓取特定内容</h2><p>18:06</p>
<ul>
<li><strong>利用 sitemap 里的信息</strong></li>
</ul>
<p>直接对目标网页 .html 进行抓取</p>
<ul>
<li><strong>对网站目录结构进行分析</strong></li>
</ul>
<p>大多数网站都会存在明确的 top-down 的分类的目录结构，我们可以进入特定目录进行抓取。</p>
<blockquote>
<p>对于 <a href="http://www.mafengwo.cn" target="_blank" rel="noopener">www.mafengwo.cn</a> 这个网站，所有旅游的游记都位于 <a href="http://www.mafengwo.cn/mdd" target="_blank" rel="noopener">www.mafengwo.cn/mdd</a> 下，按照城市进行了分类，每个城市的游记位于城市的首页。</p>
</blockquote>
<p>城市的首页：/travel-scenic-spot/mafengwo/<strong>10774</strong>.html （路径一）</p>
<p>游记的分页格式：/yj/<strong>10774/1-0-01</strong>.html （路径二）</p>
<p>游记的页面：/i/3523364.html （leaf）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 12141 城市代码</span><br><span class="line">/yj/12141/1-0-[page].html</span><br><span class="line"></span><br><span class="line"># 游记页面</span><br><span class="line">/i/\d&#123;7&#125;.html</span><br></pre></td></tr></table></figure>
<h2 id="XPath"><a href="#XPath" class="headerlink" title="XPath"></a>XPath</h2><p>20:45</p>
<p>内容抽取的方式：XPath 和正则表达式。</p>
<p><strong>安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install lxml==3.6.4</span><br></pre></td></tr></table></figure>
<p><strong>基本语法</strong></p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>nodename</td>
<td>选取此节点的所有子节点，tag 或 * 选择任意的 tag</td>
</tr>
<tr>
<td>/</td>
<td>从根节点选取，选择直接子节点，不包含更小的后代（例如孙、从孙）</td>
</tr>
<tr>
<td>//</td>
<td>从匹配选择的当前节点选择文档中的节点，而不考虑它们的位置，包含所有后代</td>
</tr>
<tr>
<td>.</td>
<td>选取当前节点</td>
</tr>
<tr>
<td>..</td>
<td>选取当前节点的父节点</td>
</tr>
<tr>
<td>@</td>
<td>选取属性</td>
</tr>
</tbody>
</table>
<p><strong>示例</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s = <span class="string">'&lt;a class="hask" href="http://www.taobao.com"&gt;Yes&lt;/a&gt;'</span></span><br><span class="line"></span><br><span class="line">tr = etree.HTML(s)</span><br><span class="line"></span><br><span class="line">tr.xpath(<span class="string">'//a'</span>)</span><br><span class="line"></span><br><span class="line">tr.xpath(<span class="string">'//a'</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">tr.xpath(<span class="string">'//a'</span>)[<span class="number">0</span>].attrib</span><br><span class="line"></span><br><span class="line">tr.xpath(<span class="string">'//*[@class="hask"]'</span>)[<span class="number">0</span>].attrib</span><br></pre></td></tr></table></figure>
<p><strong>Console</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElemeentsByClassNName(<span class="string">'hasxjicon'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="属性"><a href="#属性" class="headerlink" title="@ 属性"></a>@ 属性</h3><p>30:14</p>
<p>在 DOM 树中，以路径的方式查询节点，通过 @ 符号来选取属性。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span> <span class="attr">class</span>=<span class="string">"external text"</span> <span class="attr">href</span>=<span class="string">"http://googlee.ac"</span>&gt;</span>google<span class="tag">&lt;<span class="name">wbr</span>&gt;</span>.ac<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>rel class href 都是属性，可以通过 <code>&quot;//*[@class=&#39;external text&#39;]&quot;</code>来选取对应元素。</li>
<li>= 符号要求属性完全匹配，可以用 contains 方法来部分匹配，例如<code>&quot;//*[contains(@class, &#39;external&#39;)]&quot;</code>可以匹配，而<code>&quot;//*[@class=&#39;external&#39;]&quot;</code>不能匹配。</li>
</ul>
<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><p>36:07</p>
<p>and 和 or 运算符：</p>
<p><strong>选择 p 或者 span 或者 h1 标签的元素</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">soup = tree.xpaht(<span class="string">'//td[@class="editor bbsDetailContainer"]//*[self::p or self::span or self::h1]'</span>)</span><br></pre></td></tr></table></figure>
<p><strong>选择 class 为 editor 或者 tag 的元素</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">soup = tree.xpaht(<span class="string">'//td[@class="editor" or @class="tag"]'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><p>41:47</p>
<p>正则表达式是对字符串操作的一种逻辑公式，就是用事先定义好的一些特定字符、及这些特定字符的组合，组成一个”规则字符串“，这个”规则字符串“用来表达对字符串的一种过滤逻辑。</p>
<blockquote>
<p>在爬虫的解析中，经常会将正则表达式与 DOM 选择器结合使用。正则表达式适用于<strong>字符串特征比较明显</strong>的情况，但是同样的正则表达式可能在 HTML 源码里多次出现；而 DOM 选择器可以通过 class 及 id 来精确找到 DOM 块，从而缩小查找的范围。</p>
</blockquote>
<p>NLP 自然语言处理</p>
<h3 id="常用规则"><a href="#常用规则" class="headerlink" title="常用规则"></a>常用规则</h3><p>43:58</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>\</td>
<td>转义符，例如 \?</td>
</tr>
<tr>
<td>^</td>
<td>字符串起始</td>
</tr>
<tr>
<td>$</td>
<td>字符串结束</td>
</tr>
<tr>
<td>*</td>
<td>匹配前面子表达式0次或多次</td>
</tr>
<tr>
<td>+</td>
<td>匹配前面子表达式1次或多次</td>
</tr>
<tr>
<td>?</td>
<td>匹配前面子表达式0次或1次</td>
</tr>
<tr>
<td>{n,m}</td>
<td>匹配至少 n 次，最多 m 次</td>
</tr>
<tr>
<td>.</td>
<td>匹配除 \n 之外的单个字符</td>
</tr>
<tr>
<td>(pattern)</td>
<td>匹配并获取这个匹配，例如匹配 ab(cd)e 正则表达式只返回 cd （匹配内容，并返回匹配内容。）</td>
</tr>
<tr>
<td>[xyz]</td>
<td>字符集合，匹配任意集合里的字符</td>
</tr>
<tr>
<td>[^xyz]</td>
<td>排除集合里的字符，不匹配集合里的字符</td>
</tr>
<tr>
<td>\d</td>
<td>匹配一个数字，等价 [0-9]</td>
</tr>
</tbody>
</table>
<h3 id="爬虫常用的正则规则"><a href="#爬虫常用的正则规则" class="headerlink" title="爬虫常用的正则规则"></a>爬虫常用的正则规则</h3><p>47:07</p>
<ul>
<li>获取标签下的文本： <code>&#39;&lt;th[^&gt;]*&gt;(.*?)&lt;/th&gt;&#39;</code></li>
<li>查找特定类别的链接，例如 /wiki/ 不包含 Category 目录：<code>&lt;a href=&quot;wiki/(?!Category:)[^/&gt;]*&gt;(.*?)&lt;&#39;</code> （不包含 <code>?!Category:</code>）</li>
<li>查找商品外链，例如 jd 的商品外链为7位数字的 a 标签节点：<code>&#39;/\d{7}.html&#39;</code></li>
<li>查找淘宝的商品信息，’ 或者 “ 开始及结尾：<code>&#39;href=[\&quot;\&#39;]{1}(//detail.taobao.com/item.html[^&gt;\&quot;\&#39;\s]+?)&quot;&#39;</code></li>
</ul>
<h3 id="贪婪模式及非贪婪模式"><a href="#贪婪模式及非贪婪模式" class="headerlink" title="贪婪模式及非贪婪模式"></a>贪婪模式及非贪婪模式</h3><p>50:31</p>
<p>? 该字符紧跟在任何一个其他限制符 (*,+,?,{n},{n,},{n,m}) 后面时，匹配模式是非贪婪的。非贪婪模式尽可能少的匹配所搜索的字符串，而默认的贪婪模式则尽可能多的匹配所搜索的字符串。</p>
<p><strong>示例</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s = """<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'https://www.google.com/search?q=regular+expression&amp;oq=regular+expression&amp;aqs=chrome..69i57j0l5.7173j0j7&amp;sourceid=chrome&amp;ie=UTF-8'</span>&gt;</span>Google Test 1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'https://www.google.com/search?q=regular+expression&amp;oq=regular+expression&amp;aqs=chrome..69i57j0l5.7173j0j7&amp;sourceid=chrome&amp;ie=UTF-8'</span>&gt;</span>Google Test 2<span class="tag">&lt;/<span class="name">a</span>&gt;</span>"""</span><br></pre></td></tr></table></figure>
<p>对于上面的字符串，贪婪模式将匹配整个字符串。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.findall(<span class="string">'https://www.google.com/search\?q=.*UTF-8'</span>, s)</span><br></pre></td></tr></table></figure>
<p>对于上面的字符串，而非贪婪模式才是我们想要的额，只返回一个链接</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.findall(<span class="string">'https://www.google.com/search\?q=.*?UTF-8'</span>, s)</span><br></pre></td></tr></table></figure>
<h2 id="动态网页"><a href="#动态网页" class="headerlink" title="动态网页"></a>动态网页</h2><h3 id="动态页面的使用场景"><a href="#动态页面的使用场景" class="headerlink" title="动态页面的使用场景"></a>动态页面的使用场景</h3><p>52:19</p>
<ul>
<li><p>单页模式</p>
<p>单页模式指的是不需要外部跳转的网页，例如个人设置中心经常就是单页</p>
</li>
<li><p>页面交互多的场景 <a href="https://flight.qunar.com/" target="_blank" rel="noopener">【去哪儿网】机票查询,特价机票,打折飞机票-去哪儿网Qunar.com</a></p>
<p>一部分网页上，有很多的用户交互接口，例如<strong>去哪儿</strong>的机票选择页面，用户可以反复修改查询的参数</p>
</li>
<li><p>内容及模块丰富的网页</p>
<p>有些网页内容很丰富，一次加载完对服务器压力很大，而且这种方式延时也会很差；用户往往也不会查看所有内容</p>
</li>
</ul>
<h3 id="动态页面带来的挑战"><a href="#动态页面带来的挑战" class="headerlink" title="动态页面带来的挑战"></a>动态页面带来的挑战</h3><p>56:41</p>
<p><strong>对于爬虫：</strong></p>
<ul>
<li>简单下载 HTML 已经不行了，必须得有一个 Web 容器来运行 HTML 的脚本</li>
<li>增加了爬取的时间</li>
<li>增加了计算机的 CPU、内存的资源消耗</li>
<li>增加了爬取的不确定性</li>
</ul>
<p><strong>对于网站：</strong></p>
<ul>
<li>为了配合搜索引擎的爬取，与搜索相关的信息会采用静态方式</li>
<li>与搜索无关的信息，例如商品的价格、评论，仍然会使用动态加载</li>
</ul>
<h3 id="抓取动态页面-分析"><a href="#抓取动态页面-分析" class="headerlink" title="抓取动态页面-分析"></a>抓取动态页面-分析</h3><p>1:01:39</p>
<p>打开目标页面后，直接右键点击，只保存 HTML</p>
<p><a href="http://item.jd.com/4938580.html" target="_blank" rel="noopener">【三星Galaxy S8】【限量礼盒版】三星 Galaxy S8（SM-G9500）4GB+64GB 谜夜黑 移动联通电信4G手机 双卡双待【行情 报价 价格 评测】-京东</a></p>
<h3 id="分析动态网页-对比"><a href="#分析动态网页-对比" class="headerlink" title="分析动态网页-对比"></a>分析动态网页-对比</h3><p>1:04:52</p>
<ul>
<li><p>使用 BeyondCompare 或者 SVN 等工具，来对比网页，大致找出动态加载的部分</p>
</li>
<li><p>针对要提取的部分，分别查看 html only 与 full webpage，找出动态数据的部分</p>
</li>
<li><p>记录下它们的 class 或 id，试着用代码来提取，如果不能提取，说明是动态的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'./s7-full.htm'</span>)</span><br><span class="line">c = f.read().decode(<span class="string">'gbk'</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">e = etree.HTML(c)</span><br><span class="line"><span class="keyword">print</span> e.xpath(<span class="string">u'//span[@class="price J-p-10524731933"]'</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="问题解答-1"><a href="#问题解答-1" class="headerlink" title="问题解答"></a>问题解答</h2><p>1:08:55 休息5分钟</p>
<ul>
<li><p>bloomfilter 数据持久化，直接写到文件就行。</p>
</li>
<li><p>github 地址：<a href="https://github.com/junglelord/spider-course-2" target="_blank" rel="noopener">junglelord/spider-course-2</a></p>
<blockquote>
<p>第一次课是按照课程来组织代码的，第二次课就按照项目名来组织文件名。</p>
</blockquote>
</li>
<li><p>headless chrome，phantomjs 已经不维护了。</p>
</li>
<li><p>文本相似度 </p>
<blockquote>
<p>词向量 wordback 文本分析处理，需要机器学习、神经网络方面的知识要求比较高。</p>
</blockquote>
</li>
</ul>
<h2 id="Python-Web-引擎"><a href="#Python-Web-引擎" class="headerlink" title="Python Web 引擎"></a>Python Web 引擎</h2><p>1:18:57</p>
<ul>
<li>PyQt PySide：基于 QT 的 Python Web 引擎，需要图形界面的支持，需要安装大量的依赖。安装和配置复杂，尤其是安装图形系统，对于服务器来说代价很大</li>
<li>Selenium：一个自动化的 Web 测试工具，可以支持包括 Firefox、Chrome、PhantomJS、IE 等多种浏览器的连接与测试</li>
<li>PhantomJS：一个基于 Webkit 的 Headless 的 Web 引擎，支持 JavaScript。相比 PyQt 等方案，PhantomJS 可以部署在没有 UI 的服务器上。</li>
</ul>
<blockquote>
<p>PhantomJS + Selenium</p>
</blockquote>
<p><strong>安装 Selenium</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install selenium</span><br></pre></td></tr></table></figure>
<p><strong>安装 PhantomJS</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew cask install phantomjs</span><br></pre></td></tr></table></figure>
<h2 id="使用-PhantomJS-来加载动态页面"><a href="#使用-PhantomJS-来加载动态页面" class="headerlink" title="使用 PhantomJS 来加载动态页面"></a>使用 PhantomJS 来加载动态页面</h2><p>1:25:02</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">driver = webdriver.PhantomJS(service_args=[<span class="string">'--ignore-ssl-errors=true'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置浏览器窗口大小</span></span><br><span class="line">driver.set_window_size(<span class="number">1280</span>,<span class="number">2400</span>)</span><br><span class="line"></span><br><span class="line">driver.get(cur_url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看页面 html 源代码</span></span><br><span class="line">content = driver.page_source</span><br></pre></td></tr></table></figure>
<blockquote>
<p>SocketIO 跟 云端保持长连接。</p>
</blockquote>
<h3 id="set-window-size"><a href="#set-window-size" class="headerlink" title="set_window_size"></a>set_window_size</h3><p>1:32:48</p>
<p>对于动态网页，有可能存在大量数据是根据视图来动态加载的，PhantomJS 允许客户端设置用来模拟渲染页面的窗口的尺寸，这个尺寸如果设置比较小，我们就不得不用 JavaScript 的 scroll 命令来模拟页面往下滑动的效果以显示更多内容，所以我们可以设置一个相对大的窗口高度来渲染。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driver.set_window_size(<span class="number">1280</span>,<span class="number">2400</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Built-in-DOM-selector"><a href="#Built-in-DOM-selector" class="headerlink" title="Built-in DOM selector"></a>Built-in DOM selector</h3><p>1:34:37</p>
<p>Selenium 实现了一系列的类似与 XPath 选择器的方法，使得我们可以直接调用 <code>driver.find_element()</code>来进行元素的选择，但是这些都是基于 Python 的实现，执行效率非常低，大约是基于 C 的正则表达式或 lxml 的10倍的时间，因此不建议使用 <strong>built-in</strong> 的选择器，而是采用 <strong>lxml</strong> 或者 <strong>re</strong> 对 <code>driver.page_source</code>（<strong>html</strong> 文本）进行操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">find_element(self, by=<span class="string">'id'</span>, value=<span class="keyword">None</span>)</span><br><span class="line">find_element_by_class_name(self, name)</span><br><span class="line">find_element_by_id(self, id_)</span><br><span class="line">find_element_by_css_selector(self, css_selector )</span><br></pre></td></tr></table></figure>
<h3 id="Useful-Methods-amp-Properties"><a href="#Useful-Methods-amp-Properties" class="headerlink" title="Useful Methods &amp; Properties"></a>Useful Methods &amp; Properties</h3><p>1:37:40</p>
<p>Selenium 通过浏览器的驱动，支持大量的 HTML 及 JavaScript 的操作，常用的包括：</p>
<ul>
<li>page_source：获取当前的 HTML 文本</li>
<li>title：HTML 的 title</li>
<li>current_url：当前网页的 URL</li>
<li>get_cookie() &amp; get_cookies()：获取当前的 cookie</li>
<li>delete_cookie() &amp; delete_all_cookies()：删除所有的 cookie</li>
<li>add_cookie()：添加一段 cookie</li>
<li>set_page_load_timeout()：设置网页超时时间</li>
<li>execute_script()：同步执行一段 JavaScript 命令</li>
<li>execute_async_script()：异步执行 JavaScript 命令</li>
</ul>
<blockquote>
<p>HTML title 和 文章 title 不一样。</p>
</blockquote>
<h3 id="Close-and-Clear"><a href="#Close-and-Clear" class="headerlink" title="Close and Clear"></a>Close and Clear</h3><p> 1:40:41</p>
<p>Selenium 通过内嵌的浏览器 driver 与浏览器进行通信，因此在退出的时候必须调用 <code>driver.close()</code> 及 <code>driver.quit()</code>来退出 PhantomJS。否则 PhantomJS 会一直运行在后台并占用系统资源。</p>
<p><strong>查看进程</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep phantomjs</span><br></pre></td></tr></table></figure>
<p><strong>关闭进程</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 官方建议</span></span><br><span class="line">driver.service.process.send_signal(signal.SIGTERM)</span><br><span class="line"></span><br><span class="line">driver.close()</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pgrep phantomjs | xagrs kill</span><br></pre></td></tr></table></figure>
<h2 id="提取动态数据"><a href="#提取动态数据" class="headerlink" title="提取动态数据"></a>提取动态数据</h2><p>1:49:17</p>
<ol>
<li>加载的过程中，根据网络环境的好坏，会存在一些延时，因此要多次尝试提取。</li>
<li>动态页面的元素，同一个元素可能命名方式有很多种，要多种情况都进行尝试。如果一个元素不能找到而且 Selenium 并没有报网络错误，可能元素有新的命名了，我们需要将找不到的页面及元素信息记录在日志里，使得后续可以分析，找出新的定义的方法并对这一类页面重新提取信息。</li>
</ol>
<h3 id="提取动态数据代码"><a href="#提取动态数据代码" class="headerlink" title="提取动态数据代码"></a>提取动态数据代码</h3><p>1:50:57</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> number_tried &lt; constans[<span class="string">'MAX_PAGE_TRIED'</span>]:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        price_element = driver.find_element_by_class_name(<span class="string">''</span> % (item_id))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> selenium.common.exceptions.NoSuchElementException, msgs:</span><br><span class="line">        number_tried += <span class="number">1</span></span><br><span class="line">        <span class="keyword">print</span> msgs[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">except</span> Exception, msgs:</span><br><span class="line">        <span class="keyword">print</span> msgs[<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<h2 id="href-的类型-and"><a href="#href-的类型-and" class="headerlink" title="href 的类型 \ and \\"></a>href 的类型 \ and \\</h2><p>1:51:08</p>
<p>网页内，href 后面的链接可能有这样三种：</p>
<ul>
<li><p>href=”<a href="http://career.taobao.com&quot;" target="_blank" rel="noopener">http://career.taobao.com&quot;</a></p>
<p>完整 URL，直接跳转</p>
</li>
<li><p>href=”\\detail.taobao.com\iuslkjsd” （淘宝）</p>
<p>协议相关的绝对路径，如果现在是 <a href="https://xxx" target="_blank" rel="noopener">https://xxx</a> 则需要在 <code>\\detail.taobao.com\iuslkjsd</code>前面加上 <code>https:</code>，协议也可以是 <code>file:</code>或者 <code>ftp:</code>，这种比较灵活。</p>
</li>
<li><p>href=”\i\8277375.html” （京东）</p>
<p>网站的相对路径，需要在前面指明当前 url 的协议及 domain</p>
</li>
</ul>
<h2 id="PhantomJS-配置"><a href="#PhantomJS-配置" class="headerlink" title="PhantomJS 配置"></a>PhantomJS 配置</h2><p>1:53:15</p>
<ul>
<li>–ignore-ssl-errors=[true|false] 一些证书没有获得 CA 授权，浏览器会报错，使用这个命令后，能自动忽略此类错误。</li>
<li>–load-images=[true|false] 加载图片（不加载）</li>
<li>–disk-cache=[true|false] 硬盘缓存 （开启硬盘缓存）</li>
<li>–cookie-file=/path/to/cookies.txt cookie文件存放位置</li>
<li>—debug=[true|false] debug模式</li>
<li>–config=/path/to/config.json 指定配置文件</li>
</ul>
<h2 id="证书授信-CA-SSL-HTTP"><a href="#证书授信-CA-SSL-HTTP" class="headerlink" title="证书授信 CA SSL HTTP"></a>证书授信 CA SSL HTTP</h2><p>1:54:27</p>
<p>SSL 非对称的加密方式</p>
<ul>
<li>private key 服务器使用私钥解密信息。</li>
<li>public key 公钥公布。</li>
</ul>
<h2 id="PhantomJS-config"><a href="#PhantomJS-config" class="headerlink" title="PhantomJS config"></a>PhantomJS config</h2><p>2:01:37</p>
<p>–config=/path/to/config.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"ignoreSslErrors"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"maxDiskCacheSize"</span>: <span class="number">1000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>2:03:56</p>
<h2 id="答疑"><a href="#答疑" class="headerlink" title="答疑"></a>答疑</h2><p>2:05:27 </p>
<ul>
<li><p>js 滚动：<code>window.scrollTo(0, 4000)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.body.scrollHeight</span><br></pre></td></tr></table></figure>
</li>
<li><p>滑动验证码 破解方案</p>
</li>
</ul>
<h1 id="03-微博的抓取"><a href="#03-微博的抓取" class="headerlink" title="03 微博的抓取"></a>03 微博的抓取</h1><blockquote>
<p>讲课开始时间：2017-06-15 19:52</p>
<p>09:22 开始讲课</p>
</blockquote>
<p>分布式爬虫</p>
<h2 id="大纲-2"><a href="#大纲-2" class="headerlink" title="大纲"></a>大纲</h2><ul>
<li>使用 Selenium + PhantomjS 来抓取</li>
<li>微博接口分析</li>
<li>直接调用微博 API 来抓取</li>
<li>表单及登录</li>
</ul>
<p>10:48 流程分析</p>
<h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><p>13:03</p>
<p>最重要的是 设置 User-Agent，否则无法跳转链接</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium.webdriver.common.desired_capabilities <span class="keyword">import</span> DesiredCapabilities</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user_agent = (</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">dcap = dict(DesiredCapabilities.PHANTOMJS)</span><br><span class="line"></span><br><span class="line">dcap[<span class="string">"phantomjs.page.settings.userAgent"</span>] = user_agent</span><br><span class="line"></span><br><span class="line">driver = webdriver.PhantomJS(desired_capabilities=dcap)</span><br></pre></td></tr></table></figure>
<h2 id="输入用户名与密码"><a href="#输入用户名与密码" class="headerlink" title="输入用户名与密码"></a>输入用户名与密码</h2><p>15:49</p>
<p>为了与微博内容交互，需要使用 JavaScript</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"loginname"</span> <span class="attr">class</span>=<span class="string">"W_input "</span> <span class="attr">maxlength</span>=<span class="string">"128"</span> <span class="attr">autocomplete</span>=<span class="string">"off"</span> <span class="attr">action-data</span>=<span class="string">"text=邮箱/会员帐号/手机号"</span> <span class="attr">action-type</span>=<span class="string">"text_copy"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">node-type</span>=<span class="string">"username"</span> <span class="attr">tabindex</span>=<span class="string">"1"</span> <span class="attr">type</span>=<span class="string">"text"</span>&gt;</span>	</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"W_input "</span> <span class="attr">maxlength</span>=<span class="string">"24"</span> <span class="attr">autocomplete</span>=<span class="string">"off"</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">action-type</span>=<span class="string">"text_copy"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">node-type</span>=<span class="string">"password"</span> <span class="attr">tabindex</span>=<span class="string">"2"</span> <span class="attr">type</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"W_input "</span> <span class="attr">maxlength</span>=<span class="string">"6"</span> <span class="attr">autocomplete</span>=<span class="string">"off"</span> <span class="attr">value</span>=<span class="string">"验证码"</span> <span class="attr">action-data</span>=<span class="string">"text=请输入验证码"</span> <span class="attr">action-type</span>=<span class="string">"text_copy"</span> <span class="attr">name</span>=<span class="string">"verifycode"</span> <span class="attr">node-type</span>=<span class="string">"verifycode"</span> <span class="attr">tabindex</span>=<span class="string">"3"</span> <span class="attr">type</span>=<span class="string">"text"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"info_list login_btn"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:void(0)"</span> <span class="attr">class</span>=<span class="string">"W_btn_a btn_32px"</span> <span class="attr">action-type</span>=<span class="string">"btn_submit"</span> <span class="attr">node-type</span>=<span class="string">"submitBtn"</span> <span class="attr">suda-data</span>=<span class="string">"key=tblog_weibologin3&amp;amp;value=click_sign"</span> <span class="attr">tabindex</span>=<span class="string">"6"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">node-type</span>=<span class="string">"submitStates"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>相关的 JavaScript 代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 输入用户名</span></span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'loginname'</span>).value=<span class="string">'13715221811'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输入密码</span></span><br><span class="line"><span class="built_in">document</span>.getElementsByName(<span class="string">"password"</span>)[<span class="number">0</span>].value=<span class="string">"wowooewweojfwekjnf"</span></span><br><span class="line"><span class="built_in">document</span>.getElementsByClassName(<span class="string">"W_input "</span>)[<span class="number">2</span>].value=<span class="string">"12345623432"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 点击登录按钮</span></span><br><span class="line"><span class="built_in">document</span>.getElementsByClassName(<span class="string">"W_btn_a btn_32px"</span>)[<span class="number">0</span>].click()</span><br></pre></td></tr></table></figure>
<p>通过 Selenium 提供的 send_keys 来传递 value</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">driver.find_element_by_id(<span class="string">'loginname'</span>).send_keys(username)</span><br><span class="line">driver.find_element_by_name(<span class="string">'password'</span>).send_keys(password)</span><br></pre></td></tr></table></figure>
<h2 id="分析微博网站结构"><a href="#分析微博网站结构" class="headerlink" title="分析微博网站结构"></a>分析微博网站结构</h2><p>29:22 </p>
<ol>
<li>找出感兴趣的微博号，翻页抓取全部。（起始点）（关注，粉丝，微博）</li>
<li>随机一个页面，遍历所有页面。（关注了谁，谁关注了他）</li>
</ol>
<h2 id="关注、分析"><a href="#关注、分析" class="headerlink" title="关注、分析"></a>关注、分析</h2><p>40:28</p>
<p>关注列表、粉丝列表，作为漫游 Weibo 的外链。</p>
<ul>
<li><p><strong>要选择什么数据做指标</strong>，高质量的<strong>关注列表</strong>。</p>
</li>
<li><p>翻页对数据库有很大的负担，有<strong>深翻页</strong>的行为的一般都是<strong>机器人</strong>。</p>
</li>
</ul>
<h2 id="获取微博外链"><a href="#获取微博外链" class="headerlink" title="获取微博外链"></a>获取微博外链</h2><p>46:17</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driver.find_element_by_xpath(<span class="string">'//a[@class="t_link S_txt1"]'</span>)</span><br></pre></td></tr></table></figure>
<p>0是关注，1是粉丝，2是微博，我们只需要0，关注的微博一般是有质量的额，而粉丝的数量太多，并且有太多僵尸粉。</p>
<p>打开关注列表页：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driver.find_element_by_xpath(<span class="string">'//a[@class="t_link S_txt1"]'</span>).get_attribute(<span class="string">"href"</span>)</span><br></pre></td></tr></table></figure>
<p>获取所有关注的微博号的地址：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driver.find_element_by_xpath(‘//*[contains(@class, "follow_item")]//a[@class="S_txt1"]')</span><br></pre></td></tr></table></figure>
<h2 id="获取微博用户信息"><a href="#获取微博用户信息" class="headerlink" title="获取微博用户信息"></a>获取微博用户信息</h2><p>48:13</p>
<ul>
<li><p>提取用户的基本信息</p>
<ul>
<li>链接：用正则表达式把用户的链接参数都去掉<code>/u/1634431184?refer_flag=1005050006</code>，只保留<code></code>/u/1634431184`</li>
<li>微博昵称及头像</li>
<li>关注、粉丝及微博数量</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>过滤质量差的用户</strong>，对于微博数量少于阀值，或者关注数超过粉丝数 N 倍以上的，判定为僵尸粉或广告微博，直接跳过（对于爬取的效率有很大影响）</p>
<ul>
<li>僵尸粉：微博数量极少</li>
<li>纯广告、营销微博：关注数远远超过粉丝数量</li>
</ul>
</li>
</ul>
<ul>
<li>提取下一页，可以继续查找更多的 user</li>
</ul>
<blockquote>
<p>判断关注数和粉丝数是否作为我们的种子用户。</p>
<p>判断微博数小于某个数量，大于某个数量的。不要去爬取。（效率）</p>
<p>一般我们聚焦在某个行业的内容。</p>
</blockquote>
<h2 id="微博信息抽取-微博正文抽取"><a href="#微博信息抽取-微博正文抽取" class="headerlink" title="微博信息抽取 - 微博正文抽取"></a>微博信息抽取 - 微博正文抽取</h2><p>1:01:29 第二次讲到 1:16:01</p>
<p>微博名：<code>driver.find_element_by_tag_name(&#39;h1&#39;)</code></p>
<p>所有的 Feed：<code>driver.find_elements_by_class_name(&quot;WB_detail&quot;)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">feed = &#123;&#125;</span><br><span class="line">feed[<span class="string">'time'</span>] = element.find_element_by_xpath(<span class="string">'.//div[@class="WB_from S_txt2"]'</span>).text</span><br><span class="line">feed[<span class="string">'content'</span>] = element.find_elelment_by_class_name(<span class="string">'WB_text'</span>).text</span><br><span class="line"></span><br><span class="line">feed[<span class="string">'image_names'</span>] = []</span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> element.find_elements_by_xpath(<span class="string">'.//li[contains(@class,"WB_pic")]/img'</span>):</span><br><span class="line">    feed[<span class="string">'image_names'</span>].append(re.findall(<span class="string">'/([^/]+)$'</span>, image.get_attribute(<span class="string">'src'</span>)))</span><br></pre></td></tr></table></figure>
<p>微博的图片，只需要保存图片名</p>
<p><a href="http://wx2.sinaimg.cn/thumb150/4b7a8989ly1fcws2sryvrj22p81sub2a.jpg" target="_blank" rel="noopener">http://wx2.sinaimg.cn/thumb150/4b7a8989ly1fcws2sryvrj22p81sub2a.jpg</a></p>
<p>http://存储域名/分辨率/文件名</p>
<blockquote>
<p>个人信息，在数据库中不会存完整的链接，只会保存文件名，然后请求的时候在做拼接。</p>
<p>图片上传，服务器一般会存三个格式，一个缩略图，一个中等大小的图片，一个原图。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract_user</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">def</span> <span class="title">go_next_page</span><span class="params">(cur_driver)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        next_page = cur_driver.find_element_by_xpath(<span class="string">'//a[contains(@class, "page next")]'</span>).get_attribute(<span class="string">'href'</span>)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'next page is '</span> + next_page</span><br><span class="line">        cur_driver.get(next_page)</span><br><span class="line">        time.sleep(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'next page is not found'</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>爬虫1：爬取所有 user_id</p>
<p>爬虫2：爬取正文（1.翻页，2.提取数据，3.下一页）</p>
<h2 id="微博图片信息"><a href="#微博图片信息" class="headerlink" title="微博图片信息"></a>微博图片信息</h2><p>1:13:05</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.findall(<span class="string">'/([^/]+)$'</span>, image.get_attribute(<span class="string">'src'</span>))</span><br></pre></td></tr></table></figure>
<p>服务器上图片存储规格，三种：缩略图、中图、大图（原图）</p>
<h2 id="滚动频率与翻页"><a href="#滚动频率与翻页" class="headerlink" title="滚动频率与翻页"></a>滚动频率与翻页</h2><p>每次滚动后，检查是否已经出现了</p>
<ul>
<li><p>微博的下一页的 <code>class: page next S_txt1 S_line1</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driver.find_element_by_xpaht(<span class="string">'//a[@class="page next S_txt1 S_line1]'</span>).click()</span><br></pre></td></tr></table></figure>
</li>
<li><p>翻页命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driver.execute_script(<span class="string">'window.scrollTo(0, document.body.scrollHeight)'</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract_feed</span><span class="params">(feeds)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        <span class="comment"># 滚动到页面底部，使得当前页面所有的微博都被显示</span></span><br><span class="line">        scroll_to_bottom()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 遍历这个数组，提取所有微博的内容</span></span><br><span class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> feeds_crawler.find_elements_by_class_name(<span class="string">'WB_detail'</span>):</span><br><span class="line">            tried = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> tried &lt; <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    feed = &#123;&#125;</span><br><span class="line">                    feed[<span class="string">'time'</span>] = element.find_element_by_xpath(<span class="string">'.//div[@class="WB_from S_txt2]'</span>).text</span><br><span class="line">                    feed[<span class="string">'content'</span>] = element.find_element_by_class_name(<span class="string">'WB_text'</span>).text</span><br><span class="line">                    feed[<span class="string">'image_names'</span>] = []</span><br><span class="line">					<span class="keyword">for</span> image <span class="keyword">in</span> element.find_elements_by_xpath(<span class="string">'.//li[contains(@class,"WB_pic")]/img'</span>):</span><br><span class="line">    					feed[<span class="string">'image_names'</span>].append(re.findall(<span class="string">'/([^/]+)$'</span>, image.get_attribute(<span class="string">'src'</span>)))</span><br><span class="line">                    feeds.append(feed)</span><br><span class="line">                    <span class="comment"># print '-----------------'</span></span><br><span class="line">                    <span class="keyword">print</span> -*<span class="number">20</span></span><br><span class="line">                    <span class="keyword">print</span> feed[<span class="string">'time'</span>]</span><br><span class="line">                    <span class="keyword">print</span> feed[<span class="string">'content'</span>]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">except</span> Exception:</span><br><span class="line">                    tried += <span class="number">1</span></span><br><span class="line">                    time.sleep(<span class="number">1</span>)</span><br><span class="line">         <span class="keyword">if</span> go_next_page(feeds_crawler) <span class="keyword">is</span> <span class="keyword">False</span>:</span><br><span class="line">            <span class="keyword">return</span> feeds</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scroll_to_bottom</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 最多尝试20次滚屏</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">' scroll down'</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">50</span>):</span><br><span class="line">        <span class="comment"># print 'scrolling for the %d time' % (i)</span></span><br><span class="line">        feeds_crawler.execute_script(<span class="string">'window.scrollTo(0, document.body.scrollHeight)'</span>)</span><br><span class="line">        html = feeds_cralwer.page_source</span><br><span class="line">        tr = etree.HTML(html)</span><br><span class="line">        next_page_url = tr.xpath(<span class="string">'//a[contains(@class, "page next")]'</span>)</span><br><span class="line">        <span class="keyword">if</span> len(next_page_url) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> next_page_url[<span class="number">0</span>].get(<span class="string">'href'</span>)</span><br><span class="line">        <span class="keyword">if</span> len(re.findall(<span class="string">'点击重新载入'</span>, html)) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'scrolling failed, reload it'</span></span><br><span class="line">            feeds_crawler.find_element_by_link_text(<span class="string">'点击重新载入'</span>).click()</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>1:22:39 </p>
<p>每次滚动后，检查是否已经出现了”下一页“的按钮，如果是则停止翻页，否则检查是否出现了”网络超时“的链接，是的话，点击这个链接来重新加载。</p>
<ol>
<li>滚屏</li>
<li>提取</li>
<li>翻页</li>
</ol>
<h2 id="滚屏"><a href="#滚屏" class="headerlink" title="滚屏"></a>滚屏</h2><p>1:23:45</p>
<h2 id="微博抓取框架-重点"><a href="#微博抓取框架-重点" class="headerlink" title="微博抓取框架 - 重点"></a>微博抓取框架 - 重点</h2><p>1:24:25</p>
<p>流程图</p>
<p>Web 1: Crawler</p>
<ul>
<li>Dequeue Url：从数据库拿数据</li>
</ul>
<p>Web 2: User Info</p>
<ul>
<li>Enqueue Url：数据放到数据库</li>
</ul>
<p>1:27:31</p>
<p>爬虫操作 chrome 浏览器访问 weibo。</p>
<p>robot-&gt;chrome-&gt;weibo</p>
<p>效率比较低</p>
<p>1:30:03 休息一下</p>
<p>1:38:32 JavaScript 问题 <code>&lt;a href=&quot;javascript:&quot;&gt;</code>空 js 代码可能会触发<strong>事件</strong>然后处理。</p>
<h2 id="微博接口分析"><a href="#微博接口分析" class="headerlink" title="微博接口分析"></a>微博接口分析</h2><p>1:44:26</p>
<p>微博域名 <a href="http://m.weibo.cn" target="_blank" rel="noopener">http://m.weibo.cn</a></p>
<p>这是微博的首页网页版，能看到结构非常简单，我们能直接拿到 Feed 流，我们尝试从移动端来分析微博的数据 API 接口</p>
<p>GET</p>
<p>protocol + domain + path + parameters</p>
<p>http:// + m.weibo.cn + /u/14968146565/</p>
<h2 id="个人首页"><a href="#个人首页" class="headerlink" title="个人首页"></a>个人首页</h2><p>1:56:33 </p>
<p>参数很多，有些参数不是必要的，可以省略。</p>
<p><a href="https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=1627825392&amp;containerid=1076031627825392&amp;since_id=4334132933228564" target="_blank" rel="noopener">https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=1627825392&amp;containerid=1076031627825392&amp;since_id=4334132933228564</a></p>
<p><a href="https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=1627825392&amp;containerid=1076031627825392&amp;since_id=4333519469486774" target="_blank" rel="noopener">https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=1627825392&amp;containerid=1076031627825392&amp;since_id=4333519469486774</a></p>
<h2 id="个人-feed-流"><a href="#个人-feed-流" class="headerlink" title="个人 feed 流"></a>个人 feed 流</h2><p>2:01:06</p>
<p>ajax 请求：<a href="https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=1627825392&amp;containerid=1076031627825392" target="_blank" rel="noopener">https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=1627825392&amp;containerid=1076031627825392</a></p>
<ul>
<li>type：通过 uid 方式查询</li>
<li>value： user id</li>
<li>containerid：107603 + user id</li>
<li>翻页：since_id</li>
</ul>
<h2 id="点击打开个人关注页"><a href="#点击打开个人关注页" class="headerlink" title="点击打开个人关注页"></a>点击打开个人关注页</h2><p>2:07:05</p>
<p>有三类关注：</p>
<ul>
<li><p>推荐 <a href="https://m.weibo.cn/api/container/getIndex?containerid=231051_-_fansrecomm_-_1627825392" target="_blank" rel="noopener">https://m.weibo.cn/api/container/getIndex?containerid=231051_-_fansrecomm_-_1627825392</a></p>
</li>
<li><p>她的关注 <a href="https://m.weibo.cn/api/container/getIndex?containerid=231051_-_followers_-_1627825392" target="_blank" rel="noopener">https://m.weibo.cn/api/container/getIndex?containerid=231051_-_followers_-_1627825392</a></p>
</li>
<li><p>她的粉丝 <a href="https://m.weibo.cn/api/container/getIndex?containerid=231051_-_fans_-_1627825392" target="_blank" rel="noopener">https://m.weibo.cn/api/container/getIndex?containerid=231051_-_fans_-_1627825392</a></p>
<p><a href="https://m.weibo.cn/p/index?containerid=231051_-_fans_-_1627825392" target="_blank" rel="noopener">https://m.weibo.cn/p/index?containerid=231051_-<em>fans</em>-_1627825392</a></p>
</li>
</ul>
<p>个人主页 <a href="https://m.weibo.cn/profile/1627825392" target="_blank" rel="noopener">https://m.weibo.cn/profile/1627825392</a></p>
<h2 id="爬取流程"><a href="#爬取流程" class="headerlink" title="爬取流程"></a>爬取流程</h2><p>2:09:24</p>
<p>headers 通过 postman interceptor 提取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crawl_users</span></span></span><br></pre></td></tr></table></figure>
<p>2:17:23 数据库</p>
<p>Mongo No_SQL Document 文档型数据库（JSON 数据）</p>
<p>MySQL SQL 关系型数据库</p>
<p>2:18:35 MongoDB 操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看数据库</span></span><br><span class="line">show dbs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 spider 数据库</span></span><br><span class="line">use spider</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看表</span></span><br><span class="line">show tables</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看数据表 weibo 的数据，只看1行</span></span><br><span class="line">db.weibo.find().limit(1)</span><br></pre></td></tr></table></figure>
<p><a href="https://jsoneditoronline.org/" target="_blank" rel="noopener">JSON Editor Online - view, edit and format JSON online</a></p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>2:22:14</p>
<ul>
<li>两种方式去分析微博的数据抓取策略</li>
<li>2个爬虫去抓，一个抓用户的信息，一个抓微博内容。</li>
</ul>
<h2 id="答疑-1"><a href="#答疑-1" class="headerlink" title="答疑"></a>答疑</h2><p>2:25:23</p>
<ul>
<li>106703 这个数是通过观察 url 的规则找到的。</li>
<li>反爬虫，后边会讲。</li>
<li>表单模拟登录下一节课讲。</li>
<li>微博搜索接口 <a href="http://s.weibo.cn" target="_blank" rel="noopener">http://s.weibo.cn</a></li>
</ul>
<blockquote>
<p>zookeeper + kafka + rabbitMQ，课程有可能会讲。</p>
</blockquote>
<h1 id="04-多线程与多进程的爬虫"><a href="#04-多线程与多进程的爬虫" class="headerlink" title="04 多线程与多进程的爬虫"></a>04 多线程与多进程的爬虫</h1><blockquote>
<p>讲课开始时间：2017-06-20 20:03</p>
<p>00:41 开始讲课</p>
</blockquote>
<h2 id="大纲-3"><a href="#大纲-3" class="headerlink" title="大纲"></a>大纲</h2><p>00:50</p>
<ul>
<li>表单及登录</li>
<li>多线程及语言分析对比</li>
<li>多进程爬虫</li>
</ul>
<p>表单及登录</p>
<h2 id="HTML-提交数据"><a href="#HTML-提交数据" class="headerlink" title="HTML 提交数据"></a>HTML 提交数据</h2><p>01:55</p>
<p>21:21</p>
<ul>
<li><p>form 表单</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>HTML 的标签，由浏览器实现 POST 方法</p>
</blockquote>
</li>
<li><p>ajax 请求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$.(ajax)&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>基于 ajax 技术，异步发送 http 请求并获得返回数据，然后利用 JavaScript 对网页进行处理。</p>
</blockquote>
</li>
</ul>
<h2 id="cookie-和-session"><a href="#cookie-和-session" class="headerlink" title="cookie 和 session"></a>cookie 和 session</h2><p>10:28</p>
<p>client：cookie</p>
<p>server：session</p>
<p>服务器响应后，发给浏览器 Set-Cookie。 </p>
<h2 id="后台处理流程"><a href="#后台处理流程" class="headerlink" title="后台处理流程"></a>后台处理流程</h2><p>15:55</p>
<p>一个请求，请求前（before dispatch）、请求后（after dispatch）。响应</p>
<ul>
<li>请求</li>
<li>处理</li>
<li>响应</li>
</ul>
<p>cookie 是会过期的，服务器可以设置有效期。</p>
<h2 id="HTML-表单"><a href="#HTML-表单" class="headerlink" title="HTML 表单"></a>HTML 表单</h2><p>27:35</p>
<p>表单使用<code>&lt;form&gt;&lt;/form&gt;</code> tag 包围</p>
<p>里面包含了表单的元素：</p>
<p><code>&lt;select&gt; &lt;textarea&gt; &lt;input&gt;</code> 等</p>
<p>`<input> type 包含了多种输入类型，例如：</p>
<ul>
<li><code>&lt;input type=&quot;text&quot; name=&quot;name&quot;&gt;</code> 文本输入框</li>
<li><code>&lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;</code> 密码输入框</li>
<li><code>&lt;input type=&quot;submit&quot; value=&quot;Sublimt&quot;&gt;</code> 提交按钮</li>
</ul>
<h2 id="表单类型：-form-data"><a href="#表单类型：-form-data" class="headerlink" title="表单类型： form-data"></a>表单类型： form-data</h2><p>29:44</p>
<p>Content-Type: <code>multipart/form-data;</code>，登录是不会使用这种方式的。</p>
<h2 id="表单类型：x-www-form-urleencoded"><a href="#表单类型：x-www-form-urleencoded" class="headerlink" title="表单类型：x-www-form-urleencoded"></a>表单类型：x-www-form-urleencoded</h2><p>32:02</p>
<p>51:20</p>
<p>Content-Type: <code>applicationn/x-www-form-urlencoded</code></p>
<p>会将表单内的数据转换为键值对。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cookielib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'host'</span>: <span class="string">''</span>,</span><br><span class="line">    <span class="string">"user-agent"</span>: <span class="string">''</span>,</span><br><span class="line">    <span class="string">"content-type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    data = &#123;<span class="string">'name'</span>: <span class="string">'caca'</span>, <span class="string">"password"</span>: <span class="string">"c"</span>&#125;</span><br><span class="line">    payload = urllib.urlencode(data)</span><br><span class="line">    </span><br><span class="line">    cj = cookielib.CookieJar()</span><br><span class="line">    opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))</span><br><span class="line">    request = urllib2.Request(url, payload, headers=headers)</span><br><span class="line">    response = opener.open(request)</span><br><span class="line">    <span class="keyword">print</span> response.info()</span><br><span class="line">    <span class="keyword">print</span> response.read()</span><br><span class="line">    <span class="keyword">for</span> cookie <span class="keyword">in</span> cj:</span><br><span class="line">        <span class="keyword">print</span> cookie.name, cookie.value, cookie.domain</span><br></pre></td></tr></table></figure>
<h2 id="ajax-登录"><a href="#ajax-登录" class="headerlink" title="ajax 登录"></a>ajax 登录</h2><p>35:26</p>
<p>一般以 json 的方式提交数据</p>
<ul>
<li>淘宝网类似</li>
</ul>
<h2 id="登录-1"><a href="#登录-1" class="headerlink" title="登录"></a>登录</h2><p>38:44</p>
<ol>
<li>根据 chrome inspector 里检查到的参数，来设置登录方式<ul>
<li>最常用的是 x-www-form-urlencoded 和 json 方式，两种方式只是 body 编码不同</li>
<li>如果是 form-data，按照 form-data 的方式组合 body</li>
<li>body 部分经常需要安装特定的方式编码，比如 base64，或者 md5</li>
<li>对于非常复杂的登录协议，利用动态网页方式登录。（利用 Selenium 登录，把 cookie 拿出来，给后面的爬虫使用）</li>
</ul>
</li>
<li><code>request = urllib2.Request(url, data, headers=loginheaders)</code><ul>
<li>url 是访问的地址</li>
<li>data 是 body 部分</li>
<li>headers=loginheaders 是 HTTP 请求的 HEADER 数据</li>
</ul>
</li>
</ol>
<h2 id="表单登录-Python-代码"><a href="#表单登录-Python-代码" class="headerlink" title="表单登录 Python 代码"></a>表单登录 Python 代码</h2><p>42:40</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">url= <span class="string">""</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"content-type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">&#125;</span><br><span class="line">data = &#123;<span class="string">'name'</span>: <span class="string">'caca'</span>, <span class="string">"password"</span>: <span class="string">"c"</span>&#125;</span><br><span class="line">payload = urllib.urlencode(data)</span><br><span class="line">request = urllib2.Request(url, payload, headers=headers)</span><br><span class="line">response = urllib2.urlopen(request)</span><br></pre></td></tr></table></figure>
<h2 id="意外？？"><a href="#意外？？" class="headerlink" title="意外？？"></a>意外？？</h2><p>43:11</p>
<p>当遇到网页登录后，返回302跳转的情况下，urllib2 的 Response 会丢失 Set-Cookie 的信息，导致登录不成功。</p>
<p>通常的情况下，我们需要一个通用的能处理 Cookie 的工具</p>
<ul>
<li>自动处理 Set-Cookie 请求</li>
<li>自动处理管理过期 Cookie</li>
<li>自动在对应的域下发送特殊 Cookie</li>
</ul>
<h2 id="urllib2-插件"><a href="#urllib2-插件" class="headerlink" title="urllib2 插件"></a>urllib2 插件</h2><p>44:48</p>
<p>urllib 实现核心功能，附加功能会提供一个插件（Hook）</p>
<h2 id="获取并设置-Cookie"><a href="#获取并设置-Cookie" class="headerlink" title="获取并设置 Cookie"></a>获取并设置 Cookie</h2><p>53:44</p>
<p>登录的核心是为了获得 Cookie。</p>
<h2 id="使用-urllib2-的插件功能"><a href="#使用-urllib2-的插件功能" class="headerlink" title="使用 urllib2 的插件功能"></a>使用 urllib2 的插件功能</h2><p>54:16</p>
<p>urllib2 可以绑定一系列的处理对象 handler。</p>
<ul>
<li>HTTPRedictHandler 用来处理跳转的情况。</li>
<li>ProxyHandler 用于处理代理。</li>
</ul>
<h2 id="CookieJar"><a href="#CookieJar" class="headerlink" title="CookieJar"></a>CookieJar</h2><p>55:54</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cj = cookielib.CookieJar()</span><br><span class="line">opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))</span><br><span class="line">request = urllib2.Request(url, payload, headers=headers)</span><br><span class="line">response = opener.open(request)</span><br><span class="line"><span class="keyword">print</span> response.info()</span><br><span class="line"><span class="keyword">print</span> response.read()</span><br><span class="line"><span class="keyword">for</span> cookie <span class="keyword">in</span> cj:</span><br><span class="line">    <span class="keyword">print</span> cookie.name, cookie.value, cookie.domain</span><br></pre></td></tr></table></figure>
<h2 id="多线程爬虫"><a href="#多线程爬虫" class="headerlink" title="多线程爬虫"></a>多线程爬虫</h2><p>1:00:10</p>
<p>多线程，单线程都是运行在同一内存空间。</p>
<p>内存空间是共享的，共享的资源要有保护。</p>
<h2 id="多线程的复杂性"><a href="#多线程的复杂性" class="headerlink" title="多线程的复杂性"></a>多线程的复杂性</h2><p>1:02:01</p>
<ul>
<li>资源、数据的安全性：锁保护</li>
<li>原子性：数据操作是天然互斥的</li>
<li>同步等待：wait() notify() notifyAll()</li>
<li>死锁：多个线程对资源互锁，造成死锁</li>
<li>容灾：任何线程出现错误，整个进程都会停止</li>
</ul>
<h2 id="画个图"><a href="#画个图" class="headerlink" title="画个图"></a>画个图</h2><p>1:04:02</p>
<p>线程：一个线程取流媒体数据，一个线程播放视频到屏幕。</p>
<h2 id="多线程的优势"><a href="#多线程的优势" class="headerlink" title="多线程的优势"></a>多线程的优势</h2><p>1:05:20</p>
<ul>
<li>内存空间共享，信息数据交换效率高</li>
<li>提高 CPU 的使用效率</li>
<li>开发便捷</li>
<li>轻，创建、销毁的开销小</li>
</ul>
<h2 id="Python-线程"><a href="#Python-线程" class="headerlink" title="Python 线程"></a>Python 线程</h2><p>1:07:08</p>
<ul>
<li>支持多线程（JavaScript PHP 不支持多线程）</li>
<li>Python 线程直接映射到 native 线程（Java 1.4 的 Java 线程是 JVM 实现的，共同运行在一个 native thread）</li>
<li>GIL（Global Interpretor Lock）：对于多核的利用能力有限。</li>
</ul>
<blockquote>
<p>爬虫的瓶颈是 I/O，I/O Bound</p>
</blockquote>
<h2 id="实现一个多线程爬虫"><a href="#实现一个多线程爬虫" class="headerlink" title="实现一个多线程爬虫"></a>实现一个多线程爬虫</h2><p>1:15:28</p>
<ol>
<li>创建一个线程池 <code>threads = []</code></li>
<li>确认 url 队列线程安全 <code>Queue Deque</code></li>
<li>从队列取出 url，分配一个线程开始爬取 <code>pop()/get() threading.Thread</code></li>
<li>如果线程池满了，循环等待，直到有线程结束 <code>t.is_alive()</code></li>
<li>从线程池移除已经完成下载的线程 <code>threads.remove(t)</code></li>
<li>如果当前级别的 url 已经遍历完成，<code>t.join()</code>函数等待所有现场结束，然后开始下一级别的爬取。</li>
</ol>
<h2 id="多线程爬虫评价"><a href="#多线程爬虫评价" class="headerlink" title="多线程爬虫评价"></a>多线程爬虫评价</h2><p>1:18:41</p>
<p>优势：</p>
<ul>
<li>有效利用 CPU 时间</li>
<li>极大减小下载出错、阻塞对抓取速度的影响，整体上提高下载的速度</li>
<li>对于没有反爬虫限制的网站，下载速度可以多倍增加</li>
</ul>
<p>局限性：</p>
<ul>
<li>对于有反爬的网站，速度提升有限</li>
<li>提高了复杂度，对编码要求更高</li>
<li>线程越多，每个线程获得的时间就越少，同时线程切换更频繁也带来额外开销</li>
<li>线程之间资源竞争更激烈</li>
</ul>
<blockquote>
<p>使用 threading，不要使用 thread。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> t.is_alive():</span><br><span class="line">        threads.remove(t)</span><br><span class="line">    <span class="keyword">if</span> len(threads) &gt;= max_threads:</span><br><span class="line">        time.sleep(CRAWL_DELAY)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        t = threading.Thread(target=get_page_content, name=<span class="keyword">None</span>, args=(url,))</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.setDaemon(<span class="keyword">True</span>)</span><br><span class="line">        t.start()</span><br><span class="line">        time.sleep(CRAWL_DELAY)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Error: unable to start thread"</span></span><br></pre></td></tr></table></figure>
<h2 id="多进程爬虫"><a href="#多进程爬虫" class="headerlink" title="多进程爬虫"></a>多进程爬虫</h2><p>1:25:17</p>
<p>线程与进程</p>
<p>进程开销比较大，数据是独立的，进程之间切换比线程切换慢。</p>
<p>进程之间数据共享，</p>
<h2 id="多进程爬虫评估"><a href="#多进程爬虫评估" class="headerlink" title="多进程爬虫评估"></a>多进程爬虫评估</h2><p>1:29:50</p>
<p>目的：</p>
<ul>
<li>控制线程数量</li>
<li>对线程进行隔离，减少资源竞争</li>
<li>某些环境下，在单机上利用多个 IP 来伪装</li>
</ul>
<p>局限性：</p>
<ul>
<li>不能突破网络瓶颈</li>
<li>单机单 IP 的情况下，变得没有意义</li>
<li>数据交换的代价更大</li>
</ul>
<h2 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h2><p>1:30:00</p>
<ul>
<li>管道（PIPE）</li>
<li>信号（Signal）：复杂</li>
<li>消息队列：Posix 及 system V</li>
<li>共享内存：速度最快，需要结合信号量达到进程间同步及互斥</li>
<li>信号量：用于数据同步</li>
<li>Socket：可以标准化，可以用于多机</li>
</ul>
<h2 id="Android-进程间通信-Binder"><a href="#Android-进程间通信-Binder" class="headerlink" title="Android 进程间通信 Binder"></a>Android 进程间通信 Binder</h2><p>1:30:47</p>
<h2 id="Android-进程间通信-AIDL"><a href="#Android-进程间通信-AIDL" class="headerlink" title="Android 进程间通信 AIDL"></a>Android 进程间通信 AIDL</h2><p>1:32:01</p>
<h2 id="创建多进程爬虫"><a href="#创建多进程爬虫" class="headerlink" title="创建多进程爬虫"></a>创建多进程爬虫</h2><p>1:36:07</p>
<h3 id="Solution-A-C-S-模式"><a href="#Solution-A-C-S-模式" class="headerlink" title="Solution A - C/S 模式"></a>Solution A - C/S 模式</h3><ol>
<li>一个服务进程，入队及出队 URL，入队需检查是否已经下载</li>
<li>监控目前的爬取状态、进度</li>
<li>多个爬取进程，从服务进程获取 URL，并将新的 URL 返回给服务进程</li>
<li>使用 Socket 来做 IPC</li>
</ol>
<blockquote>
<p>注册与发现，新客户端被创建，服务端可以发现。远程管理、队列管理、错误维护、</p>
</blockquote>
<h3 id="Solution-B-数据库模式"><a href="#Solution-B-数据库模式" class="headerlink" title="Solution B - 数据库模式"></a>Solution B - 数据库模式</h3><ol>
<li>使用数据库来读取爬取列表</li>
<li>多个爬取进程，URL 的获取与增加都通过数据库此操作</li>
</ol>
<h2 id="C-S-v-s-数据库"><a href="#C-S-v-s-数据库" class="headerlink" title="C/S v.s. 数据库"></a>C/S v.s. 数据库</h2><p>1:38:44</p>
<p>CS 优势：</p>
<ul>
<li>运行速度快，添加、修改、查询都是内存的 BIT 位操作</li>
<li>扩展方便，例如动态 URL 队列重排</li>
</ul>
<p>数据库：</p>
<ul>
<li>开发便捷，数据库天生具备读写保护及支持 IPC</li>
<li>只需要写一个爬虫程序</li>
</ul>
<blockquote>
<p>堆内的存储（CPU 内，代码空间内）、堆外的存储，外存，网络存储。访问速度呈指数级别的下降。</p>
</blockquote>
<h2 id="创建-MySQL-数据库表"><a href="#创建-MySQL-数据库表" class="headerlink" title="创建 MySQL 数据库表"></a>创建 MySQL 数据库表</h2><p>1:42:03</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>index</td>
<td>int(11)</td>
<td>PRIMARY KEY AUTOINCREMENT</td>
</tr>
<tr>
<td>url</td>
<td>varchar(512)</td>
<td>UNIQUE</td>
</tr>
<tr>
<td>status</td>
<td>varchar(11)</td>
<td>download status: new,downloading,done</td>
</tr>
<tr>
<td>md5</td>
<td>varchar(16)</td>
<td>UNIQUE md5 value of url</td>
</tr>
<tr>
<td>depth</td>
<td>int(11)</td>
<td>page depth</td>
</tr>
<tr>
<td>queue_time</td>
<td>timestamp</td>
<td>CURRENT_TIMESTAMP time url enqueue</td>
</tr>
<tr>
<td>done_time</td>
<td>timestamp</td>
<td>time page downloaded</td>
</tr>
</tbody>
</table>
<h2 id="数据库创建"><a href="#数据库创建" class="headerlink" title="数据库创建"></a>数据库创建</h2><p>1:42:33</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE urls (</span><br><span class="line">	index int(11) NOT NULL AUTOINCREMENT,</span><br><span class="line">    url varchar(512) NOT NULL,</span><br><span class="line">    status varchar(11) NOT NULL DEFAULT new,</span><br><span class="line">    md5 varchar(16) NOT NULL,</span><br><span class="line">    depth int(11)NOT NULL,</span><br><span class="line">    queue_time timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">    done_time timestamp NOT NULL DEFAULT 0 ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">    PRIMARY KEY index,</span><br><span class="line">    UNIQUE KEY md5</span><br><span class="line">)ENGINE=InnoDB</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ON UPDATE CURRENT_TIMESTAMP 不是所有版本的 MySQL 数据库都支持。老版本不支持。</p>
</blockquote>
<h2 id="Python-MySQL-Connector"><a href="#Python-MySQL-Connector" class="headerlink" title="Python MySQL Connector"></a>Python MySQL Connector</h2><p>1:43:40</p>
<ul>
<li><p>使用 MySQLConnectionPool 来管理多线程下的 MySQL 数据库链接</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql.connector.poolinng.MySQLConnectionPool</span><br><span class="line">self.cnxpool.get_connection()</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>__init__</code> 类实例的时候自动检查和创建数据库及表</p>
</li>
<li><p>Cursor 类：<code>cursor = con.cursor(dictionary=True)</code></p>
</li>
<li><p><code>SELECT ... FOR UPDATE</code> 加读锁，避免多个进程取出同一个 url</p>
</li>
<li><p><code>cursor.commit()</code>支持<strong>事务</strong>，默认关闭了 autocommit 因此需要提交</p>
</li>
</ul>
<blockquote>
<p>ConnectionPool 去链接数据库。数据库优化问题</p>
</blockquote>
<p><a href="https://dev.mysql.com/doc/connector-python/en/" target="_blank" rel="noopener">MySQL :: MySQL Connector/Python Developer Guide</a></p>
<h2 id="1-48-49-课程结束"><a href="#1-48-49-课程结束" class="headerlink" title="1:48:49 课程结束"></a>1:48:49 课程结束</h2><h2 id="1-48-51-下节课预热"><a href="#1-48-51-下节课预热" class="headerlink" title="1:48:51 下节课预热"></a>1:48:51 下节课预热</h2><ul>
<li>CS 模式爬虫</li>
<li>Zookeeper 分布式系统管理发现。</li>
</ul>
<h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><p>1:49:47</p>
<h2 id="解答"><a href="#解答" class="headerlink" title="解答"></a>解答</h2><p>1:51:56</p>
<ul>
<li>Nginx</li>
<li>HBase</li>
<li>GIL 锁</li>
<li>MySQL 访问的库 1:56:00 <code>mysqlmanager.py</code></li>
</ul>
<p>Python Mysql Connector</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pymysql</span><br></pre></td></tr></table></figure>
<p>Python Mysql Connector<br>py2.7</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mysqlclient</span><br></pre></td></tr></table></figure>
<h1 id="05-微博数据的存储：分布式数据库及应用"><a href="#05-微博数据的存储：分布式数据库及应用" class="headerlink" title="05 微博数据的存储：分布式数据库及应用"></a>05 微博数据的存储：分布式数据库及应用</h1><blockquote>
<p>讲课开始时间：2017-06-22 19:53</p>
<p>开始讲课 08:05</p>
</blockquote>
<p>主要讲爬虫用的<strong>数据库存储</strong>方式。</p>
<h2 id="大纲-4"><a href="#大纲-4" class="headerlink" title="大纲"></a>大纲</h2><ul>
<li>一个简单的分布式爬虫</li>
<li>分布式存储</li>
<li>分布式数据库及缓存</li>
<li>完整的分布式爬虫</li>
</ul>
<h2 id="分布式爬虫系统"><a href="#分布式爬虫系统" class="headerlink" title="分布式爬虫系统"></a>分布式爬虫系统</h2><p>08:36</p>
<p>降低 I/O ，防火墙限制流量就被反爬虫了。</p>
<p>爬虫的两个最典型应用方向，搜索引擎，NPL（自然语言处理）</p>
<h2 id="分布式爬虫的作用"><a href="#分布式爬虫的作用" class="headerlink" title="分布式爬虫的作用"></a>分布式爬虫的作用</h2><p>16:59</p>
<ul>
<li>解决目标地址对 IP 访问频率的限制</li>
<li>利用更高的带宽，提高下载速度 （解决 I/O bond）</li>
<li>大规模系统的分布式存储和备份 （数据安全问题）</li>
<li>数据的扩展能力 </li>
</ul>
<h2 id="将多进程爬虫部署到多台主机上"><a href="#将多进程爬虫部署到多台主机上" class="headerlink" title="将多进程爬虫部署到多台主机上"></a>将多进程爬虫部署到多台主机上</h2><p>19:48</p>
<ul>
<li><p>将数据库地址配置到统一的服务器上</p>
</li>
<li><p>数据库设置仅允许特定 IP 来源的访问请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;%&apos; IDENTIFIED BY &apos;password&apos; WITH GRANT OPTION; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<p>vim .cnf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># bind-address = 127.0.0.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置防火墙，允许端口远程连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i eht0 -p tcp -m tcp --dport 3306 -j ACCEPT</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>Mastere Slave 方式的爬虫</p>
<p>DB 方式的爬虫</p>
</blockquote>
<h2 id="分布式存储"><a href="#分布式存储" class="headerlink" title="分布式存储"></a>分布式存储</h2><p>31:32</p>
<blockquote>
<p>使用 HDFS 存储抓回来的网页源码</p>
</blockquote>
<p>MySQL：可以存任务调度</p>
<h2 id="爬虫原始数据存储特点"><a href="#爬虫原始数据存储特点" class="headerlink" title="爬虫原始数据存储特点"></a>爬虫原始数据存储特点</h2><p>32:47</p>
<ul>
<li>文件小，大量 KB 级别的文件</li>
<li>文件数量大</li>
<li>增量方式一次性写入，极少需要修改</li>
<li>顺序读写</li>
<li>并发的文件读写</li>
<li>可扩展</li>
</ul>
<h2 id="Google-FS"><a href="#Google-FS" class="headerlink" title="Google FS"></a>Google FS</h2><p>36:30</p>
<p>HDFS 是 Google FS 的一个开源实现。</p>
<p>大量小文件组成一个数据块然后写入到一个磁盘上。</p>
<blockquote>
<p>随机读取数据很差</p>
</blockquote>
<p><strong>HDFS 架构</strong></p>
<ul>
<li>数据节点（Data Node）（存数据的系统）</li>
<li>名字节点（Name Node）</li>
</ul>
<h2 id="Python-hdfs-module"><a href="#Python-hdfs-module" class="headerlink" title="Python hdfs module"></a>Python hdfs module</h2><p>42:42</p>
<p>Python hdfs module</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install hdfs</span><br></pre></td></tr></table></figure>
<h2 id="HBASE"><a href="#HBASE" class="headerlink" title="HBASE"></a>HBASE</h2><p>44:13</p>
<ul>
<li>On top of HDFS</li>
<li>Column-oriented database</li>
<li>Can store huge size raw data</li>
<li>KEY-VALUE</li>
</ul>
<blockquote>
<p>HBASE 存储 网页文件</p>
<p>AWS - S3</p>
<p>阿里云 - OSS</p>
</blockquote>
<p>列数据库</p>
<p>行数据库-MySQl</p>
<h2 id="HBASE-和-HDFS-比较"><a href="#HBASE-和-HDFS-比较" class="headerlink" title="HBASE 和 HDFS 比较"></a>HBASE 和 HDFS 比较</h2><p>50:13</p>
<p>HDFS 分布式存储系统，HBASE 数据库。</p>
<h2 id="HBASE-样子"><a href="#HBASE-样子" class="headerlink" title="HBASE 样子"></a>HBASE 样子</h2><p>52:03</p>
<ul>
<li>tables</li>
<li>column families</li>
<li>column：Key-Value 键值对</li>
</ul>
<blockquote>
<p>不是讲 HADOOP，而是讲爬虫是怎么用 HBASE 的。</p>
</blockquote>
<h2 id="HBASE-存储架构"><a href="#HBASE-存储架构" class="headerlink" title="HBASE 存储架构"></a>HBASE 存储架构</h2><p>55:00</p>
<p>HRegion-&gt;MemStore（Column Falimilies）</p>
<blockquote>
<p><strong>我们怎么去怎么去定义 Column Falimilies（CF）？</strong></p>
<p>key，CF 网页源码（数据量大），CF 网页地理信息（数据量小）</p>
<p>一个 store 只放一个 CF，</p>
</blockquote>
<h2 id="HBASE-框架图"><a href="#HBASE-框架图" class="headerlink" title="HBASE 框架图"></a>HBASE 框架图</h2><p>59:39</p>
<h2 id="结合代码去学-HBASE-怎么使用"><a href="#结合代码去学-HBASE-怎么使用" class="headerlink" title="结合代码去学 HBASE 怎么使用"></a>结合代码去学 HBASE 怎么使用</h2><p>1:00:18</p>
<p>hbasemgr.py</p>
<p>一般使用 batchdata 方式，网络连接传输是有代价的。</p>
<p>一次写入一批数据。</p>
<p>HBASE 自己搭建。</p>
<h2 id="存储方案"><a href="#存储方案" class="headerlink" title="存储方案"></a>存储方案</h2><p>1:05:58</p>
<p>MySQL/MongoDB：存任务 + 结构提取后的数据（信息）</p>
<p>HBASE：存网页源待码</p>
<p>Redis：做告诉缓存</p>
<h2 id="1-07-35-休息下，答疑"><a href="#1-07-35-休息下，答疑" class="headerlink" title="1:07:35 休息下，答疑"></a>1:07:35 休息下，答疑</h2><p>安装 HBASE Python 库 <a href="https://happybase.readthedocs.io/en/latest/" target="_blank" rel="noopener">HappyBase — HappyBase 1.1.0 documentation</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install happybase</span><br></pre></td></tr></table></figure>
<p>Hadoop 教程：<a href="http://www.tutorialspoint.com/hadoop" target="_blank" rel="noopener">Hadoop Tutorial</a></p>
<ul>
<li><p>MySQL 的 QPS，建立连接到连接被释放掉。</p>
</li>
<li><p>Redis 要做持久化</p>
</li>
</ul>
<h2 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h2><p>1:16:09</p>
<p>关系型数据库和 MongoDB 的数据类型对比</p>
<table>
<thead>
<tr>
<th>RDBMS</th>
<th>MongoDB</th>
</tr>
</thead>
<tbody>
<tr>
<td>Database</td>
<td>Database</td>
</tr>
<tr>
<td>Table</td>
<td>Collection</td>
</tr>
<tr>
<td>Tuple/Row</td>
<td>Doucment</td>
</tr>
<tr>
<td>column</td>
<td>Field</td>
</tr>
<tr>
<td>Table Join</td>
<td>Embedded Documents（就在文档内）</td>
</tr>
<tr>
<td>Primary Key</td>
<td>Primary Key (Default key _id provided by mongodb itself)</td>
</tr>
</tbody>
</table>
<h2 id="非关系型数据库的优势"><a href="#非关系型数据库的优势" class="headerlink" title="非关系型数据库的优势"></a>非关系型数据库的优势</h2><p>1:21:12</p>
<ul>
<li>Schema less：没有规则，列数不一定</li>
<li>Ease of scale-out：很容易扩展</li>
</ul>
<blockquote>
<p>MySQL 典型的 B+ 树结构。分表分库。</p>
</blockquote>
<p>1:27:45 簇分片 Sharels（读写分离 模式）（replica 模式）</p>
<h2 id="MongoDB-安装"><a href="#MongoDB-安装" class="headerlink" title="MongoDB 安装"></a>MongoDB 安装</h2><p>1:29:16</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show dbs</span><br><span class="line"></span><br><span class="line">use 数据库名</span><br><span class="line"></span><br><span class="line">show tables</span><br><span class="line"></span><br><span class="line">db.数据库名.find().limit(1)</span><br></pre></td></tr></table></figure>
<h2 id="pymongo"><a href="#pymongo" class="headerlink" title="pymongo"></a>pymongo</h2><p>1:30:50</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pymongo</span><br></pre></td></tr></table></figure>
<p>Python 操作 Mongo</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.findOneAndUpdate(filter, update, options)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>MongoDB 存储 任务队列，</p>
</blockquote>
<ul>
<li>事务操作，把 n 个操作构成一个原子操作。（收入、库存、购票信息一起操作完成，要么一个失败，所有的都失败。）</li>
<li>锁的概念，读锁和写锁。阻塞。</li>
<li>MySQL InnoDB 支持行级锁，MyISAM 只能做表级锁。</li>
</ul>
<blockquote>
<p>使用 Mongo 存储微博的数据。</p>
</blockquote>
<h2 id="数据库类型"><a href="#数据库类型" class="headerlink" title="数据库类型"></a>数据库类型</h2><p>1:38:10</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Databases</th>
</tr>
</thead>
<tbody>
<tr>
<td>RDBMS</td>
<td>Oracle,MySQL</td>
</tr>
<tr>
<td>Key-Value</td>
<td>BerkeleyDB</td>
</tr>
<tr>
<td>In Memory Key-Value</td>
<td>MemoryCached,Redis</td>
</tr>
<tr>
<td>Document</td>
<td>MongoDB</td>
</tr>
<tr>
<td>Column</td>
<td>HBase</td>
</tr>
<tr>
<td>Graphic</td>
<td>Neo4j, Titan（支持分片）</td>
</tr>
</tbody>
</table>
<p>1:40:55 一种存任务队列，相比于 MySQL 没有上限限制。</p>
<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><p>1:42:13</p>
<ul>
<li>基于 KEY VALUE 模式的内存数据库</li>
<li>支持负载的对象模型（MemoryCached 仅支持少量类型）</li>
<li>支持 Replication，实现集群（MemoryCached 不支持分布式部署）</li>
<li>所有操作都是原子性（MemoryCached 多数操作都不是原子的）</li>
<li>可以序列化到磁盘（MemoryCached 不能序列化）</li>
</ul>
<h2 id="Redis-安装"><a href="#Redis-安装" class="headerlink" title="Redis 安装"></a>Redis 安装</h2><p>1:47:07</p>
<p>1:48:20 Python Redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install redis</span><br></pre></td></tr></table></figure>
<p><strong>操作</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">r = redis.StrictRedis(host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">r.set(<span class="string">'foo'</span>, <span class="string">'bar'</span>)</span><br><span class="line"></span><br><span class="line">r.get(<span class="string">'foo'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="MongoDB-的优化"><a href="#MongoDB-的优化" class="headerlink" title="MongoDB 的优化"></a>MongoDB 的优化</h2><p>1:48:55</p>
<ul>
<li>url 做为 _id，默认会被创建索引，创建索引是需要额外的开销的</li>
<li>index 尽量简单， url 长了一些</li>
<li>dequeueUrl find_one() 并没有利用 index,会全库扫描，但是仍然会很快，因为扫描到第一个后就停止了，但是当下载完成的数量特别大的时候，扫描依然是很费时的，考虑一下能不能进一步优化</li>
<li>插入的操作很频繁，每一个网页对应着几百次插入，到了 depth = 3 的时候，基数网页是百万级，插入检查将是亿级，考虑使用更高效的方式来检查。</li>
</ul>
<h2 id="Mongo-with-Redis-，Redis-做缓存级别的查询"><a href="#Mongo-with-Redis-，Redis-做缓存级别的查询" class="headerlink" title="Mongo with Redis ，Redis 做缓存级别的查询"></a>Mongo with Redis ，Redis 做缓存级别的查询</h2><p>1:51:56</p>
<p>CPU cache&gt;Heap&gt;Redis&gt;Disk&gt;LAN&gt;WAN</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>1:58:32</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.db.mfw.count() <span class="keyword">is</span> <span class="number">0</span>:</span><br><span class="line">    self.db.mfw.create_index(<span class="string">'status'</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">deef enqueuUrl(self, url, status, depth):</span><br><span class="line">    <span class="keyword">if</span> self.redis_client.get(url) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">   	self.redis_client.set(url, <span class="keyword">True</span>)</span><br><span class="line">    record = &#123;</span><br><span class="line">        <span class="string">'url'</span>: url,</span><br><span class="line">        <span class="string">'status'</span>: status,</span><br><span class="line">        <span class="string">'queue_time'</span>: datetime.utcnow(),</span><br><span class="line">        <span class="string">'depth'</span>: depth</span><br><span class="line">    &#125;</span><br><span class="line">    self.db.mfw.insert(&#123;</span><br><span class="line">        <span class="string">'_id'</span>: hashlib.md5(url).hexdigest()&#125;,</span><br><span class="line">        &#123;<span class="string">'$set'</span>: record</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>redis 有 list 类型，list 如何实现的，一种是 array-list（随机查找很快）(增删很慢），一种是 linked-list（插入，删除，很快）。 qlist（链表 + 数组）</p>
</blockquote>
<p>2:03:33 课程结束</p>
<h2 id="答疑-2"><a href="#答疑-2" class="headerlink" title="答疑"></a>答疑</h2><p>2:04:01</p>
<ul>
<li>redis 崩溃数据的安全，第一种方式，redis 定时增量持久化。第二种方式，通过日志系统。</li>
<li>协程的概念老师也不太懂</li>
<li>scrapy 定时爬，apscheduler</li>
</ul>
<h1 id="06-多机并行的微博抓取：分布式系统设计"><a href="#06-多机并行的微博抓取：分布式系统设计" class="headerlink" title="06 多机并行的微博抓取：分布式系统设计"></a>06 多机并行的微博抓取：分布式系统设计</h1><blockquote>
<p>讲课开始时间：2017-06-27 19:54</p>
<p>开始讲课 08:03</p>
</blockquote>
<h2 id="大纲-5"><a href="#大纲-5" class="headerlink" title="大纲"></a>大纲</h2><p>08:13</p>
<ul>
<li>分布式系统概述</li>
<li>主从服务设计</li>
</ul>
<h2 id="分布式系统"><a href="#分布式系统" class="headerlink" title="分布式系统"></a>分布式系统</h2><p>10:31</p>
<p>开发分布式系统流程</p>
<h2 id="分布式系统的优势"><a href="#分布式系统的优势" class="headerlink" title="分布式系统的优势"></a>分布式系统的优势</h2><p>15:34</p>
<h2 id="分布式系统遇到的挑战"><a href="#分布式系统遇到的挑战" class="headerlink" title="分布式系统遇到的挑战"></a>分布式系统遇到的挑战</h2><p>19:52</p>
<p>关于很多数据之间的迁移。</p>
<h2 id="分布式爬虫系统-1"><a href="#分布式爬虫系统-1" class="headerlink" title="分布式爬虫系统"></a>分布式爬虫系统</h2><p>28:51</p>
<ul>
<li>master 干什么事情</li>
<li>制定协议 master 和 slave 通信（队列检查，通过 redis 检查队列，）</li>
</ul>
<h2 id="Master-Slave-结构"><a href="#Master-Slave-结构" class="headerlink" title="Master-Slave 结构"></a>Master-Slave 结构</h2><p>37:14</p>
<ul>
<li>有一个主机，对所有的服务器进行管理，绝大多数分布式系统，都是 Master-Slave的主从模式。</li>
<li>当爬虫服务器多的时候，必须能通过一个中心节点对从节点进行管理</li>
<li>能对整体的爬取进行控制</li>
<li>爬虫之间信息共享的桥梁</li>
<li>负载控制</li>
</ul>
<h2 id="Remote-Procedure-Calls"><a href="#Remote-Procedure-Calls" class="headerlink" title="Remote Procedure Calls"></a>Remote Procedure Calls</h2><p>39:12</p>
<h2 id="Protocol-Message-Type"><a href="#Protocol-Message-Type" class="headerlink" title="Protocol - Message Type"></a>Protocol - Message Type</h2><p>43:44</p>
<p>MSG_TYPE = ‘TYPE’</p>
<p>REGISTER = ‘REGISTER’</p>
<p>UNREGISTER = ‘UNREGISTER’</p>
<p>HEARTBEAT = ‘HEARTBEAT’</p>
<p>PAUSED = ‘PAUSED’</p>
<p>RESUMED = ‘RESUMED’</p>
<p>SHUTDOWN = ‘SHUTDOWN’</p>
<h2 id="Protocol-Actions"><a href="#Protocol-Actions" class="headerlink" title="Protocol - Actions"></a>Protocol - Actions</h2><p>48:29</p>
<p>ACTION_REQUIRED = ‘ACTION_REQUIRED’</p>
<p>PAUSE_REQUIRED = ‘PAUSE_REQUIRED’</p>
<p>RESUME_REQUIRED = ‘RESUME_REQUIRED’</p>
<p>SHUTDOWN_REQUIRED = ‘SHUTDOWN_REQUIRED’</p>
<h2 id="Protocol-Key-Definition"><a href="#Protocol-Key-Definition" class="headerlink" title="Protocol - Key Definition"></a>Protocol - Key Definition</h2><p>51:07</p>
<p>SERVER_STATUS = ‘SERVER_STATUS’</p>
<p> // SPIDER 的 ID</p>
<p>CLIENT_ID = ‘CLIENT_ID’</p>
<p>ERROR = ‘ERROR’</p>
<p>51:55 client_crawler.py</p>
<h2 id="爬虫线程"><a href="#爬虫线程" class="headerlink" title="爬虫线程"></a>爬虫线程</h2><p>58:51 </p>
<p>主线程：检查状态，创建爬出</p>
<p>爬虫线程：爬取完成退出</p>
<p>心跳线程：维护状态</p>
<h2 id="Socket-编程"><a href="#Socket-编程" class="headerlink" title="Socket 编程"></a>Socket 编程</h2><p>1:03:53</p>
<p>TCP client</p>
<p>TCP Server</p>
<h2 id="创建-socket-client"><a href="#创建-socket-client" class="headerlink" title="创建 socket client"></a>创建 socket client</h2><p>1:06:25</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s = socket.create_connection(socket.AF_INET, socket.SOCK_STREAM)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>AF_INET：IPv4 协议</p>
<p>SOCK_STREAM：TCP （保证连接）还是 UDP （速度快）</p>
</blockquote>
<h2 id="创建-socket-server"><a href="#创建-socket-server" class="headerlink" title="创建 socket server"></a>创建 socket server</h2><p>1:07:44</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">server_socket.bind(socket.gethostname(), <span class="number">20010</span>)</span><br><span class="line"></span><br><span class="line">server_socket.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    (client_socket, address) = server_socket.accept()</span><br><span class="line">    server ct = client_thread(client_socket)</span><br><span class="line">    ct.run()</span><br></pre></td></tr></table></figure>
<h2 id="Ways-to-listen"><a href="#Ways-to-listen" class="headerlink" title="Ways to listen"></a>Ways to listen</h2><p>1:10:16</p>
<ul>
<li>新建一个线程</li>
<li>新建一个进程 （Apache）</li>
<li>使用无阻塞 socket</li>
</ul>
<h2 id="Non-blocking-mode-listening"><a href="#Non-blocking-mode-listening" class="headerlink" title="Non-blocking mode listening"></a>Non-blocking mode listening</h2><p>1:13:00</p>
<ul>
<li>connection.setblocking(False)</li>
<li>asyncore</li>
</ul>
<h2 id="停止-ways-to-end-communication"><a href="#停止-ways-to-end-communication" class="headerlink" title="停止 ways to end communication"></a>停止 ways to end communication</h2><p>1:14:42</p>
<ul>
<li><p>fixed length message</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">data = []</span><br><span class="line"></span><br><span class="line">total_len = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> total_len &lt; MSG_LEN:</span><br><span class="line">    char = conn.recv(<span class="number">1</span>)</span><br><span class="line">    data.append(char)</span><br><span class="line">    total_len += <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>加上结束符 delimited</p>
</li>
<li><p>indicates messagee length in beginning 设置字符长度</p>
</li>
<li><p>shutdown connection：<code>server call close(), client recv() returns 0</code></p>
</li>
</ul>
<p>socket_server.py</p>
<h2 id="server-socket-client-socket-spider"><a href="#server-socket-client-socket-spider" class="headerlink" title="server socket, client socket, spider"></a>server socket, client socket, spider</h2><p>1:24:53</p>
<p>1:27:53 没有再看了，因为感觉看不懂，目前也用不到这些高深的东西。遂直接看 14 信息检索、搜索引擎原理及应用，因为之前看过别的使用 Elasticsearch 做爬虫抓取后的搜索。</p>
<h1 id="07"><a href="#07" class="headerlink" title="07"></a>07</h1><h1 id="08"><a href="#08" class="headerlink" title="08"></a>08</h1><p>Scrapy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install scrapy</span><br></pre></td></tr></table></figure>
<h1 id="09"><a href="#09" class="headerlink" title="09"></a>09</h1><p>Python 的 PageRank - NetworkX</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install networkx</span><br></pre></td></tr></table></figure>
<p>查重算法<br>SimHash – 海明距离</p>
<p>依赖 sh库</p>
<p><a href="https://www.the5fire.com/analyze-python-lib-sh.html" target="_blank" rel="noopener">[Python库]分析一个python库–sh（系统调用）</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install simhash</span><br></pre></td></tr></table></figure>
<h1 id="10"><a href="#10" class="headerlink" title="10"></a>10</h1><p>Daemontool</p>
<p>Pillow</p>
<p>Pillow 是一个图像工具包，包含了一个 Image 类用来做图像的处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pillow</span><br></pre></td></tr></table></figure>
<p>Tesseract-Ocr</p>
<p>Tesseract-Ocr 是一个 Google 主导的开源 OCR (Optical Character Recongnition) 引擎。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pytesseract</span><br></pre></td></tr></table></figure>
<h1 id="12"><a href="#12" class="headerlink" title="12"></a>12</h1><p>Goose<br>PyGoose</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install goose3</span><br></pre></td></tr></table></figure>
<p>py2.7</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pygoose</span><br></pre></td></tr></table></figure>
<h1 id="13"><a href="#13" class="headerlink" title="13"></a>13</h1><p>结巴分词</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install jieba</span><br></pre></td></tr></table></figure>
<p>Python TF-IDF</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install sklearn scipy numpy</span><br></pre></td></tr></table></figure>
<h1 id="14-信息检索、搜索引擎原理及应用"><a href="#14-信息检索、搜索引擎原理及应用" class="headerlink" title="14 信息检索、搜索引擎原理及应用"></a>14 信息检索、搜索引擎原理及应用</h1><blockquote>
<p>讲课开始时间：2017-07-25 19:55</p>
<p>06:11 开始讲课</p>
</blockquote>
<p>06:11 之前的在讲爬虫</p>
<p>33:49 开始讲今天的内容，Elastic Search</p>
<h2 id="大纲-6"><a href="#大纲-6" class="headerlink" title="大纲"></a>大纲</h2><ul>
<li>倒排索引</li>
<li>文本匹配及排序</li>
<li>Elasticsearch</li>
</ul>
<h2 id="核心-倒排表"><a href="#核心-倒排表" class="headerlink" title="核心-倒排表"></a>核心-倒排表</h2><p>38:05</p>
<h2 id="处理过程"><a href="#处理过程" class="headerlink" title="处理过程"></a>处理过程</h2><p>39:13</p>
<p>爬虫-&gt;正文抽取-&gt;分词-&gt;Doc ID-&gt;正拍表-&gt;倒排表（词汇 ID，Term ID）</p>
<h2 id="正排索引"><a href="#正排索引" class="headerlink" title="正排索引"></a>正排索引</h2><p>42:40</p>
<ul>
<li>LocalId：文档的局部编号</li>
<li>WordId：文档分词后的编号</li>
<li>nHits：某个索引词出现的次数</li>
<li>HitList 变长字段：某个索引词在文档出现的位置</li>
</ul>
<h2 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h2><p>44:06</p>
<ul>
<li>词典：不同索引词组成的索引表</li>
<li>记录表：每个索引词出现过的文档集合以及命中位置</li>
</ul>
<p>查询系统</p>
<h2 id="Boolean-模型"><a href="#Boolean-模型" class="headerlink" title="Boolean 模型"></a>Boolean 模型</h2><p>45:23</p>
<p>单纯地查询每个检查词，最后把检索词的结果取交集。</p>
<h3 id="词与词的关联"><a href="#词与词的关联" class="headerlink" title="词与词的关联"></a>词与词的关联</h3><p>48:57</p>
<p>在提取特征词的时候，我们可以用 TfIdf 来找出特征词，同时 TfIdf 也可以用来表述一个词 w(i) 对于一篇文字 d(j) 的重要性 w(i,j) Boolean 的检索方式，词与词之间被看成是独立的，而实际上，搜索词之间的组合，是具备一定关联。</p>
<h3 id="标准化网页长度"><a href="#标准化网页长度" class="headerlink" title="标准化网页长度"></a>标准化网页长度</h3><p>52:37</p>
<p>一般来说，一篇网页的文本越长，它被随机搜索词命中的机率也就越大。因此我们需要考虑把网页的长度进行标准化，一般来说，网页文本长度有以下的方式来表达：</p>
<ul>
<li>Size in Bytes：网页文本流的长度</li>
<li>Size in Words：网页字词数量</li>
<li>向量的模：</li>
</ul>
<h2 id="向量模型"><a href="#向量模型" class="headerlink" title="向量模型"></a>向量模型</h2><p>56:00</p>
<h2 id="概率模型"><a href="#概率模型" class="headerlink" title="概率模型"></a>概率模型</h2><p>58:37</p>
<p>贝叶斯模型</p>
<h2 id="几种模型的简单比较"><a href="#几种模型的简单比较" class="headerlink" title="几种模型的简单比较"></a>几种模型的简单比较</h2><p>1:12:44</p>
<h2 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h2><p>1:42:16</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Jira安装配置" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/30/Jira安装配置/" class="article-date">
      <time datetime="2017-11-30T00:45:00.000Z" itemprop="datePublished">2017-11-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/30/Jira安装配置/">Jira安装配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Jira安装配置"><a href="#Jira安装配置" class="headerlink" title="Jira安装配置"></a>Jira安装配置</h1><blockquote>
<p>MySQL 5.7.25</p>
<p>JIRA Core server 7.12.1</p>
</blockquote>
<p>安装MySQL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">下载mysql源</span></span><br><span class="line">wget http://dev.mysql.com/get/mysql57-community-release-el6-11.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装源</span></span><br><span class="line">rpm -ivh mysql57-community-release-el6-11.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查mysql的YUM源是否安装成功：</span></span><br><span class="line">yum repolist enabled | grep "mysql.*-community.*" </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装mysql</span></span><br><span class="line">yum install mysql-community-server</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置开机启动</span></span><br><span class="line">chkconfig --list | grep mysqld</span><br><span class="line">chkconfig mysqld on</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">service mysqld start</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看默认密码：</span></span><br><span class="line">grep 'temporary password' /var/log/mysqld.log</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改 root 密码</span></span><br><span class="line">set password for 'root'@'localhost' = password('new-password');</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建jira用户</span></span><br><span class="line">CREATE USER 'jira'@'localhost' IDENTIFIED BY 'password'; </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建数据库 jira</span></span><br><span class="line">create database jira default character set utf8 collate utf8_bin;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 授权</span></span><br><span class="line">grant all on jira.* to 'jira'@'localhost' identified by 'password';</span><br><span class="line"></span><br><span class="line">使授权立刻生效 </span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>
<h4 id="下载Jira"><a href="#下载Jira" class="headerlink" title="下载Jira"></a>下载<a href="https://www.atlassian.com/software/jira/download" target="_blank" rel="noopener">Jira</a></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://downloads.atlassian.com/software/jira/downloads/atlassian-jira-software-7.12.1-x64.bin</span><br></pre></td></tr></table></figure>
<h3 id="安装jira"><a href="#安装jira" class="headerlink" title="安装jira"></a>安装jira</h3><p>现在开始安装jira</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 更改权限</span></span><br><span class="line">chmod 755 atlassian-jira-software-*-x64.bin</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">./atlassian-jira-software-*-x64.bin</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">/opt/atlassian/jira/bin/start-jira.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭</span></span><br><span class="line">/opt/atlassian/jira/bin/stop-jira.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 防火墙开启8080端口</span></span><br><span class="line">/sbin/iptables -I INPUT -p tcp --dport 8080 -j ACCEPT</span><br><span class="line">/etc/rc.d/init.d/iptables save</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看</span></span><br><span class="line">/etc/init.d/iptables status</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启</span></span><br><span class="line">/etc/init.d/iptables restart</span><br></pre></td></tr></table></figure>
<p>通过上图，我们可以很明显的看出jira安装到了/opt/atlassian/jira和/var/atlassian/application-data/jira目录下，并且jira监听的端口是8080。</p>
<p>现在我们先关闭jira，然后把破解包里面的atlassian-extras-3.1.2.jar和mysql-connector-java-5.1.39-bin.jar两个文件复制到/opt/atlassian/jira/atlassian-jira/WEB-INF/lib/目录下。</p>
<p>其中atlassian-extras-3.1.2.jar是用来替换原来的atlassian-extras-3.1.2.jar文件，用作破解jira系统的。</p>
<p>而mysql-connector-java-5.1.39-bin.jar是用来连接mysql数据库的驱动软件包。</p>
<p>现在再次启动jira，然后我们现在来访问如下地址：</p>
<p>IP:8080</p>
<p>而连接数据库的配置是/var/atlassian/application-data/jira/dbconfig.xml，如下：</p>
<p>cat /var/atlassian/application-data/jira/dbconfig.xml</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.ilanni.com/?p=12119" target="_blank" rel="noopener">烂泥：jira7.3/7.2安装、中文及破解(20170829更新)</a><br><a href="http://www.yfshare.vip/2017/05/09/%E9%83%A8%E7%BD%B2JIRA-7-2-2-for-Linux/" target="_blank" rel="noopener">部署JIRA 7.2.2 for Linux</a><a href="http://blog.wangruirui.cn/2017/04/26/jara-install/" target="_blank" rel="noopener">CentOS 7 安装jara7.3.3 破解+汉化 一篇就够了(By-Ruicky)</a><br><a href="https://confluence.atlassian.com/doc/server-hardware-requirements-guide-30736403.html" target="_blank" rel="noopener">硬件要求</a></p>
<p><a href="https://blog.csdn.net/weiwangchao_/article/details/49820101" target="_blank" rel="noopener">如何让tomcat只支持ipv4</a></p>
<p><a href="https://blog.csdn.net/qq_42339484/article/details/81914221" target="_blank" rel="noopener">CentOS 6.5/6.6 安装（install）mysql 5.7 最完整版教程</a></p>
<p><a href="https://blog.csdn.net/lovoo/article/details/78092018" target="_blank" rel="noopener">Centos技术(3)–CentOS 6.5系统中iptables防火墙开放端口80 3306 22端口</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Python爬虫学习实践笔记" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/23/Python爬虫学习实践笔记/" class="article-date">
      <time datetime="2017-11-23T14:09:39.000Z" itemprop="datePublished">2017-11-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/23/Python爬虫学习实践笔记/">Python爬虫学习实践笔记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>Python 3.6.3</p>
</blockquote>
<p>环境创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv crawl_spider --python=/Users/jinlong/.pyenv/versions/3.6.3/bin/python</span><br></pre></td></tr></table></figure>
<p>安装库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install requests==2.18.4 beautifulsoup4==4.6.0</span><br></pre></td></tr></table></figure>
<p><a href="http://python-requests.org/" target="_blank" rel="noopener">Requests</a></p>
<p><a href="https://www.crummy.com/software/BeautifulSoup/" target="_blank" rel="noopener">Beautiful Soup</a></p>
<p>lxml和BeautifulSoup的区别</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-CentOS7 新装服务器初始化配置" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/17/CentOS7 新装服务器初始化配置/" class="article-date">
      <time datetime="2017-11-17T10:52:45.000Z" itemprop="datePublished">2017-11-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/17/CentOS7 新装服务器初始化配置/">CentOS7 新装服务器初始化配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="CentOS7-新装服务器初始化配置"><a href="#CentOS7-新装服务器初始化配置" class="headerlink" title="CentOS7 新装服务器初始化配置"></a>CentOS7 新装服务器初始化配置</h1><blockquote>
<p>CentOS 7.4.1708</p>
</blockquote>
<p><a href="http://wzlinux.blog.51cto.com/8021085/1945374" target="_blank" rel="noopener">CentOS 7 新装服务器部署流程</a></p>
<p>所有的服务器基本都是最小化安装，版本为CentOS 7.x  64位系列。</p>
<h2 id="配置IP和网关"><a href="#配置IP和网关" class="headerlink" title="配置IP和网关"></a>配置IP和网关</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line"></span><br><span class="line">IPADDR=10.0.0.7</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.1</span><br><span class="line">DNS1=114.114.114.114</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#重启网络服务</span><br><span class="line">systemctl restart network.service</span><br></pre></td></tr></table></figure>
<h2 id="设置时区"><a href="#设置时区" class="headerlink" title="设置时区"></a>设置时区</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">timedatectl list-timezones           #列出所有时区</span><br><span class="line">timedatectl set-local-rtc 1          #将硬件时钟调整为与本地时钟一致,0为设置为UTC时间</span><br><span class="line">timedatectl set-timezone Asia/Shanghai #设置系统时区为上海</span><br></pre></td></tr></table></figure>
<h2 id="设置主机名"><a href="#设置主机名" class="headerlink" title="设置主机名"></a>设置主机名</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#设置一个主机的变量因为主机名从node1-node9</span><br><span class="line">a=1</span><br><span class="line">#$a为变量</span><br><span class="line">hostnamectl set-hostname node$a.ovwane.com</span><br></pre></td></tr></table></figure>
<h2 id="关闭SELinux"><a href="#关闭SELinux" class="headerlink" title="关闭SELinux"></a>关闭SELinux</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/SELINUX=enforcing/SELINUX=disabled/g&apos; /etc/selinux/config</span><br></pre></td></tr></table></figure>
<h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld&amp;&amp;systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<h2 id="关闭IPv6"><a href="#关闭IPv6" class="headerlink" title="关闭IPv6"></a>关闭IPv6</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/^GRUB_CMDLINE_LINUX=\&quot;/GRUB_CMDLINE_LINUX=\&quot;ipv6.disable=1 /g&apos; /etc/default/grub&amp;&amp;</span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br></pre></td></tr></table></figure>
<h2 id="更改YUM源"><a href="#更改YUM源" class="headerlink" title="更改YUM源"></a>更改YUM源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm /etc/yum.repos.d/* -rf;curl -ssL http://mirrors.163.com/.help/CentOS7-Base-163.repo&gt;/etc/yum.repos.d/CentOS-Base.repo;echo $?</span><br></pre></td></tr></table></figure>
<h2 id="时间同步"><a href="#时间同步" class="headerlink" title="时间同步"></a>时间同步</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y chrony;systemctl enable chronyd.service&amp;&amp;systemctl start chronyd.service</span><br></pre></td></tr></table></figure>
<h2 id="常用软件"><a href="#常用软件" class="headerlink" title="常用软件"></a>常用软件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y lrzsz wget vim git tree bash-completion sysstat lsof net-tools unzip</span><br></pre></td></tr></table></figure>
<h2 id="VIM安装配置"><a href="#VIM安装配置" class="headerlink" title="VIM安装配置"></a>VIM安装配置</h2><h2 id="修改文件句柄数"><a href="#修改文件句柄数" class="headerlink" title="修改文件句柄数"></a>修改文件句柄数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#临时修改，立刻生效</span><br><span class="line">ulimit -n 655360         </span><br><span class="line"> </span><br><span class="line">#永久修改</span><br><span class="line">echo &quot;* soft nofile 655360&quot; &gt;&gt; /etc/security/limits.conf&amp;&amp;echo &quot;* hard nofile 655360&quot; &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure>
<h2 id="SSH设置"><a href="#SSH设置" class="headerlink" title="SSH设置"></a>SSH设置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/#UseDNS no/UseDNS no/g&apos; /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>
<h2 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -r now</span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Linux之路" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/14/Linux之路/" class="article-date">
      <time datetime="2017-11-14T14:53:32.000Z" itemprop="datePublished">2017-11-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/14/Linux之路/">Linux之路</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>2012.06.19 上海第一份工作 有一台Red Hat的Linux服务器<br>2013.10月份 小毛哥的大学中参观学习，郑州河南财经政法大学老校区的课堂上学习Linux。<br>2016.12.12 北京的公司有CentOS 6.3的服务器</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-五笔输入法" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/13/五笔输入法/" class="article-date">
      <time datetime="2017-11-13T15:29:00.000Z" itemprop="datePublished">2017-11-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/13/五笔输入法/">五笔输入法</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>五笔输入法</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h2><blockquote>
<p>macOS 10.13.1</p>
</blockquote>
<h3 id="鼠鬚管"><a href="#鼠鬚管" class="headerlink" title="鼠鬚管"></a>鼠鬚管</h3><p><a href="http://rime.im/" target="_blank" rel="noopener">中州韻輸入法引擎</a><br><a href="https://github.com/rime/squirrel" target="_blank" rel="noopener">鼠鬚管</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew cask install squirrel</span><br></pre></td></tr></table></figure>
<p>鼠鬚管图形化配置工具<br><del><a href="https://github.com/neolee/SCU" target="_blank" rel="noopener">neolee/SCU</a> 是由 <a href="https://github.com/neolee" target="_blank" rel="noopener">Neo Lee</a> 開發的圖形化配置工具。</del></p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><h2 id="新世紀五筆"><a href="#新世紀五筆" class="headerlink" title="新世紀五筆"></a>新世紀五筆</h2><p><a href="https://github.com/lswqzhang/RIME-wubi" target="_blank" rel="noopener">RIME（鼠须管、小狼毫、中州韵）输入法五笔方案，98版，新世纪版</a></p>
<ol>
<li>直接使用<br>macOS 将 RIME 文件夹中的文件复制到 RIME输入法 用户设定文件夹”/Library/Input Methods/Squirrel.app/Contents”。</li>
</ol>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-学习计划书" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/13/学习计划书/" class="article-date">
      <time datetime="2017-11-13T15:09:00.000Z" itemprop="datePublished">2017-11-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/13/学习计划书/">学习计划书</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>一转眼从想学习PHP开始已经整整五年，可是却一直没有学成。回想这五年来，从一个初入社会的毛头小子，现在眼看就是要奔三的人了，可是收入才只能温饱啊。个中滋味，不胜言表啊！回顾之前的工作，做的大部分都是体力劳动相对多点的，价值不高，也不被人所尊重，至少我看来是这样的。在工作的过程中，我发现很多比我年纪小的毕业生月薪可以是我的两倍，这个有点刺激到我了。我心想还是有一个技术会比较好，这样学习技术的想法在我心里萌发了。<br>可是学什么呢？看看当前的社会形势，得学一个符合发展趋势的技术。要学习，要深造的这个念头就这样在我的脑海中萦绕着。就在这个阶段，迷茫的时候。身边的小伙伴就给了我建议，为什么不学一下计算机的相关知识呢，互联网是大势所趋，而且对人才的需求量也比较大。就这样我开始在网上了解。看到很多人和我有类似的经理，经过半年多的努力学习，可以找到一个月薪过万的工作，我很羡慕，也很想变成和他们一样。结合自己的实际情况，我感觉Linux运维工作比较适合我。于是自己鼓足勇气，决心学习，破釜沉舟。口号喊得再响不行，我要做一个行动派，说做就做。这样我报名了老男孩运维网络班，来给自己充电，提高自己。<br>从现在开始（2017.11.13），我计划用5-6个月的时间结束课程（预计在2018年3月-4月）。自己现在有目标了，也有奔头了，为了月薪可以过万，拼了。这个信念点燃了我的斗志，我也要给一个证明自己的机会，不达目的，誓不罢休。XXX，为了你的万元梦想向前冲吧，不要畏惧，不要气馁，你行的，加油！加油！加油！</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-CentOS6 新装服务器初始化配置" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/12/CentOS6 新装服务器初始化配置/" class="article-date">
      <time datetime="2017-11-12T11:31:45.000Z" itemprop="datePublished">2017-11-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/12/CentOS6 新装服务器初始化配置/">CentOS 6 新装服务器部署流程</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://oldboy.blog.51cto.com/2561410/1336488" target="_blank" rel="noopener">CentOS（5.8/6.4）linux生产环境若干优化实战</a><a href="http://wzlinux.blog.51cto.com/8021085/1704772" target="_blank" rel="noopener">CentOS 6 新装服务器部署流程</a><a href="http://maocong.blog.51cto.com/4706737/1682372" target="_blank" rel="noopener">实践生产服务器环境最小化安装后 Centos 6.5 优化</a></p>
<p>特别说明：本文来自老男孩linux培训VIP学生学习笔记。特和所有博友分享。更多优化，请关注老男孩培训后续课程内容以及分享。<br>为了满足广大博友工作需求，老男孩linux培训课程从2013年起已经同时适合Centos5.X和Centos6.X!<br>CentOS系统安装之后并不能立即投入生产环境使用，往往需要先经过我们运维人员的优化才行。在此讲解几点关于Linux系统安装后的基础优化操作。注意：本次优化都是基于CentOS（5.8/6.4）。<br>下面我就为大家简单讲解几点关于Linux系统安装后的基础优化操作。</p>
<p>修改ip地址、网关、主机名、DNS等<br>关闭selinux，清空iptables<br>添加普通用户并进行sudo授权管理<br>更新yum源及必要软件安装<br>定时自动更新服务器时间<br>精简开机自启动服务<br>定时自动清理/var/spool/clientmqueue/目录垃圾文件，放置inode节点被占满<br>变更默认的ssh服务端口，禁止root用户远程连接<br>锁定关键文件系统<br>调整文件描述符大小<br>调整字符集，使其支持中文<br>去除系统及内核版本登录前的屏幕显示<br>内核参数优化</p>
<h2 id="修改ip地址、网关、主机名、DNS等"><a href="#修改ip地址、网关、主机名、DNS等" class="headerlink" title="修改ip地址、网关、主机名、DNS等"></a>修改ip地址、网关、主机名、DNS等</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line"></span><br><span class="line">DEVICE=eth0         #网卡名字</span><br><span class="line">BOOTPROTO=static    #静态IP地址获取状态 如：DHCP表示自动获取IP地址</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=10.0.0.6</span><br><span class="line">NETMASK=255.255.255.0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">修改网关</span><br><span class="line">vi /etc/sysconfig/network</span><br><span class="line">GATEWAY=10.0.0.1    #修改默认网关,如果上面eth0里面不配置网关的话，默认就使用这里的网关了。</span><br><span class="line"></span><br><span class="line">修改DNS</span><br><span class="line">vi /etc/resolv.conf</span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line"></span><br><span class="line">service network restart   #重启网卡，生效</span><br><span class="line">#重启网卡，也可以用下面的命令</span><br><span class="line">/etc/init.d/network restart</span><br></pre></td></tr></table></figure>
<h2 id="设置时区"><a href="#设置时区" class="headerlink" title="设置时区"></a>设置时区</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f /etc/localtime</span><br><span class="line">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure>
<h2 id="添加普通用户并进行sudo授权管理"><a href="#添加普通用户并进行sudo授权管理" class="headerlink" title="添加普通用户并进行sudo授权管理"></a>添加普通用户并进行sudo授权管理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">useradd sunsky</span><br><span class="line">echo &quot;123456&quot;|passwd --stdin sunsky&amp;&amp;history –c</span><br><span class="line"></span><br><span class="line">visudo</span><br><span class="line">在root    ALL=(ALL)    ALL此行下，添加如下内容</span><br><span class="line">sunsky    ALL=(ALL)    ALL</span><br></pre></td></tr></table></figure>
<h2 id="更改YUM源"><a href="#更改YUM源" class="headerlink" title="更改YUM源"></a>更改YUM源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm /etc/yum.repos.d/* -rf;curl -ssL http://mirrors.163.com/.help/CentOS6-Base-163.repo&gt;/etc/yum.repos.d/CentOS-Base.repo;echo $?</span><br></pre></td></tr></table></figure>
<h2 id="安装常用工具"><a href="#安装常用工具" class="headerlink" title="安装常用工具"></a>安装常用工具</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ntpdate lrzsz wget vim git tree bash-completion sysstat lsof</span><br></pre></td></tr></table></figure>
<p>lrzsz是一个上传下载的软件<br>sysstat是用来检测系统性能及效率的工具</p>
<h2 id="定时自动更新服务器时间"><a href="#定时自动更新服务器时间" class="headerlink" title="定时自动更新服务器时间"></a>定时自动更新服务器时间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;*/10 * * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&apos; &gt;&gt;/var/spool/cron/root</span><br></pre></td></tr></table></figure>
<h2 id="精简开机自启动服务"><a href="#精简开机自启动服务" class="headerlink" title="精简开机自启动服务"></a>精简开机自启动服务</h2><p>刚装完操作系统可以只保留crond，network，rsyslog，sshd这四个服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#关闭所有服务</span><br><span class="line">for sun in `chkconfig --list|grep 3:on|awk &apos;&#123;print $1&#125;&apos;`;do chkconfig --level 3 $sun off;done</span><br><span class="line">#开启需要的服务</span><br><span class="line">for sun in crond rsyslog sshd network;do chkconfig --level 3 $sun on;done</span><br><span class="line">#查看开机启动服务</span><br><span class="line">chkconfig --list|grep 3:on</span><br></pre></td></tr></table></figure>
<h2 id="变更默认的ssh服务端口，禁止root用户远程连接"><a href="#变更默认的ssh服务端口，禁止root用户远程连接" class="headerlink" title="变更默认的ssh服务端口，禁止root用户远程连接"></a>变更默认的ssh服务端口，禁止root用户远程连接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak</span><br><span class="line"></span><br><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line">Port 52113#ssh连接默认的端口</span><br><span class="line">PermitRootLogin no   #root用户黑客都知道，禁止它远程登录</span><br><span class="line">PermitEmptyPasswords no #禁止空密码登录</span><br><span class="line">UseDNS no            #不使用DNS</span><br><span class="line"></span><br><span class="line">/etc/init.d/sshd reload    #从新加载配置</span><br><span class="line">netstat -lnt     #查看端口信息</span><br><span class="line">lsof -i tcp:52113</span><br></pre></td></tr></table></figure>
<h2 id="锁定关键文件系统"><a href="#锁定关键文件系统" class="headerlink" title="锁定关键文件系统"></a>锁定关键文件系统</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@c64 ~]# chattr +i /etc/passwd</span><br><span class="line">[root@c64 ~]# chattr +i /etc/inittab</span><br><span class="line">[root@c64 ~]# chattr +i /etc/group</span><br><span class="line">[root@c64 ~]# chattr +i /etc/shadow</span><br><span class="line">[root@c64 ~]# chattr +i /etc/gshadow</span><br><span class="line">使用chattr命令后，为了安全我们需要将其改名</span><br><span class="line">/bin/mv /usr/bin/chattr /usr/bin/任意名称</span><br></pre></td></tr></table></figure>
<h2 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h2><p>文件描述符在形式上是一个非负整数。实际上，它是一个索引值，指向内核为每一个进程所维护的该进程打开文件的记录表。当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。在程序设计中，一些涉及底层的程序编写往往会围绕着文件描述符展开。但是文件描述符这一概念往往只适用于Unix、Linux这样的操作系统。<br>习惯上，标准输入（standard input）的文件描述符是 0，标准输出（standard output）是 1，标准错误（standard error）是 2。尽管这种习惯并非Unix内核的特性，但是因为一些 shell 和很多应用程序都使用这种习惯，因此，如果内核不遵循这种习惯的话，很多应用程序将不能使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#临时修改，立刻生效</span><br><span class="line">ulimit -n 655360         </span><br><span class="line"> </span><br><span class="line">#永久修改</span><br><span class="line">echo &quot;* soft nofile 655360&quot; &gt;&gt; /etc/security/limits.conf&amp;&amp;echo &quot;* hard nofile 655360&quot; &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure>
<h2 id="调整字符集，使其支持中文"><a href="#调整字符集，使其支持中文" class="headerlink" title="调整字符集，使其支持中文"></a>调整字符集，使其支持中文</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sed-i &apos;s#LANG=&quot;en_US.UTF-8&quot;#LANG=&quot;zh_CN.GB18030&quot;#&apos;/etc/sysconfig/i18n</span><br><span class="line">source/etc/sysconfig/i18n</span><br><span class="line">扩展：什么是字符集？</span><br><span class="line">简单的说就是一套文字符号及其编码。常用的字符集有：</span><br><span class="line">GBK 定长双字节不是国际标准，支持系统不少</span><br><span class="line">UTF-8 非定长 1-4字节广泛支持，MYSQL也使用UTF-8</span><br></pre></td></tr></table></figure>
<h2 id="去除系统及内核版本登录前的屏幕显示"><a href="#去除系统及内核版本登录前的屏幕显示" class="headerlink" title="去除系统及内核版本登录前的屏幕显示"></a>去除系统及内核版本登录前的屏幕显示</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;/etc/redhat-release</span><br><span class="line">&gt;/etc/issue</span><br></pre></td></tr></table></figure>
<h2 id="内核参数优化"><a href="#内核参数优化" class="headerlink" title="内核参数优化"></a>内核参数优化</h2><p>说明：本优化适合apache，nginx，squid多种等web应用，特殊的业务也可能需要略作调整。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">#by sun in 20131001</span><br><span class="line">net.ipv4.tcp_fin_timeout = 2</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_keepalive_time =600</span><br><span class="line">net.ipv4.ip_local_port_range = 4000    65000</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.route.gc_timeout = 100</span><br><span class="line">net.ipv4.tcp_syn_retries = 1</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line">net.core.somaxconn = 16384</span><br><span class="line">net.core.netdev_max_backlog = 16384</span><br><span class="line">net.ipv4.tcp_max_orphans = 16384</span><br><span class="line"></span><br><span class="line">#一下参数是对iptables防火墙的优化，防火墙不开会有提示，可以忽略不理。</span><br><span class="line">net.ipv4.ip_conntrack_max = 25000000</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_max = 25000000</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_tcp_timeout_established = 180</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_tcp_timeout_time_wait = 120</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_tcp_timeout_close_wait = 60</span><br><span class="line">net.ipv4.netfilter.ip_conntrack_tcp_timeout_fin_wait = 120</span><br><span class="line"></span><br><span class="line">sysctl –p    #使配置文件生效</span><br></pre></td></tr></table></figure>
<p>到此，我们Linux系统安装后的基础优化已经操作的差不多了，总结下来一共有13个优化点需要我们来熟知。后面我会出一个一键优化的shell脚本出来和大家一起交流学习。</p>
<p>所有的服务器基本都是最小化安装，版本为CentOS 6.x  64位系列。</p>
<h3 id="设置时区-1"><a href="#设置时区-1" class="headerlink" title="设置时区"></a>设置时区</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f /etc/localtime</span><br><span class="line">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure>
<h3 id="系统时间更新和设定定时任务"><a href="#系统时间更新和设定定时任务" class="headerlink" title="系统时间更新和设定定时任务"></a>系统时间更新和设定定时任务</h3><p>第一种：更新时间并且写入BOIS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntpdate time.windows.com &amp;&amp; hwclock -w &amp;&amp; hwclock --systohc</span><br></pre></td></tr></table></figure>
<p>第二种：更新时间并且写入定时任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;*/30 * * * * ntpdate time.windows.com &amp;&amp; hwclock -w &amp;&amp; hwclock --systohc &gt;/dev/null 2&gt;&amp;1&apos; &gt;&gt;/var/spool/cron/root</span><br></pre></td></tr></table></figure>
<p>第三种：每间隔5分钟和10分钟同步一次时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;*/5 * * * * /usr/sbin/ntpdate time.windows.com &gt;/dev/null 2 &gt;&amp;1&apos; &gt;&gt;/var/spool/cron/root</span><br><span class="line">echo &apos;*/10 * * * * /usr/sbin/ntpdate time.nist.gov &gt;/dev/null 2&gt;&amp;1&apos; &gt;&gt;/var/spool/cron/root</span><br></pre></td></tr></table></figure>
<p>提示：CentOS 6.x的时间同步命令路径不一样 6是/usr/sbin/ntpdate 5是/sbin/ntpdate</p>
<p>#关闭selinux<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/SELINUX=enforcing/SELINUX=disabled/g&apos; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">getenforce</span><br></pre></td></tr></table></figure></p>
<h3 id="关闭火墙"><a href="#关闭火墙" class="headerlink" title="关闭火墙"></a>关闭火墙</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service iptables stop</span><br><span class="line">iptables -L</span><br><span class="line">service iptables save</span><br></pre></td></tr></table></figure>
<h3 id="修改文件句柄数"><a href="#修改文件句柄数" class="headerlink" title="修改文件句柄数"></a>修改文件句柄数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#查看文件描述符大小</span><br><span class="line">ulimit -n</span><br><span class="line"></span><br><span class="line">第一种：#这里参考的是阿里云主机默认设置。</span><br><span class="line">vi /etc/security/limits.conf</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br><span class="line">* soft nproc 65535</span><br><span class="line">* hard nproc 65535</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br><span class="line"></span><br><span class="line">第二种：echo &apos;* - nofile 65535&apos; &gt;&gt; /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line">第三种：把ulimit -SHn 65535命令加入到/etc/rc.local，然后每次重启生效 追加命令到rc.local配置文件里面</span><br><span class="line"></span><br><span class="line">cat &gt;&gt;/etc/rc.local&lt;&lt;EOF</span><br><span class="line">#open files</span><br><span class="line">ulimit -HSn 65535</span><br><span class="line">#stack size</span><br><span class="line">ulimit -s 65535</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">第四种：如果不修改limits配置文件，直接立即生效，但重启后又恢复之前的默认。 ulimit -SHn 65535</span><br></pre></td></tr></table></figure>
<h2 id="修改SSH端口号和屏蔽root账号远程登陆"><a href="#修改SSH端口号和屏蔽root账号远程登陆" class="headerlink" title="修改SSH端口号和屏蔽root账号远程登陆"></a>修改SSH端口号和屏蔽root账号远程登陆</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#备份SSH配置</span><br><span class="line">cp /etc/ssh/sshd_config sshd_config_bak</span><br><span class="line">#修改SSH安全配置</span><br><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line">#SSH链接默认端口</span><br><span class="line">port 52113</span><br><span class="line">#禁止root账号登陆</span><br><span class="line">PermitRootLogin no</span><br><span class="line">#禁止空密码</span><br><span class="line">PermitEmptyPasswords no</span><br><span class="line">#不使用DNS</span><br><span class="line">UseDNS no</span><br></pre></td></tr></table></figure>
<p>重新载入SSH配置 /etc/init.d/sshd reload 查看端口里面是否有刚才修改过的端口号52113</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">netstat -lnt</span><br><span class="line"> </span><br><span class="line">或者反查端口是那个进程</span><br><span class="line">lsof -i tcp:52113</span><br></pre></td></tr></table></figure>
<h3 id="配置LDAP客户端-可选"><a href="#配置LDAP客户端-可选" class="headerlink" title="配置LDAP客户端(可选)"></a>配置LDAP客户端(可选)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum install openldap-clients nss-pam-ldapd -y</span><br><span class="line"></span><br><span class="line">authconfig --enablemkhomedir \</span><br><span class="line">--disableldaptls \</span><br><span class="line">--enablemd5 \</span><br><span class="line">--enableldap \</span><br><span class="line">--enableldapauth \</span><br><span class="line">--ldapserver=ldap://211.x.x.27:8389 \</span><br><span class="line">--ldapbasedn=&quot;dc=wzlinux,dc=com&quot; \</span><br><span class="line">--enableshadow \</span><br><span class="line">--update</span><br></pre></td></tr></table></figure>
<h3 id="删除不必要的系统用户和群组"><a href="#删除不必要的系统用户和群组" class="headerlink" title="删除不必要的系统用户和群组"></a>删除不必要的系统用户和群组</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#删除不必要的用户</span><br><span class="line">userdel adm</span><br><span class="line">userdel lp</span><br><span class="line">userdel sync</span><br><span class="line">userdel shutdown</span><br><span class="line">userdel halt</span><br><span class="line">userdel news</span><br><span class="line">userdel uucp</span><br><span class="line">userdel operator</span><br><span class="line">userdel games</span><br><span class="line">userdel gopher</span><br><span class="line">userdel ftp</span><br><span class="line">#删除不必要的群组</span><br><span class="line">groupdel adm</span><br><span class="line">groupdel lp</span><br><span class="line">groupdel news</span><br><span class="line">groupdel uucp</span><br><span class="line">groupdel games</span><br><span class="line">groupdel dip</span><br><span class="line">groupdel pppusers</span><br></pre></td></tr></table></figure>
<h3 id="关闭重启ctl-alt-delete组合键"><a href="#关闭重启ctl-alt-delete组合键" class="headerlink" title="关闭重启ctl-alt-delete组合键"></a>关闭重启ctl-alt-delete组合键</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/init/control-alt-delete.conf</span><br><span class="line">#注释掉</span><br><span class="line">#exec /sbin/shutdown -r now &quot;Control-Alt-Deletepressed&quot;</span><br></pre></td></tr></table></figure>
<h3 id="设置一些全局变量"><a href="#设置一些全局变量" class="headerlink" title="设置一些全局变量"></a>设置一些全局变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#设置自动退出终端，防止非法关闭ssh客户端造成登录进程过多，可以设置大一些，单位为秒</span><br><span class="line">echo &quot;TMOUT=3600&quot;&gt;&gt; /etc/profile</span><br><span class="line">#历史命令记录数量设置为10条</span><br><span class="line">sed -i &quot;s/HISTSIZE=1000/HISTSIZE=10/&quot; /etc/profile</span><br><span class="line">#立即生效</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="关闭不需要的tty（保留2个就可以）"><a href="#关闭不需要的tty（保留2个就可以）" class="headerlink" title="关闭不需要的tty（保留2个就可以）"></a>关闭不需要的tty（保留2个就可以）</h2><p>vim /etc/inittab<br>init -q （不重启生效）</p>
<h2 id="修改shell命令的history的记录个数"><a href="#修改shell命令的history的记录个数" class="headerlink" title="修改shell命令的history的记录个数"></a>修改shell命令的history的记录个数</h2><p>vim /etc/profile<br>source /etc/profile</p>
<h2 id="关闭centos的写磁盘I-O功能"><a href="#关闭centos的写磁盘I-O功能" class="headerlink" title="关闭centos的写磁盘I/O功能"></a>关闭centos的写磁盘I/O功能</h2><p>vim /etc/fstab<br>追加类似该格式的(实际情况在修改分区)<br>/dev/sda5 /data/pics ext3 noatime,nodiratime 0 0</p>
<h2 id="优化内核参数"><a href="#优化内核参数" class="headerlink" title="优化内核参数"></a>优化内核参数</h2><h2 id="包的安装（注意尽量源码安装）"><a href="#包的安装（注意尽量源码安装）" class="headerlink" title="包的安装（注意尽量源码安装）"></a>包的安装（注意尽量源码安装）</h2><h2 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -r now</span><br></pre></td></tr></table></figure>
<p>1</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-HAProxy安装配置" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/12/HAProxy安装配置/" class="article-date">
      <time datetime="2017-11-12T05:39:00.000Z" itemprop="datePublished">2017-11-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/12/HAProxy安装配置/">HAProxy安装配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://zhang789.blog.51cto.com/11045979/1873432" target="_blank" rel="noopener">高可用高性能负载均衡软件HAproxy详解指南</a><br><a href="http://actionwenji.blog.51cto.com/4170472/1363335" target="_blank" rel="noopener">HAProxy简介和搭建</a></p>
<h2 id="haproxy简介"><a href="#haproxy简介" class="headerlink" title="haproxy简介"></a>haproxy简介</h2><p>HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代 理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。<br>   HAProxy实现了一种事件驱动, 单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制 、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户端(User-Space) 实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么他们必须进行优化以 使每个CPU时间片(Cycle)做更多的工作。<br>   HAProxy相比LVS的使用要简单很多，功能方面也很丰富。当 前，HAProxy支持两种主要的代理模式:”tcp”也即4层（大多用于邮件服务器、内部协议通信服务器等），和7层（HTTP）。在4层模式 下，HAProxy仅在客户端和服务器之间转发双向流量。7层模式下，HAProxy会分析协议，并且能通过允许、拒绝、交换、增加、修改或者删除请求 (request)或者回应(response)里指定内容来控制协议，这种操作要基于特定规则。</p>
<h2 id="HAproxy简介"><a href="#HAproxy简介" class="headerlink" title="HAproxy简介"></a>HAproxy简介</h2><p>1、HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。<br>2、HAProxy实现了一种事件驱动, 单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制 、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户空间(User-Space) 实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么他们必须进行优化以 使每个CPU时间片(Cycle)做更多的工作。(为了解决上下文切换，可以像nginx一样绑定cpu上面)</p>
<p>##为什么要使用HAproxy<br>1.免费开源，稳定性也是非常好，这个可通过一些项目可以看出来，单Haproxy也跑得不错，稳定性可以与硬件级的F5相媲美； </p>
<ol start="2">
<li>根据官方文档，HAProxy可以跑满10Gbps-New benchmark of HAProxy at 10 Gbps usingMyricom’s 10GbE NICs （Myri-10G PCI-Express），这个数值作为软件级负载均衡器是相当惊人的。 </li>
<li>HAProxy 支持连接拒绝 : 因为维护一个连接的打开的开销是很低的，有时我们很需要限制攻击蠕虫（attack bots），也就是说限制它们的连接打开从而限制它们的危害。 这个已经为一个陷于小型DDoS攻击的网站开发了而且已经拯救了很多站点，这个优点也是其它负载均衡器没有的。<br>4.HAProxy 支持全透明代理（已具备硬件防火墙的典型特点）: 可以用客户端IP地址或者任何其他地址来连接后端服务器. 这个特性仅在Linux 2.4/2.6内核打了cttproxy补丁后才可以使用，这个特性也使得为某特殊服务器处理部分流量同时又不修改服务器的地址成为可能。 </li>
<li>HAProxy现多于线上的Mysql集群环境，我们常用于它作为MySQL（读）负载均衡。 </li>
<li>自带强大的监控服务器状态的页面，实际环境中我们结合Nagios进行邮件或短信报警。 </li>
<li>HAProxy支持虚拟主机。 </li>
<li>HAProxy特别适用于那些负载特大的web站点， 这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。</li>
</ol>
<h2 id="haproxy-性能特点"><a href="#haproxy-性能特点" class="headerlink" title="haproxy 性能特点"></a>haproxy 性能特点</h2><p>HAProxy借助于OS上几种常见的技术来实现性能的最大化。</p>
<p>1、单进程、事件驱动模型显著降低了上下文切换的开销及内存占用。<br>2、O(1)事件检查器(event checker)允许其在高并发连接中对任何连接的任何事件实现即时探测。<br>3、在任何可用的情况下，单缓冲(single buffering)机制能以不复制任何数据的方式完成读写操作，这会节约大量的CPU时钟周期及内存带宽；<br>4、借助于Linux 2.6 (&gt;= 2.6.27.19)上的splice()系统调用，HAProxy可以实现零复制转发(Zero-copy forwarding)，在Linux 3.5及以上的OS中还可以实现零复制启动(zero-starting)；<br>5、MRU内存分配器在固定大小的内存池中可实现即时内存分配，这能够显著减少创建一个会话的时长；<br>6、树型存储：侧重于使用作者多年前开发的弹性二叉树，实现了以O(log(N))的低开销来保持计时器命令、保持运行队列命令及管理轮询及最少连接队列；<br>7、优化的HTTP首部分析：优化的首部分析功能避免了在HTTP首部分析过程中重读任何内存区域；<br>8、精心地降低了昂贵的系统调用，大部分工作都在用户空间完成，如时间读取、缓冲聚合及文件描述符的启用和禁用等；<br>所有的这些细微之处的优化实现了在中等规模负载之上依然有着相当低的CPU负载，甚至于在非常高的负载场景中，5%的用户空间占用率和95%的系统空间占用率也是非常普遍的现象，这意味着HAProxy进程消耗比系统空间消耗低20倍以上。因此，对OS进行性能调优是非常重要的。即使用户空间的占用率提高一倍，其CPU占用率也仅为10%，这也解释了为何7层处理对性能影响有限这一现象。由此，在高端系统上HAProxy的7层性能可轻易超过硬件负载均衡设备。<br>在生产环境中，在7层处理上使用HAProxy作为昂贵的高端硬件负载均衡设备故障故障时的紧急解决方案也时长可见。硬件负载均衡设备在“报文”级别处理请求，这在支持跨报文请求(request across multiple packets)有着较高的难度，并且它们不缓冲任何数据，因此有着较长的响应时间。对应地，软件负载均衡设备使用TCP缓冲，可建立极长的请求，且有着较大的响应时间。</p>
<h2 id="负载均衡器的性能评估因素"><a href="#负载均衡器的性能评估因素" class="headerlink" title="负载均衡器的性能评估因素"></a>负载均衡器的性能评估因素</h2><p>三个重要因素：<br>1、会话率 ：单位时间内的处理的请求数<br>2、会话并发能力：并发处理能力<br>3、数据率：处理数据能力<br>经过官方测试统计，haproxy 单位时间处理的最大请求数为20000个，可以同时维护40000-50000个并发连接，最大数据处理能力为10Gbps。综合上述，haproxy是性能优越的负载均衡、反向代理服务器。</p>
<h1 id="安装HAproxy"><a href="#安装HAproxy" class="headerlink" title="安装HAproxy"></a>安装HAproxy</h1><p>1、安装haproxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum -y groupinstall &quot;Development Tools&quot;</span><br><span class="line">[root@localhost ~]# yum -y install haproxy</span><br></pre></td></tr></table></figure>
<p>2、配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# rpm -ql haproxy</span><br><span class="line">/etc/haproxy   #配置文件目录 </span><br><span class="line">/etc/haproxy/haproxy.cfg   #配置文件 </span><br><span class="line">/usr/lib/systemd/system/haproxy.service    #启动脚本</span><br><span class="line">/usr/sbin/haproxy    #haproxy 命令 </span><br><span class="line">/usr/share/man/man1/haproxy.1.gz #man 文档</span><br></pre></td></tr></table></figure>
<p>3、默认配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy haproxy]# cat haproxy.cfg</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line"># Example configuration for a possible web application.  See the </span><br><span class="line"># full configuration options online. </span><br><span class="line"># </span><br><span class="line">#   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt  #官方配置文档，很详细，英文没问题的博友，可以看看</span><br><span class="line"># </span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># Global settings #全局配置文件</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">global </span><br><span class="line">    # to have these messages end up in /var/log/haproxy.log you will </span><br><span class="line">    # need to:  #配置日志</span><br><span class="line">    # </span><br><span class="line">    # 1) configure syslog to accept network log events.  This is done </span><br><span class="line">    #    by adding the &apos;-r&apos; option to the SYSLOGD_OPTIONS in </span><br><span class="line">    #    /etc/sysconfig/syslog #修改syslog配置文件</span><br><span class="line">    # </span><br><span class="line">    # 2) configure local2 events to go to the /var/log/haproxy.log </span><br><span class="line">    #   file. A line like the following can be added to </span><br><span class="line">    #   /etc/sysconfig/syslog  #定义日志设备</span><br><span class="line">    # </span><br><span class="line">    #    local2.*                       /var/log/haproxy.log </span><br><span class="line">    # </span><br><span class="line">    log         127.0.0.1 local2 #</span><br><span class="line">#全局的日志配置 其中日志级别是[err warning info debug]</span><br><span class="line">#local0 是日志设备，必须为如下24种标准syslog设备的一种:</span><br><span class="line">#kern user mail daemon auth syslog lpr news</span><br><span class="line">#uucp cron auth2 ftp ntp audit alert cron2</span><br><span class="line">#local0 local1 local2 local3 local4 local5 local6 local7</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid #将所有进程的pid写入文件启动进程的用户必须有权限访问此文件。</span><br><span class="line">    maxconn     4000 #最大连接数，默认4000</span><br><span class="line">    user        haproxy #用户</span><br><span class="line">    group       haproxy #组</span><br><span class="line">    daemon ##创建1个进程进入deamon模式运行。此参数要求将运行模式设置为&quot;daemon&quot;</span><br><span class="line">    # turn on stats unix socket  #unix socket 文件</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># common defaults that all the &apos;listen&apos; and &apos;backend&apos; sections will </span><br><span class="line"># use if not designated in their block  #默认的全局设置，这些参数可以被利用配置到frontend，backend，listen组件</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">defaults</span><br><span class="line">    mode                    http  #默认的模式mode &#123; tcp|http|health &#125;，tcp是4层，http是7层，health只会返回OK</span><br><span class="line">    log                     global #采用全局定义的日志</span><br><span class="line">    option                  httplog #日志类别http日志格式</span><br><span class="line">    option                  dontlognull #不记录健康检查的日志信息</span><br><span class="line">    option http-server-close #每次请求完毕后主动关闭http通道</span><br><span class="line">    option forwardfor       except 127.0.0.0/8 #不记录本机转发的日志</span><br><span class="line">    option                  redispatch #serverId对应的服务器挂掉后,强制定向到其他健康的服务器</span><br><span class="line">    retries                 3 #3次连接失败就认为服务不可用，也可以通过后面设置</span><br><span class="line">    timeout http-request    10s  #请求超时</span><br><span class="line">    timeout queue           1m #队列超时</span><br><span class="line">    timeout connect         10s #连接超时</span><br><span class="line">    timeout client          1m #客户端连接超时</span><br><span class="line">    timeout server          1m #服务器连接超时</span><br><span class="line">    timeout http-keep-alive 10s #长连接超时</span><br><span class="line">    timeout check           10s  #检查超时</span><br><span class="line">    maxconn                 3000 #最大连接数</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># main frontend which proxys to the backends #frontend 与backends  代理配置</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">frontend  main *:5000</span><br><span class="line">#acl策略配置</span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /stylesheets </span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line">    use_backend static          if url_static  #满足策略要求，则响应策略定义的backend页面</span><br><span class="line">    default_backend             app #不满足则响应backend的默认页面</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># static backend for serving up images, stylesheets and such #定义使用静态后端图像，样式表等</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">backend static </span><br><span class="line">    balance     roundrobin #负载均衡模式轮询</span><br><span class="line">    server      static 127.0.0.1:4331 check #服务器定义</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># round robin balancing between the various backends </span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">backend app </span><br><span class="line">    balance     roundrobin #负载均衡模式轮询</span><br><span class="line">    server  app1 127.0.0.1:5001 check #服务器定义，check进行健康检查</span><br><span class="line">    server  app2 127.0.0.1:5002 check </span><br><span class="line">    server  app3 127.0.0.1:5003 check </span><br><span class="line">    server  app4 127.0.0.1:5004 check</span><br></pre></td></tr></table></figure>
<h1 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h1><h2 id="实现web负载"><a href="#实现web负载" class="headerlink" title="实现web负载"></a>实现web负载</h2><p>client-&gt;Internet-HAProxy-&gt;{Web 1,Web 2}</p>
<p>1、安装http和测试页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web1 ~]# yum -y install httpd</span><br><span class="line">[root@web1 ~]# cd /var/www/html/</span><br><span class="line">[root@web1 html]# echo &quot;&lt;h1&gt;Server WWW node1&lt;/h1&gt;&quot; &gt; index.html</span><br></pre></td></tr></table></figure>
<p>2、node2安装http和测试页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web2 ~]# yum -y install httpd</span><br><span class="line">[root@web2 ~]# cd /var/www/html/</span><br><span class="line">[root@web2 html]# echo &quot;&lt;h1&gt;Server WWW node2&lt;/h1&gt;&quot; &gt; index.html</span><br></pre></td></tr></table></figure>
<p>3、haproxy安装配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HAproxy ~]# yum -y groupinstall &quot;Development Tools&quot;</span><br><span class="line">[root@HAproxy ~]# yum -y install haproxy</span><br></pre></td></tr></table></figure>
<p>4、配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@HAproxy ~]# cat /etc/haproxy/haproxy.cfg </span><br><span class="line">......主要配置函数</span><br><span class="line">listen stats   #监控页面</span><br><span class="line">    mode http</span><br><span class="line">    bind 0.0.0.0:1080</span><br><span class="line">    stats enable</span><br><span class="line">    stats hide-version</span><br><span class="line">    stats uri     /haproxyadmin?stats</span><br><span class="line">    stats realm   Haproxy\ Statistics</span><br><span class="line">    stats auth    admin:admin</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">frontend main  #定义服务器组</span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend server</span><br><span class="line">backend server  #定义服务器</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    option httpchk HEAD /index.html HTTP/1.0</span><br><span class="line">    server node1 192.168.211.140:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br><span class="line">    server node2 192.168.211.128:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br></pre></td></tr></table></figure>
<p>5、查看监控页面<br><a href="http://haproxy:1080/haproxyadmin?stats" target="_blank" rel="noopener">http://haproxy:1080/haproxyadmin?stats</a></p>
<p>6、测试</p>
<h1 id="HAproxy配置文件详解"><a href="#HAproxy配置文件详解" class="headerlink" title="HAproxy配置文件详解"></a>HAproxy配置文件详解</h1><p>1、配置文件的格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HAProxy的配置处理3类来主要参数来源：</span><br><span class="line">——最优先处理的命令行参数，</span><br><span class="line">——“global”配置段，用于设定全局配置参数；</span><br><span class="line">——proxy相关配置段，如“defaults”、“listen”、“frontend”和“backend”；</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">“defaults”段用于为所有其它配置段提供默认参数，这配置默认配置参数可由下一个“defaults”所重新设定。 </span><br><span class="line">“frontend”段用于定义一系列监听的套接字，这些套接字可接受客户端请求并与之建立连接。 </span><br><span class="line">“backend”段用于定义一系列“后端”服务器，代理将会将对应客户端的请求转发至这些服务器。 </span><br><span class="line">“listen”段通过关联“前端”和“后端”定义了一个完整的代理，通常只对TCP流量有用。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>1、注，“global”配置中的参数为进程级别的参数，且通常与其运行的OS相关。<br>2、注，所有代理的名称只能使用大写字母、小写字母、数字、-(中线)、_(下划线)、.(点号)和:(冒号)。此外，ACL名称会区分字母大小写。</p>
</blockquote>
<p>2、时间格式<br>一些包含了值的参数表示时间，如超时时长。这些值一般以毫秒为单位，但也可以使用其它的时间单位后缀。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">us: 微秒(microseconds)，即1/1000000秒；</span><br><span class="line">ms: 毫秒(milliseconds)，即1/1000秒；</span><br><span class="line">s: 秒(seconds)；</span><br><span class="line">m: 分钟(minutes)；</span><br><span class="line">h：小时(hours)；</span><br><span class="line">d: 天(days)；</span><br></pre></td></tr></table></figure>
<p>3、例子</p>
<p>下面的例子配置了一个监听在所有接口的80端口上HTTP proxy服务，它转发所有的请求轮训至后端192.168.211.139和192.168.211.128的”server”上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    daemon</span><br><span class="line">    maxconn 25600</span><br><span class="line">defaults</span><br><span class="line">    mode http</span><br><span class="line">    timeout connect 5000ms</span><br><span class="line">    timeout client 50000ms</span><br><span class="line">    timeout server 50000ms</span><br><span class="line">frontend http-in</span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend servers</span><br><span class="line">backend servers</span><br><span class="line">        balance roundrobin</span><br><span class="line">        server server1 192.168.211.139:80 check</span><br><span class="line">        server server2 192.168.211.128:80 check</span><br></pre></td></tr></table></figure>
<p>4.全局配置</p>
<blockquote>
<p>注，“global”配置中的参数为进程级别的参数，且通常与其运行的OS相关。</p>
</blockquote>
<p>(1).进程管理及安全相关的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">chroot &lt;jail dir&gt;：修改haproxy的工作目录至指定的目录并在放弃权限之前执行chroot()操作，可以提升haproxy的安全级别，不过需要注意的是要确保指定的目录为空目录且任何用户均不能有写权限； </span><br><span class="line">daemon：让haproxy以守护进程的方式工作于后台，其等同于“-D”选项的功能，当然，也可以在命令行中以“-db”选项将其禁用； </span><br><span class="line">gid &lt;number&gt;：以指定的GID运行haproxy，建议使用专用于运行haproxy的GID，以免因权限问题带来风险； </span><br><span class="line">group &lt;group name&gt;：同gid，不过指定的组名； </span><br><span class="line">log &lt;address&gt; &lt;facility&gt; [max level [min level]]：定义全局的syslog服务器，最多可以定义两个； </span><br><span class="line">log-send-hostname [&lt;string&gt;]：在syslog信息的首部添加当前主机名，可以为“string”指定的名称，也可以缺省使用当前主机名； </span><br><span class="line">nbproc &lt;number&gt;：指定启动的haproxy进程个数，只能用于守护进程模式的haproxy；默认只启动一个进程，鉴于调试困难等多方面的原因，一般只在单进程仅能打开少数文件描述符的场景中才使用多进程模式； </span><br><span class="line">pidfile：将所有进程的pid写入文件启动进程的用户必须有权限访问此文件 </span><br><span class="line">uid：以指定的UID身份运行haproxy进程； </span><br><span class="line">ulimit-n：设定每进程所能够打开的最大文件描述符数目，默认情况下其会自动进行计算，因此不推荐修改此选项； </span><br><span class="line">user：同uid，但使用的是用户名； </span><br><span class="line">stats： </span><br><span class="line">node：定义当前节点的名称，用于HA场景中多haproxy进程共享同一个IP地址时； </span><br><span class="line">description：当前实例的描述信息；</span><br></pre></td></tr></table></figure>
<p>(2).性能调整相关的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">maxconn &lt;number&gt;：设定每个haproxy进程所接受的最大并发连接数，其等同于命令行选项“n”；“ulimit n”自动计算的结果正是参照此参数设定的； </span><br><span class="line">maxpipes &lt;number&gt;：haproxy使用pipe完成基于内核的tcp报文重组，此选项则用于设定每进程所允许使用的最大pipe个数；每个pipe会打开两个文件描述符，因此，“ulimit n”自动计算时会根据需要调大此值；默认为maxconn/4，其通常会显得过大； </span><br><span class="line">noepoll：在Linux系统上禁用epoll机制； </span><br><span class="line">nokqueue：在BSE系统上禁用kqueue机制； </span><br><span class="line">nopoll：禁用poll机制； </span><br><span class="line">nosepoll：在Linux禁用启发式epoll机制； </span><br><span class="line">nosplice：禁止在Linux套接字上使用内核tcp重组，这会导致更多的recv/send系统调用；不过，在Linux 2.6.2528系列的内核上，tcp重组功能有bug存在； </span><br><span class="line">spreadchecks &lt;0..50, in percent&gt;：在haproxy后端有着众多服务器的场景中，在精确的时间间隔后统一对众服务器进行健康状况检查可能会带来意外问题；此选项用于将其检查的时间间隔长度上增加或减小一定的随机时长； </span><br><span class="line">tune.bufsize &lt;number&gt;：设定buffer的大小，同样的内存条件小，较小的值可以让haproxy有能力接受更多的并发连接，较大的值可以让某些应用程序使用较大的cookie信息；默认为16384，其可以在编译时修改，不过强烈建议使用默认值； </span><br><span class="line">tune.chksize &lt;number&gt;：设定检查缓冲区的大小，单位为字节；更大的值有助于在较大的页面中完成基于字符串或模式的文本查找，但也会占用更多的系统资源；不建议修改; </span><br><span class="line">tune.maxaccept &lt;number&gt;：设定haproxy进程内核调度运行时一次性可以接受的连接的个数，较大的值可以带来较大的吞吐率，默认在单进程模式下为100，多进程模式下为8，设定为1可以禁止此限制；一般不建议修改； </span><br><span class="line">tune.maxpollevents &lt;number&gt;：设定一次系统调用可以处理的事件最大数，默认值取决于OS；其值小于200时可节约带宽，但会略微增大网络延迟，而大于200时会降低延迟，但会稍稍增加网络带宽的占用量； </span><br><span class="line">tune.maxrewrite &lt;number&gt;：设定为首部重写或追加而预留的缓冲空间，建议使用1024左右的大小；在需要使用更大的空间时，haproxy会自动增加其值； </span><br><span class="line">tune.rcvbuf.server &lt;number&gt;：设定内核套接字中服务端或客户端接收缓冲的大小，单位为字节；强烈推荐使用默认值；</span><br></pre></td></tr></table></figure>
<h2 id="haproxy-配置文件中的关键字参考"><a href="#haproxy-配置文件中的关键字参考" class="headerlink" title="haproxy 配置文件中的关键字参考"></a>haproxy 配置文件中的关键字参考</h2><p>1.balance</p>
<p>格式：</p>
<p>balance <algorithm> [ <arguments> ]<br>balance url_param <param> [check_post [&lt;max_wait&gt;]]<br>定义负载均衡算法，可用于“defaults”、“listen”和“backend”。用于在负载均衡场景中挑选一个server，其仅应用于持久信息不可用的条件下或需要将一个连接重新派发至另一个服务器时。支持的算法有：</arguments></algorithm></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">roundrobin：基于权重进行轮叫，在服务器的处理时间保持均匀分布时，这是最平衡、最公平的算法。此算法是动态的，这表示其权重可以在运行时进行调整，不过，在设计上，最多能接受4128个后端服务器；（这完全够我们用了） </span><br><span class="line">static-rr：基于权重进行轮叫，与roundrobin类似，但是为静态方法，在运行时调整其服务器权重不会生效；不过，其在后端服务器连接数上没有限制；（新的服务器上线后，会立即发送上来大量的连接） </span><br><span class="line">leastconn：新的连接请求被派发至具有最少连接数目的后端服务器；在有着较长时间会话的场景中推荐使用此算法，如LDAP、SQL等，其并不太适用于较短会话的应用层协议，如HTTP；此算法是动态的，可以在运行时调整其权重； </span><br><span class="line">source：将请求的源地址进行hash运算，并由后端服务器的权重总数相除后派发至某匹配的服务器；这可以使得同一个客户端IP的请求始终被派发至某特定的服务器；不过，当服务器权重总数发生变化时，如某服务器宕机或添加了新的服务器，许多客户端的请求可能会被派发至与此前请求不同的服务器；常用于负载均衡无cookie功能的基于TCP的协议；其默认为静态，不过也可以使用hash-type修改此特性； </span><br><span class="line">uri：对URI的左半部分(“问题”标记之前的部分)或整个URI进行hash运算，并由服务器的总权重相除后派发至某匹配的服务器；这可以使得对同一个URI的请求总是被派发至某特定的服务器，除非服务器的权重总数发生了变化；此算法常用于代理缓存或反病毒代理以提高缓存的命中率；需要注意的是，此算法仅应用于HTTP后端服务器场景；其默认为静态算法，不过也可以使用hash-type修改此特性； </span><br><span class="line">url_param：通过为URL指定的参数在每个HTTP GET请求中将会被检索；如果找到了指定的参数且其通过等于号“=”被赋予了一个值，那么此值将被执行hash运算并被服务器的总权重相除后派发至某匹配的服务器；此算法可以通过追踪请求中的用户标识进而确保同一个用户ID的请求将被送往同一个特定的服务器，除非服务器的总权重发生了变化；如果某请求中没有出现指定的参数或其没有有效值，则使用轮叫算法对相应请求进行调度；此算法默认为静态的，不过其也可以使用hash-type修改此特性； </span><br><span class="line">hdr(&lt;name&gt;)：对于每个HTTP请求，通过指定的HTTP首部将会被检索；如果相应的首部没有出现或其没有有效值，则使用轮叫算法对相应请求进行调度；其有一个可选选项“use_domain_only”，可在指定检索类似Host类的首部时仅计算域名部分(比如通过www.test.com来说，仅计算test字符串的hash值)以降低hash算法的运算量；此算法默认为静态的，不过其也可以使用hash-type修改此特性； </span><br><span class="line">rdp-cookie </span><br><span class="line">rdp-cookie(name)</span><br></pre></td></tr></table></figure>
<p>会话保持机制</p>
<p>1、调度众多的MySQL从服务器，用什么调度方法？<br>    leastconn<br>2、调度web图片服务器组，用什么调度方法？<br>    roundrobin<br>3、调度web应用程序服务器组，用什么调度方法？<br>    source<br>    session保持的方式：<br>        session绑定<br>            源IP绑定：<br>                nginx: ip_hash<br>                haproxy: source<br>                ipvs: sh<br>            cookie绑定：<br>                cookie<br>                    session复制<br>                    session服务器<br>4、调度web缓存服务器组，用什么调度方法？<br>    uri<br>    hash-type<br>    map-based<br>    consistent<br>///解释：<br>uri: 用于后端服务器是cache server的场景，保证缓存命中率的；<br>url-params: 常用于后端服务器需要对用户进行认证的场景中；<br>hdr(host)<br>            host: <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a><br>            host: web.magedu.com<br>use_domain_only：在计算hash值时，仅使用域名，如上面的magedu.com；<br>常用于hdr(host)实现将对同一个虚拟主机的访问始终定向至同一个upstream server；</p>
<p>2.bind</p>
<p>格式：</p>
<p>bind [<address>]:&lt;port_range&gt; [, …]<br>bind [<address>]:&lt;port_range&gt; [, …] interface <interface><br>此指令仅能用于frontend和listen区段，用于定义一个或几个监听的套接字。 </interface></address></address></p>
<p><address>：可选选项，其可以为主机名、IPv4地址、IPv6地址或；省略此选项、将其指定为或0.0.0.0时，将监听当前系统的所有IPv4地址； </address></p>
<p>&lt;port_range&gt;：可以是一个特定的TCP端口，也可是一个端口范围(如5005-5010)，代理服务器将通过指定的端口来接收客户端请求；需要注意的是，每组监听的套接字在同一个实例上只能使用一次，而且小于1024的端口需要有特定权限的用户才能使用，这可能需要通过uid参数来定义； </p>
<p><interface>：指定物理接口的名称，仅能在Linux系统上使用；其不能使用接口别名，而仅能使用物理接口名称，而且只有管理有权限指定绑定的物理接口；</interface></p>
<p>3.mode</p>
<p>格式：</p>
<p>mode { tcp|http|health }<br>设定实例的运行模式或协议。当实现内容交换时，前端和后端必须工作于同一种模式(一般说来都是HTTP模式)，否则将无法启动实例。<br>tcp：实例运行于纯TCP模式，在客户端和服务器端之间将建立一个全双工的连接，且不会对7层报文做任何类型的检查；此为默认模式，通常用于SSL、SSH、SMTP等应用；<br>http：实例运行于HTTP模式，客户端请求在转发至后端服务器之前将被深度分析，所有不与RFC格式兼容的请求都会被拒绝；<br>health：实例工作于health模式，其对入站请求仅响应“OK”信息并关闭连接，且不会记录任何日志信息；此模式将用于响应外部组件的健康状态检查请求；目前来讲，此模式已经废弃，因为tcp或http模式中的monitor关键字可完成类似功能；</p>
<ol start="4">
<li>hash-type</li>
</ol>
<p>格式：</p>
<p>hash-type <method><br>定义用于将hash码映射至后端服务器的方法；其不能用于frontend区段；可用方法有map-based和consistent，在大多数场景下推荐使用默认的map-based方法。<br>map-based：hash表是一个包含了所有在线服务器的静态数组。其hash值将会非常平滑，会将权重考虑在列，但其为静态方法，对在线服务器的权重进行调整将不会生效，这意味着其不支持慢速启动。此外，挑选服务器是根据其在数组中的位置进行的，因此，当一台服务器宕机或添加了一台新的服务器时，大多数连接将会被重新派发至一个与此前不同的服务器上，对于缓存服务器的工作场景来说，此方法不甚适用。<br>consistent：hash表是一个由各服务器填充而成的树状结构；基于hash键在hash树中查找相应的服务器时，最近的服务器将被选中。此方法是动态的，支持在运行时修改服务器权重，因此兼容慢速启动的特性。添加一个新的服务器时，仅会对一小部分请求产生影响，因此，尤其适用于后端服务器为cache的场景。不过，此算法不甚平滑，派发至各服务器的请求未必能达到理想的均衡效果，因此，可能需要不时的调整服务器的权重以获得更好的均衡性。</method></p>
<p>5.log</p>
<p>格式：</p>
<p>log global<br>log <address> <facility> [<level> [<minlevel>]]<br>为每个实例启用事件和流量日志，因此可用于所有区段。每个实例最多可以指定两个log参数，不过，如果使用了“log global”且”global”段已经定了两个log参数时，多余了log参数将被忽略。<br>global：当前实例的日志系统参数同”global”段中的定义时，将使用此格式；每个实例仅能定义一次“log global”语句，且其没有任何额外参数； </minlevel></level></facility></address></p>
<p><address>：定义日志发往的位置，其格式之一可以为，其中的port为UDP协议端口，默认为514；格式之二为Unix套接字文件路径，但需要留心chroot应用及用户的读写权限； </address></p>
<p><facility>：可以为syslog系统的标准facility之一； </facility></p>
<p><level>：定义日志级别，即输出信息过滤器，默认为所有信息；指定级别时，所有等于或高于此级别的日志信息将会被发送；</level></p>
<p>6.maxconn</p>
<p>格式：</p>
<p>maxconn <conns><br>设定一个前端的最大并发连接数，因此，其不能用于backend区段。对于大型站点来说，可以尽可能提高此值以便让haproxy管理连接队列，从而避免无法应答用户请求。当然，此最大值不能超出“global”段中的定义。此外，需要留心的是，haproxy会为每个连接维持两个缓冲，每个缓冲的大小为8KB，再加上其它的数据，每个连接将大约占用17KB的RAM空间。这意味着经过适当优化后，有着1GB的可用RAM空间时将能维护40000-50000并发连接。</conns></p>
<p>如果为指定了一个过大值，极端场景下，其最终占据的空间可能会超出当前主机的可用内存，这可能会带来意想不到的结果；因此，将其设定了一个可接受值方为明智决定。其默认为2000。</p>
<p>7.default_backend</p>
<p>格式：</p>
<p>default_backend <backend><br>在没有匹配的”use_backend”规则时为实例指定使用的默认后端，因此，其不可应用于backend区段。在”frontend”和”backend”之间进行内容交换时，通常使用”use-backend”定义其匹配规则；而没有被规则匹配到的请求将由此参数指定的后端接收。 </backend></p>
<p><backend>：指定使用的后端的名称；<br>使用案例：</backend></p>
<p>use_backend     dynamic  if  url_dyn<br>use_backend     static   if  url_css url_img extension_img<br>default_backend dynamic<br>8.server</p>
<p>格式：</p>
<p>server <name> <address>[:port] [param*]<br>为后端声明一个server，因此，不能用于defaults和frontend区段。 </address></name></p>
<p><name>：为此服务器指定的内部名称，其将出现在日志及警告信息中；如果设定了”http-send-server-name”，它还将被添加至发往此服务器的请求首部中； </name></p>
<p><address>：此服务器的的IPv4地址，也支持使用可解析的主机名，只不过在启动时需要解析主机名至相应的IPv4地址；<br>[:port]：指定将连接请求所发往的此服务器时的目标端口，其为可选项；未设定时，将使用客户端请求时的同一相端口；<br>[param*]：为此服务器设定的一系参数；其可用的参数非常多，具体请参考官方文档中的说明，下面仅说明几个常用的参数；</address></p>
<p>服务器或默认服务器参数：</p>
<p>backup：设定为备用服务器，仅在负载均衡场景中的其它server均不可用于启用此server；</p>
<p>check：启动对此server执行健康状态检查，其可以借助于额外的其它参数完成更精细的设定，如：</p>
<blockquote>
<p>inter <delay>：设定健康状态检查的时间间隔，单位为毫秒，默认为2000；也可以使用fastinter和downinter来根据服务器端状态优化此时间延迟；<br>rise <count>：设定健康状态检查中，某离线的server从离线状态转换至正常状态需要成功检查的次数；<br>fall <count>：确认server从正常状态转换为不可用状态需要检查的次数；</count></count></delay></p>
</blockquote>
<p>cookie <value>：为指定server设定cookie值，此处指定的值将在请求入站时被检查，第一次为此值挑选的server将在后续的请求中被选中，其目的在于实现持久连接的功能；<br>maxconn <maxconn>：指定此服务器接受的最大并发连接数；如果发往此服务器的连接数目高于此处指定的值，其将被放置于请求队列，以等待其它连接被释放；<br>maxqueue <maxqueue>：设定请求队列的最大长度；<br>observe <mode>：通过观察服务器的通信状况来判定其健康状态，默认为禁用，其支持的类型有“layer4”和“layer7”，“layer7”仅能用于http代理场景；<br>redir <prefix>：启用重定向功能，将发往此服务器的GET和HEAD请求均以302状态码响应；需要注意的是，在prefix后面不能使用/，且不能使用相对地址，以免造成循环；例如：server srv1 172.16.100.6:80 redir <a href="http://imageserver.test.com" target="_blank" rel="noopener">http://imageserver.test.com</a> check </prefix></mode></maxqueue></maxconn></value></p>
<p>weight <weight>：权重，默认为1，最大值为256，0表示不参与负载均衡；</weight></p>
<p>检查方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">option httpchk    </span><br><span class="line">option httpchk &lt;uri&gt;    </span><br><span class="line">option httpchk &lt;method&gt; &lt;uri&gt;    </span><br><span class="line">option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt;：不能用于frontend段，例如：</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backend https_relay</span><br><span class="line">    mode tcp</span><br><span class="line">    option httpchk OPTIONS * HTTP/1.1\r\nHost:\ www.test.com</span><br><span class="line">    server apache1 192.168.1.1:443 check port 80</span><br></pre></td></tr></table></figure>
<p>使用案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server first  172.16.100.7:1080 cookie first  check inter 1000</span><br><span class="line">server second 172.16.100.8:1080 cookie second check inter 1000</span><br></pre></td></tr></table></figure>
<p>9.capture request header</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">capture request header &lt;name&gt; len &lt;length&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>捕获并记录指定的请求首部最近一次出现时的第一个值，仅能用于“frontend”和“listen”区段。捕获的首部值使用花括号{}括起来后添加进日志中。如果需要捕获多个首部值，它们将以指定的次序出现在日志文件中，并以竖线“|”作为分隔符。不存在的首部记录为空字符串，最常需要捕获的首部包括在虚拟主机环境中使用的“Host”、上传请求首部中的“Content-length”、快速区别真实用户和网络机器人的“User-agent”，以及代理环境中记录真实请求来源的“X-Forward-For”。</p>
</blockquote>
<p><name>：要捕获的首部的名称，此名称不区分字符大小写，但建议与它们出现在首部中的格式相同，比如大写首字母。需要注意的是，记录在日志中的是首部对应的值，而非首部名称。 </name></p>
<p><length>：指定记录首部值时所记录的精确长度，超出的部分将会被忽略。<br>可以捕获的请求首部的个数没有限制，但每个捕获最多只能记录64个字符。为了保证同一个frontend中日志格式的统一性，首部捕获仅能在frontend中定义。</length></p>
<p>10.capture response header</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">capture response header &lt;name&gt; len &lt;length&gt;</span><br></pre></td></tr></table></figure>
<p>捕获并记录响应首部，其格式和要点同请求首部。</p>
<p>11.stats enable</p>
<p>格式：<br>启用基于程序编译时默认设置的统计报告，不能用于“frontend”区段。只要没有另外的其它设定，它们就会使用如下的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stats uri   : /haproxy?stats</span><br><span class="line">stats realm : &quot;HAProxy Statistics&quot;</span><br><span class="line">stats auth  : no authentication</span><br><span class="line">stats scope : no restriction</span><br></pre></td></tr></table></figure>
<p>尽管“stats enable”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而带来非期后果。下面是一个配置案例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">backend public_www</span><br><span class="line">  server websrv1 172.16.100.11:80</span><br><span class="line">  stats enable</span><br><span class="line">  stats hide-version</span><br><span class="line">  stats scope   .</span><br><span class="line">  stats uri     /haproxyadmin?stats</span><br><span class="line">  stats realm   Haproxy\ Statistics</span><br><span class="line">  stats auth    statsadmin:password</span><br><span class="line">  stats auth    statsmaster:password</span><br></pre></td></tr></table></figure>
<p>12.stats hide-version</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats hide-version</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启用统计报告并隐藏HAProxy版本报告，不能用于“frontend”区段。默认情况下，统计页面会显示一些有用信息，包括HAProxy的版本号，然而，向所有人公开HAProxy的精确版本号是非常有风险的，因为它能帮助恶意用户快速定位版本的缺陷和漏洞。尽管“stats hide-version”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而带来非期后果。具体请参照“stats enable”一节的说明。</p>
</blockquote>
<p>13.stats realm</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats realm &lt;realm&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启用统计报告并高精认证领域，不能用于“frontend”区段。haproxy在读取realm时会将其视作一个单词，因此，中间的任何空白字符都必须使用反斜线进行转义。此参数仅在与“stats auth”配置使用时有意义。</p>
</blockquote>
<p><realm>：实现HTTP基本认证时显示在浏览器中的领域名称，用于提示用户输入一个用户名和密码。<br>尽管“stats realm”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而带来非期后果。具体请参照“stats enable”一节的说明。</realm></p>
<p>14.stats scope</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats scope &#123; &lt;name&gt; | &quot;.&quot; &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启用统计报告并限定报告的区段，不能用于“frontend”区段。当指定此语句时，统计报告将仅显示其列举出区段的报告信息，所有其它区段的信息将被隐藏。如果需要显示多个区段的统计报告，此语句可以定义多次。需要注意的是，区段名称检测仅仅是以字符串比较的方式进行，它不会真检测指定的区段是否真正存在。</p>
</blockquote>
<p><name>：可以是一个“listen”、“frontend”或“backend”区段的名称，而“.”则表示stats scope语句所定义的当前区段。<br>尽管“stats scope”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而带来非期后果。下面是一个配置案例。</name></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backend private_monitoring</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri     /haproxyadmin?stats</span><br><span class="line">    stats refresh 10s</span><br></pre></td></tr></table></figure>
<p>15.stats auth</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats auth &lt;user&gt;:&lt;passwd&gt;</span><br></pre></td></tr></table></figure>
<p>启用带认证的统计报告功能并授权一个用户帐号，其不能用于“frontend”区段。 </p>
<p><user>：授权进行访问的用户名； </user></p>
<p><passwd>：此用户的访问密码，明文格式；</passwd></p>
<blockquote>
<p>此语句将基于默认设定启用统计报告功能，并仅允许其定义的用户访问，其也可以定义多次以授权多个用户帐号。可以结合“stats realm”参数在提示用户认证时给出一个领域说明信息。在使用非法用户访问统计功能时，其将会响应一个“401 Forbidden”页面。其认证方式为HTTP Basic认证，密码传输会以明文方式进行，因此，配置文件中也使用明文方式存储以说明其非保密信息故此不能相同于其它关键性帐号的密码。<br>尽管“stats auth”一条就能够启用统计报告，但还是建议设定其它所有的参数，以免其依赖于默认设定而带来非期后果。</p>
</blockquote>
<p>16.stats admin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stats admin &#123; if | unless &#125; &lt;cond&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在指定的条件满足时启用统计报告页面的管理级别功能，它允许通过web接口启用或禁用服务器，不过，基于安全的角度考虑，统计报告页面应该尽可能为只读的。此外，如果启用了HAProxy的多进程模式，启用此管理级别将有可能导致异常行为。<br>目前来说，POST请求方法被限制于仅能使用缓冲区减去保留部分之外的空间，因此，服务器列表不能过长，否则，此请求将无法正常工作。因此，建议一次仅调整少数几个服务器。下面是两个案例，第一个限制了仅能在本机打开报告页面时启用管理级别功能，第二个定义了仅允许通过认证的用户使用管理级别功能。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">backend stats_localhost</span><br><span class="line">    stats enable</span><br><span class="line">    stats admin if LOCALHOST</span><br><span class="line">backend stats_auth</span><br><span class="line">    stats enable</span><br><span class="line">    stats auth  haproxyadmin:password</span><br><span class="line">    stats admin if TRUE</span><br></pre></td></tr></table></figure>
<p>17.option httplog</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option httplog [ clf ]</span><br></pre></td></tr></table></figure>
<p>启用记录HTTP请求、会话状态和计时器的功能。<br>clf：使用CLF格式来代替HAProxy默认的HTTP格式，通常在使用仅支持CLF格式的特定日志分析器时才需要使用此格式。</p>
<blockquote>
<p>默认情况下，日志输入格式非常简陋，因为其仅包括源地址、目标地址和实例名称，而“option httplog”参数将会使得日志格式变得丰富许多，其通常包括但不限于HTTP请求、连接计时器、会话状态、连接数、捕获的首部及cookie、“frontend”、“backend”及服务器名称，当然也包括源地址和端口号等。</p>
</blockquote>
<p>18.option logasap</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">option logasap   </span><br><span class="line">no option logasap</span><br></pre></td></tr></table></figure>
<p>启用或禁用提前将HTTP请求记入日志，不能用于“backend”区段。</p>
<blockquote>
<p>默认情况下，HTTP请求是在请求结束时进行记录以便能将其整体传输时长和字节数记入日志，由此，传较大的对象时，其记入日志的时长可能会略有延迟。“option logasap”参数能够在服务器发送complete首部时即时记录日志，只不过，此时将不记录整体传输时长和字节数。此情形下，捕获“Content-Length”响应首部来记录传输的字节数是一个较好选择。下面是一个例子。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listen http_proxy 0.0.0.0:80</span><br><span class="line">    mode http</span><br><span class="line">    option httplog</span><br><span class="line">    option logasap</span><br><span class="line">    log 172.16.100.9 local2</span><br></pre></td></tr></table></figure>
<p>19.option forwardfor</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option forwardfor [ except &lt;network&gt; ] [ header &lt;name&gt; ] [ if-none ]</span><br></pre></td></tr></table></figure>
<p>允许在发往服务器的请求首部中插入“X-Forwarded-For”首部。 </p>
<p><network>：可选参数，当指定时，源地址为匹配至此网络中的请求都禁用此功能。 </network></p>
<p><name>：可选参数，可使用一个自定义的首部，如“X-Client”来替代“X-Forwarded-For”。有些独特的web服务器的确需要用于一个独特的首部。<br>if-none：仅在此首部不存在时才将其添加至请求报文问道中。</name></p>
<blockquote>
<p>HAProxy工作于反向代理模式，其发往服务器的请求中的客户端IP均为HAProxy主机的地址而非真正客户端的地址，这会使得服务器端的日志信息记录不了真正的请求来源，“X-Forwarded-For”首部则可用于解决此问题。HAProxy可以向每个发往服务器的请求上添加此首部，并以客户端IP为其value。</p>
</blockquote>
<p>需要注意的是，HAProxy工作于隧道模式，其仅检查每一个连接的第一个请求，因此，仅第一个请求报文被附加此首部。如果想为每一个请求都附加此首部，请确保同时使用了“option httpclose”、“option forceclose”和“option http-server-close”几个option。</p>
<p>下面是一个例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">frontend www</span><br><span class="line">    mode http</span><br><span class="line">    option forwardfor except 127.0.0.1</span><br></pre></td></tr></table></figure>
<p>20.errorfile</p>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errorfile &lt;code&gt; &lt;file&gt;</span><br></pre></td></tr></table></figure>
<p>在用户请求不存在的页面时，返回一个页面文件给客户端而非由haproxy生成的错误代码；可用于所有段中。<br><code>：指定对HTTP的哪些状态码返回指定的页面；这里可用的状态码有200、400、403、408、500、502、503和504； </code></p>
<p><file>：指定用于响应的页面文件；<br>例如：</file></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">errorfile 400 /etc/haproxy/errorpages/400badreq.http</span><br><span class="line">errorfile 403 /etc/haproxy/errorpages/403forbid.http</span><br><span class="line">errorfile 503 /etc/haproxy/errorpages/503sorry.http</span><br><span class="line">21.errorloc 和 errorloc302</span><br></pre></td></tr></table></figure>
<p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">errorloc &lt;code&gt; &lt;url&gt;   </span><br><span class="line">errorloc302 &lt;code&gt; &lt;url&gt;</span><br></pre></td></tr></table></figure>
<p>请求错误时，返回一个HTTP重定向至某URL的信息；可用于所有配置段中。<br><code>：指定对HTTP的哪些状态码返回指定的页面；这里可用的状态码有200、400、403、408、500、502、503和504； </code></p>
<p><url>：Location首部中指定的页面位置的具体路径，可以是在当前服务器上的页面的相对路径，也可以使用绝对路径；需要注意的是，如果URI自身错误时产生某特定状态码信息的话，有可能会导致循环定向；</url></p>
<p>需要留意的是，这两个关键字都会返回302状态吗，这将使得客户端使用同样的HTTP方法获取指定的URL，对于非GET法的场景(如POST)来说会产生问题，因为返回客户的URL是不允许使用GET以外的其它方法的。如果的确有这种问题，可以使用errorloc303来返回303状态码给客户端。</p>
<p>22.errorloc303</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errorloc303 &lt;code&gt; &lt;url&gt;</span><br></pre></td></tr></table></figure>
<p>请求错误时，返回一个HTTP重定向至某URL的信息给客户端；可用于所有配置段中。<br><code>：指定对HTTP的哪些状态码返回指定的页面；这里可用的状态码有400、403、408、500、502、503和504； </code></p>
<p><url>：Location首部中指定的页面位置的具体路径，可以是在当前服务器上的页面的相对路径，也可以使用绝对路径；需要注意的是，如果URI自身错误时产生某特定状态码信息的话，有可能会导致循环定向；</url></p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">backend webserver</span><br><span class="line">  server 172.16.100.6 172.16.100.6:80 check maxconn 3000 cookie srv01</span><br><span class="line">  server 172.16.100.7 172.16.100.7:80 check maxconn 3000 cookie srv02</span><br><span class="line">  errorloc 403 /etc/haproxy/errorpages/sorry.htm</span><br><span class="line">  errorloc 503 /etc/haproxy/errorpages/sorry.htm</span><br></pre></td></tr></table></figure>
<p>option http-request 访问控制<br>option http-server-close：允许服务器端关闭连接；<br>option dontlognull：访问内容为空的不记录日志；<br>option redispatch：在session失败后，是否允许重新分配；<br>retries：用于haproxy到后端server连接失败时重试次数；<br>option httplog：启用记录HTTP请求、会话状态和计时器的功能；<br>option forwardfor：允许在发往服务器的请求首部中插入“X-Forwarded-For”首部；</p>
<h2 id="HAproxy的ACL详解"><a href="#HAproxy的ACL详解" class="headerlink" title="# HAproxy的ACL详解"></a># HAproxy的ACL详解</h2><p>haproxy的ACL用于实现基于请求报文的首部、响应报文的内容或其它的环境状态信息来做出转发决策，这大大增强了其配置弹性。其配置法则通常分为两步，首先去定义ACL，即定义一个测试条件，而后在条件得到满足时执行某特定的动作，如阻止请求或转发至某特定的后端。定义ACL的语法格式如下。<br>acl <aclname> <criterion> [flags] [operator] <value> …</value></criterion></aclname></p>
<p><aclname>：ACL名称，区分字符大小写，且其只能包含大小写字母、数字、-(连接线)、_(下划线)、.(点号)和:(冒号)；haproxy中，acl可以重名，这可以把多个测试条件定义为一个共同的acl； </aclname></p>
<p><criterion>：测试标准，即对什么信息发起测试；测试方式可以由[flags]指定的标志进行调整；而有些测试标准也可以需要为其在之前指定一个操作符[operator]；<br>[flags]：目前haproxy的acl支持的标志位有3个：</criterion></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-i：不区分&lt;value&gt;中模式字符的大小写；</span><br><span class="line">-f：从指定的文件中加载模式；</span><br><span class="line">--：标志符的强制结束标记，在模式中的字符串像标记符时使用；</span><br></pre></td></tr></table></figure>
<p><value>：acl测试条件支持的值有以下四类：<br>1、整数或整数范围：如1024:65535表示从1024至65535；仅支持使用正整数(如果出现类似小数的标识，其为通常为版本测试)，且支持使用的操作符有5个，分别为eq、ge、gt、le和lt；<br>2、字符串：支持使用“-i”以忽略字符大小写，支持使用“\”进行转义；如果在模式首部出现了-i，可以在其之前使用“–”标志位；<br>3、正则表达式：其机制类同字符串匹配；<br>4、IP地址及网络地址</value></p>
<blockquote>
<p>同一个acl中可以指定多个测试条件，这些测试条件需要由逻辑操作符指定其关系。条件间的组合测试关系有三种：“与”(默认即为与操作)、“或”(使用“||”操作符)以及“非”(使用“!”操作符)。</p>
</blockquote>
<p>常用的测试标准(criteria)</p>
<p>be_sess_rate <integer></integer></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">be_sess_rate(backend) &lt;integer&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>用于测试指定的backend上会话创建的速率(即每秒创建的会话数)是否满足指定的条件；常用于在指定backend上的会话速率过高时将用户请求转发至另外的backend，或用于阻止攻击行为。例如：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backend dynamic</span><br><span class="line">    mode http</span><br><span class="line">    acl being_scanned be_sess_rate gt 50</span><br><span class="line">    redirect location /error_pages/denied.html if being_scanned</span><br></pre></td></tr></table></figure>
<p>fe_sess_rate <integer></integer></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fe_sess_rate(frontend) &lt;integer&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>用于测试指定的frontend(或当前frontend)上的会话创建速率是否满足指定的条件；常用于为frontend指定一个合理的会话创建速率的上限以防止服务被滥用。例如下面的例子限定入站邮件速率不能大于50封/秒，所有在此指定范围之外的请求都将被延时50毫秒。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frontend mail</span><br><span class="line">    bind :25</span><br><span class="line">    mode tcp</span><br><span class="line">    maxconn 500</span><br><span class="line">    acl too_fast fe_sess_rate ge 50</span><br><span class="line">    tcp-request inspect-delay 50ms</span><br><span class="line">    tcp-request content accept if ! too_fast</span><br><span class="line">    tcp-request content accept if WAIT_END</span><br></pre></td></tr></table></figure>
<p>hdr <string></string></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdr(header) &lt;string&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>用于测试请求报文中的所有首部或指定首部是否满足指定的条件；指定首部时，其名称不区分大小写，且在括号“()”中不能有任何多余的空白字符。测试服务器端的响应报文时可以使用shdr()。例如下面的例子用于测试首部Connection的值是否为close。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdr(Connection) -i close</span><br></pre></td></tr></table></figure>
<p>method <string></string></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method &lt;string&gt;</span><br></pre></td></tr></table></figure>
<p>测试HTTP请求报文中使用的方法。<br>path_beg <string></string></p>
<blockquote>
<p>用于测试请求的URL是否以指定的模式开头。下面的例子用于测试URL是否以/static、/images、/javascript或/stylesheets头。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acl url_static       path_beg       -i /static /images /javascript /stylesheets</span><br></pre></td></tr></table></figure>
<p>path_end <string></string></p>
<blockquote>
<p>用于测试请求的URL是否以指定的模式结尾。例如，下面的例子用户测试URL是否以jpg、gif、png、css或js结尾。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acl url_static       path_end       -i .jpg .gif .png .css .js</span><br></pre></td></tr></table></figure>
<p>hdr_beg <string></string></p>
<blockquote>
<p>用于测试请求报文的指定首部的开头部分是否符合指定的模式。例如，下面的例子用记测试请求是否为提供静态内容的主机img、video、download或ftp。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acl host_static hdr_beg(host) -i img. video. download. ftp.</span><br></pre></td></tr></table></figure>
<p>hdr_end <string></string></p>
<blockquote>
<p>用于测试请求报文的指定首部的结尾部分是否符合指定的模式。例如，下面的例子用记测试请求是否为</p>
</blockquote>
<h2 id="ACL案例"><a href="#ACL案例" class="headerlink" title="ACL案例"></a>ACL案例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">########ACL策略定义#########################</span><br><span class="line">1、#如果请求的域名满足正则表达式返回true -i是忽略大小写</span><br><span class="line">acl denali_policy hdr_reg(host) -i ^(www.inbank.com|image.inbank.com)$</span><br><span class="line"></span><br><span class="line">2、#如果请求域名满足www.inbank.com 返回 true -i是忽略大小写</span><br><span class="line">acl tm_policy hdr_dom(host) -i www.inbank.com</span><br><span class="line"></span><br><span class="line">3、#在请求url中包含sip_apiname=，则此控制策略返回true,否则为false</span><br><span class="line">acl invalid_req url_sub -i sip_apiname=#定义一个名为invalid_req的策略</span><br><span class="line"></span><br><span class="line">4、#在请求url中存在timetask作为部分地址路径，则此控制策略返回true,否则返回false</span><br><span class="line">acl timetask_req url_dir -i timetask</span><br><span class="line"></span><br><span class="line">5、#当请求的header中Content-length等于0时返回 true</span><br><span class="line">acl missing_cl hdr_cnt(Content-length) eq 0</span><br><span class="line"></span><br><span class="line">#########acl策略匹配相应###################</span><br><span class="line">1、#当请求中header中Content-length等于0 阻止请求返回403</span><br><span class="line">block if missing_cl</span><br><span class="line"></span><br><span class="line">2、#block表示阻止请求，返回403错误，当前表示如果不满足策略invalid_req，或者满足策略timetask_req，则阻止请求。</span><br><span class="line">block if !invalid_req || timetask_req</span><br><span class="line"></span><br><span class="line">3、#当满足denali_policy的策略时使用denali_server的backend</span><br><span class="line">use_backend denali_server if denali_policy</span><br><span class="line"></span><br><span class="line">4、#当满足tm_policy的策略时使用tm_server的backend</span><br><span class="line">use_backend tm_server if tm_policy</span><br><span class="line"></span><br><span class="line">5、#reqisetbe关键字定义，根据定义的关键字选择backend</span><br><span class="line">reqisetbe ^Host:\ img dynamic</span><br><span class="line">reqisetbe ^[^\ ]*\ /(img|css)/ dynamic</span><br><span class="line">reqisetbe ^[^\ ]*\ /admin/stats stats</span><br><span class="line"></span><br><span class="line">6、#以上都不满足的时候使用默认mms_server的backend</span><br><span class="line">default_backend mms</span><br></pre></td></tr></table></figure>
<h3 id="一份haproxy配置文件的详解"><a href="#一份haproxy配置文件的详解" class="headerlink" title="一份haproxy配置文件的详解"></a>一份haproxy配置文件的详解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">###########全局配置#########</span><br><span class="line">global</span><br><span class="line">　　log 127.0.0.1 local0 #[日志输出配置，所有日志都记录在本机，通过local0输出]</span><br><span class="line">　　log 127.0.0.1 local1 notice #定义haproxy 日志级别[error warringinfo debug]</span><br><span class="line">　　daemon #以后台形式运行harpoxy</span><br><span class="line">　　nbproc 1 #设置进程数量</span><br><span class="line">　　maxconn 4096 #默认最大连接数,需考虑ulimit-n限制</span><br><span class="line">　　#user haproxy #运行haproxy的用户</span><br><span class="line">　　#group haproxy #运行haproxy的用户所在的组</span><br><span class="line">　　#pidfile /var/run/haproxy.pid #haproxy 进程PID文件</span><br><span class="line">　　#ulimit-n 819200 #ulimit 的数量限制</span><br><span class="line">　　#chroot /usr/share/haproxy #chroot运行路径</span><br><span class="line">　　#debug #haproxy 调试级别，建议只在开启单进程的时候调试</span><br><span class="line">　　#quiet</span><br><span class="line"></span><br><span class="line">########默认配置############</span><br><span class="line">defaults</span><br><span class="line">　　log global</span><br><span class="line">　　mode http #默认的模式mode &#123; tcp|http|health &#125;，tcp是4层，http是7层，health只会返回OK</span><br><span class="line">　　option httplog #日志类别,采用httplog</span><br><span class="line">　　option dontlognull #不记录健康检查日志信息</span><br><span class="line">　　retries 2 #两次连接失败就认为是服务器不可用，也可以通过后面设置</span><br><span class="line">　　#option forwardfor #如果后端服务器需要获得客户端真实ip需要配置的参数，可以从Http Header中获得客户端ip</span><br><span class="line">　　option httpclose #每次请求完毕后主动关闭http通道,haproxy不支持keep-alive,只能模拟这种模式的实现</span><br><span class="line">　　#option redispatch #当serverId对应的服务器挂掉后，强制定向到其他健康的服务器，以后将不支持</span><br><span class="line">　　option abortonclose #当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接</span><br><span class="line">　　maxconn 4096 #默认的最大连接数</span><br><span class="line">　　timeout connect 5000ms #连接超时</span><br><span class="line">　　timeout client 30000ms #客户端超时</span><br><span class="line">　　timeout server 30000ms #服务器超时</span><br><span class="line">　　#timeout check 2000 #心跳检测超时</span><br><span class="line">　　#timeout http-keep-alive10s #默认持久连接超时时间</span><br><span class="line">　　#timeout http-request 10s #默认http请求超时时间</span><br><span class="line">　　#timeout queue 1m #默认队列超时时间</span><br><span class="line">　　balance roundrobin #设置默认负载均衡方式，轮询方式</span><br><span class="line">　　#balance source #设置默认负载均衡方式，类似于nginx的ip_hash</span><br><span class="line">　　#balnace leastconn #设置默认负载均衡方式，最小连接数</span><br><span class="line"></span><br><span class="line">########统计页面配置########</span><br><span class="line">listen stats</span><br><span class="line">　　bind 0.0.0.0:1080 #设置Frontend和Backend的组合体，监控组的名称，按需要自定义名称</span><br><span class="line">　　mode http #http的7层模式</span><br><span class="line">　　option httplog #采用http日志格式</span><br><span class="line">　　#log 127.0.0.1 local0 err #错误日志记录</span><br><span class="line">　　maxconn 10 #默认的最大连接数</span><br><span class="line">　　stats refresh 30s #统计页面自动刷新时间</span><br><span class="line">　　stats uri /stats #统计页面url</span><br><span class="line">　　stats realm XingCloud\ Haproxy #统计页面密码框上提示文本</span><br><span class="line">　　stats auth admin:admin #设置监控页面的用户和密码:admin,可以设置多个用户名</span><br><span class="line">　　stats auth Frank:Frank #设置监控页面的用户和密码：Frank</span><br><span class="line">　　stats hide-version #隐藏统计页面上HAProxy的版本信息</span><br><span class="line">　　stats admin if TRUE #设置手工启动/禁用，后端服务器(haproxy-1.4.9以后版本)</span><br><span class="line"></span><br><span class="line">########设置haproxy 错误页面#####</span><br><span class="line">#errorfile 403 /home/haproxy/haproxy/errorfiles/403.http</span><br><span class="line">#errorfile 500 /home/haproxy/haproxy/errorfiles/500.http</span><br><span class="line">#errorfile 502 /home/haproxy/haproxy/errorfiles/502.http</span><br><span class="line">#errorfile 503 /home/haproxy/haproxy/errorfiles/503.http</span><br><span class="line">#errorfile 504 /home/haproxy/haproxy/errorfiles/504.http</span><br><span class="line"></span><br><span class="line">########frontend前端配置##############</span><br><span class="line">frontend main</span><br><span class="line">　　bind *:80 #这里建议使用bind *:80的方式，要不然做集群高可用的时候有问题，vip切换到其他机器就不能访问了。</span><br><span class="line">　　acl web hdr(host) -i www.abc.com  #acl后面是规则名称，-i为忽略大小写，后面跟的是要访问的域名，如果访问www.abc.com这个域名，就触发web规则，。</span><br><span class="line">　　acl img hdr(host) -i img.abc.com  #如果访问img.abc.com这个域名，就触发img规则。</span><br><span class="line">　　use_backend webserver if web   #如果上面定义的web规则被触发，即访问www.abc.com，就将请求分发到webserver这个作用域。</span><br><span class="line">　　use_backend imgserver if img   #如果上面定义的img规则被触发，即访问img.abc.com，就将请求分发到imgserver这个作用域。</span><br><span class="line">　　default_backend dynamic #不满足则响应backend的默认页面</span><br><span class="line"></span><br><span class="line">########backend后端配置##############</span><br><span class="line">backend webserver #webserver作用域</span><br><span class="line">　　mode http</span><br><span class="line">　　balance roundrobin #balance roundrobin 负载轮询，balance source 保存session值，支持static-rr，leastconn，first，uri等参数</span><br><span class="line">　　option httpchk /index.html HTTP/1.0 #健康检查, 检测文件，如果分发到后台index.html访问不到就不再分发给它</span><br><span class="line">　　server web1 10.16.0.9:8085 cookie 1 weight 5 check inter 2000 rise 2 fall 3</span><br><span class="line">　　server web2 10.16.0.10:8085 cookie 2 weight 3 check inter 2000 rise 2 fall 3</span><br><span class="line">　　#cookie 1表示serverid为1，check inter 1500 是检测心跳频率 </span><br><span class="line">　　#rise 2是2次正确认为服务器可用，fall 3是3次失败认为服务器不可用，weight代表权重</span><br><span class="line"></span><br><span class="line">backend imgserver</span><br><span class="line">　　mode http</span><br><span class="line">　　option httpchk /index.php</span><br><span class="line">　　balance roundrobin </span><br><span class="line">　　server img01 192.168.137.101:80 check inter 2000 fall 3</span><br><span class="line">　　server img02 192.168.137.102:80 check inter 2000 fall 3</span><br><span class="line"></span><br><span class="line">backend dynamic </span><br><span class="line">　　balance roundrobin </span><br><span class="line">　　server test1 192.168.1.23:80 check maxconn 2000 </span><br><span class="line">　　server test2 192.168.1.24:80 check maxconn 2000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">listen tcptest </span><br><span class="line">　　bind 0.0.0.0:5222 </span><br><span class="line">　　mode tcp </span><br><span class="line">　　option tcplog #采用tcp日志格式 </span><br><span class="line">　　balance source </span><br><span class="line">　　#log 127.0.0.1 local0 debug </span><br><span class="line">　　server s1 192.168.100.204:7222 weight 1 </span><br><span class="line">　　server s2 192.168.100.208:7222 weight 1</span><br></pre></td></tr></table></figure>
<h1 id="HAproxy实例"><a href="#HAproxy实例" class="headerlink" title="HAproxy实例"></a>HAproxy实例</h1><h2 id="案例1：定义独立日志文件"><a href="#案例1：定义独立日志文件" class="headerlink" title="案例1：定义独立日志文件"></a>案例1：定义独立日志文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 haproxy]# vim /etc/rsyslog.conf #为其添加日志功能</span><br><span class="line"># Provides UDP syslog reception</span><br><span class="line">$ModLoad imudp</span><br><span class="line">$UDPServerRun 514 ------&gt;启动udp，启动端口后将作为服务器工作</span><br><span class="line"># Provides TCP syslog reception</span><br><span class="line">$ModLoad imtcp</span><br><span class="line">$InputTCPServerRun 514 ------&gt;启动tcp监听端口</span><br><span class="line">local2.* /var/log/haproxy.log</span><br><span class="line"></span><br><span class="line">[root@node1 haproxy]# service rsyslog restar</span><br><span class="line">[root@LB haproxy]# vim haproxy.cfg</span><br><span class="line">log 127.0.0.1 local2 ---------&gt;在global端中添加此行</span><br></pre></td></tr></table></figure>
<h2 id="案例2：haproxy统计页面的输出机制"><a href="#案例2：haproxy统计页面的输出机制" class="headerlink" title="案例2：haproxy统计页面的输出机制"></a>案例2：haproxy统计页面的输出机制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">listen statistics</span><br><span class="line">bind *:8009 # 自定义监听端口</span><br><span class="line">stats enable # 启用基于程序编译时默认设置的统计报告</span><br><span class="line">stats auth admin:admin # 统计页面用户名和密码设置</span><br><span class="line">stats uri /admin?stats # 自定义统计页面的URL，默认为/haproxy?stats</span><br><span class="line">stats hide-version # 隐藏统计页面上HAProxy的版本信息</span><br><span class="line">stats refresh 30s # 统计页面自动刷新时间</span><br><span class="line">stats admin if TRUE #如果认证通过就做管理功能，可以管理后端的服务器</span><br><span class="line">stats realm Hapadmin # 统计页面密码框上提示文本，默认为Haproxy\ Statistics</span><br></pre></td></tr></table></figure>
<h2 id="案例3：动静分离示例："><a href="#案例3：动静分离示例：" class="headerlink" title="案例3：动静分离示例："></a>案例3：动静分离示例：</h2><p>1、在两台机器上面同样在网站根目录下准备一个index.html和index.php </p>
<p>2、实现功能访问.html后缀的只能访问128，访问.php结尾访问140</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">frontend webservs</span><br><span class="line">    bind *:80</span><br><span class="line">    acl url_static path_beg -i /static /images /javascript /stylesheets</span><br><span class="line">    acl url_static path_end -i .jpg .gif .png .css .js .html</span><br><span class="line">    acl url_php path_end -i .php</span><br><span class="line">    acl host_static hdr_beg(host) -i img. imgs. video. videos. ftp. image. download.</span><br><span class="line">    use_backend static if url_static or host_static</span><br><span class="line">    use_backend dynamic if url_php</span><br><span class="line">    default_backend dynamic</span><br><span class="line">backend dynamic</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server node2 192.168.211.140:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br><span class="line">backend static</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server node1 192.168.211.128:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br></pre></td></tr></table></figure>
<h2 id="案例4：实现web负载"><a href="#案例4：实现web负载" class="headerlink" title="案例4：实现web负载"></a>案例4：实现web负载</h2><p>1、node1安装http和测试页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web1 ~]# yum -y install httpd</span><br><span class="line">[root@web1 ~]# cd /var/www/html/</span><br><span class="line">[root@web1 html]# echo &quot;&lt;h1&gt;Server WWW node1&lt;/h1&gt;&quot; &gt; index.html</span><br></pre></td></tr></table></figure>
<p>2、node2安装http和测试页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web2 ~]# yum -y install httpd</span><br><span class="line">[root@web2 ~]# cd /var/www/html/</span><br><span class="line">[root@web2 html]# echo &quot;&lt;h1&gt;Server WWW node2&lt;/h1&gt;&quot; &gt; index.html</span><br></pre></td></tr></table></figure>
<p>3、haproxy安装配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HAproxy ~]# yum -y groupinstall &quot;Development Tools&quot;</span><br><span class="line">[root@HAproxy ~]# yum -y install haproxy</span><br></pre></td></tr></table></figure>
<p>4、配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@HAproxy ~]# cat /etc/haproxy/haproxy.cfg </span><br><span class="line">......主要配置函数</span><br><span class="line">listen stats   #监控页面</span><br><span class="line">    mode http</span><br><span class="line">    bind 0.0.0.0:1080</span><br><span class="line">    stats enable</span><br><span class="line">    stats hide-version</span><br><span class="line">    stats uri     /haproxyadmin?stats</span><br><span class="line">    stats realm   Haproxy\ Statistics</span><br><span class="line">    stats auth    admin:admin</span><br><span class="line">    stats admin if TRUE</span><br><span class="line">frontend main  #定义服务器组</span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend server</span><br><span class="line">backend server  #定义服务器</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    option httpchk HEAD /index.html HTTP/1.0</span><br><span class="line">    server node1 192.168.211.140:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br><span class="line">    server node2 192.168.211.128:80 cookie 1 weight 5 check inter 2000 rise 1 fall 1</span><br></pre></td></tr></table></figure>
<p>5、查看监控页面</p>
<p>6、测试</p>
<h2 id="案例5：负载均衡MySQL服务"><a href="#案例5：负载均衡MySQL服务" class="headerlink" title="案例5：负载均衡MySQL服务"></a>案例5：负载均衡MySQL服务</h2><pre><code>frontend mysql
    bind *:3306
    mode tcp
    log global
    default_backend mysqlservers
backend mysqlservers
    balance leastconn
    server dbsrv1 192.168.211.140:3306 check port 3306 intval 2 rise 1 fall 2 maxconn 300
    server dbsrv2 192.168.211.128:3306 check port 3306 intval 2 rise 1 fall 2 maxconn 300
</code></pre>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HAProxy/">HAProxy</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-生病的这段日子" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/11/生病的这段日子/" class="article-date">
      <time datetime="2017-11-11T08:27:43.000Z" itemprop="datePublished">2017-11-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/11/生病的这段日子/">生病的这段日子</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>生病的这段日子</p>
<p>2017.10.21~</p>
<p>2017.10.21 星期六早上大概3点多。肚子突然就疼起来了。起初以为吃坏了肚子。肠炎而已。就忍着疼一直到天亮还是疼。大概10点多吧。去了住的地方路口的小诊所。给医生说自己肚子疼，可能是肠炎。然后医生就给输液，然后贴肚子的。起初好转很多也不疼了。等输液输完。贴肚子的使用完后。过了一会儿依然疼。给医生说。医生又给的阿莫西林和止疼药。同时医生说你去大医院检查一下吧、在诊所吃了阿莫西林和止疼药。休息了一会儿。还是疼。就回住处了。晚上喝了一点纯牛奶。疼痛一直没有消失。等到22号依然疼。早上9点多。还是疼。就骑着电动车忍着疼去了村中的另一家诊所。医生是一位阿姨。然后给她描述了症状，然后她给检查了。并说腹部敲击回声和整个腹部都痛。应该不是肠炎一类的病。就让去大医院看。这次没有再犹豫。就打滴滴去了北京清华长庚医院。排了急诊。等了好久，缴费，排队，检查，缴费，输液，然后有个医生过来说你的病很严重。需要住院，然后输着液。去缴费。在输液室等着医护带着去了住院部。22号下午住院，星期一有两个小伙伴去医院看我。很感谢他们。一直到27号做手术。期间输液没有停止，左胳膊输液出了反应肿了，换右胳膊。右胳膊肿了，换左胳膊，最后又换右胳膊。直到29号出院。</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/20/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><a class="page-number" href="/page/23/">23</a><span class="space">&hellip;</span><a class="page-number" href="/page/46/">46</a><a class="extend next" rel="next" href="/page/22/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 幻舞梦境
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit">海贼到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-39498261-3', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?1bb44bf25fea8f000a1397f9b5438de7";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>