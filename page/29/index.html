<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>幻舞梦境</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="幻舞梦境">
<meta property="og:url" content="http://ovwane.me/page/29/index.html">
<meta property="og:site_name" content="幻舞梦境">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="幻舞梦境">
  
    <link rel="alternative" href="/atom.xml" title="幻舞梦境" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
     
      <meta name="baidu-site-verification" content="3rC08I0Cp6" />
    
     
      <meta name="google-site-verification" content="rn8f25RzFQoiByt8ezg9E17KZIElbIlwJ4y-EKSlWbA" />
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">幻舞梦境</a></h1>
        </hgroup>

        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">首页</a></li>
                        
                            <li><a href="/WebGuide">导航</a></li>
                        
                            <li><a href="/ovwane_love">Love</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" target="_blank" href="https://github.com/ovwane" title="github">github</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Ansible/" style="font-size: 11.43px;">Ansible</a> <a href="/tags/Bind/" style="font-size: 10px;">Bind</a> <a href="/tags/Cacti/" style="font-size: 10px;">Cacti</a> <a href="/tags/CentOS/" style="font-size: 20px;">CentOS</a> <a href="/tags/Cobbler/" style="font-size: 10px;">Cobbler</a> <a href="/tags/DHCP/" style="font-size: 10px;">DHCP</a> <a href="/tags/Django/" style="font-size: 12.86px;">Django</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Elasticsearch/" style="font-size: 10px;">Elasticsearch</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Gitlab/" style="font-size: 11.43px;">Gitlab</a> <a href="/tags/HAProxy/" style="font-size: 10px;">HAProxy</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Homebrew/" style="font-size: 10px;">Homebrew</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Jenkins/" style="font-size: 11.43px;">Jenkins</a> <a href="/tags/KVM/" style="font-size: 10px;">KVM</a> <a href="/tags/Kubernetes/" style="font-size: 10px;">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 15.71px;">Linux</a> <a href="/tags/MariaDB/" style="font-size: 10px;">MariaDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/Nagios/" style="font-size: 10px;">Nagios</a> <a href="/tags/Nginx/" style="font-size: 17.14px;">Nginx</a> <a href="/tags/Oh-My-Zsh/" style="font-size: 10px;">Oh My Zsh</a> <a href="/tags/OpenLDAP/" style="font-size: 10px;">OpenLDAP</a> <a href="/tags/OpenStack/" style="font-size: 10px;">OpenStack</a> <a href="/tags/PHP/" style="font-size: 11.43px;">PHP</a> <a href="/tags/PXE/" style="font-size: 10px;">PXE</a> <a href="/tags/Python/" style="font-size: 15.71px;">Python</a> <a href="/tags/RHEL7/" style="font-size: 10px;">RHEL7</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Requests/" style="font-size: 10px;">Requests</a> <a href="/tags/Resin/" style="font-size: 10px;">Resin</a> <a href="/tags/Samba/" style="font-size: 10px;">Samba</a> <a href="/tags/Scrapy/" style="font-size: 11.43px;">Scrapy</a> <a href="/tags/Scrapyd/" style="font-size: 10px;">Scrapyd</a> <a href="/tags/SpiderKeeper/" style="font-size: 10px;">SpiderKeeper</a> <a href="/tags/Squid/" style="font-size: 10px;">Squid</a> <a href="/tags/Subversion/" style="font-size: 10px;">Subversion</a> <a href="/tags/Supervisor/" style="font-size: 10px;">Supervisor</a> <a href="/tags/Tomcat/" style="font-size: 12.86px;">Tomcat</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/Xadmin/" style="font-size: 10px;">Xadmin</a> <a href="/tags/Zabbix/" style="font-size: 10px;">Zabbix</a> <a href="/tags/cacti/" style="font-size: 10px;">cacti</a> <a href="/tags/dovecot/" style="font-size: 10px;">dovecot</a> <a href="/tags/httpd/" style="font-size: 11.43px;">httpd</a> <a href="/tags/iSCSI/" style="font-size: 10px;">iSCSI</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/kickstart/" style="font-size: 10px;">kickstart</a> <a href="/tags/macOS/" style="font-size: 14.29px;">macOS</a> <a href="/tags/nagios/" style="font-size: 10px;">nagios</a> <a href="/tags/postfix/" style="font-size: 10px;">postfix</a> <a href="/tags/rsync/" style="font-size: 10px;">rsync</a> <a href="/tags/sshd/" style="font-size: 10px;">sshd</a> <a href="/tags/uWSGI/" style="font-size: 10px;">uWSGI</a> <a href="/tags/vsftpd/" style="font-size: 10px;">vsftpd</a> <a href="/tags/zabbix/" style="font-size: 10px;">zabbix</a> <a href="/tags/历史/" style="font-size: 18.57px;">历史</a> <a href="/tags/情感/" style="font-size: 10px;">情感</a> <a href="/tags/监控/" style="font-size: 12.86px;">监控</a> <a href="/tags/自己/" style="font-size: 10px;">自己</a> <a href="/tags/运维/" style="font-size: 10px;">运维</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://luuman.github.io/">name</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">纯海迷、爱运动、爱交友、爱旅行、喜欢接触新鲜事物、迎接新的挑战，更爱游离于错综复杂的编码与逻辑中</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">幻舞梦境</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">幻舞梦境</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">首页</a></li>
                
                    <li><a href="/WebGuide">导航</a></li>
                
                    <li><a href="/ovwane_love">Love</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/ovwane" title="github">github</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-2015年终总结之思考" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/31/2015年终总结之思考/" class="article-date">
      <time datetime="2015-12-31T08:20:00.000Z" itemprop="datePublished">2015-12-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/31/2015年终总结之思考/">2015年终总结之思考</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-COBBLER无人值守安装" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/26/COBBLER无人值守安装/" class="article-date">
      <time datetime="2015-12-26T11:22:15.000Z" itemprop="datePublished">2015-12-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/26/COBBLER无人值守安装/">COBBLER无人值守安装</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://www.zyops.com/autoinstall-cobbler" target="_blank" rel="noopener">COBBLER无人值守安装</a></p>
<h2 id="Cobbler介绍"><a href="#Cobbler介绍" class="headerlink" title="Cobbler介绍"></a>Cobbler介绍</h2><p>Cobbler是一个Linux服务器安装的服务，可以通过网络启动(PXE)的方式来快速安装、重装物理服务器和虚拟机，同时还可以管理DHCP，DNS等。</p>
<p>Cobbler可以使用命令行方式管理，也提供了基于Web的界面管理工具(cobbler-web)，还提供了API接口，可以方便二次开发使用。</p>
<p>Cobbler是较早前的kickstart的升级版，优点是比较容易配置，还自带web界面比较易于管理。</p>
<p>Cobbler内置了一个轻量级配置管理系统，但它也支持和其它配置管理系统集成，如Puppet，暂时不支持SaltStack。</p>
<h3 id="Cobbler集成的服务"><a href="#Cobbler集成的服务" class="headerlink" title="Cobbler集成的服务"></a>Cobbler集成的服务</h3><ul>
<li>PXE服务支持</li>
<li>DHCP服务管理</li>
<li>DNS服务管理(可选bind,dnsmasq)</li>
<li>电源管理</li>
<li>Kickstart服务支持</li>
<li>YUM仓库管理</li>
<li>TFTP(PXE启动时需要)</li>
<li>Apache(提供kickstart的安装源，并提供定制化的kickstart配置)</li>
</ul>
<h2 id="Cobbler安装配置"><a href="#Cobbler安装配置" class="headerlink" title="Cobbler安装配置"></a>Cobbler安装配置</h2><h3 id="系统环境准备"><a href="#系统环境准备" class="headerlink" title="系统环境准备"></a>系统环境准备</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# cat /etc/redhat-release</span><br><span class="line">CentOS release 6.7 (Final)</span><br><span class="line">[root@linux-node1 ~]# uname -r</span><br><span class="line">2.6.32-573.el6.x86_64</span><br><span class="line">[root@linux-node1 ~]# getenforce</span><br><span class="line">Disabled</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/iptables status</span><br><span class="line">iptables: Firewall is not running.</span><br><span class="line">[root@linux-node1 ~]# ifconfig eth0|awk -F &quot;[ :]+&quot; &apos;NR==2 &#123;print $4&#125;&apos;</span><br><span class="line">10.0.0.7</span><br><span class="line">[root@linux-node1 ~]# hostname</span><br><span class="line">linux-node1.example.com</span><br><span class="line"># 配置阿里云的epel源</span><br><span class="line">[root@linux-node1 ~]# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.rep</span><br></pre></td></tr></table></figure>
<h3 id="安装Cobbler"><a href="#安装Cobbler" class="headerlink" title="安装Cobbler"></a>安装Cobbler</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# yum -y install cobbler cobbler-web dhcp tftp-server pykickstart httpd</span><br><span class="line">[root@linux-node1 ~]# rpm -ql cobbler  # 查看安装的文件，下面列出部分。</span><br><span class="line">/etc/cobbler                  # 配置文件目录</span><br><span class="line">/etc/cobbler/settings         # cobbler主配置文件，这个文件是YAML格式，Cobbler是python写的程序。</span><br><span class="line">/etc/cobbler/dhcp.template    # DHCP服务的配置模板</span><br><span class="line">/etc/cobbler/tftpd.template   # tftp服务的配置模板</span><br><span class="line">/etc/cobbler/rsync.template   # rsync服务的配置模板</span><br><span class="line">/etc/cobbler/iso              # iso模板配置文件目录</span><br><span class="line">/etc/cobbler/pxe              # pxe模板文件目录</span><br><span class="line">/etc/cobbler/power            # 电源的配置文件目录</span><br><span class="line">/etc/cobbler/users.conf       # Web服务授权配置文件</span><br><span class="line">/etc/cobbler/users.digest     # 用于web访问的用户名密码配置文件</span><br><span class="line">/etc/cobbler/dnsmasq.template # DNS服务的配置模板</span><br><span class="line">/etc/cobbler/modules.conf     # Cobbler模块配置文件</span><br><span class="line">/var/lib/cobbler              # Cobbler数据目录</span><br><span class="line">/var/lib/cobbler/config       # 配置文件</span><br><span class="line">/var/lib/cobbler/kickstarts   # 默认存放kickstart文件</span><br><span class="line">/var/lib/cobbler/loaders      # 存放的各种引导程序</span><br><span class="line">/var/www/cobbler              # 系统安装镜像目录</span><br><span class="line">/var/www/cobbler/ks_mirror    # 导入的系统镜像列表</span><br><span class="line">/var/www/cobbler/images       # 导入的系统镜像启动文件</span><br><span class="line">/var/www/cobbler/repo_mirror  # yum源存储目录</span><br><span class="line">/var/log/cobbler              # 日志目录</span><br><span class="line">/var/log/cobbler/install.log  # 客户端系统安装日志</span><br><span class="line">/var/log/cobbler/cobbler.log  # cobbler日志</span><br></pre></td></tr></table></figure>
<h3 id="配置Cobbler"><a href="#配置Cobbler" class="headerlink" title="配置Cobbler"></a>配置Cobbler</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# /etc/init.d/httpd restart</span><br><span class="line">停止 httpd：                                               [失败]</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/cobblerd start</span><br><span class="line">Starting cobbler daemon:                                   [确定]</span><br><span class="line">[root@linux-node1 ~]# cobbler check  # 检查Cobbler的配置，如果看不到下面的结果，再次执行/etc/init.d/cobblerd restart</span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line">1 : The &apos;server&apos; field in /etc/cobbler/settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.</span><br><span class="line">2 : For PXE to be functional, the &apos;next_server&apos; field in /etc/cobbler/settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.</span><br><span class="line">3 : some network boot-loaders are missing from /var/lib/cobbler/loaders, you may run &apos;cobbler get-loaders&apos; to download them, or, if you only want to handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The &apos;cobbler get-loaders&apos; command is the easiest way to resolve these requirements.</span><br><span class="line">4 : change &apos;disable&apos; to &apos;no&apos; in /etc/xinetd.d/rsync</span><br><span class="line">5 : debmirror package is not installed, it will be required to manage debian deployments and repositories</span><br><span class="line">6 : The default password used by the sample templates for newly installed machines (default_password_crypted in /etc/cobbler/settings) is still set to &apos;cobbler&apos; and should be changed, try: &quot;openssl passwd -1 -salt &apos;random-phrase-here&apos; &apos;your-password-here&apos;&quot; to generate new one</span><br><span class="line">7 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them</span><br><span class="line">Restart cobblerd and then run &apos;cobbler sync&apos; to apply changes.</span><br><span class="line"># 看着上面的结果，一个一个解决。</span><br><span class="line"># 第1、2、6个问题，顺便修改其他功能</span><br><span class="line">[root@linux-node1 ~]# cp /etc/cobbler/settings&#123;,.ori&#125;  # 备份</span><br><span class="line"># server，Cobbler服务器的IP。</span><br><span class="line">sed -i &apos;s/server: 127.0.0.1/server: 10.0.0.7/&apos; /etc/cobbler/settings</span><br><span class="line"># next_server，如果用Cobbler管理DHCP，修改本项，作用不解释，看kickstart。</span><br><span class="line">sed -i &apos;s/next_server: 127.0.0.1/next_server: 10.0.0.7/&apos; /etc/cobbler/settings</span><br><span class="line"># 用Cobbler管理DHCP</span><br><span class="line">sed -i &apos;s/manage_dhcp: 0/manage_dhcp: 1/&apos; /etc/cobbler/settings</span><br><span class="line"># 防止循环装系统，适用于服务器第一启动项是PXE启动。</span><br><span class="line">sed -i &apos;s/pxe_just_once: 0/pxe_just_once: 1/&apos; /etc/cobbler/settings</span><br><span class="line"># 设置新装系统的默认root密码123456。下面的命令来源于提示6。random-phrase-here为干扰码，可以自行设定。</span><br><span class="line">[root@linux-node1 ~]# openssl passwd -1 -salt &apos;oldboy&apos; &apos;123456&apos;</span><br><span class="line">$1$oldboy$Npg9Pt9k98Mlg0ZeqHAuN1</span><br><span class="line">[root@linux-node1 ~]# vim /etc/cobbler/settings </span><br><span class="line">default_password_crypted: &quot;$1$oldboy$Npg9Pt9k98Mlg0ZeqHAuN1&quot; </span><br><span class="line"># 第3个问题</span><br><span class="line">[root@linux-node1 ~]# cobbler get-loaders  # 会自动从官网下载</span><br><span class="line">[root@linux-node1 ~]# cd /var/lib/cobbler/loaders/  # 下载的内容</span><br><span class="line">[root@linux-node1 loaders]# ls</span><br><span class="line">COPYING.elilo     COPYING.yaboot  grub-x86_64.efi  menu.c32    README</span><br><span class="line">COPYING.syslinux  elilo-ia64.efi  grub-x86.efi     pxelinux.0  yaboot</span><br><span class="line"># 第4个问题</span><br><span class="line">[root@linux-node1 ~]# vim /etc/xinetd.d/rsync</span><br><span class="line">disable = no</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/xinetd restart</span><br><span class="line">停止 xinetd：                                              [确定]</span><br><span class="line">正在启动 xinetd：                                          [确定]</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/cobblerd restart</span><br><span class="line">Stopping cobbler daemon:                                   [确定]</span><br><span class="line">Starting cobbler daemon:                                   [确定]</span><br><span class="line">[root@linux-node1 ~]# cobbler check</span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line">1 : debmirror package is not installed, it will be required to manage debian deployments and repositories  # 和debian系统相关，不需要</span><br><span class="line">2 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them # fence设备相关，不需要</span><br><span class="line">Restart cobblerd and then run &apos;cobbler sync&apos; to apply changes.</span><br></pre></td></tr></table></figure>
<h3 id="配置DHCP"><a href="#配置DHCP" class="headerlink" title="配置DHCP"></a>配置DHCP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 修改cobbler的dhcp模版，不要直接修改dhcp本身的配置文件，因为cobbler会覆盖。</span><br><span class="line">[root@linux-node1 ~]# vim /etc/cobbler/dhcp.template </span><br><span class="line"># 仅列出修改过的字段</span><br><span class="line">……</span><br><span class="line">subnet 10.0.0.0 netmask 255.255.255.0 &#123;</span><br><span class="line">     option routers             10.0.0.2;</span><br><span class="line">     option domain-name-servers 10.0.0.2;</span><br><span class="line">     option subnet-mask         255.255.255.0;</span><br><span class="line">     range dynamic-bootp        10.0.0.100 10.0.0.200;</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<h3 id="同步cobbler配置"><a href="#同步cobbler配置" class="headerlink" title="同步cobbler配置"></a>同步cobbler配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 同步最新cobbler配置，它会根据配置自动修改dhcp等服务。</span><br><span class="line">[root@linux-node1 ~]# cobbler sync   # 同步所有配置，可以仔细看一下sync做了什么。</span><br><span class="line">task started: 2015-12-03_204822_sync</span><br><span class="line">task started (id=Sync, time=Thu Dec  3 20:48:22 2015)</span><br><span class="line">running pre-sync triggers</span><br><span class="line">cleaning trees</span><br><span class="line">removing: /var/lib/tftpboot/pxelinux.cfg/default</span><br><span class="line">removing: /var/lib/tftpboot/grub/images</span><br><span class="line">copying bootloaders</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/pxelinux.0 -&gt; /var/lib/tftpboot/pxelinux.0</span><br><span class="line">copying: /var/lib/cobbler/loaders/pxelinux.0 -&gt; /var/lib/tftpboot/pxelinux.0</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/menu.c32 -&gt; /var/lib/tftpboot/menu.c32</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/yaboot -&gt; /var/lib/tftpboot/yaboot</span><br><span class="line">trying hardlink /usr/share/syslinux/memdisk -&gt; /var/lib/tftpboot/memdisk</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/grub-x86.efi -&gt; /var/lib/tftpboot/grub/grub-x86.efi</span><br><span class="line">trying hardlink /var/lib/cobbler/loaders/grub-x86_64.efi -&gt; /var/lib/tftpboot/grub/grub-x86_64.efi</span><br><span class="line">copying distros to tftpboot</span><br><span class="line">copying images</span><br><span class="line">generating PXE configuration files</span><br><span class="line">generating PXE menu structure</span><br><span class="line">rendering DHCP files</span><br><span class="line">generating /etc/dhcp/dhcpd.conf</span><br><span class="line">rendering TFTPD files</span><br><span class="line">generating /etc/xinetd.d/tftp</span><br><span class="line">cleaning link caches</span><br><span class="line">running post-sync triggers</span><br><span class="line">running python triggers from /var/lib/cobbler/triggers/sync/post/*</span><br><span class="line">running python trigger cobbler.modules.sync_post_restart_services</span><br><span class="line">running: dhcpd -t -q</span><br><span class="line">received on stdout: </span><br><span class="line">received on stderr: </span><br><span class="line">running: service dhcpd restart</span><br><span class="line">received on stdout: 关闭 dhcpd：[确定]</span><br><span class="line">正在启动 dhcpd：[确定]</span><br><span class="line">received on stderr: </span><br><span class="line">running shell triggers from /var/lib/cobbler/triggers/sync/post/*</span><br><span class="line">running python triggers from /var/lib/cobbler/triggers/change/*</span><br><span class="line">running python trigger cobbler.modules.scm_track</span><br><span class="line">running shell triggers from /var/lib/cobbler/triggers/change/*</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"># 再看一下dhcp的配置文件。</span><br><span class="line">[root@linux-node1 ~]# less /etc/dhcp/dhcpd.conf</span><br><span class="line"># ******************************************************************</span><br><span class="line"># Cobbler managed dhcpd.conf file</span><br><span class="line"># generated from cobbler dhcp.conf template (Thu Dec  3 12:48:23 2015)</span><br><span class="line"># Do NOT make changes to /etc/dhcpd.conf. Instead, make your changes</span><br><span class="line"># in /etc/cobbler/dhcp.template, as /etc/dhcpd.conf will be</span><br><span class="line"># overwritten.</span><br><span class="line"># ******************************************************************</span><br><span class="line">ddns-update-style interim;</span><br><span class="line">…………</span><br></pre></td></tr></table></figure>
<h3 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># 启动相关服务并设置开机启动(可选) 与第二种方法二选一</span><br><span class="line">chkconfig httpd on</span><br><span class="line">chkconfig xinetd on</span><br><span class="line">chkconfig cobblerd on</span><br><span class="line">chkconfig dhcpd on</span><br><span class="line">/etc/init.d/httpd restart</span><br><span class="line">/etc/init.d/xinetd restart</span><br><span class="line">/etc/init.d/cobblerd restart</span><br><span class="line">/etc/init.d/dhcpd restart</span><br><span class="line"># 编写Cobbler相关服务启动脚本(可选)</span><br><span class="line">cat &gt;&gt;/etc/init.d/cobbler&lt;&lt;EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line"># chkconfig: 345 80 90</span><br><span class="line"># description:cobbler</span><br><span class="line">case \$1 in</span><br><span class="line">  start)</span><br><span class="line">    /etc/init.d/httpd start</span><br><span class="line">    /etc/init.d/xinetd start</span><br><span class="line">    /etc/init.d/dhcpd start</span><br><span class="line">    /etc/init.d/cobblerd start</span><br><span class="line">    ;;</span><br><span class="line">  stop)</span><br><span class="line">    /etc/init.d/httpd stop</span><br><span class="line">    /etc/init.d/xinetd stop</span><br><span class="line">    /etc/init.d/dhcpd stop</span><br><span class="line">    /etc/init.d/cobblerd stop</span><br><span class="line">    ;;</span><br><span class="line">  restart)</span><br><span class="line">    /etc/init.d/httpd restart</span><br><span class="line">    /etc/init.d/xinetd restart</span><br><span class="line">    /etc/init.d/dhcpd restart</span><br><span class="line">    /etc/init.d/cobblerd restart</span><br><span class="line">    ;;</span><br><span class="line">  status)</span><br><span class="line">    /etc/init.d/httpd status</span><br><span class="line">    /etc/init.d/xinetd status</span><br><span class="line">    /etc/init.d/dhcpd status</span><br><span class="line">    /etc/init.d/cobblerd status</span><br><span class="line">    ;;</span><br><span class="line">  sync)</span><br><span class="line">    cobbler sync</span><br><span class="line">    ;;</span><br><span class="line">  *)</span><br><span class="line">    echo &quot;Input error,please in put &apos;start|stop|restart|status|sync&apos;!&quot;</span><br><span class="line">    exit 2</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line">EOF</span><br><span class="line"># chmod +x /etc/init.d/cobbler</span><br><span class="line"># chkconfig cobbler on</span><br></pre></td></tr></table></figure>
<h2 id="Cobbler的命令行管理"><a href="#Cobbler的命令行管理" class="headerlink" title="Cobbler的命令行管理"></a>Cobbler的命令行管理</h2><h3 id="查看命令帮助"><a href="#查看命令帮助" class="headerlink" title="查看命令帮助"></a>查看命令帮助</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# cobbler</span><br><span class="line">usage</span><br><span class="line">=====</span><br><span class="line">cobbler &lt;distro|profile|system|repo|image|mgmtclass|package|file&gt; ... </span><br><span class="line">        [add|edit|copy|getks*|list|remove|rename|report] [options|--help]</span><br><span class="line">cobbler &lt;aclsetup|buildiso|import|list|replicate|report|reposync|sync|validateks|version|signature|get-loaders|hardlink&gt; [options|--help]</span><br><span class="line">[root@linux-node1 ~]# cobbler import --help  # 导入镜像</span><br><span class="line">Usage: cobbler [options]</span><br><span class="line">Options:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  --arch=ARCH           OS architecture being imported</span><br><span class="line">  --breed=BREED         the breed being imported</span><br><span class="line">  --os-version=OS_VERSION</span><br><span class="line">                        the version being imported</span><br><span class="line">  --path=PATH           local path or rsync location</span><br><span class="line">  --name=NAME           name, ex &apos;RHEL-5&apos;</span><br><span class="line">  --available-as=AVAILABLE_AS</span><br><span class="line">                        tree is here, don&apos;t mirror</span><br><span class="line">  --kickstart=KICKSTART_FILE</span><br><span class="line">                        assign this kickstart file</span><br><span class="line">  --rsync-flags=RSYNC_FLAGS</span><br><span class="line">                        pass additional flags to rsync</span><br><span class="line">cobbler check    核对当前设置是否有问题</span><br><span class="line">cobbler list     列出所有的cobbler元素</span><br><span class="line">cobbler report   列出元素的详细信息</span><br><span class="line">cobbler sync     同步配置到数据目录,更改配置最好都要执行下</span><br><span class="line">cobbler reposync 同步yum仓库</span><br><span class="line">cobbler distro   查看导入的发行版系统信息</span><br><span class="line">cobbler system   查看添加的系统信息</span><br><span class="line">cobbler profile  查看配置信息</span><br></pre></td></tr></table></figure>
<h3 id="导入镜像"><a href="#导入镜像" class="headerlink" title="导入镜像"></a>导入镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# mount /dev/cdrom /mnt/  # 挂载CentOS7的系统镜像。</span><br><span class="line"># 导入系统镜像</span><br><span class="line">[root@linux-node1 ~]# cobbler import --path=/mnt/ --name=CentOS-7.1-x86_64 --arch=x86_64</span><br><span class="line"># --path 镜像路径</span><br><span class="line"># --name 为安装源定义一个名字</span><br><span class="line"># --arch 指定安装源是32位、64位、ia64, 目前支持的选项有: x86│x86_64│ia64</span><br><span class="line"># 安装源的唯一标示就是根据name参数来定义，本例导入成功后，安装源的唯一标示就是：CentOS-7.1-x86_64，如果重复，系统会提示导入失败。</span><br><span class="line">[root@linux-node1 ~]# cobbler distro list  # 查看镜像列表</span><br><span class="line">   CentOS-7.1-x86_64</span><br><span class="line"># 镜像存放目录，cobbler会将镜像中的所有安装文件拷贝到本地一份，放在/var/www/cobbler/ks_mirror下的CentOS-7.1-x86_64目录下。因此/var/www/cobbler目录必须具有足够容纳安装文件的空间。</span><br><span class="line">[root@linux-node1 ~]# cd /var/www/cobbler/ks_mirror/</span><br><span class="line">[root@linux-node1 ks_mirror]# ls</span><br><span class="line">CentOS-7.1-x86_64  config</span><br><span class="line">[root@linux-node1 ks_mirror]# ls CentOS-7.1-x86_64/</span><br><span class="line">CentOS_BuildTag  GPL       LiveOS    RPM-GPG-KEY-CentOS-7</span><br><span class="line">EFI              images    Packages  RPM-GPG-KEY-CentOS-Testing-7</span><br><span class="line">EULA             isolinux  repodata  TRANS.TBL</span><br></pre></td></tr></table></figure>
<h3 id="指定ks-cfg文件及调整内核参数"><a href="#指定ks-cfg文件及调整内核参数" class="headerlink" title="指定ks.cfg文件及调整内核参数"></a>指定ks.cfg文件及调整内核参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"># Cobbler的ks.cfg文件存放位置</span><br><span class="line">[root@linux-node1 ks_mirror]# cd /var/lib/cobbler/kickstarts/</span><br><span class="line">[root@linux-node1 kickstarts]# ls  # 自带很多</span><br><span class="line">default.ks    install_profiles  sample_autoyast.xml  sample_esxi4.ks  sample_old.seed</span><br><span class="line">esxi4-ks.cfg  legacy.ks         sample_end.ks（默认使用的ks文件）        sample_esxi5.ks  sample.seed</span><br><span class="line">esxi5-ks.cfg  pxerescue.ks      sample_esx4.ks       sample.ks</span><br><span class="line">[root@linux-node1 kickstarts]# rz  # 上传准备好的ks文件</span><br><span class="line">rz waiting to receive.</span><br><span class="line">Starting zmodem transfer.  Press Ctrl+C to cancel.</span><br><span class="line">Transferring Cobbler-CentOS-7.1-x86_64.cfg...</span><br><span class="line">  100%       1 KB       1 KB/sec    00:00:01       0 Errors</span><br><span class="line">[root@linux-node1 kickstarts]# mv Cobbler-CentOS-7.1-x86_64.cfg CentOS-7.1-x86_64.cfg</span><br><span class="line"># 在第一次导入系统镜像后，Cobbler会给镜像指定一个默认的kickstart自动安装文件在/var/lib/cobbler/kickstarts下的sample_end.ks。</span><br><span class="line">[root@linux-node1 ~]# cobbler list</span><br><span class="line">distros:</span><br><span class="line">   CentOS-7.1-x86_64</span><br><span class="line">profiles:</span><br><span class="line">   CentOS-7.1-x86_64</span><br><span class="line">systems:</span><br><span class="line">repos:</span><br><span class="line">images:</span><br><span class="line">mgmtclasses:</span><br><span class="line">packages:</span><br><span class="line">files:</span><br><span class="line"># 查看安装镜像文件信息</span><br><span class="line">[root@linux-node1 ~]# cobbler distro report --name=CentOS-7.1-x86_64</span><br><span class="line">Name                           : CentOS-7.1-x86_64</span><br><span class="line">Architecture                   : x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Breed                          : redhat</span><br><span class="line">Comment                        : </span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Initrd                         : /var/www/cobbler/ks_mirror/CentOS-7.1-x86_64/images/pxeboot/initrd.img</span><br><span class="line">Kernel                         : /var/www/cobbler/ks_mirror/CentOS-7.1-x86_64/images/pxeboot/vmlinuz</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart Metadata             : &#123;&apos;tree&apos;: &apos;http://@@http_server@@/cblr/links/CentOS-7.1-x86_64&apos;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">OS Version                     : rhel7</span><br><span class="line">Owners                         : [&apos;admin&apos;]</span><br><span class="line">Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line"># 查看所有的profile设置</span><br><span class="line">[root@linux-node1 ~]# cobbler profile report</span><br><span class="line"># 查看指定的profile设置</span><br><span class="line">[root@linux-node1 ~]# cobbler profile report --name=CentOS-7.1-x86_64</span><br><span class="line">Name                           : CentOS-7.1-x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        : </span><br><span class="line">DHCP Tag                       : default</span><br><span class="line">Distribution                   : CentOS-7.1-x86_64</span><br><span class="line">Enable gPXE?                   : 0</span><br><span class="line">Enable PXE Menu?               : 1</span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart                      : /var/lib/cobbler/kickstarts/sample_end.ks  --&gt;默认ks文件</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">Management Parameters          : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Owners                         : [&apos;admin&apos;]</span><br><span class="line">Parent Profile                 : </span><br><span class="line">Internal proxy                 : </span><br><span class="line">Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Repos                          : []</span><br><span class="line">Server Override                : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line">Virt Auto Boot                 : 1</span><br><span class="line">Virt Bridge                    : xenbr0</span><br><span class="line">Virt CPUs                      : 1</span><br><span class="line">Virt Disk Driver Type          : raw</span><br><span class="line">Virt File Size(GB)             : 5</span><br><span class="line">Virt Path                      : </span><br><span class="line">Virt RAM (MB)                  : 512</span><br><span class="line">Virt Type                      : kvm</span><br><span class="line"># 编辑profile，修改关联的ks文件</span><br><span class="line">[root@linux-node1 ~]# cobbler profile edit --name=CentOS-7.1-x86_64 --kickstart=/var/lib/cobbler/kickstarts/CentOS-7.1-x86_64.cfg</span><br><span class="line"># 修改安装系统的内核参数，在CentOS7系统有一个地方变了，就是网卡名变成eno16777736这种形式，但是为了运维标准化，我们需要将它变成我们常用的eth0，因此使用下面的参数。但要注意是CentOS7才需要下面的步骤，CentOS6不需要。</span><br><span class="line">[root@linux-node1 ~]# cobbler profile edit --name=CentOS-7.1-x86_64 --kopts=&apos;net.ifnames=0 biosdevname=0&apos;</span><br><span class="line">[root@linux-node1 ~]# cobbler profile report CentOS-7.1-x86_64</span><br><span class="line">Name                           : CentOS-7.1-x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        : </span><br><span class="line">DHCP Tag                       : default</span><br><span class="line">Distribution                   : CentOS-7.1-x86_64</span><br><span class="line">Enable gPXE?                   : 0</span><br><span class="line">Enable PXE Menu?               : 1</span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Kernel Options                 : &#123;&apos;biosdevname&apos;: &apos;0&apos;, &apos;net.ifnames&apos;: &apos;0&apos;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart                      : /var/lib/cobbler/kickstarts/CentOS-7.1-x86_64.cfg</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">Management Parameters          : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Owners                         : [&apos;admin&apos;]</span><br><span class="line">Parent Profile                 : </span><br><span class="line">Internal proxy                 : </span><br><span class="line">Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Repos                          : []</span><br><span class="line">Server Override                : &lt;&lt;inherit&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line">Virt Auto Boot                 : 1</span><br><span class="line">Virt Bridge                    : xenbr0</span><br><span class="line">Virt CPUs                      : 1</span><br><span class="line">Virt Disk Driver Type          : raw</span><br><span class="line">Virt File Size(GB)             : 5</span><br><span class="line">Virt Path                      : </span><br><span class="line">Virt RAM (MB)                  : 512</span><br><span class="line">Virt Type                      : kvm</span><br><span class="line"># 每次修改完都要同步一次</span><br><span class="line">[root@linux-node1 ~]# cobbler sync</span><br></pre></td></tr></table></figure>
<h3 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h3><p>可以很愉快的告诉你到这里就可以安装系统了！<br>有没有发现不美观的地方？<br>网址不是我的！改！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#修改Cobbler提示</span><br><span class="line">[root@linux-node1 ~]# vim /etc/cobbler/pxe/pxedefault.template</span><br><span class="line">MENU TITLE Cobbler | http://www.zyops.com</span><br><span class="line">[root@linux-node1 ~]# cobbler sync # 修改配置都要同步</span><br></pre></td></tr></table></figure>
<h2 id="ks-cfg文件简析"><a href="#ks-cfg文件简析" class="headerlink" title="ks.cfg文件简析"></a>ks.cfg文件简析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">文件大部分参数含义见kickstart文章，此处只讲一些不同的地方。同时可以参考模板文件。</span><br><span class="line">[root@linux-node1 kickstarts]# cat CentOS-7.1-x86_64.cfg</span><br><span class="line"># Cobbler for Kickstart Configurator for CentOS 7.1 by yao zhang</span><br><span class="line">install</span><br><span class="line">url --url=$tree  # 这些$开头的变量都是调用配置文件里的值。</span><br><span class="line">text</span><br><span class="line">lang en_US.UTF-8</span><br><span class="line">keyboard us</span><br><span class="line">zerombr</span><br><span class="line">bootloader --location=mbr --driveorder=sda --append=&quot;crashkernel=auto rhgb quiet&quot;</span><br><span class="line"># Network information</span><br><span class="line">$SNIPPET(&apos;network_config&apos;)</span><br><span class="line">timezone --utc Asia/Shanghai</span><br><span class="line">authconfig --enableshadow --passalgo=sha512</span><br><span class="line">rootpw  --iscrypted $default_password_crypted</span><br><span class="line">clearpart --all --initlabel</span><br><span class="line">part /boot --fstype xfs --size 1024  # CentOS7系统磁盘默认格式xfs</span><br><span class="line">part swap --size 1024</span><br><span class="line">part / --fstype xfs --size 1 --grow</span><br><span class="line">firstboot --disable</span><br><span class="line">selinux --disabled</span><br><span class="line">firewall --disabled</span><br><span class="line">logging --level=info</span><br><span class="line">reboot</span><br><span class="line">%pre</span><br><span class="line">$SNIPPET(&apos;log_ks_pre&apos;)</span><br><span class="line">$SNIPPET(&apos;kickstart_start&apos;)</span><br><span class="line">$SNIPPET(&apos;pre_install_network_config&apos;)</span><br><span class="line"># Enable installation monitoring</span><br><span class="line">$SNIPPET(&apos;pre_anamon&apos;)</span><br><span class="line">%end</span><br><span class="line">%packages</span><br><span class="line">@base</span><br><span class="line">@compat-libraries</span><br><span class="line">@debugging</span><br><span class="line">@development</span><br><span class="line">tree</span><br><span class="line">nmap</span><br><span class="line">sysstat</span><br><span class="line">lrzsz</span><br><span class="line">dos2unix</span><br><span class="line">telnet</span><br><span class="line">iptraf</span><br><span class="line">ncurses-devel</span><br><span class="line">openssl-devel</span><br><span class="line">zlib-devel</span><br><span class="line">OpenIPMI-tools</span><br><span class="line">screen</span><br><span class="line">%end</span><br><span class="line">%post</span><br><span class="line">systemctl disable postfix.service</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>
<h2 id="定制化安装"><a href="#定制化安装" class="headerlink" title="定制化安装"></a>定制化安装</h2><p>可能从学习kickstart开始就有人想怎样能够指定某台服务器使用指定ks文件，kickstart实现这功能可能比较复杂，但是Cobbler就很简单了。</p>
<p>区分一台服务器的最简单的方法就是物理MAC地址。<br>物理服务器的MAC地址在服务器上的标签上写了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cobbler system add --name=oldboy --mac=00：0C：29：7F：2F：A1 --profile=CentOS-7.1-x86_64 --ip-address=10.0.0.111 --subnet=255.255.255.0 --gateway=10.0.0.2 --interface=eth0 --static=1 --hostname=oldboy.example.com --name-servers=&quot;114.114.114.114 8.8.8.8&quot;</span><br><span class="line"># --name 自定义，但不能重复</span><br><span class="line"># 查看定义的列表</span><br><span class="line">[root@linux-node1 ~]# cobbler system list</span><br><span class="line">   oldboy</span><br><span class="line">[root@linux-node1 ~]# cobbler sync</span><br></pre></td></tr></table></figure>
<p>再次开机安装就不再询问选择了，直接安装。</p>
<h2 id="Cobbler的Web管理界面的安装与配置"><a href="#Cobbler的Web管理界面的安装与配置" class="headerlink" title="Cobbler的Web管理界面的安装与配置"></a>Cobbler的Web管理界面的安装与配置</h2><p>已经安装cobbler-web软件。</p>
<p>访问网址：<a href="http://10.0.0.7/cobbler_web和https://10.0.0.7/cobbler_web" target="_blank" rel="noopener">http://10.0.0.7/cobbler_web和https://10.0.0.7/cobbler_web</a></p>
<p>默认用户名：cobbler<br>默认密码 ：cobbler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/etc/cobbler/users.conf       # Web服务授权配置文件</span><br><span class="line">/etc/cobbler/users.digest     # 用于web访问的用户名密码配置文件</span><br><span class="line">[root@linux-node1 ~]# cat /etc/cobbler/users.digest</span><br><span class="line">cobbler:Cobbler:a2d6bae81669d707b72c0bd9806e01f3</span><br><span class="line"># 设置Cobbler web用户登陆密码</span><br><span class="line"># 在Cobbler组添加cobbler用户，提示输入2遍密码确认</span><br><span class="line">[root@linux-node1 ~]# htdigest /etc/cobbler/users.digest &quot;Cobbler&quot; cobbler</span><br><span class="line">Changing password for user cobbler in realm Cobbler</span><br><span class="line">New password: 123456</span><br><span class="line">Re-type new password:123456</span><br><span class="line">[root@linux-node1 ~]# cobbler sync</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/httpd restart</span><br><span class="line">停止 httpd：                                               [确定]</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br><span class="line">[root@linux-node1 ~]# /etc/init.d/cobblerd restart</span><br><span class="line">Stopping cobbler daemon:                                   [确定]</span><br><span class="line">Starting cobbler daemon:                                   [确定]</span><br></pre></td></tr></table></figure>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cobbler/">Cobbler</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Github上的Python Crawler收集列表" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/10/29/Github上的Python Crawler收集列表/" class="article-date">
      <time datetime="2015-10-29T10:58:03.000Z" itemprop="datePublished">2015-10-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="https://github.com/soimort/you-get" target="_blank" rel="noopener">soimort/you-get</a></p>
<p><a href="https://github.com/rg3/youtube-dl" target="_blank" rel="noopener">rg3/youtube-dl</a></p>
<p><a href="https://github.com/dragonflylxp/crawler" target="_blank" rel="noopener">python爬虫项目集合</a></p>
<p><a href="https://github.com/liinnux/awesome-crawler-cn" target="_blank" rel="noopener">Awesome-crawler-cn</a></p>
<p><a href="https://github.com/Ehco1996/Python-crawler" target="_blank" rel="noopener">Python-crawler</a></p>
<p><a href="https://github.com/gnemoug/distribute_crawler" target="_blank" rel="noopener">woaidu_crawler</a></p>
<p><a href="https://github.com/lzjun567/crawler_html2pdf" target="_blank" rel="noopener">crawler_html2pdf</a></p>
<p><a href="https://github.com/sam408130/base_spider" target="_blank" rel="noopener">sam408130/crawler</a></p>
<p><a href="https://github.com/sam408130/scrapy" target="_blank" rel="noopener">Python系列文章</a></p>
<p><a href="https://github.com/sam408130/parse-baidu-baike" target="_blank" rel="noopener">用于抓取百度百科中的百科名片及列表部分信息</a></p>
<p><a href="https://github.com/pujinxiao/Python-Crawler" target="_blank" rel="noopener">python多线程爬虫爬取电影天堂资源</a></p>
<p><a href="https://github.com/gnemoug/LinkedIn-Crawler" target="_blank" rel="noopener">LinkedIn-Crawler</a></p>
<p><a href="https://github.com/SparrowG/LinkedIn-Crawler" target="_blank" rel="noopener">SparrowG/LinkedIn-Crawler</a></p>
<p><a href="https://github.com/Nyloner/NyCrawler" target="_blank" rel="noopener">NyCrawler</a></p>
<p><a href="https://github.com/mokeyjay/Yandere-crawler" target="_blank" rel="noopener">Yandere-crawler</a></p>
<p><a href="https://github.com/youshoubianer/infoqCrawler" target="_blank" rel="noopener">infoqCrawler</a></p>
<p><a href="https://github.com/sam408130/xcf_crawler" target="_blank" rel="noopener">下厨房爬虫</a></p>
<p><a href="https://github.com/lzjun567/zhihu-crawler" target="_blank" rel="noopener">zhihu-crawler</a></p>
<p><a href="github.com/rmax/scrapy-redis">Scrapy-Redis</a></p>
<p><a href="https://github.com/ShenJianShou/crawler_samples" target="_blank" rel="noopener">神箭手 云爬虫 爬取规则示例</a></p>
<p>ovwane/python_crawler</p>
<p>README.md<br>Crawler<br>收集网络上大神们写的爬虫代码。</p>
<h1 id="spider"><a href="#spider" class="headerlink" title="spider"></a>spider</h1><p><a href="https://github.com/chenqing/spider" target="_blank" rel="noopener">chenqing/spider</a></p>
<p><a href="https://github.com/imchenkun/ick-spider" target="_blank" rel="noopener">imchenkun/ick-spider</a></p>
<p><a href="https://github.com/Otakuwizard/spider" target="_blank" rel="noopener">Otakuwizard/spider</a></p>
<p><a href="https://github.com/Germey/Weibo" target="_blank" rel="noopener">Germey/Weibo</a></p>
<h1 id="Scrapy"><a href="#Scrapy" class="headerlink" title="Scrapy"></a>Scrapy</h1><p><a href="https://github.com/DormyMo/SpiderKeeper" target="_blank" rel="noopener">SpiderKeeper</a></p>
<p><a href="https://github.com/scrapy/scrapyd" target="_blank" rel="noopener">scrapy/scrapyd</a></p>
<p><a href="https://github.com/Germey/Gerapy" target="_blank" rel="noopener">Germey/Gerapy</a></p>
<p><a href="https://github.com/sam408130/scrapy" target="_blank" rel="noopener">sam408130/scrapy</a></p>
<p><a href="https://github.com/Wooden-Robot/scrapy-tutorial" target="_blank" rel="noopener">Wooden-Robot/scrapy-tutorial</a></p>
<p><a href="https://github.com/LiuXingMing/Scrapy_Redis_Bloomfilter" target="_blank" rel="noopener">LiuXingMing/Scrapy_Redis_Bloomfilter</a></p>
<p><a href="https://github.com/younghz/sr-chn" target="_blank" rel="noopener">scrapy-redis代码研究</a></p>
<p>#代理<br><a href="https://github.com/DormyMo/ProxyCrawler" target="_blank" rel="noopener">ProxyCrawler</a></p>
<p><a href="https://github.com/awolfly9/IPProxyTool" target="_blank" rel="noopener">awolfly9/IPProxyTool</a></p>
<p><a href="https://github.com/Nyloner/ProxyPool" target="_blank" rel="noopener">Nyloner/ProxyPool</a></p>
<p><a href="https://github.com/Germey/ProxyPool" target="_blank" rel="noopener">Germey/ProxyPool</a></p>
<p><a href="https://github.com/Germey/CookiesPool" target="_blank" rel="noopener">Germey/CookiesPool</a></p>
<p><a href="https://github.com/love3forever/proxyHunter" target="_blank" rel="noopener">love3forever/proxyHunter</a></p>
<p><a href="https://github.com/pujinxiao/IPProxyPool" target="_blank" rel="noopener">pujinxiao/IPProxyPool</a></p>
<p><a href="https://github.com/qiyeboy/IPProxyPool" target="_blank" rel="noopener">qiyeboy/IPProxyPool</a></p>
<p><a href="https://github.com/Germey/AutoProxy" target="_blank" rel="noopener">Germey/AutoProxy</a></p>
<p>#1</p>
<p><a href="https://github.com/istresearch/scrapy-cluster" target="_blank" rel="noopener">istresearch/scrapy-cluster</a></p>
<p><a href="https://github.com/wangqifan/ZhiHu" target="_blank" rel="noopener">wangqifan/ZhiHu</a></p>
<p><a href="https://github.com/otakurice/weibonlp" target="_blank" rel="noopener">otakurice/weibonlp</a></p>
<p><a href="https://github.com/geekcompany/DeerResume" target="_blank" rel="noopener">geekcompany/DeerResume</a></p>
<p><a href="https://github.com/otakurice/notravellist" target="_blank" rel="noopener">otakurice/notravellist</a></p>
<p><a href="https://github.com/Nyloner/NyPython" target="_blank" rel="noopener">Nyloner/NyPython</a></p>
<p><a href="https://github.com/otakurice/lagoujob" target="_blank" rel="noopener">otakurice/lagoujob</a></p>
<p>#简单爬虫<br><a href="https://github.com/xiaozhiqi2016/spider_basic" target="_blank" rel="noopener">xiaozhiqi2016/spider_basic</a></p>
<p><a href="https://github.com/Germey/TaobaoProduct" target="_blank" rel="noopener">Germey/TaobaoProduct</a></p>
<p><a href="https://github.com/Germey/Cnki" target="_blank" rel="noopener">Germey/Cnki</a></p>
<p><a href="https://github.com/Germey/TaobaoMM" target="_blank" rel="noopener">Germey/TaobaoMM</a></p>
<p><a href="https://github.com/Wooden-Robot/Pythonspider" target="_blank" rel="noopener">Wooden-Robot/Pythonspider</a></p>
<p><a href="https://github.com/bigstupidx/Pythonspider" target="_blank" rel="noopener">bigstupidx/Pythonspider</a></p>
<p><a href="https://github.com/StephinChou/Pythonspider" target="_blank" rel="noopener">StephinChou/Pythonspider</a></p>
<p><a href="https://github.com/Germey/MeiKong" target="_blank" rel="noopener">Germey/MeiKong</a></p>
<p>#爬虫资料汇总<br><a href="https://github.com/KDF5000/SpiderRef" target="_blank" rel="noopener">KDF5000/SpiderRef</a></p>
<p><a href="https://github.com/Ehco1996/Python-crawler" target="_blank" rel="noopener">Ehco1996/Python-crawler</a></p>
<p><a href="https://github.com/luyishisi/Nyspider" target="_blank" rel="noopener">luyishisi/Nyspider</a></p>
<p><a href="https://github.com/Nyloner/Nyspider" target="_blank" rel="noopener">Nyloner/Nyspider</a></p>
<p>#单个网站爬虫<br><a href="https://github.com/fankcoder/spider-comments" target="_blank" rel="noopener">fankcoder/spider-comments</a></p>
<p><a href="https://github.com/wwj718/jobSpider" target="_blank" rel="noopener">wwj718/jobSpider</a></p>
<p><a href="https://github.com/zaxlct/baike-spider" target="_blank" rel="noopener">zaxlct/baike-spider</a></p>
<p><a href="https://github.com/hk029/LagouSpider" target="_blank" rel="noopener">hk029/LagouSpider</a></p>
<p><a href="https://github.com/Jack-Cherish/python-spider" target="_blank" rel="noopener">Jack-Cherish/python-spider</a></p>
<p><a href="https://github.com/wanglu119/distributed-spider" target="_blank" rel="noopener">wanglu119/distributed-spider</a></p>
<p><a href="https://github.com/pujinxiao/Lagou_spider" target="_blank" rel="noopener">pujinxiao/Lagou_spider</a></p>
<p><a href="https://github.com/Wooden-Robot/spider-practice" target="_blank" rel="noopener">Wooden-Robot/spider-practice</a></p>
<p><a href="https://github.com/sam408130/base_spider" target="_blank" rel="noopener">sam408130/base_spider</a></p>
<p><a href="https://github.com/LJ147/githubSpider" target="_blank" rel="noopener">LJ147/githubSpider</a></p>
<p><a href="https://github.com/facert/awesome-spider" target="_blank" rel="noopener">awesome-spider</a></p>
<p><a href="https://github.com/LiuXingMing/SinaSpider" target="_blank" rel="noopener">LiuXingMing/SinaSpider</a></p>
<p><a href="https://github.com/pujinxiao/sina_spider" target="_blank" rel="noopener">pujinxiao/sina_spider</a></p>
<p><a href="https://github.com/xiaozhiqi2016/spider_advanced" target="_blank" rel="noopener">xiaozhiqi2016/spider_advanced</a></p>
<p><a href="https://github.com/LiuXingMing/LinkedinSpider" target="_blank" rel="noopener">LiuXingMing/LinkedinSpider</a></p>
<p><a href="https://github.com/pujinxiao/zhihu_spider" target="_blank" rel="noopener">pujinxiao/zhihu_spider</a></p>
<p><a href="https://github.com/KDF5000/RuolinSpider" target="_blank" rel="noopener">KDF5000/RuolinSpider</a></p>
<p><a href="https://github.com/hk029/NovelSpider" target="_blank" rel="noopener">hk029/NovelSpider</a></p>
<p><a href="https://github.com/pujinxiao/jobbole_spider" target="_blank" rel="noopener">pujinxiao/jobbole_spider</a></p>
<p><a href="https://github.com/Germey/TouTiao" target="_blank" rel="noopener">Germey/TouTiao</a></p>
<p><a href="https://github.com/Germey/Zhihu" target="_blank" rel="noopener">Germey/Zhihu</a></p>
<p><a href="https://github.com/Germey/Weixin" target="_blank" rel="noopener">Germey/Weixin</a></p>
<p><a href="https://github.com/Germey/MaoYan" target="_blank" rel="noopener">Germey/MaoYan</a></p>
<p><a href="https://github.com/hk029/DoubanMovieSpider" target="_blank" rel="noopener">hk029/DoubanMovieSpider</a></p>
<p><a href="https://github.com/hk029/BaiduTiebaSpider" target="_blank" rel="noopener">hk029/BaiduTiebaSpider</a></p>
<p><a href="https://github.com/Germey/TaobaoComments" target="_blank" rel="noopener">Germey/TaobaoComments</a></p>
<p><a href="https://github.com/Germey/iaskspider" target="_blank" rel="noopener">Germey/iaskspider</a></p>
<p><a href="https://github.com/tpeng/weibosearch" target="_blank" rel="noopener">tpeng/weibosearch</a></p>
<p><a href="https://github.com/piglei/nowater" target="_blank" rel="noopener">piglei/nowater</a></p>
<p><a href="https://github.com/l-passer/Passer-zhihu" target="_blank" rel="noopener">l-passer/Passer-zhihu</a></p>
<p><a href="https://github.com/rg3/youtube-dl" target="_blank" rel="noopener">rg3/youtube-dl</a></p>
<p><a href="https://github.com/gnemoug/sina_reptile" target="_blank" rel="noopener">gnemoug/sina_reptile</a></p>
<p><a href="https://github.com/sam408130/parse-baidu-baike" target="_blank" rel="noopener">sam408130/parse-baidu-baike</a></p>
<p><a href="https://github.com/piglei/tieba_poster" target="_blank" rel="noopener">piglei/tieba_poster</a></p>
<p><a href="https://github.com/darkhandz/BaiduLoginWithTiebaSignin" target="_blank" rel="noopener">darkhandz/BaiduLoginWithTiebaSignin</a></p>
<p><a href="https://github.com/ovwane/jdlingyu" target="_blank" rel="noopener">ovwane/jdlingyu</a></p>
<p><a href="https://github.com/pujinxiao/weixin" target="_blank" rel="noopener">pujinxiao/weixin</a></p>
<p><a href="https://github.com/pujinxiao/crops_pider" target="_blank" rel="noopener">pujinxiao/crops_pider</a></p>
<p><a href="https://github.com/pujinxiao/TaoBao" target="_blank" rel="noopener">pujinxiao/TaoBao</a></p>
<p><a href="https://github.com/pujinxiao/wechat_sogou_crawl" target="_blank" rel="noopener">pujinxiao/wechat_sogou_crawl</a></p>
<p><a href="https://github.com/jaryee/wechat_sogou_crawl" target="_blank" rel="noopener">jaryee/wechat_sogou_crawl</a></p>
<p><a href="https://github.com/pujinxiao/qiantuwang" target="_blank" rel="noopener">pujinxiao/qiantuwang</a></p>
<p><a href="https://github.com/fankcoder/findtrip" target="_blank" rel="noopener">fankcoder/findtrip</a></p>
<p><a href="https://github.com/echopy/QQSpider" target="_blank" rel="noopener">echopy/QQSpider</a></p>
<p><a href="https://github.com/thuxugang/QQSpider" target="_blank" rel="noopener">thuxugang/QQSpider</a></p>
<p><a href="https://github.com/echopy/Maizi" target="_blank" rel="noopener">echopy/Maizi</a></p>
<p><a href="https://github.com/echopy/Baidu_Registration" target="_blank" rel="noopener">echopy/Baidu_Registration</a></p>
<p><a href="https://github.com/ovwane/jdlingyu" target="_blank" rel="noopener">ovwane/jdlingyu</a></p>
<p><a href="https://github.com/dongweiming/weapp-zhihulive" target="_blank" rel="noopener">dongweiming/weapp-zhihulive</a></p>
<p><a href="https://github.com/LiuXingMing/Tmall1212" target="_blank" rel="noopener">LiuXingMing/Tmall1212</a></p>
<p><a href="https://github.com/LiuXingMing/QQSpider" target="_blank" rel="noopener">LiuXingMing/QQSpider</a></p>
<p><a href="https://github.com/Germey/TaobaoUser" target="_blank" rel="noopener">Germey/TaobaoUser</a></p>
<p><a href="https://github.com/BruceDone/cnbeta" target="_blank" rel="noopener">BruceDone/cnbeta</a></p>
<p><a href="https://github.com/hk029/Pickup" target="_blank" rel="noopener">hk029/Pickup</a></p>
<p><a href="https://github.com/hk029/doubanbook" target="_blank" rel="noopener">hk029/doubanbook</a></p>
<p><a href="https://github.com/DormyMo/scrappy" target="_blank" rel="noopener">DormyMo/scrappy</a></p>
<h1 id="webdriver"><a href="#webdriver" class="headerlink" title="webdriver"></a>webdriver</h1><p><a href="https://github.com/easonhan007/webdriver_guide" target="_blank" rel="noopener">asonhan007/webdriver_guide</a></p>
<p>#PySpider 爬虫</p>
<p><a href="https://github.com/Germey/PySpiders" target="_blank" rel="noopener">Germey/PySpiders</a></p>
<p><a href="https://github.com/rmax/scrapy-redis" target="_blank" rel="noopener">rmax/scrapy-redis</a></p>
<p><a href="https://github.com/LJ147/ImageSpyder" target="_blank" rel="noopener">LJ147/ImageSpyder</a></p>
<p>#验证码<br>知乎<br><a href="https://github.com/liyaopinner/zheye" target="_blank" rel="noopener">iyaopinner/zheye</a></p>
<p><a href="https://github.com/muchrooms/zheye" target="_blank" rel="noopener">muchrooms/zheye</a></p>
<p><a href="https://github.com/Germey/Python3" target="_blank" rel="noopener">Germey/Python3</a></p>
<p><a href="https://github.com/LJ147/github-trending" target="_blank" rel="noopener">LJ147/github-trending</a></p>
<p><a href="https://github.com/pujinxiao/zhilian" target="_blank" rel="noopener">pujinxiao/zhilian</a></p>
<p><a href="https://github.com/LiuXingMing/WeiboSliderCode" target="_blank" rel="noopener">LiuXingMing/WeiboSliderCode</a></p>
<p><a href="https://github.com/Germey/crack-geetest" target="_blank" rel="noopener">Germey/crack-geetest</a></p>
<p><a href="https://github.com/dzhongyi/crack-geetest" target="_blank" rel="noopener">dzhongyi/crack-geetest</a></p>
<p><a href="https://github.com/DormyMo/ProxyCrawler" target="_blank" rel="noopener">DormyMo/ProxyCrawler</a></p>
<p>#登录<br><a href="https://github.com/xchaoinfo/fuck-login" target="_blank" rel="noopener">xchaoinfo/fuck-login</a></p>
<p><a href="https://github.com/pujinxiao/douban_login" target="_blank" rel="noopener">pujinxiao/douban_login</a></p>
<p><a href="https://github.com/LiuXingMing/WeiboSliderCode" target="_blank" rel="noopener">LiuXingMing/WeiboSliderCode</a></p>
<h1 id="UA"><a href="#UA" class="headerlink" title="UA"></a>UA</h1><p><a href="https://github.com/hellysmile/fake-useragent" target="_blank" rel="noopener">hellysmile/fake-useragent</a></p>
<p>#爬虫知乎专栏</p>
<p><a href="https://zhuanlan.zhihu.com/Ehco-python" target="_blank" rel="noopener">从零开始写Python爬虫</a></p>
<p><a href="https://zhuanlan.zhihu.com/python-cn" target="_blank" rel="noopener">Python之美-董伟明</a><br><a href="http://www.cnblogs.com/jinxiao-pu/p/6706319.htm" target="_blank" rel="noopener">python分布式爬虫打造搜索引擎——–scrapy实现</a><br><a href="https://github.com/pujinxiao/project_pjx" target="_blank" rel="noopener">pujinxiao/project_pjx</a></p>
<p><a href="https://github.com/qiyeboy" target="_blank" rel="noopener">七夜安全爬虫 490个项目</a></p>
<p>#数据分析</p>
<p><a href="https://github.com/wwj718/Zhihu_bigdata" target="_blank" rel="noopener">wwj718/Zhihu_bigdata</a></p>
<p><a href="https://github.com/yoghurtjia/Zhihu_bigdata" target="_blank" rel="noopener">yoghurtjia/Zhihu_bigdata</a></p>
<p><a href="https://github.com/yoghurtjia/-python-BAT-" target="_blank" rel="noopener">针对常见的BAT公司中的大数据面试和笔试问题，列出解决思路，并使用python来实现</a></p>
<p><a href="https://github.com/yoghurtjia/sortquery" target="_blank" rel="noopener">yoghurtjia/sortquery 有10个文件，每个文件1G，每个文件的每行存放的都是用户的query（请自己随机产生），每个文件的query都可能重复。要求你按照query的频度排序。</a></p>
<p><a href="https://github.com/younghz/TBBKAnalysis" target="_blank" rel="noopener">关于淘宝“爆款”数据爬取与分析</a><br><a href="https://github.com/adbmal/sortquery" target="_blank" rel="noopener">adbmal/sortquery</a></p>
<p><a href="https://github.com/KDF5000/RqFetchData" target="_blank" rel="noopener">KDF5000/RqFetchData</a></p>
<p>#爬虫监控<br><a href="https://github.com/pc10201/markets_monitor" target="_blank" rel="noopener">pc10201/markets_monitor</a></p>
<p>#学习记录<br><a href="https://github.com/yoghurtjia/github-pages" target="_blank" rel="noopener">yoghurtjia/github-pages</a></p>
<p><a href="https://github.com/zzbkszd/github-pages" target="_blank" rel="noopener">zzbkszd/github-pages</a></p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-去北京" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/06/15/去北京/" class="article-date">
      <time datetime="2015-06-15T10:13:00.000Z" itemprop="datePublished">2015-06-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/15/去北京/">去北京</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <pre><code>坐上广州开往北京的列车。
</code></pre>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-LNAMP配置WordPress" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/05/17/LNAMP配置WordPress/" class="article-date">
      <time datetime="2015-05-17T15:21:20.000Z" itemprop="datePublished">2015-05-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/05/17/LNAMP配置WordPress/">LNAMP配置运行WordPress</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>LNAMP配置运行WordPress</p>
<h2 id="nginx-301重定向配置"><a href="#nginx-301重定向配置" class="headerlink" title="nginx 301重定向配置"></a><a href="http://www.ttlsa.com/nginx/nginx-301-redirect/" target="_blank" rel="noopener">nginx 301重定向配置</a></h2><p>301重定向不陌生, 有时候有需求把某目录整个重定向到一个二级域名,或者不带www的顶级域名请求全部重定向到带www的二级域名.如果是Apache，需要配置.htaccess，nginx不支持，需要在配置文件里面使用rewrite指令来实现。</p>
<p>顶级域名重定向到www</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"> server_name ttlsa.com;</span><br><span class="line"> rewrite ^/(.*)$ http://www.ttlsa.com/$1 permanent;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>如上配置，所有ttlsa.com的请求都会重定向到<a href="http://www.ttlsa.com,301重定向对SEO很有帮助.这个配置大家用的最多。" target="_blank" rel="noopener">www.ttlsa.com,301重定向对SEO很有帮助.这个配置大家用的最多。</a></p>
<p>www二级域名重定向到顶级域名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"> server_name www.ttlsa.com;</span><br><span class="line"> rewrite ^/(.*)$ http://domain.com/$1 permanent;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>江湖盛传顶级域名的权重会比www二级域名的权重高，有些seoer会要求运维一定要把www的请求转到顶级域名，和上面的做法相反。</p>
<p>目录重定向</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ( $request_filename ~ nginxjiaocheng/ ) &#123;</span><br><span class="line"> rewrite ^ http://www.ttlsa.com/nginx/? permanent;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>目录跳转新域名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ( $request_filename ~ nginx/ ) &#123;</span><br><span class="line"> rewrite ^ http://nginx.ttlsa.com/? permanent;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/httpd/">httpd</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-去广州" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/04/14/去广州/" class="article-date">
      <time datetime="2015-04-14T09:17:00.000Z" itemprop="datePublished">2015-04-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/14/去广州/">去广州</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <pre><code>上海发向广州的火车。没有买到有座位的票，一路站到广州。
</code></pre>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2014年终总结之败家" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/31/2014年终总结之败家/" class="article-date">
      <time datetime="2014-12-31T08:01:09.000Z" itemprop="datePublished">2014-12-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/31/2014年终总结之败家/">2014年终总结之败家</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2014年终总结之思考" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/31/2014年终总结之思考/" class="article-date">
      <time datetime="2014-12-31T08:00:24.000Z" itemprop="datePublished">2014-12-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/31/2014年终总结之思考/">2014年终总结之思考</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/生活/">生活</a><a class="article-category-link" href="/categories/生活/感想/">感想</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/历史/">历史</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-阿铭Linux培训第5期笔记" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/11/10/阿铭Linux培训第5期笔记/" class="article-date">
      <time datetime="2014-11-10T20:01:25.000Z" itemprop="datePublished">2014-11-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/10/阿铭Linux培训第5期笔记/">阿铭Linux培训第5期笔记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="01-linux简介-如何学习linux"><a href="#01-linux简介-如何学习linux" class="headerlink" title="01 linux简介 如何学习linux"></a>01 linux简介 如何学习linux</h1>
      
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Nginx安装配置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/09/01/Nginx安装配置/" class="article-date">
      <time datetime="2014-09-01T18:10:02.000Z" itemprop="datePublished">2014-09-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/01/Nginx安装配置/">Nginx安装配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://www.ttlsa.com/nginx/nginx-install-on-linux/" target="_blank" rel="noopener">Nginx安装配置</a></p>
<h1 id="nginx介绍"><a href="#nginx介绍" class="headerlink" title="nginx介绍"></a>nginx介绍</h1><p>Nginx是一个自由、开源、高性能及轻量级的HTTP服务器及反转代理服务器，<br>其性能与IMAP/POP3代理服务器相当。Nginx以其高性能、稳定、功能丰富、配置简单及占用系统资源少而著称。<br>Nginx 超越 Apache 的高性能和稳定性，使得国内使用 Nginx 作为 Web 服务器的网站也越来越多.</p>
<h2 id="基础功能"><a href="#基础功能" class="headerlink" title="基础功能"></a>基础功能</h2><p>处理静态文件，索引文件以及自动索引；<br>反向代理加速(无缓存)，简单的负载均衡和容错；<br>FastCGI，简单的负载均衡和容错；<br>模块化的结构。过滤器包括gzipping, byte ranges, chunked responses, 以及 SSI-filter 。在SSI过滤器中，到同一个 proxy 或者 FastCGI 的多个子请求并发处理；<br>SSL 和 TLS SNI 支持；</p>
<h2 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h2><p>Nginx专为性能优化而开发，性能是其最重要的考量, 实现上非常注重效率 。它支持内核Poll模型，能经受高负载的考验, 有报告表明能支持高达 50,000 个并发连接数。<br>Nginx作为负载均衡服务器: Nginx 既可以在内部直接支持 Rails 和 PHP 程序对外进行服务, 也可以支持作为 HTTP代理服务器对外进行服务。<br>Nginx具有很高的稳定性。其它HTTP服务器，当遇到访问的峰值，或者有人恶意发起慢速连接时，也很可能会导致服务器物理内存耗尽频繁交换，失去响应，只能重启服务器。<br>例如当前apache一旦上到200个以上进程，web响应速度就明显非常缓慢了。而Nginx采取了分阶段资源分配技术，使得它的CPU与内存占用率非常低。<br>nginx官方表示保持10,000个没有活动的连接，它只占2.5M内存，就稳定性而言, nginx比lighthttpd更胜一筹。<br>Nginx支持热部署。它的启动特别容易, 并且几乎可以做到7*24不间断运行，即使运行数个月也不需要重新启动。你还能够在不间断服务的情况下，对软件版本进行进行升级。<br>Nginx采用C进行编写, 不论是系统资源开销还是CPU使用效率都比 Perlbal 要好很多。</p>
<h1 id="nginx安装"><a href="#nginx安装" class="headerlink" title="nginx安装"></a>nginx安装</h1><blockquote>
<p>当今nginx的劲头越来越猛，记得2011年版本才1.0.6,现在已经更新到了1.5.1,nginx的更新速度越来越快。</p>
</blockquote>
<h2 id="软件准备"><a href="#软件准备" class="headerlink" title="软件准备"></a>软件准备</h2><h3 id="安装pcre"><a href="#安装pcre" class="headerlink" title="安装pcre"></a>安装pcre</h3><p>为了支持rewrite功能，我们需要安装pcre。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pcre*</span><br></pre></td></tr></table></figure>
<h3 id="安装openssl"><a href="#安装openssl" class="headerlink" title="安装openssl"></a>安装openssl</h3><p>需要ssl的支持，如果不需要ssl支持，请跳过这一步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openssl*</span><br></pre></td></tr></table></figure>
<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.5.1.tar.gz</span><br><span class="line">tar xvf nginx-1.5.1.tar.gz</span><br><span class="line">cd nginx-1.5.1</span><br></pre></td></tr></table></figure>
<p>编译安装nginx</p>
<p>编译参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">--prefix= 指向安装目录</span><br><span class="line">--sbin-path 指向（执行）程序文件（nginx）</span><br><span class="line">--conf-path= 指向配置文件（nginx.conf）</span><br><span class="line">--error-log-path= 指向错误日志目录</span><br><span class="line">--pid-path= 指向pid文件（nginx.pid）</span><br><span class="line">--lock-path= 指向lock文件（nginx.lock）（安装文件锁定，防止安装文件被别人利用，或自己误操作。）</span><br><span class="line">--user= 指定程序运行时的非特权用户</span><br><span class="line">--group= 指定程序运行时的非特权用户组</span><br><span class="line">--builddir= 指向编译目录</span><br><span class="line">--with-rtsig_module 启用rtsig模块支持（实时信号）</span><br><span class="line">--with-select_module 启用select模块支持（一种轮询模式,不推荐在高载环境下使用）禁用：--without-select_module</span><br><span class="line">--with-poll_module 启用poll模块支持（功能与select相同，与select特性相同，为一种轮询模式,不推荐在高载环境下使用）</span><br><span class="line">--with-file-aio 启用file aio支持（一种APL文件传输格式）</span><br><span class="line">--with-ipv6 启用ipv6支持</span><br><span class="line">--with-http_ssl_module 启用ngx_http_ssl_module支持（使支持https请求，需已安装openssl）</span><br><span class="line">--with-http_realip_module 启用ngx_http_realip_module支持（这个模块允许从请求标头更改客户端的IP地址值，默认为关）</span><br><span class="line">--with-http_addition_module 启用ngx_http_addition_module支持（作为一个输出过滤器，支持不完全缓冲，分部分响应请求）</span><br><span class="line">--with-http_xslt_module 启用ngx_http_xslt_module支持（过滤转换XML请求）</span><br><span class="line">--with-http_image_filter_module 启用ngx_http_image_filter_module支持（传输JPEG/GIF/PNG 图片的一个过滤器）（默认为不启用。gd库要用到）</span><br><span class="line">--with-http_geoip_module 启用ngx_http_geoip_module支持（该模块创建基于与MaxMind GeoIP二进制文件相配的客户端IP地址的ngx_http_geoip_module变量）</span><br><span class="line">--with-http_sub_module 启用ngx_http_sub_module支持（允许用一些其他文本替换nginx响应中的一些文本）</span><br><span class="line">--with-http_dav_module 启用ngx_http_dav_module支持（增加PUT,DELETE,MKCOL：创建集合,COPY和MOVE方法）默认情况下为关闭，需编译开启</span><br><span class="line">--with-http_flv_module 启用ngx_http_flv_module支持（提供寻求内存使用基于时间的偏移量文件）</span><br><span class="line">--with-http_gzip_static_module 启用ngx_http_gzip_static_module支持（在线实时压缩输出数据流）</span><br><span class="line">--with-http_random_index_module 启用ngx_http_random_index_module支持（从目录中随机挑选一个目录索引）</span><br><span class="line">--with-http_secure_link_module 启用ngx_http_secure_link_module支持（计算和检查要求所需的安全链接网址）</span><br><span class="line">--with-http_degradation_module  启用ngx_http_degradation_module支持（允许在内存不足的情况下返回204或444码）</span><br><span class="line">--with-http_stub_status_module 启用ngx_http_stub_status_module支持（获取nginx自上次启动以来的工作状态）</span><br><span class="line">--without-http_charset_module 禁用ngx_http_charset_module支持（重新编码web页面，但只能是一个方向--服务器端到客户端，并且只有一个字节的编码可以被重新编码）</span><br><span class="line">--without-http_gzip_module 禁用ngx_http_gzip_module支持（该模块同-with-http_gzip_static_module功能一样）</span><br><span class="line">--without-http_ssi_module 禁用ngx_http_ssi_module支持（该模块提供了一个在输入端处理处理服务器包含文件（SSI）的过滤器，目前支持SSI命令的列表是不完整的）</span><br><span class="line">--without-http_userid_module 禁用ngx_http_userid_module支持（该模块用来处理用来确定客户端后续请求的cookies）</span><br><span class="line">--without-http_access_module 禁用ngx_http_access_module支持（该模块提供了一个简单的基于主机的访问控制。允许/拒绝基于ip地址）</span><br><span class="line">--without-http_auth_basic_module禁用ngx_http_auth_basic_module（该模块是可以使用用户名和密码基于http基本认证方法来保护你的站点或其部分内容）</span><br><span class="line">--without-http_autoindex_module 禁用disable ngx_http_autoindex_module支持（该模块用于自动生成目录列表，只在ngx_http_index_module模块未找到索引文件时发出请求。）</span><br><span class="line">--without-http_geo_module 禁用ngx_http_geo_module支持（创建一些变量，其值依赖于客户端的IP地址）</span><br><span class="line">--without-http_map_module 禁用ngx_http_map_module支持（使用任意的键/值对设置配置变量）</span><br><span class="line">--without-http_split_clients_module 禁用ngx_http_split_clients_module支持（该模块用来基于某些条件划分用户。条件如：ip地址、报头、cookies等等）</span><br><span class="line">--without-http_referer_module 禁用disable ngx_http_referer_module支持（该模块用来过滤请求，拒绝报头中Referer值不正确的请求）</span><br><span class="line">--without-http_rewrite_module 禁用ngx_http_rewrite_module支持（该模块允许使用正则表达式改变URI，并且根据变量来转向以及选择配置。如果在server级别设置该选项，那么他们将在 location之前生效。如果在location还有更进一步的重写规则，location部分的规则依然会被执行。如果这个URI重写是因为location部分的规则造成的，那么 location部分会再次被执行作为新的URI。 这个循环会执行10次，然后Nginx会返回一个500错误。）</span><br><span class="line">--without-http_proxy_module 禁用ngx_http_proxy_module支持（有关代理服务器）</span><br><span class="line">--without-http_fastcgi_module 禁用ngx_http_fastcgi_module支持（该模块允许Nginx 与FastCGI 进程交互，并通过传递参数来控制FastCGI 进程工作。 ）FastCGI一个常驻型的公共网关接口。</span><br><span class="line">--without-http_uwsgi_module 禁用ngx_http_uwsgi_module支持（该模块用来医用uwsgi协议，uWSGI服务器相关）</span><br><span class="line">--without-http_scgi_module 禁用ngx_http_scgi_module支持（该模块用来启用SCGI协议支持，SCGI协议是CGI协议的替代。它是一种应用程序与HTTP服务接口标准。它有些像FastCGI但他的设计 更容易实现。）</span><br><span class="line">--without-http_memcached_module 禁用ngx_http_memcached_module支持（该模块用来提供简单的缓存，以提高系统效率）</span><br><span class="line">-without-http_limit_zone_module 禁用ngx_http_limit_zone_module支持（该模块可以针对条件，进行会话的并发连接数控制）</span><br><span class="line">--without-http_limit_req_module 禁用ngx_http_limit_req_module支持（该模块允许你对于一个地址进行请求数量的限制用一个给定的session或一个特定的事件）</span><br><span class="line">--without-http_empty_gif_module 禁用ngx_http_empty_gif_module支持（该模块在内存中常驻了一个1*1的透明GIF图像，可以被非常快速的调用）</span><br><span class="line">--without-http_browser_module 禁用ngx_http_browser_module支持（该模块用来创建依赖于请求报头的值。如果浏览器为modern ，则$modern_browser等于modern_browser_value指令分配的值；如 果浏览器为old，则$ancient_browser等于 ancient_browser_value指令分配的值；如果浏览器为 MSIE中的任意版本，则 $msie等于1）</span><br><span class="line">--without-http_upstream_ip_hash_module 禁用ngx_http_upstream_ip_hash_module支持（该模块用于简单的负载均衡）</span><br><span class="line">--with-http_perl_module 启用ngx_http_perl_module支持（该模块使nginx可以直接使用perl或通过ssi调用perl）</span><br><span class="line">--with-perl_modules_path= 设定perl模块路径</span><br><span class="line">--with-perl= 设定perl库文件路径</span><br><span class="line">--http-log-path= 设定access log路径</span><br><span class="line">--http-client-body-temp-path= 设定http客户端请求临时文件路径</span><br><span class="line">--http-proxy-temp-path= 设定http代理临时文件路径</span><br><span class="line">--http-fastcgi-temp-path= 设定http fastcgi临时文件路径</span><br><span class="line">--http-uwsgi-temp-path= 设定http uwsgi临时文件路径</span><br><span class="line">--http-scgi-temp-path= 设定http scgi临时文件路径</span><br><span class="line">-without-http 禁用http server功能</span><br><span class="line">--without-http-cache 禁用http cache功能</span><br><span class="line">--with-mail 启用POP3/IMAP4/SMTP代理模块支持</span><br><span class="line">--with-mail_ssl_module 启用ngx_mail_ssl_module支持</span><br><span class="line">--without-mail_pop3_module 禁用pop3协议（POP3即邮局协议的第3个版本,它是规定个人计算机如何连接到互联网上的邮件服务器进行收发邮件的协议。是因特网电子邮件的第一个离线协议标 准,POP3协议允许用户从服务器上把邮件存储到本地主机上,同时根据客户端的操作删除或保存在邮件服务器上的邮件。POP3协议是TCP/IP协议族中的一员，主要用于 支持使用客户端远程管理在服务器上的电子邮件）</span><br><span class="line">--without-mail_imap_module 禁用imap协议（一种邮件获取协议。它的主要作用是邮件客户端可以通过这种协议从邮件服务器上获取邮件的信息，下载邮件等。IMAP协议运行在TCP/IP协议之上， 使用的端口是143。它与POP3协议的主要区别是用户可以不用把所有的邮件全部下载，可以通过客户端直接对服务器上的邮件进行操作。）</span><br><span class="line">--without-mail_smtp_module 禁用smtp协议（SMTP即简单邮件传输协议,它是一组用于由源地址到目的地址传送邮件的规则，由它来控制信件的中转方式。SMTP协议属于TCP/IP协议族，它帮助每台计算机在发送或中转信件时找到下一个目的地。）</span><br><span class="line">--with-google_perftools_module 启用ngx_google_perftools_module支持（调试用，剖析程序性能瓶颈）</span><br><span class="line">--with-cpp_test_module 启用ngx_cpp_test_module支持</span><br><span class="line">--add-module= 启用外部模块支持</span><br><span class="line">--with-cc= 指向C编译器路径</span><br><span class="line">--with-cpp= 指向C预处理路径</span><br><span class="line">--with-cc-opt= 设置C编译器参数（PCRE库，需要指定–with-cc-opt=”-I /usr/local/include”，如果使用select()函数则需要同时增加文件描述符数量，可以通过–with-cc- opt=”-D FD_SETSIZE=2048”指定。）</span><br><span class="line">--with-ld-opt= 设置连接文件参数。（PCRE库，需要指定–with-ld-opt=”-L /usr/local/lib”。）</span><br><span class="line">--with-cpu-opt= 指定编译的CPU，可用的值为: pentium, pentiumpro, pentium3, pentium4, athlon, opteron, amd64, sparc32, sparc64, ppc64</span><br><span class="line">--without-pcre 禁用pcre库</span><br><span class="line">--with-pcre 启用pcre库</span><br><span class="line">--with-pcre= 指向pcre库文件目录</span><br><span class="line">--with-pcre-opt= 在编译时为pcre库设置附加参数</span><br><span class="line">--with-md5= 指向md5库文件目录（消息摘要算法第五版，用以提供消息的完整性保护）</span><br><span class="line">--with-md5-opt= 在编译时为md5库设置附加参数</span><br><span class="line">--with-md5-asm 使用md5汇编源</span><br><span class="line">--with-sha1= 指向sha1库目录（数字签名算法，主要用于数字签名）</span><br><span class="line">--with-sha1-opt= 在编译时为sha1库设置附加参数</span><br><span class="line">--with-sha1-asm 使用sha1汇编源</span><br><span class="line">--with-zlib= 指向zlib库目录</span><br><span class="line">--with-zlib-opt= 在编译时为zlib设置附加参数</span><br><span class="line">--with-zlib-asm= 为指定的CPU使用zlib汇编源进行优化，CPU类型为pentium, pentiumpro</span><br><span class="line">--with-libatomic 为原子内存的更新操作的实现提供一个架构</span><br><span class="line">--with-libatomic= 指向libatomic_ops安装目录</span><br><span class="line">--with-openssl= 指向openssl安装目录</span><br><span class="line">--with-openssl-opt 在编译时为openssl设置附加参数</span><br><span class="line">--with-debug 启用debug日志</span><br></pre></td></tr></table></figure>
<p>安装make工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install make -y</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-pcre</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="启动nginx"><a href="#启动nginx" class="headerlink" title="启动nginx"></a>启动nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#启动</span><br><span class="line">/usr/local/nginx/sbin/nginx start</span><br><span class="line">#关闭</span><br><span class="line">/usr/local/nginx/sbin/nginx stop</span><br><span class="line">#重新加载配置文件</span><br><span class="line">/usr/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="nginx安全配置"><a href="#nginx安全配置" class="headerlink" title="nginx安全配置"></a>nginx安全配置</h2><h3 id="隐藏Nginx版本号"><a href="#隐藏Nginx版本号" class="headerlink" title="隐藏Nginx版本号"></a>隐藏Nginx版本号</h3><p>server_tokens off;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">keepalive_timeout 60;</span><br><span class="line">tcp_nodelay on;</span><br><span class="line">server_tokens off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果使用了php-fpm,需要修改fastcfi.conf或fcgi.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_param SERVER_SOFTWARE nginx/$nginx_version;</span><br><span class="line">改为：</span><br><span class="line">fastcgi_param SERVER_SOFTWARE nginx;</span><br></pre></td></tr></table></figure>
<p>### </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">在配置文件中小心使用&quot;if&quot;</span><br><span class="line">它是重写模块的一部分，不应该在任何地方使用。</span><br><span class="line">“if”声明是重写模块评估指令强制性的部分。换个说法，Nginx的配置一般来说是声明式的。在有些情况下，由于用户的需求，他们试图在一些非重写指令内使用“if”，这导致我们现在遇到的情况。大多数情况下都能正常工作，但…看上面提到的。</span><br><span class="line">看起来唯一正确的解决方案是在非重写的指令内完全禁用“if”。这将更改现有的许多配置，所以还没有完成。IfIsEvil：http://wiki.nginx.org/IfIsEvil</span><br><span class="line"></span><br><span class="line">将每个~ .php$请求转递给PHP</span><br><span class="line">我们上周发布了这个流行指令的潜在安全漏洞介绍。即使文件名为hello.php.jpeg它也会匹配~ .php$这个正则而执行文件。</span><br><span class="line">现在有两个解决上述问题的好方法。我觉得确保你不轻易执行任意代码的混合方法很有必要。</span><br><span class="line"></span><br><span class="line">1 如果没找到文件时使用try_files和only(在所有的动态执行情况下都应该注意) 将它转递给运行PHP的FCGI进程。</span><br><span class="line">2 确认php.ini文件中cgi.fix_pathinfo设置为0 (cgi.fix_pathinfo=0) 。这样确保PHP检查文件全名(当它在文件结尾没有发现.php它将忽略)</span><br><span class="line">3 修复正则表达式匹配不正确文件的问题。现在正则表达式认为任何文件都包含&quot;.php&quot;。在站点后加“if”确保只有正确的文件才能运行。将/location ~ .php$和location ~ ..*/.*.php$都设置为return 403;</span><br><span class="line"></span><br><span class="line">禁用autoindex模块</span><br><span class="line">这个可能在你使用的Nginx版本中已经更改了，如果没有的话只需在配置文件的location块中增加autoindex off;声明即可。</span><br><span class="line"></span><br><span class="line">禁用服务器上的ssi (服务器端引用)</span><br><span class="line">这个可以通过在location块中添加ssi off; 。</span><br><span class="line"></span><br><span class="line">在配置文件中设置自定义缓存以限制缓冲区溢出攻击的可能性</span><br><span class="line"></span><br><span class="line">client_body_buffer_size 1K;</span><br><span class="line">client_header_buffer_size 1k;</span><br><span class="line">client_max_body_size 1k;</span><br><span class="line">large_client_header_buffers 2 1k;</span><br><span class="line"></span><br><span class="line">将timeout设低来防止DOS攻击</span><br><span class="line">所有这些声明都可以放到主配置文件中。</span><br><span class="line"></span><br><span class="line">client_body_timeout 10;</span><br><span class="line">client_header_timeout 10;</span><br><span class="line">keepalive_timeout 5 5;</span><br><span class="line">send_timeout 10;</span><br><span class="line"></span><br><span class="line">限制用户连接数来预防DOS攻击</span><br><span class="line"></span><br><span class="line">limit_zone slimits $binary_remote_addr 5m;</span><br><span class="line">limit_conn slimits 5;</span><br><span class="line"></span><br><span class="line">试着避免使用HTTP认证</span><br><span class="line">HTTP认证默认使用crypt，它的哈希并不安全。如果你要用的话就用MD5（这也不是个好选择但负载方面比crypt好） 。</span><br><span class="line"></span><br><span class="line">保持与最新的Nginx安全更新</span><br></pre></td></tr></table></figure>
<h2 id="nginx日志配置"><a href="#nginx日志配置" class="headerlink" title="nginx日志配置"></a>nginx日志配置</h2><p>日志对于统计排错来说非常有利的。</p>
<p>nginx日志相关的配置如access_log、log_format、open_log_file_cache、log_not_found、log_subrequest、rewrite_log、error_log。</p>
<p>nginx有一个非常灵活的日志记录模式。每个级别的配置可以有各自独立的访问日志。日志格式通过log_format命令来定义。ngx_http_log_module是用来定义请求日志格式的。</p>
<h3 id="access-log指令"><a href="#access-log指令" class="headerlink" title="access_log指令"></a>access_log指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">语法: access_log path [format [buffer=size [flush=time]]];</span><br><span class="line">access_log path format gzip[=level] [buffer=size] [flush=time];</span><br><span class="line">access_log syslog:server=address[,parameter=value] [format];</span><br><span class="line">access_log off;</span><br><span class="line">默认值: access_log logs/access.log combined;</span><br><span class="line">配置段: http, server, location, if in location, limit_except</span><br><span class="line">gzip压缩等级。</span><br><span class="line">buffer设置内存缓存区大小。</span><br><span class="line">flush保存在缓存区中的最长时间。</span><br><span class="line">不记录日志：access_log off;</span><br><span class="line">使用默认combined格式记录日志：access_log logs/access.log 或 access_log logs/access.log combined;</span><br></pre></td></tr></table></figure>
<h3 id="log-format指令"><a href="#log-format指令" class="headerlink" title="log_format指令"></a>log_format指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">语法: log_format name string …;</span><br><span class="line">默认值: log_format combined “…”;</span><br><span class="line">配置段: http</span><br></pre></td></tr></table></figure>
<p>name表示格式名称，string表示等义的格式。log_format有一个默认的无需设置的combined日志格式，相当于apache的combined日志格式，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log_format  combined  &apos;$remote_addr - $remote_user  [$time_local]  &apos;</span><br><span class="line">                                   &apos; &quot;$request&quot;  $status  $body_bytes_sent  &apos;</span><br><span class="line">                                   &apos; &quot;$http_referer&quot;  &quot;$http_user_agent&quot; &apos;;</span><br><span class="line">log_format  combined  &apos;$remote_addr - $remote_user  [$time_local]  &apos;</span><br><span class="line">                                   &apos; &quot;$request&quot;  $status  $body_bytes_sent  &apos;</span><br><span class="line">                                   &apos; &quot;$http_referer&quot;  &quot;$http_user_agent&quot; &apos;;</span><br></pre></td></tr></table></figure>
<p>如果nginx位于负载均衡器，squid，nginx反向代理之后，web服务器无法直接获取到客户端真实的IP地址了。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$remote_addr获取反向代理的IP地址。反向代理服务器在转发请求的http头信息中，可以增加X-Forwarded-For信息，用来记录 客户端IP地址和客户端请求的服务器地址。</span><br><span class="line"></span><br><span class="line">log_format  porxy  &apos;$http_x_forwarded_for - $remote_user  [$time_local]  &apos;</span><br><span class="line">                             &apos; &quot;$request&quot;  $status $body_bytes_sent &apos;</span><br><span class="line">                             &apos; &quot;$http_referer&quot;  &quot;$http_user_agent&quot; &apos;;</span><br><span class="line">log_format  porxy  &apos;$http_x_forwarded_for - $remote_user  [$time_local]  &apos;</span><br><span class="line">                             &apos; &quot;$request&quot;  $status $body_bytes_sent &apos;</span><br><span class="line">                             &apos; &quot;$http_referer&quot;  &quot;$http_user_agent&quot; &apos;;</span><br></pre></td></tr></table></figure>
<p>日志格式允许包含的变量注释如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$remote_addr, $http_x_forwarded_for 记录客户端IP地址</span><br><span class="line">$remote_user 记录客户端用户名称</span><br><span class="line">$request 记录请求的URL和HTTP协议</span><br><span class="line">$status 记录请求状态</span><br><span class="line">$body_bytes_sent 发送给客户端的字节数，不包括响应头的大小； 该变量与Apache模块mod_log_config里的“%B”参数兼容。</span><br><span class="line">$bytes_sent 发送给客户端的总字节数。</span><br><span class="line">$connection 连接的序列号。</span><br><span class="line">$connection_requests 当前通过一个连接获得的请求数量。</span><br><span class="line">$msec 日志写入时间。单位为秒，精度是毫秒。</span><br><span class="line">$pipe 如果请求是通过HTTP流水线(pipelined)发送，pipe值为“p”，否则为“.”。</span><br><span class="line">$http_referer 记录从哪个页面链接访问过来的</span><br><span class="line">$http_user_agent 记录客户端浏览器相关信息</span><br><span class="line">$request_length 请求的长度（包括请求行，请求头和请求正文）。</span><br><span class="line">$request_time 请求处理时间，单位为秒，精度毫秒； 从读入客户端的第一个字节开始，直到把最后一个字符发送给客户端后进行日志写入为止。</span><br><span class="line">$time_iso8601 ISO8601标准格式下的本地时间。</span><br><span class="line">$time_local 通用日志格式下的本地时间。</span><br><span class="line"></span><br><span class="line">$remote_addr, $http_x_forwarded_for 记录客户端IP地址</span><br><span class="line">$remote_user 记录客户端用户名称</span><br><span class="line">$request 记录请求的URL和HTTP协议</span><br><span class="line">$status 记录请求状态</span><br><span class="line">$body_bytes_sent 发送给客户端的字节数，不包括响应头的大小； 该变量与Apache模块mod_log_config里的“%B”参数兼容。</span><br><span class="line">$bytes_sent 发送给客户端的总字节数。</span><br><span class="line">$connection 连接的序列号。</span><br><span class="line">$connection_requests 当前通过一个连接获得的请求数量。</span><br><span class="line">$msec 日志写入时间。单位为秒，精度是毫秒。</span><br><span class="line">$pipe 如果请求是通过HTTP流水线(pipelined)发送，pipe值为“p”，否则为“.”。</span><br><span class="line">$http_referer 记录从哪个页面链接访问过来的</span><br><span class="line">$http_user_agent 记录客户端浏览器相关信息</span><br><span class="line">$request_length 请求的长度（包括请求行，请求头和请求正文）。</span><br><span class="line">$request_time 请求处理时间，单位为秒，精度毫秒； 从读入客户端的第一个字节开始，直到把最后一个字符发送给客户端后进行日志写入为止。</span><br><span class="line">$time_iso8601 ISO8601标准格式下的本地时间。</span><br><span class="line">$time_local 通用日志格式下的本地时间。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>发送给客户端的响应头拥有“sent_http_”前缀。 比如$sent_http_content_range。</p>
</blockquote>
<p>实例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">	log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                                        &apos;&quot;$status&quot; $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                                        &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &apos;</span><br><span class="line">                                        &apos;&quot;$gzip_ratio&quot; $request_time $bytes_sent $request_length&apos;;</span><br><span class="line"></span><br><span class="line">	log_format srcache_log &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                                &apos;&quot;$status&quot; $body_bytes_sent $request_time $bytes_sent $request_length &apos;</span><br><span class="line">                                &apos;[$upstream_response_time] [$srcache_fetch_status] [$srcache_store_status] [$srcache_expire]&apos;;</span><br><span class="line"></span><br><span class="line">	open_log_file_cache max=1000 inactive=60s;</span><br><span class="line"></span><br><span class="line">	server &#123;</span><br><span class="line">		server_name ~^(www\.)?(.+)$;</span><br><span class="line">		access_log logs/$2-access.log main;</span><br><span class="line">		error_log logs/$2-error.log;</span><br><span class="line"></span><br><span class="line">		location /srcache &#123;</span><br><span class="line">			access_log logs/access-srcache.log srcache_log;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="open-log-file-cache指令"><a href="#open-log-file-cache指令" class="headerlink" title="open_log_file_cache指令"></a>open_log_file_cache指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法: open_log_file_cache max=N [inactive=time] [min_uses=N] [valid=time];</span><br><span class="line">open_log_file_cache off;</span><br><span class="line">默认值: open_log_file_cache off;</span><br><span class="line">配置段: http, server, location</span><br></pre></td></tr></table></figure>
<p>对于每一条日志记录，都将是先打开文件，再写入日志，然后关闭。可以使用open_log_file_cache来设置日志文件缓存(默认是off)，格式如下：<br>参数注释如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">max:设置缓存中的最大文件描述符数量，如果缓存被占满，采用LRU算法将描述符关闭。</span><br><span class="line">inactive:设置存活时间，默认是10s</span><br><span class="line">min_uses:设置在inactive时间段内，日志文件最少使用多少次后，该日志文件描述符记入缓存中，默认是1次</span><br><span class="line">valid:设置检查频率，默认60s</span><br><span class="line">off：禁用缓存</span><br></pre></td></tr></table></figure>
<p>实例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">open_log_file_cache max=1000 inactive=20s valid=1m min_uses=2;</span><br><span class="line">open_log_file_cache max=1000 inactive=20s valid=1m min_uses=2;</span><br></pre></td></tr></table></figure>
<h3 id="log-not-found指令"><a href="#log-not-found指令" class="headerlink" title="log_not_found指令"></a>log_not_found指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法: log_not_found on | off;</span><br><span class="line">默认值: log_not_found on;</span><br><span class="line">配置段: http, server, location</span><br><span class="line">是否在error_log中记录不存在的错误。默认是。</span><br></pre></td></tr></table></figure>
<h3 id="log-subrequest指令"><a href="#log-subrequest指令" class="headerlink" title="log_subrequest指令"></a>log_subrequest指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法: log_subrequest on | off;</span><br><span class="line">默认值: log_subrequest off;</span><br><span class="line">配置段: http, server, location</span><br><span class="line">是否在access_log中记录子请求的访问日志。默认不记录。</span><br></pre></td></tr></table></figure>
<h3 id="rewrite-log指令"><a href="#rewrite-log指令" class="headerlink" title="rewrite_log指令"></a>rewrite_log指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">由ngx_http_rewrite_module模块提供的。用来记录重写日志的。对于调试重写规则建议开启。 Nginx重写规则指南</span><br><span class="line">语法: rewrite_log on | off;</span><br><span class="line">默认值: rewrite_log off;</span><br><span class="line">配置段: http, server, location, if</span><br><span class="line">启用时将在error log中记录notice级别的重写日志。</span><br></pre></td></tr></table></figure>
<h3 id="error-log指令"><a href="#error-log指令" class="headerlink" title="error_log指令"></a>error_log指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法: error_log file | stderr | syslog:server=address[,parameter=value] [debug | info | notice | warn | error | crit | alert | emerg];</span><br><span class="line">默认值: error_log logs/error.log error;</span><br><span class="line">配置段: main, http, server, location</span><br><span class="line">配置错误日志。</span><br></pre></td></tr></table></figure>
<h3 id="nginx日志切割"><a href="#nginx日志切割" class="headerlink" title="nginx日志切割"></a>nginx日志切割</h3><p>nginx日志默认情况下统统写入到一个文件中，文件会变的越来越大，非常不方便查看分析。以日期来作为日志的切割是比较好的，通常我们是以每日来做统计的。下面来说说nginx日志切割。</p>
<h4 id="定义日志轮滚策略"><a href="#定义日志轮滚策略" class="headerlink" title="定义日志轮滚策略"></a>定义日志轮滚策略</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim nginx-log-rotate</span><br><span class="line"></span><br><span class="line">/data/logs/nginx/*.log &#123;</span><br><span class="line">    nocompress</span><br><span class="line">    daily</span><br><span class="line">    copytruncate</span><br><span class="line">    create</span><br><span class="line">    notifempty</span><br><span class="line">    rotate 7</span><br><span class="line">    olddir /data/logs/nginx/old_log</span><br><span class="line">    missingok</span><br><span class="line">    dateext</span><br><span class="line">    postrotate</span><br><span class="line">        /bin/kill -HUP `cat /var/run/nginx.pid 2&gt; /dev/null` 2&gt; /dev/null || true</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>/data/logs/nginx/*.log使用通配符时，/data/logs/nginx/目录下的所有匹配到的日志文件都将切割。如果要切割特定日志文件，就指定到该文件。</p>
<h4 id="设置计划任务"><a href="#设置计划任务" class="headerlink" title="设置计划任务"></a>设置计划任务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/crontab</span><br><span class="line">59 23 * * * root ( /usr/sbin/logrotate -f /PATH/TO/nginx-log-rotate)</span><br><span class="line">1</span><br><span class="line">59 23 * * * root ( /usr/sbin/logrotate -f /PATH/TO/nginx-log-rotate)</span><br><span class="line">这样每天23点59分钟执行日志切割。</span><br></pre></td></tr></table></figure>
<h2 id="配置虚拟主机"><a href="#配置虚拟主机" class="headerlink" title="配置虚拟主机"></a>配置虚拟主机</h2><h3 id="新建目录"><a href="#新建目录" class="headerlink" title="新建目录"></a>新建目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#站点目录</span><br><span class="line">mkdir /data/wwwroot -p</span><br><span class="line">cd /data/wwwroot/</span><br><span class="line">mkdir a.ttlsa.com</span><br><span class="line">mkdir b.ttlsa.com</span><br><span class="line">#日志文件目录</span><br><span class="line">mkdir /data/logs/nginx -p</span><br></pre></td></tr></table></figure>
<h4 id="配置nginx主配置文件"><a href="#配置nginx主配置文件" class="headerlink" title="配置nginx主配置文件"></a>配置nginx主配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">server&#123;</span><br><span class="line">server_name a.ttlsa.com;</span><br><span class="line">listen 80;</span><br><span class="line">root /data/wwwroot/a.ttlsa.com;</span><br><span class="line"> </span><br><span class="line">access_log /data/logs/nginx/a.ttlsa.com-access.log main;</span><br><span class="line">location /</span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">server&#123;</span><br><span class="line">server_name b.ttlsa.com;</span><br><span class="line">listen 80;</span><br><span class="line">root /data/wwwroot/b.ttlsa.com;</span><br><span class="line"> </span><br><span class="line">access_log /data/logs/nginx/b.ttlsa.com-access.log main;</span><br><span class="line">location /</span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置讲解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server&#123;&#125;：配置虚拟主机必须有这个段。</span><br><span class="line">server_name：虚拟主机的域名，可以写多个域名，类似于别名，比如说你可以配置成</span><br><span class="line">server_name b.ttlsa.com c.ttlsa.com d.ttlsa.com，这样的话，访问任何一个域名，内容都是一样的</span><br><span class="line">listen 80，监听ip和端口，这边仅仅只有端口，表示当前服务器所有ip的80端口，如果只想监听127.0.0.1的80，写法如下：</span><br><span class="line">listen 127.0.0.1:80</span><br><span class="line">root /data/site/b.ttlsa.com：站点根目录，你网站文件存放的地方。注：站点目录和域名尽量一样，养成一个好习惯</span><br><span class="line">access_log /data/logs/nginx/b.ttlsa.com-access.log main：访问日志</span><br><span class="line">location /&#123;&#125; 默认uri,location具体内容后续讲解,大家关注一下.</span><br></pre></td></tr></table></figure>
<p>检查nginx配置文件并启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -t</span><br><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
<h2 id="nginx正向代理"><a href="#nginx正向代理" class="headerlink" title="nginx正向代理"></a>nginx正向代理</h2><p>我们平时用的最多的最常见的是反向代理。反向代理想必都会配置的， 那么nginx的正向代理是如何配置的呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 8090;</span><br><span class="line">	location / &#123;</span><br><span class="line">			resolver 218.85.157.99 218.85.152.99;</span><br><span class="line">			resolver_timeout 30s;</span><br><span class="line">			proxy_pass http://$host$request_uri;</span><br><span class="line">	&#125;</span><br><span class="line">	access_log  /data/httplogs/proxy-$host-aceess.log;      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就这么简单哈。<br>测试：<br><a href="http://www.ttlsa.com:8090" target="_blank" rel="noopener">http://www.ttlsa.com:8090</a></p>
<p>resolver指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">语法: resolver address ... [valid=time];</span><br><span class="line">默认值: —</span><br><span class="line">配置段: http, server, location</span><br><span class="line">配置DNS服务器IP地址。可以指定多个，以轮询方式请求。</span><br><span class="line">nginx会缓存解析的结果。默认情况下，缓存时间是名字解析响应中的TTL字段的值，可以通过valid参数更改。</span><br></pre></td></tr></table></figure>
<p>resolver_timeout指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法: resolver_timeout time;</span><br><span class="line">默认值: resolver_timeout 30s;</span><br><span class="line">配置段: http, server, location</span><br><span class="line">解析超时时间。</span><br></pre></td></tr></table></figure>
<h2 id="nginx反向代理"><a href="#nginx反向代理" class="headerlink" title="nginx反向代理"></a>nginx反向代理</h2><p>由于公司内网有多台服务器的http服务要映射到公司外网静态IP，如果用路由的端口映射来做，就只能一台内网服务器的80端口映射到外网80端口，其他服务器的80端口只能映射到外网的非80端口。非80端口的映射在访问的时候要域名加上端口，比较麻烦。并且公司入口路由最多只能做20个端口映射。肯定以后不够用。<br>然后k兄就提议可以在内网搭建个nginx反向代理服务器，将nginx反向代理服务器的80映射到外网IP的80，这样指向到公司外网IP的域名的HTTP请求就会发送到nginx反向代理服务器，利用nginx反向代理将不同域名的请求转发给内网不同机器的端口，就起到了“根据域名自动转发到相应服务器的特定端口”的效果，而路由器的端口映射做到的只是“根据不同端口自动转发到相应服务器的特定端口”，真是喜大普奔啊。<br>涉及的知识：nginx编译安装，nginx反向代理基本配置，路由端口映射知识，还有网络域名等常识。<br>本次实验目标是做到：在浏览器中输入xxx123.tk能访问到内网机器192.168.10.38的3000端口，输入xxx456.tk能访问到内网机器192.168.10.40的80端口。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>vim nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">user www www;</span><br><span class="line">worker_processes 1;</span><br><span class="line">error_log logs/error.log;</span><br><span class="line">pid logs/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    worker_connections 65535;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line">    include /usr/local/nginx/conf/reverse-proxy.conf;</span><br><span class="line">    sendfile on;</span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line">    gzip on;</span><br><span class="line">    client_max_body_size 50m; #缓冲区代理缓冲用户端请求的最大字节数,可以理解为保存到本地再传给用户</span><br><span class="line">    client_body_buffer_size 256k;</span><br><span class="line">    client_header_timeout 3m;</span><br><span class="line">    client_body_timeout 3m;</span><br><span class="line">    send_timeout 3m;</span><br><span class="line">    proxy_connect_timeout 300s; #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line">    proxy_read_timeout 300s; #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line">    proxy_send_timeout 300s;</span><br><span class="line">    proxy_buffer_size 64k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line">    proxy_buffers 4 32k; #proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line">    proxy_busy_buffers_size 64k; #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line">    proxy_temp_file_write_size 64k; #设定缓存文件夹大小，大于这个值，将从upstream服务器传递请求，而不缓冲到磁盘</span><br><span class="line">    proxy_ignore_client_abort on; #不允许代理端主动关闭连接</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root html;</span><br><span class="line">            index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编辑反向代理服务器配置文件：<br>vim /usr/local/nginx/conf/reverse-proxy.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name xxx123.tk;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass http://192.168.10.38:3000;</span><br><span class="line">    &#125;</span><br><span class="line">    access_log logs/xxx123.tk_access.log;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name xxx456.tk;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass http://192.168.10.40:80;</span><br><span class="line">    &#125;</span><br><span class="line">    access_log logs/xxx456.tk_access.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果想对后端机器做负载均衡，像下面这配置就可以把对nagios.xxx123.tk的请求分发给内网的131和132这两台机器做负载均衡了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">upstream monitor_server &#123;</span><br><span class="line">    server 192.168.0.131:80;</span><br><span class="line">    server 192.168.0.132:80;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name nagios.xxx123.tk;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; </span><br><span class="line">        proxy_pass http://monitor_server;</span><br><span class="line">    &#125;</span><br><span class="line">    access_log logs/nagios.xxx123.tk_access.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>额，关于负载均衡和缓存就不多说了，这里只是要起到一个简单的“域名转发”功能。<br>另外，由于http请求最后都是由反向代理服务器传递给后段的机器，所以后端的机器原来的访问日志记录的访问IP都是反向代理服务器的IP。<br>要想能记录真实IP，需要修改后端机器的日志格式，这里假设后端也是一台nginx：<br>在后端配置文件里面加入这一段即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log_format access &apos;$HTTP_X_REAL_IP - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">&apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">&apos;&quot;$http_user_agent&quot; $HTTP_X_Forwarded_For&apos;;</span><br><span class="line"> </span><br><span class="line">access_log logs/access.log access;</span><br></pre></td></tr></table></figure>
<p>再看看原来日志的格式长什么样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#log_format main &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line"># &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line"># &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"> </span><br><span class="line">#access_log logs/access.log main;</span><br></pre></td></tr></table></figure>
<p>之前没配置下面这段，访问时候偶尔会出现504 gateway timeout，由于偶尔出现，所以不太好排查。</p>
<p>从日志看来是连接超时了，网上一通乱查之后估计可能是后端服务器响应超时了，本着大胆假设，小心求证的原则，既然假设了错误原因就要做实验重现错误：那就调整代理超时参数，反过来把代理超时阀值设小（比如1ms）看会不会次次出现504。后来发现把proxy_read_timeout 这个参数设置成1ms的时候，每次访问都出现504。于是把这个参数调大，加入下面那段配置，解决问题了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">proxy_connect_timeout 300s;</span><br><span class="line">proxy_read_timeout 300s;</span><br><span class="line">proxy_send_timeout 300s;</span><br><span class="line">proxy_buffer_size 64k;</span><br><span class="line">proxy_buffers 4 32k;</span><br><span class="line">proxy_busy_buffers_size 64k;</span><br><span class="line">proxy_temp_file_write_size 64k;</span><br><span class="line">proxy_ignore_client_abort on;</span><br></pre></td></tr></table></figure>
<h2 id="nginx-tcp代理"><a href="#nginx-tcp代理" class="headerlink" title="nginx tcp代理"></a>nginx tcp代理</h2><p><a href="http://yaoweibin.github.io/nginx_tcp_proxy_module/README.html" target="_blank" rel="noopener">nginx_tcp_proxy_module模块</a><br>nginx tcp代理功能由nginx_tcp_proxy_module模块提供，同时监测后端主机状态。该模块包括的模块有： ngx_tcp_module, ngx_tcp_core_module, ngx_tcp_upstream_module, ngx_tcp_proxy_module, ngx_tcp_upstream_ip_hash_module。</p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.4.4.tar.gz</span><br><span class="line">tar zxvf nginx-1.4.4.tar.gz</span><br><span class="line">cd nginx-1.4.4</span><br><span class="line">./configure --add-module=/path/to/nginx_tcp_proxy_module</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location /status &#123;</span><br><span class="line">        check_status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">tcp &#123;</span><br><span class="line">    upstream cluster_www_ttlsa_com &#123;</span><br><span class="line">        # simple round-robin</span><br><span class="line">        server 127.0.0.1:1234;</span><br><span class="line">        check interval=3000 rise=2 fall=5 timeout=1000;</span><br><span class="line">        #check interval=3000 rise=2 fall=5 timeout=1000 type=ssl_hello;</span><br><span class="line">        #check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span><br><span class="line">        #check_http_send &quot;GET / HTTP/1.0\r\n\r\n&quot;;</span><br><span class="line">        #check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8888;</span><br><span class="line">        proxy_pass cluster_www_ttlsa_com;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这会出现一个问题，就是tcp连接会掉线。原因在于当服务端关闭连接的时候，客户端不可能立刻发觉连接已经被关闭，需要等到当Nginx在执行check规则时认为服务端链接关闭，此时nginx会关闭与客户端的连接。</p>
<h3 id="保持连接配置"><a href="#保持连接配置" class="headerlink" title="保持连接配置"></a>保持连接配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location /status &#123;</span><br><span class="line">        check_status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">tcp &#123;</span><br><span class="line"> timeout 1d;</span><br><span class="line">    proxy_read_timeout 10d;</span><br><span class="line">    proxy_send_timeout 10d;</span><br><span class="line">    proxy_connect_timeout 30;</span><br><span class="line">    upstream cluster_www_ttlsa_com &#123;</span><br><span class="line">        # simple round-robin</span><br><span class="line">        server 127.0.0.1:1234;</span><br><span class="line">        check interval=3000 rise=2 fall=5 timeout=1000;</span><br><span class="line">        #check interval=3000 rise=2 fall=5 timeout=1000 type=ssl_hello;</span><br><span class="line">        #check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span><br><span class="line">        #check_http_send &quot;GET / HTTP/1.0\r\n\r\n&quot;;</span><br><span class="line">        #check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8888;</span><br><span class="line">        proxy_pass cluster_www_ttlsa_com;</span><br><span class="line"> so_keepalive on;</span><br><span class="line">        tcp_nodelay on;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="高可用nginx群集和高速缓存"><a href="#高可用nginx群集和高速缓存" class="headerlink" title="高可用nginx群集和高速缓存"></a>高可用nginx群集和高速缓存</h2><p>nginx+keepalived+proxy_cache 配置高可用nginx群集和高速缓存</p>
<h3 id="安装nginx-主从服务器"><a href="#安装nginx-主从服务器" class="headerlink" title="安装nginx 主从服务器"></a>安装nginx 主从服务器</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.0.11.tar.gz</span><br><span class="line">wget http://labs.frickle.com/files/ngx_cache_purge-1.4.tar.gz</span><br></pre></td></tr></table></figure>
<h4 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum -y install zlib-devel pcre-devel openssl-devel  # 安装依赖</span><br><span class="line">tar –xvf ngx_cache_purge-1.4.tar.gz</span><br><span class="line">tar –xvf nginx-1.0.11.tar.gz</span><br><span class="line">cd nginx-1.0.11/</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/nginx --add-module=../ngx_cache_purge-1.4 --with-http_stub_status_module --with-http_ssl_module --with-http_flv_module --with-http_gzip_static_module</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h4 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/local/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">user nobody;</span><br><span class="line">worker_processes 8;</span><br><span class="line">events &#123;</span><br><span class="line">worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">include mime.types;</span><br><span class="line">default_type application/octet-stream;</span><br><span class="line">charset utf-8;</span><br><span class="line">server_names_hash_bucket_size 128;</span><br><span class="line">client_header_buffer_size 32k;</span><br><span class="line">large_client_header_buffers 4 32k;</span><br><span class="line">client_max_body_size 300m;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">tcp_nodelay on;</span><br><span class="line">client_body_buffer_size 512k;</span><br><span class="line">proxy_connect_timeout 5;</span><br><span class="line">proxy_read_timeout 60;</span><br><span class="line">proxy_send_timeout 5;</span><br><span class="line">proxy_buffer_size 16k;</span><br><span class="line">proxy_buffers 4 64k;</span><br><span class="line">proxy_busy_buffers_size 128k;</span><br><span class="line">proxy_temp_file_write_size 128k;</span><br><span class="line">sendfile on;</span><br><span class="line">gzip on;</span><br><span class="line">gzip_min_length 1k;</span><br><span class="line">gzip_buffers 4 16k;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_comp_level 2;</span><br><span class="line">gzip_types text/plain application/x-javascript text/css application/xml;</span><br><span class="line">gzip_vary on;</span><br><span class="line">proxy_temp_path /data/proxy_temp_dir;</span><br><span class="line">proxy_cache_path /data/proxy_cache_dir levels=1:2 keys_zone=cache_one:50m inactive=1m max_size=2g;</span><br><span class="line">upstream real_server_pool&#123;</span><br><span class="line">server 192.168.200.148:80 weight=1 max_fails=2 fail_timeout=30s;</span><br><span class="line">server 192.168.10.251:80 weight=1 max_fails=2 fail_timeout=30s;</span><br><span class="line">&#125;</span><br><span class="line">keepalive_timeout 65;</span><br><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name localhost;</span><br><span class="line">location / &#123;</span><br><span class="line">root html;</span><br><span class="line">index index.html index.htm;</span><br><span class="line">proxy_next_upstream http_502 http_504 error timeout invalid_header;</span><br><span class="line">proxy_cache cache_one;</span><br><span class="line">proxy_cache_valid 200 304 12h;</span><br><span class="line">proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">proxy_set_header Host $host;</span><br><span class="line">proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">proxy_pass http://real_server_pool;</span><br><span class="line">expires 1d;</span><br><span class="line">&#125;</span><br><span class="line">error_page 500 502 503 504 /50x.html;</span><br><span class="line">location = /50x.html &#123;</span><br><span class="line">root html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ .*\.(php|jsp|cgi)?$</span><br><span class="line">&#123;</span><br><span class="line">proxy_set_header Host $host;</span><br><span class="line">proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">proxy_pass http://real_server_pool;</span><br><span class="line">&#125;</span><br><span class="line">log_format access &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot;&apos;</span><br><span class="line">&apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">&apos;&quot;$http_user_agent&quot; $http_x_forwarded_for&apos;;</span><br><span class="line">access_log /data/logs/access.log access;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>备用调度器的nginx配置文件和主调度器的配置文件一样。</p>
<h4 id="启动nginx-1"><a href="#启动nginx-1" class="headerlink" title="启动nginx"></a>启动nginx</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
<h3 id="安装keepalived（在nginx的mater和backup都安装）"><a href="#安装keepalived（在nginx的mater和backup都安装）" class="headerlink" title="安装keepalived（在nginx的mater和backup都安装）"></a>安装keepalived（在nginx的mater和backup都安装）</h3><h4 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.keepalived.org/software/keepalived-1.1.19.tar.gz</span><br></pre></td></tr></table></figure>
<h4 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf keepalived-1.1.19.tar.gz</span><br><span class="line">cd keepalived-1.1.19</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/keepalived</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">cp /usr/local/keepalived/sbin/keepalived /usr/sbin/</span><br><span class="line">cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/</span><br><span class="line">cp /usr/local/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/</span><br><span class="line">mkdir /etc/keepalived</span><br></pre></td></tr></table></figure>
<h4 id="配置-4"><a href="#配置-4" class="headerlink" title="配置"></a>配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/keepalived/keepalived.conf</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_INET1 &#123;</span><br><span class="line">state MASTER</span><br><span class="line">interface eth0</span><br><span class="line">virtual_router_id 53</span><br><span class="line">priority 100</span><br><span class="line">advert_int 1</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type pass</span><br><span class="line">auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">192.168.10.104/24</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.10.104 80 &#123;</span><br><span class="line">delay_loop 6</span><br><span class="line">lb_algo rr</span><br><span class="line">lb_kind NAT</span><br><span class="line">nat_mask 255.255.255.0</span><br><span class="line">persistence_timeout 50</span><br><span class="line">protocol TCP</span><br><span class="line">real_server 192.168.10.251 80 &#123;</span><br><span class="line">weight 3</span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 10</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 80</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.200.148 80 &#123;</span><br><span class="line">weight 3</span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 10</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">connect_port 80</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置备用调度器的keepalived,只需要将state MASTER 改为state BACKUP,降低priority 100 的值:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">state MASTER ---&gt; state BACKUP</span><br><span class="line">priority 100 ---&gt;  priority 99 （此值必须低于主的）</span><br></pre></td></tr></table></figure>
<h4 id="主备启动"><a href="#主备启动" class="headerlink" title="主备启动"></a>主备启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/keepalived start</span><br></pre></td></tr></table></figure>
<h2 id="优化指南"><a href="#优化指南" class="headerlink" title="优化指南"></a>优化指南</h2><h3 id="基本的-优化过的-配置"><a href="#基本的-优化过的-配置" class="headerlink" title="基本的 (优化过的)配置"></a>基本的 (优化过的)配置</h3><p>我们将修改的唯一文件是nginx.conf，其中包含Nginx不同模块的所有设置。你应该能够在服务器的/etc/nginx目录中找到nginx.conf。首先，我们将谈论一些全局设置，然后按文件中的模块挨个来，谈一下哪些设置能够让你在大量客户端访问时拥有良好的性能，为什么它们会提高性能。本文的结尾有一个完整的配置文件。</p>
<h4 id="高层的配置"><a href="#高层的配置" class="headerlink" title="高层的配置"></a>高层的配置</h4><p>nginx.conf文件中，Nginx中有少数的几个高级配置在模块部分之上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user www-data;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line">worker_processes auto;</span><br><span class="line">worker_rlimit_nofile 100000;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user和pid应该按默认设置 - 我们不会更改这些内容，因为更改与否没有什么不同。</span><br><span class="line">worker_processes 定义了nginx对外提供web服务时的worder进程数。最优值取决于许多因素，包括（但不限于）CPU核的数量、存储数据的硬盘数量及负载模式。不能确定的时候，将其设置为可用的CPU内核数将是一个好的开始（设置为“auto”将尝试自动检测它）。</span><br><span class="line">worker_rlimit_nofile 更改worker进程的最大打开文件数限制。如果没设置的话，这个值为操作系统的限制。设置后你的操作系统和Nginx可以处理比“ulimit -a”更多的文件，所以把这个值设高，这样nginx就不会有“too many open files”问题了。</span><br></pre></td></tr></table></figure>
<h4 id="Events模块"><a href="#Events模块" class="headerlink" title="Events模块"></a>Events模块</h4><p>events模块中包含nginx中所有处理连接的设置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">worker_connections 2048;</span><br><span class="line">multi_accept on;</span><br><span class="line">use epoll;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">worker_connections设置可由一个worker进程同时打开的最大连接数。如果设置了上面提到的worker_rlimit_nofile，我们可以将这个值设得很高。</span><br><span class="line">记住，最大客户数也由系统的可用socket连接数限制（~ 64K），所以设置不切实际的高没什么好处。</span><br><span class="line">multi_accept 告诉nginx收到一个新连接通知后接受尽可能多的连接。</span><br><span class="line">use 设置用于复用客户端线程的轮询方法。如果你使用Linux 2.6+，你应该使用epoll。如果你使用*BSD，你应该使用kqueue。想知道更多有关事件轮询？看下维基百科吧（注意，想了解一切的话可能需要neckbeard和操作系统的课程基础）</span><br><span class="line">（值得注意的是如果你不知道Nginx该使用哪种轮询方法的话，它会选择一个最适合你操作系统的）</span><br></pre></td></tr></table></figure>
<h4 id="HTTP-模块"><a href="#HTTP-模块" class="headerlink" title="HTTP 模块"></a>HTTP 模块</h4><p>HTTP模块控制着nginx http处理的所有核心特性。因为这里只有很少的配置，所以我们只节选配置的一小部分。所有这些设置都应该在http模块中，甚至你不会特别的注意到这段设置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">server_tokens off;</span><br><span class="line">sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">tcp_nodelay on;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server_tokens 并不会让nginx执行的速度更快，但它可以关闭在错误页面中的nginx版本数字，这样对于安全性是有好处的。sendfile可以让sendfile()发挥作用。sendfile()可以在磁盘和TCP socket之间互相拷贝数据(或任意两个文件描述符)。Pre-sendfile是传送数据之前在用户空间申请数据缓冲区。之后用read()将数据从文件拷贝到这个缓冲区，write()将缓冲区数据写入网络。sendfile()是立即将数据从磁盘读到OS缓存。因为这种拷贝是在内核完成的，sendfile()要比组合read()和write()以及打开关闭丢弃缓冲更加有效(更多有关于sendfile)</span><br><span class="line">tcp_nopush 告诉nginx在一个数据包里发送所有头文件，而不一个接一个的发送</span><br><span class="line">tcp_nodelay 告诉nginx不要缓存数据，而是一段一段的发送--当需要及时发送数据时，就应该给应用设置这个属性，这样发送一小块数据信息时就不能立即得到返回值。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">access_log off;</span><br><span class="line">error_log /var/log/nginx/error.log crit;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">access_log设置nginx是否将存储访问日志。关闭这个选项可以让读取磁盘IO操作更快(aka,YOLO)</span><br><span class="line">error_log 告诉nginx只能记录严重的错误。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keepalive_timeout 10;</span><br><span class="line">client_header_timeout 10;</span><br><span class="line">client_body_timeout 10;</span><br><span class="line">reset_timedout_connection on;</span><br><span class="line">send_timeout 10;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keepalive_timeout 给客户端分配keep-alive链接超时时间。服务器将在这个超时时间过后关闭链接。我们将它设置低些可以让ngnix持续工作的时间更长。client_header_timeout 和client_body_timeout 设置请求头和请求体(各自)的超时时间。我们也可以把这个设置低些。</span><br><span class="line">reset_timeout_connection告诉nginx关闭不响应的客户端连接。这将会释放那个客户端所占有的内存空间。</span><br><span class="line">send_timeout 指定客户端的响应超时时间。这个设置不会用于整个转发器，而是在两次客户端读取操作之间。如果在这段时间内，客户端没有读取任何数据，nginx就会关闭连接。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">limit_conn_zone $binary_remote_addr zone=addr:5m;</span><br><span class="line">limit_conn addr 100;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">limit_conn_zone设置用于保存各种key（比如当前连接数）的共享内存的参数。5m就是5兆字节，这个值应该被设置的足够大以存储（32K*5）32byte状态或者（16K*5）64byte状态。</span><br><span class="line">limit_conn为给定的key设置最大连接数。这里key是addr，我们设置的值是100，也就是说我们允许每一个IP地址最多同时打开有100个连接。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">include /etc/nginx/mime.types;</span><br><span class="line">default_type text/html;</span><br><span class="line">charset UTF-8;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">include只是一个在当前文件中包含另一个文件内容的指令。这里我们使用它来加载稍后会用到的一系列的MIME类型。default_type设置文件使用的默认的MIME-type。</span><br><span class="line">charset设置我们的头文件中的默认的字符集</span><br><span class="line">以下两点对于性能的提升在伟大的WebMasters StackExchange中有解释。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gzip on;</span><br><span class="line">gzip_disable &quot;msie6&quot;;</span><br><span class="line"># gzip_static on;</span><br><span class="line">gzip_proxied any;</span><br><span class="line">gzip_min_length 1000;</span><br><span class="line">gzip_comp_level 4;</span><br><span class="line">gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gzip是告诉nginx采用gzip压缩的形式发送数据。这将会减少我们发送的数据量。</span><br><span class="line">gzip_disable为指定的客户端禁用gzip功能。我们设置成IE6或者更低版本以使我们的方案能够广泛兼容。</span><br><span class="line">gzip_static告诉nginx在压缩资源之前，先查找是否有预先gzip处理过的资源。这要求你预先压缩你的文件（在这个例子中被注释掉了），从而允许你使用最高压缩比，这样nginx就不用再压缩这些文件了（想要更详尽的gzip_static的信息，请点击这里）。</span><br><span class="line">gzip_proxied允许或者禁止压缩基于请求和响应的响应流。我们设置为any，意味着将会压缩所有的请求。</span><br><span class="line">gzip_min_length设置对数据启用压缩的最少字节数。如果一个请求小于1000字节，我们最好不要压缩它，因为压缩这些小的数据会降低处理此请求的所有进程的速度。</span><br><span class="line">gzip_comp_level设置数据的压缩等级。这个等级可以是1-9之间的任意数值，9是最慢但是压缩比最大的。我们设置为4，这是一个比较折中的设置。</span><br><span class="line">gzip_type设置需要压缩的数据格式。上面例子中已经有一些了，你也可以再添加更多的格式。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache max=100000 inactive=20s;</span><br><span class="line">open_file_cache_valid 30s;</span><br><span class="line">open_file_cache_min_uses 2;</span><br><span class="line">open_file_cache_errors on;</span><br><span class="line"></span><br><span class="line">include /etc/nginx/conf.d/*.conf;</span><br><span class="line">include /etc/nginx/sites-enabled/*;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache打开缓存的同时也指定了缓存最大数目，以及缓存的时间。我们可以设置一个相对高的最大时间，这样我们可以在它们不活动超过20秒后清除掉。</span><br><span class="line">open_file_cache_valid 在open_file_cache中指定检测正确信息的间隔时间。</span><br><span class="line">open_file_cache_min_uses 定义了open_file_cache中指令参数不活动时间期间里最小的文件数。</span><br><span class="line">open_file_cache_errors指定了当搜索一个文件时是否缓存错误信息，也包括再次给配置中添加文件。我们也包括了服务器模块，这些是在不同文件中定义的。如果你的服务器模块不在这些位置，你就得修改这一行来指定正确的位置。</span><br></pre></td></tr></table></figure>
<p>一个完整的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cat nginx.conf</span><br><span class="line"></span><br><span class="line">user www-data;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line">worker_processes auto;</span><br><span class="line">worker_rlimit_nofile 100000;</span><br><span class="line">events &#123;</span><br><span class="line"> worker_connections 2048;</span><br><span class="line"> multi_accept on;</span><br><span class="line"> use epoll;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">  server_tokens off;</span><br><span class="line"> sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line"> tcp_nodelay on;</span><br><span class="line"> access_log off;</span><br><span class="line"> error_log /var/log/nginx/error.log crit;</span><br><span class="line"> keepalive_timeout 10;</span><br><span class="line"> client_header_timeout 10;</span><br><span class="line"> client_body_timeout 10;</span><br><span class="line">reset_timedout_connection on;</span><br><span class="line"> send_timeout 10;</span><br><span class="line"> limit_conn_zone $binary_remote_addr zone=addr:5m;</span><br><span class="line"> limit_conn addr 100;</span><br><span class="line"> include /etc/nginx/mime.types;</span><br><span class="line"> default_type text/html;</span><br><span class="line">charset UTF-8;</span><br><span class="line">gzip on;</span><br><span class="line"> gzip_disable &quot;msie6&quot;;</span><br><span class="line">gzip_proxied any;</span><br><span class="line">gzip_min_length 1000;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line"> gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line"> open_file_cache max=100000 inactive=20s;</span><br><span class="line">open_file_cache_valid 30s;</span><br><span class="line">open_file_cache_min_uses 2;</span><br><span class="line">open_file_cache_errors on;</span><br><span class="line"> include /etc/nginx/conf.d/*.conf;</span><br><span class="line"> include /etc/nginx/sites-enabled/*;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#<br>#</p>
<h1 id="nginx开启https"><a href="#nginx开启https" class="headerlink" title="nginx开启https"></a>nginx开启https</h1><p>nginx的https协议需要ssl模块的支持，我们在编译nginx时使用–with-http_ssl_module参数加入SSL模块。还需要服务器私钥，服务器证书。</p>
<p>检查Nginx的SSL模块是否安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V |grep ssl</span><br></pre></td></tr></table></figure>
<p>准备证书<br><a href="https://www.startcomca.com" target="_blank" rel="noopener">StartSSL</a></p>
<p>开启Nginx SSL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen       443;</span><br><span class="line">ssl on;</span><br><span class="line">ssl_certificate /data/cert/server.crt;</span><br><span class="line">ssl_certificate_key /data/cert/server.key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br><span class="line">netstat -lntup|grep 443</span><br></pre></td></tr></table></figure>
<p>配置重定向80端口转443端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">rewrite ^(.*) https://$server_name$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#</p>

      
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术/">技术</a><a class="article-category-link" href="/categories/技术/Linux/">Linux</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/28/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="page-number" href="/page/28/">28</a><span class="page-number current">29</span><a class="page-number" href="/page/30/">30</a><a class="extend next" rel="next" href="/page/30/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2018 幻舞梦境
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >海贼到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-39498261-3', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?1bb44bf25fea8f000a1397f9b5438de7";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>